
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>The APL Way &#8212; Learning APL</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <link rel="next" title="Namespaces ⎕NS" href="namespaces.html" />
    <link rel="prev" title="Error handling" href="errors.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-3 bd-sidebar site-navigation show" id="site-navigation">
    
        <div class="navbar-brand-box">
    <a class="navbar-brand text-wrap" href="index.html">
      
        <!-- `logo` is deprecated in Sphinx 4.0, so remove this when we stop supporting 3 -->
        
      
      
      <img src="_static/logo2.png" class="logo" alt="logo">
      
      
      <h1 class="site-logo" id="site-title">Learning APL</h1>
      
    </a>
</div><form class="bd-search d-flex align-items-center" action="search.html" method="get">
  <i class="icon fas fa-search"></i>
  <input type="search" class="form-control" name="q" id="search-input" placeholder="Search this book..." aria-label="Search this book..." autocomplete="off" >
</form><nav class="bd-links" id="bd-docs-nav" aria-label="Main">
    <div class="bd-toc-item active">
        <ul class="nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="intro.html">
   Introduction
  </a>
 </li>
</ul>
<ul class="current nav bd-sidenav">
 <li class="toctree-l1">
  <a class="reference internal" href="array.html">
   It’s arrays all the way down
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="indexing.html">
   Indexing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="manip.html">
   Glyphiary
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="functions.html">
   Direct functions and operators
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="iteration.html">
   Iteration
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="key.html">
   The Key operator:
   <code class="docutils literal notranslate">
    <span class="pre">
     ⌸
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="at.html">
   The At operator:
   <code class="docutils literal notranslate">
    <span class="pre">
     @
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="rank.html">
   The Rank/Atop operator:
   <code class="docutils literal notranslate">
    <span class="pre">
     ⍤
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="stencil.html">
   The Stencil operator:
   <code class="docutils literal notranslate">
    <span class="pre">
     ⌺
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="over.html">
   The Över operator:
   <code class="docutils literal notranslate">
    <span class="pre">
     ⍥
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dyadictrn.html">
   Dyadic transpose:
   <code class="docutils literal notranslate">
    <span class="pre">
     A⍉B
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="decode.html">
   Encode decode:
   <code class="docutils literal notranslate">
    <span class="pre">
     ⊤⊥
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="products.html">
   Products
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tacit.html">
   Trainspotting
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="find.html">
   Finding things
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="cookbook1.html">
   Partitions
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="errors.html">
   Error handling
  </a>
 </li>
 <li class="toctree-l1 current active">
  <a class="current reference internal" href="#">
   The APL Way
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="namespaces.html">
   Namespaces
   <code class="docutils literal notranslate">
    <span class="pre">
     ⎕NS
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="io.html">
   Dealing with real data
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="http.html">
   HttpCommand
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="dfnsws.html">
   The dfns workspace
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="testing.html">
   Testing
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="workflow.html">
   A Dyalog workflow. Or two.
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="next.html">
   What now?
  </a>
 </li>
 <li class="toctree-l1">
  <a class="reference internal" href="tldr.html">
   Too long; didn’t read
  </a>
 </li>
</ul>

    </div>
</nav> <!-- To handle the deprecated key -->

<div class="navbar_extra_footer">
  Powered by <a href="https://jupyterbook.org">Jupyter Book</a>
</div>

</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            <button id="navbar-toggler" class="navbar-toggler ml-0" type="button" data-toggle="collapse"
                data-toggle="tooltip" data-placement="bottom" data-target=".site-navigation" aria-controls="navbar-menu"
                aria-expanded="true" aria-label="Toggle navigation" aria-controls="site-navigation"
                title="Toggle navigation" data-toggle="tooltip" data-placement="left">
                <i class="fas fa-bars"></i>
                <i class="fas fa-arrow-left"></i>
                <i class="fas fa-arrow-up"></i>
            </button>
            
            
<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn" aria-label="Download this page"><i
            class="fas fa-download"></i></button>

    <div class="dropdown-buttons">
        <!-- ipynb file if we had a myst markdown file -->
        
        <!-- Download raw file -->
        <a class="dropdown-buttons" href="_sources/aplway.ipynb"><button type="button"
                class="btn btn-secondary topbarbtn" title="Download source file" data-toggle="tooltip"
                data-placement="left">.ipynb</button></a>
        <!-- Download PDF via print -->
        <button type="button" id="download-print" class="btn btn-secondary topbarbtn" title="Print to PDF"
            onClick="window.print()" data-toggle="tooltip" data-placement="left">.pdf</button>
    </div>
</div>

            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/xpqz/learnapl"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/xpqz/learnapl/issues/new?title=Issue%20on%20page%20%2Faplway.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#the-power-of-the-array">
   The power of the Array
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#luhn-s-algorithm">
   Luhn’s Algorithm
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#balancing-the-scales">
   Balancing the Scales
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#merge">
   Merge
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#right-align-a-block-of-text">
   Right-align a block of text
  </a>
 </li>
 <li class="toc-h2 nav-item toc-entry">
  <a class="reference internal nav-link" href="#fizzbuzz">
   FizzBuzz
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="the-apl-way">
<h1>The APL Way<a class="headerlink" href="#the-apl-way" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>Every reader should ask himself periodically “Toward what end, toward what end?”—but do not ask it too often lest you pass up the fun of programming for the constipation of bittersweet philosophy. –<em>Alan Perlis</em></p>
</div></blockquote>
<p>Up until now, we’ve skirted around one of the main advantages of APL – array-oriented, or <em>data-parallel</em> programming. This feels awkward and unnatural at first, but finding data-parallel approaches to problems is a skill that makes for efficient solutions in other languages, too, not just APL, and libraries such as Python’s <a class="reference external" href="https://numpy.org/">NumPy</a> encourages such solutions (it was inspired by APL, by the way).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this chapter, we’ll be making some comparisons between data-parallel APL and “loop &amp; branch” implementations in Python. We chose Python because its syntax is clean and understandable by a large proportion of programmers from other languages, too. In case it’s not immediately obvious, no effort has been made to find optimal Python solutions here; indeed, quite the opposite. View the Python examples as pseudocode illustrations of the algorithms, and yes, we’re fully aware that one can string together elegant, efficient Python solutions using iterator algebra and comprehensions.</p>
</div>
<p>A few pointers – Richard Park gave a series of webinars on <a class="reference external" href="https://dyalog.tv/Webinar/?v=myoK22rq1jk">Thinking in APL</a> that you should check out, and Adám Brudzewski gave several interactive Cultivations dedicated to the topic, <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-39-array-programming-techniques">Lesson 39 - Array programming techniques</a> and <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-42-array-coding-style-in-depth">Lesson 42 - Array coding style in depth</a>, too.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span> <span class="o">-</span><span class="nv">s</span><span class="o">=</span><span class="nv">min</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
<span class="nv">assert</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍺</span><span class="kd">←</span><span class="s1">&#39;assertion failure&#39;</span> <span class="p">⋄</span> <span class="m">0</span><span class="o">∊</span><span class="bp">⍵:⍺</span> <span class="nf">⎕signal</span> <span class="m">8</span> <span class="p">⋄</span> <span class="nv">shy</span><span class="kd">←</span><span class="m">0</span><span class="kt">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON -style=min
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<div class="section" id="the-power-of-the-array">
<h2>The power of the Array<a class="headerlink" href="#the-power-of-the-array" title="Permalink to this headline">¶</a></h2>
<p>Several factors super-charge array-oriented programming in APL:</p>
<ol class="simple">
<li><p>Many operations on non-nested arrays are fast; <em>really</em> fast, taking advantage of data parallelism in the processor (SIMD).</p></li>
<li><p>By operating on whole arrays, we can – with a bit of practice – avoid branches, thus avoiding processor branch-prediction misses.</p></li>
<li><p>Arrays in APL are implemented frugally when it comes to memory, especially Boolean arrays.</p></li>
</ol>
<p>The helicopter pitch for the simplest case might go something like this. Here’s a naive “loop and branch” way to pick all elements matching some predicate in Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;Loop &amp; branch&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">array</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>and here’s a data-parallel version:</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="nv">elems</span> <span class="kd">←</span> <span class="nv">f</span> <span class="nv">array</span> <span class="c1">⍝ Boolean mask</span>
<span class="nv">elems</span><span class="na">/</span><span class="nv">array</span>     <span class="c1">⍝ Compress; i.e. pick elemets at 1s</span>
</pre></div>
</div>
<p>Let’s say we want to find the odd numbers in a sequence:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">where</span> <span class="kd">←</span> <span class="m">2</span><span class="o">|</span><span class="nv">data</span> <span class="kd">←</span> <span class="o">⍳</span><span class="m">20</span> <span class="c1">⍝ mod-2 for the whole array at once</span>
<span class="nv">where</span><span class="na">/</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 3 5 7 9 11 13 15 17 19
</span></div></div>
</div>
<p>In the APL version, there is no loop, and no branch. The data is simple, and most likely allocated contiguously, and the CPU will be able to process several items in parallel for every cycle without any branch-prediction misses. Of course, with only 20 elements, algorithmic performance is a largely academic concern.</p>
<p>We can think of many problems that can be solved using the pattern of a scalar selection function applied to an array. One example, given by Richard Park in his webinar mentioned above, is to pick out all vowels from a string:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;aeiou&#39;</span> <span class="kt">{</span><span class="p">(</span><span class="bp">⍵</span><span class="o">∊</span><span class="bp">⍺</span><span class="p">)</span><span class="na">/</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;pick out all vowels from a string&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">iouaoeoai
</span></div></div>
</div>
<p>…or for train spotters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;aeiou&#39;</span> <span class="p">(</span><span class="o">∊</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">⍤/</span><span class="o">⊢</span><span class="p">)</span> <span class="s1">&#39;pick out all vowels from a string&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">iouaoeoai
</span></div></div>
</div>
<p>It’s the same idea as the ‘odd numbers’ above: create a Boolean mask using set membership (dyadic <code class="docutils literal notranslate"><span class="pre">∊</span></code>) and compress.</p>
<p>As an aside, and for the avoidance of any doubt, the <em>actual</em> APL way would be to just intersect the string with the vowels:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;aeiou&#39;</span> <span class="o">∩</span><span class="na">⍨</span> <span class="s1">&#39;pick out all vowels from a string&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">iouaoeoai
</span></div></div>
</div>
<p>Shorter, faster, array-ier, nicer – but not the point we wanted to make.</p>
</div>
<div class="section" id="luhn-s-algorithm">
<h2>Luhn’s Algorithm<a class="headerlink" href="#luhn-s-algorithm" title="Permalink to this headline">¶</a></h2>
<p>For something meatier, let’s look at implementing <a class="reference external" href="https://en.wikipedia.org/wiki/Luhn_algorithm">Luhn’s</a> algorithm, an error-detecting code used for validating credit card numbers. This was used to illustrate array-oriented concepts by Dyalog CTO, <a class="reference external" href="https://aplwiki.com/wiki/Morten_Kromberg">Morten Kromberg</a>, at a <a class="reference external" href="https://jiotalks.com/watch/204/home/Morten_Kromberg_&amp;_Aaron_Hsu/Pragmatic_Array_Oriented_Functional_Programming">presentation</a> given at JIO. We’ll follow Morten’s clear explanation of this algorithm:</p>
<ol>
<li><p>Split the credit card number into a <em>body</em> and the last digit, a <em>checksum</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Card number: 7 9 9 2 7 3 9 8 7 1 3
Body:        7 9 9 2 7 3 9 8 7 1    Checksum: 3
</pre></div>
</div>
</li>
<li><p>Multiply every other digit in the body by 2, starting from the last digit with a 2</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Body:        7  9 9 2 7 3 9  8 7 1
Weights:     1  2 1 2 1 2 1  2 1 2
           ×______________________
Products:    7 18 9 4 7 6 9 16 7 2
</pre></div>
</div>
</li>
<li><p>Separate any numbers greater than 9 into their individual digits, and sum columns</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Tens:        0 1 0 0 0 0 0 1 0 0
Units:       7 8 9 4 7 6 9 6 7 2
           +____________________
Sum:         7 9 9 4 7 6 9 7 7 2
</pre></div>
</div>
</li>
<li><p>Sum the sums</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Sum:         7+9+9+4+7+6+9+7+7+2 = 67
</pre></div>
</div>
</li>
<li><p>Sum the <em>digits</em> of this, modulo 10:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Result:      (6+7)%10 = 3
</pre></div>
</div>
</li>
</ol>
<p>If the result equals the checksum, the card number is valid.</p>
<p>Here’s one way this could be implemented in Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">luhn</span><span class="p">(</span><span class="n">cardnum</span><span class="p">):</span>
    <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">parity</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cardnum</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cardnum</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">digit</span> <span class="o">=</span> <span class="n">cardnum</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">parity</span><span class="p">:</span>
            <span class="n">digit</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">digit</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
                <span class="n">digit</span> <span class="o">-=</span> <span class="mi">9</span>
        <span class="n">checksum</span> <span class="o">+=</span> <span class="n">digit</span>

    <span class="k">return</span> <span class="n">checksum</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
<p>It may or may not be clear that the Python implementation follows the algorithm description. We step through the card number backwards making it easier to ensure that we get the factors right, regardless of the number of digits.</p>
<p>Now let’s implement this in APL. We can follow the algorithm description very closely.</p>
<p><strong>1: Split the credit card number into a <em>body</em> and the last digit, a <em>checksum</em></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">card</span> <span class="kd">←</span> <span class="m">7</span> <span class="m">9</span> <span class="m">9</span> <span class="m">2</span> <span class="m">7</span> <span class="m">3</span> <span class="m">9</span> <span class="m">8</span> <span class="m">7</span> <span class="m">1</span> <span class="m">3</span>

<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">body</span> <span class="kd">←</span> <span class="p">(</span><span class="nv">count</span><span class="kd">←</span><span class="m">¯1</span><span class="o">+≢</span><span class="nv">card</span><span class="p">)</span><span class="o">↑</span><span class="nv">card</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">check</span> <span class="kd">←</span> <span class="o">⊢</span><span class="na">/</span><span class="nv">card</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">7 9 9 2 7 3 9 8 7 1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div></div>
</div>
<p><strong>2: Multiply every other digit in the body by 2, starting from the last digit with a 2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">weights</span> <span class="kd">←</span> <span class="nv">count</span><span class="o">⍴</span><span class="p">(</span><span class="m">2</span><span class="o">|</span><span class="nv">count</span><span class="p">)</span><span class="o">⌽</span><span class="m">1</span> <span class="m">2</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">products</span> <span class="kd">←</span> <span class="nv">body</span><span class="o">×</span><span class="nv">weights</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 1 2 1 2 1 2 1 2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">7 18 9 4 7 6 9 16 7 2
</span></div></div>
</div>
<p><strong>3, 4. Separate any numbers greater than 9 into their individual digits, and sum</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">digits</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">10</span><span class="o">⊤</span><span class="nv">products</span> <span class="c1">⍝ We can think of `0 10⊤` as divmod</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">sum</span> <span class="kd">←</span> <span class="o">+</span><span class="na">⌿</span><span class="o">,</span><span class="nv">digits</span>        <span class="c1">⍝ By raveling, we save doing sum the sum of cols</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 0 0 0 0 0 1 0 0
7 8 9 4 7 6 9 6 7 2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">67
</span></div></div>
</div>
<p><strong>5. Digit sum, mod 10</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">10</span><span class="o">|-</span><span class="nv">sum</span> <span class="c1">⍝ Magic</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div></div>
</div>
<p>If we put all that together, we arrive at Morten’s solution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">luhn</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">check</span> <span class="kd">←</span> <span class="o">⊢</span><span class="na">/</span><span class="bp">⍵</span>
    <span class="nv">body</span> <span class="kd">←</span> <span class="p">(</span><span class="nv">count</span><span class="kd">←</span><span class="m">¯1</span><span class="o">+≢</span><span class="bp">⍵</span><span class="p">)</span><span class="o">↑</span><span class="bp">⍵</span>
    <span class="nv">weights</span> <span class="kd">←</span> <span class="nv">count</span><span class="o">⍴</span><span class="p">(</span><span class="m">2</span><span class="o">|</span><span class="nv">count</span><span class="p">)</span><span class="o">⌽</span><span class="m">1</span> <span class="m">2</span>
    <span class="nv">digits</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">10</span><span class="o">⊤</span><span class="nv">body</span><span class="o">×</span><span class="nv">weights</span>
    <span class="nv">check</span><span class="o">=</span><span class="m">10</span><span class="o">|-+</span><span class="na">/</span><span class="o">,</span><span class="nv">digits</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">assert</span> <span class="nv">luhn</span> <span class="m">7</span> <span class="m">9</span> <span class="m">9</span> <span class="m">2</span> <span class="m">7</span> <span class="m">3</span> <span class="m">9</span> <span class="m">8</span> <span class="m">7</span> <span class="m">1</span> <span class="m">3</span>
</pre></div>
</div>
</div>
</div>
<p>The Luhn algorithm was obviously chosen as an ideal fit for a data-parallel implementation. A few things stand out: firstly, the APL implementation follows the algorithm definition very closely, much closer than the Python version. Granted – and this is an interesting experiment – you can take the APL approach and implement a Python version following a similar pattern, albeit without array operations. Secondly, the solution is completely free or loops and branches. As Morten also observes, over 10 digits, there is no meaningful performance implication here, but it’s not hard to imagine what would happen over a million or more digits.</p>
</div>
<div class="section" id="balancing-the-scales">
<h2>Balancing the Scales<a class="headerlink" href="#balancing-the-scales" title="Permalink to this headline">¶</a></h2>
<p>This is Problem 8, Phase II from the 2020 Dyalog problem solving competition. You can see the problem statement <a class="reference external" href="https://www.dyalog.com/uploads/files/student_competition/2020_problems_phase2.pdf">here</a>. Obviously, there are spoilers to follow – if you want to have a crack at it yourself, stop reading here.</p>
<p>Our task is to partition a set of numbers into two groups of equal sum if this is possible, or return <code class="docutils literal notranslate"><span class="pre">⍬</span></code> if not. This is a well-known NP-hard problem, called <a class="reference external" href="https://en.wikipedia.org/wiki/Partition_problem">The Partition Problem</a>, and as such has no fast, always correct solutions for the general case. The problem statement indicates that we only need to consider a set of 20 numbers or fewer, which is a bit of a hint on what kind of solution is expected.</p>
<p>This problem, in common with many other NP problems, also has a plethora of interesting heuristic solutions: faster algorithms that whilst not guaranteed to always find the optimal solution will either get close, or be correct for a significant subset of the problem domain in a fraction of the time the exhaustive search would take. We’ll look at one of these approaches, too, although it probably wasn’t what Dyalog wanted in terms of the competition (I might be wrong; I didn’t take part at the time).</p>
<p>So given that we have a defined upper bound, and that Dyalog wants the solution to be optimal for all inputs up to this bound, and we know this problem to be NP-hard, we’re looking at an exhaustive search of some sort. We can also guess that given this is a Dyalog competition problem, whilst the algorithm might be crude, we should be able to exploit APL’s fast array processing to implement it efficiently.</p>
<p>The algorithm (if we can call it that) is simply to try every possible combination in which the numbers can be put into two separate piles and check if the partition sum equals half the total sum. If we have <code class="docutils literal notranslate"><span class="pre">n</span></code> items in our set, that corresponds to considering all numbers up to <code class="docutils literal notranslate"><span class="pre">¯1+2*n</span></code> in binary (recall  that <code class="docutils literal notranslate"><span class="pre">*</span></code> is exponentiation, not multiplication), and the two sets correspond to those matching the 0 bits and 1 bits respectively. For example, if we have the numbers 1, 1 and 2 we need to consider the following partitions (although we can skip the first and last):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(0: 0 0 0)
 1: 0 0 1
 2: 0 1 0
 3: 0 1 1
 4: 1 0 0
 5: 1 0 1
 6: 1 1 0
(7: 1 1 1)
</pre></div>
</div>
<p>In this case, the solutions would be either 0 0 1, or its inverse, 1 1 0, corresponding to the partitioning <code class="docutils literal notranslate"><span class="pre">(1</span> <span class="pre">1)(,2)</span></code>.</p>
<p>So what are we dealing with here, in terms of the search space?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">¯1</span><span class="o">+</span><span class="m">2</span><span class="o">*</span><span class="m">20</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1048575
</span></div></div>
</div>
<p>Just over a million or so different partitions to check, which should be manageable. The search space doubles in size for each additional item, which is something alluded to in the <a class="reference external" href="https://en.wikipedia.org/wiki/Wheat_and_chessboard_problem">old fable</a> about the inventor of Chess:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">e</span><span class="kd">←</span><span class="m">¯1</span><span class="o">+</span><span class="m">2</span><span class="na">∘</span><span class="o">*</span><span class="p">⋄</span><span class="nv">e</span><span class="na">¨</span><span class="m">21</span><span class="o">+⍳</span><span class="m">9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2097151 4194303 8388607 16777215 33554431 67108863 134217727 268435455 536870911
</span></div></div>
</div>
<p>To generate all binary combinations for <code class="docutils literal notranslate"><span class="pre">n</span></code> bits, we can use the following incantation (for n=3):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍉</span><span class="m">2</span><span class="na">∘</span><span class="o">⊥</span><span class="na">⍣</span><span class="m">¯1</span><span class="o">⍳</span><span class="m">2</span><span class="o">*</span><span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0
0 0 1
0 1 0
0 1 1
1 0 0
1 0 1
1 1 0
1 1 1
</span></div></div>
</div>
<p>Given a Boolean vector, how do we turn that into the two corresponding sets of numbers? There are several ways you can try, for example compress:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="kt">{</span><span class="p">(</span><span class="bp">⍺</span><span class="na">/</span><span class="bp">⍵</span><span class="p">)(</span><span class="bp">⍵</span><span class="na">/⍨</span><span class="o">~</span><span class="bp">⍺</span><span class="p">)</span><span class="kt">}</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="c1">⍝ compress and compress ~</span>
<span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="kt">{</span><span class="p">(</span><span class="bp">⍵</span><span class="o">~</span><span class="nv">v</span><span class="p">)(</span><span class="nv">v</span><span class="kd">←</span><span class="bp">⍺</span><span class="na">/</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="c1">⍝ compress and set difference</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─┐
│1 1│2│
└───┴─┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬───┐
│2│1 1│
└─┴───┘
</span></div></div>
</div>
<p>but we can exploit the fact that we’re really interested in the <em>sums</em> of the sets. The sum of the items corresponding to the set bits is really just the bit pattern times the input set, summed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">/</span><span class="m">1</span> <span class="m">1</span> <span class="m">0</span><span class="o">×</span><span class="m">1</span> <span class="m">1</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div></div>
</div>
<p>which we by now hopefully should recognize as an inner product:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="o">+</span><span class="na">.</span><span class="o">×</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div></div>
</div>
<p>And of course, inner product can be applied to an array, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">patterns</span> <span class="kd">←</span> <span class="o">⍉</span><span class="m">2</span><span class="na">∘</span><span class="o">⊥</span><span class="na">⍣</span><span class="m">¯1</span><span class="o">⍳</span><span class="m">2</span><span class="o">*</span><span class="m">3</span>
<span class="nv">patterns</span> <span class="o">+</span><span class="na">.</span><span class="o">×</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 2 1 3 1 3 2 4
</span></div></div>
</div>
<p>We can now draw up a plan for this.</p>
<ol class="simple">
<li><p>Our target partition sum is the total divided by two.</p></li>
<li><p>Generate the bit patterns up to <code class="docutils literal notranslate"><span class="pre">≢⍵</span></code>.</p></li>
<li><p>Calculate the sums of the numbers corresponding to the set bits in each pattern</p></li>
<li><p>Find the first point where the partition sum is equal to the target</p></li>
<li><p>Return the corresponding partitioning</p></li>
</ol>
<p>This translates readily to APL:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Balance</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">total</span> <span class="kd">←</span> <span class="o">+</span><span class="na">/</span><span class="bp">⍵</span>
    <span class="m">2</span><span class="o">|</span><span class="nv">total</span><span class="bp">:</span> <span class="no">⍬</span>             <span class="c1">⍝ Sum must be divisible by 2</span>
    <span class="nv">psum</span> <span class="kd">←</span> <span class="nv">total</span><span class="o">÷</span><span class="m">2</span>         <span class="c1">⍝ Our target partition sum</span>
    <span class="nv">bitp</span> <span class="kd">←</span> <span class="o">⍉</span><span class="m">2</span><span class="na">∘</span><span class="o">⊥</span><span class="na">⍣</span><span class="m">¯1</span><span class="o">⍳</span><span class="m">2</span><span class="o">*≢</span><span class="bp">⍵</span>    <span class="c1">⍝ All possible bit patterns up to ≢⍵</span>
    <span class="nv">idx</span> <span class="kd">←</span> <span class="o">⍸&lt;</span><span class="na">\</span><span class="nv">psum</span><span class="o">=</span><span class="nv">bitp</span><span class="o">+</span><span class="na">.</span><span class="o">×</span><span class="bp">⍵</span> <span class="c1">⍝ First index of partition sum = target</span>
    <span class="no">⍬</span><span class="o">≡</span><span class="nv">idx</span><span class="bp">:</span> <span class="no">⍬</span>               <span class="c1">⍝ If we have no 1s, there is no solution</span>
    <span class="nv">part</span> <span class="kd">←</span> <span class="nv">idx</span><span class="o">⌷</span><span class="nv">bitp</span>        <span class="c1">⍝ Partition corresponding to solution index</span>
    <span class="p">(</span><span class="nv">part</span><span class="na">/</span><span class="bp">⍵</span><span class="p">)(</span><span class="bp">⍵</span><span class="na">/⍨</span><span class="o">~</span><span class="nv">part</span><span class="p">)</span>     <span class="c1">⍝ Compress input by solution pattern and inverse</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Balance</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬───┐
│2│1 1│
└─┴───┘
</span></div></div>
</div>
<p>and on the full 20-bits:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Balance</span> <span class="m">10</span> <span class="m">81</span> <span class="m">98</span> <span class="m">27</span> <span class="m">28</span> <span class="m">5</span> <span class="m">1</span> <span class="m">46</span> <span class="m">63</span> <span class="m">99</span> <span class="m">25</span> <span class="m">39</span> <span class="m">84</span> <span class="m">87</span> <span class="m">76</span> <span class="m">85</span> <span class="m">78</span> <span class="m">64</span> <span class="m">41</span> <span class="m">93</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────────────────────┬────────────────────────────────────┐
│99 84 87 76 85 41 93│10 81 98 27 28 5 1 46 63 25 39 78 64│
└────────────────────┴────────────────────────────────────┘
</span></div></div>
</div>
<p>To a Python programmer, this approach must seem <em>incredibly</em> counter-intuitive, borderline criminally wasteful. Despite the fact that we only want the first solution (which occurs around bit pattern 1,500ish), we go through the <em>entire</em> search space. In a “loop and branch” language, we’d try each candidate pattern in turn, and break once we find the first solution.</p>
<p>But the seemingly naive APL solution is quick, even though it will process 2-3 orders of magnitude more patterns than would a scalar solution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">runtime</span> <span class="s2">&quot;Balance 10 81 98 27 28 5 1 46 63 99 25 39 84 87 76 85 78 64 41 93&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">
* Benchmarking "Balance 10 81 98 27 28 5 1 46 63 99 25 39 84 87 76 85 78 64 41 93"
┌──────────┬────┐
│          │(ms)│
├──────────┼────┤
│CPU (avg):│28  │
├──────────┼────┤
│Elapsed:  │29  │
└──────────┴────┘
</span></div></div>
</div>
<p>So what’s going on here? Well, two things. Firstly, we’re hitting the most optimal core of Dyalog APL, its handling of Boolean vectors, using only primitive functions. Secondly, APL is able to vectorise our operations, taking advantage of SIMD operations in the processor.</p>
<p>For completeness, let’s see how a scalar solution would perform. We can, for example, take a tail-call Scheme-like approach:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">BalanceScalar</span> <span class="kd">←</span> <span class="kt">{</span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">0</span>     
    <span class="nv">total</span> <span class="kd">←</span> <span class="o">+</span><span class="na">/</span><span class="bp">⍵</span>
    <span class="m">2</span><span class="o">|</span><span class="nv">total</span><span class="bp">:</span> <span class="no">⍬</span>             <span class="c1">⍝ Sum must be divisible by 2</span>
    <span class="nv">psum</span> <span class="kd">←</span> <span class="nv">total</span><span class="o">÷</span><span class="m">2</span>         <span class="c1">⍝ Our target partition sum</span>
    <span class="nv">data</span> <span class="kd">←</span> <span class="bp">⍵</span>
    <span class="nv">bitp</span> <span class="kd">←</span> <span class="o">↓⍉</span><span class="m">2</span><span class="na">∘</span><span class="o">⊥</span><span class="na">⍣</span><span class="m">¯1</span><span class="o">⍳</span><span class="m">2</span><span class="o">*≢</span><span class="bp">⍵</span>   <span class="c1">⍝ Pre-compute the bit patterns</span>
    <span class="kt">{</span>                      <span class="c1">⍝ Try one sum after the other, halt on first solution</span>
        <span class="m">0</span><span class="o">=</span><span class="bp">⍵:</span> <span class="no">⍬</span>
        <span class="nv">patt</span> <span class="kd">←</span> <span class="bp">⍵</span><span class="o">⊃</span><span class="nv">bitp</span>
        <span class="nv">psum</span><span class="o">=</span><span class="nv">patt</span><span class="o">+</span><span class="na">.</span><span class="o">×</span><span class="nv">data</span><span class="bp">:</span> <span class="p">(</span><span class="nv">patt</span><span class="na">/</span><span class="nv">data</span><span class="p">)(</span><span class="nv">data</span><span class="na">/⍨</span><span class="o">~</span><span class="nv">patt</span><span class="p">)</span> <span class="c1">⍝ Exit on first solution found</span>
        <span class="bp">∇</span><span class="m">¯1</span><span class="o">+</span><span class="bp">⍵</span>
    <span class="kt">}</span> <span class="m">¯1</span><span class="o">+≢</span><span class="nv">bitp</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">BalanceScalar</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─┐
│1 1│2│
└───┴─┘
</span></div></div>
</div>
<p>Ok, let’s compare:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;cmpx&#39;</span><span class="nf">⎕CY</span><span class="s1">&#39;dfns&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">d</span><span class="kd">←</span><span class="m">10</span> <span class="m">81</span> <span class="m">98</span> <span class="m">27</span> <span class="m">28</span> <span class="m">5</span> <span class="m">1</span> <span class="m">46</span> <span class="m">63</span> <span class="m">99</span> <span class="m">25</span> <span class="m">39</span> <span class="m">84</span> <span class="m">87</span> <span class="m">76</span> <span class="m">85</span> <span class="m">78</span> <span class="m">64</span> <span class="m">41</span> <span class="m">93</span>
<span class="nv">cmpx</span> <span class="s1">&#39;Balance d&#39;</span> <span class="s1">&#39;BalanceScalar d&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  Balance d       → 2.7E¯2 |   0% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕             
* BalanceScalar d → 4.0E¯2 | +46% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕
</span></div></div>
</div>
<p>Ouch. That difference is pretty stark.</p>
<p>Dyalog can no longer vectorise, and performance slips considerably. If you take home anything from this chapter, this is the thing to remember.</p>
<p>However, the brute-force algorithm is of course still crude, even if APL can be quick about it at the specified scale. Add a few more elements, and the unforgiving <code class="docutils literal notranslate"><span class="pre">O(2^N)</span></code> complexity would soon crush us.</p>
<p>As I mentioned earlier, there are a number of heuristic algorithms that have a much more benign complexity, at the cost of not being able to guarantee optimal solutions in all cases. One such algorithm is called the <a class="reference external" href="https://en.wikipedia.org/wiki/Largest_differencing_method">Karmarkar-Karp</a>, after its inventors, and has a complexity of <code class="docutils literal notranslate"><span class="pre">O(N</span> <span class="pre">log</span> <span class="pre">N)</span></code>, but is not guaranteed to find the optimal solution, even if such a solution does exist.</p>
<p>In short, the KK algorithm maintains a priority queue of the remaining numbers, and picks the two largest numbers in each iteration, replacing them with their difference until a single number remains – this represents the final difference between the two partitions. We can construct the corresponding partitions via backtracking. A thorough analysis of this algorithm can be found <a class="reference external" href="https://core.ac.uk/download/pdf/82710454.pdf">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">KarmarkarKarp</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">sort</span> <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍵</span><span class="sr">[;</span><span class="o">⍋</span><span class="bp">⍵</span><span class="sr">[</span><span class="m">0</span><span class="sr">;]]</span><span class="kt">}</span>
    <span class="p">(</span><span class="nv">pairs</span> <span class="nv">last</span><span class="p">)</span> <span class="kd">←</span> <span class="no">⍬</span> <span class="kt">{</span>
        <span class="m">2</span><span class="o">&gt;≢⍉</span><span class="bp">⍵:⍺</span> <span class="p">(</span><span class="m">1</span> <span class="m">0</span><span class="o">⌷</span><span class="bp">⍵</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">i</span> <span class="nv">x</span><span class="p">)(</span><span class="nv">j</span> <span class="nv">y</span><span class="p">)</span> <span class="kd">←</span> <span class="o">↓⍉</span><span class="bp">⍵</span><span class="sr">[;</span><span class="m">0</span> <span class="m">1</span><span class="sr">]</span>
        <span class="p">(</span><span class="bp">⍺</span><span class="o">,⊂</span><span class="nv">x</span> <span class="nv">y</span><span class="p">)</span><span class="bp">∇</span><span class="nv">sort</span> <span class="p">(</span><span class="m">2</span><span class="o">↓</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="p">(</span><span class="nv">i</span><span class="o">-</span><span class="nv">j</span><span class="p">)</span> <span class="nv">x</span>
    <span class="kt">}</span> <span class="nv">sort</span> <span class="o">↑</span><span class="p">(</span><span class="o">-</span><span class="bp">⍵</span><span class="p">)(</span><span class="bp">⍵</span><span class="p">)</span>
        
    <span class="nv">last</span> <span class="no">⍬</span> <span class="kt">{</span>
        <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="kd">←</span> <span class="bp">⍺</span>
        <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="bp">⍺</span>
        <span class="nv">pair</span> <span class="kd">←</span> <span class="o">⊃</span><span class="m">¯1</span><span class="o">↑</span><span class="bp">⍵</span>
        <span class="nv">a</span><span class="o">∊</span><span class="na">⍨</span><span class="o">⊃</span><span class="nv">pair</span><span class="bp">:</span> <span class="p">(</span><span class="nv">a</span> <span class="p">(</span><span class="nv">b</span><span class="o">,</span><span class="m">1</span><span class="o">⊃</span><span class="nv">pair</span><span class="p">))</span><span class="bp">∇</span><span class="m">¯1</span><span class="o">↓</span><span class="bp">⍵</span>
        <span class="p">((</span><span class="nv">a</span><span class="o">,</span><span class="m">1</span><span class="o">⊃</span><span class="nv">pair</span><span class="p">)</span> <span class="nv">b</span><span class="p">)</span><span class="bp">∇</span><span class="m">¯1</span><span class="o">↓</span><span class="bp">⍵</span>
    <span class="kt">}</span> <span class="nv">pairs</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>In our test case, the KK does return an optimal solution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">KarmarkarKarp</span> <span class="m">10</span> <span class="m">81</span> <span class="m">98</span> <span class="m">27</span> <span class="m">28</span> <span class="m">5</span> <span class="m">1</span> <span class="m">46</span> <span class="m">63</span> <span class="m">99</span> <span class="m">25</span> <span class="m">39</span> <span class="m">84</span> <span class="m">87</span> <span class="m">76</span> <span class="m">85</span> <span class="m">78</span> <span class="m">64</span> <span class="m">41</span> <span class="m">93</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────────────────────────────┬────────────────────────────┐
│41 85 99 5 93 10 63 27 64 78│1 25 28 76 81 39 46 84 87 98│
└────────────────────────────┴────────────────────────────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">cmpx</span> <span class="s1">&#39;Balance d&#39;</span> <span class="s1">&#39;KarmarkarKarp d&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  Balance d       → 3.7E¯2 |    0% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕
* KarmarkarKarp d → 1.4E¯4 | -100%                                         
</span></div></div>
</div>
<p>and, unsurprisingly, although completely scalar, it wins hands down. However, it’s still a heuristic:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Balance</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span>
<span class="nv">KarmarkarKarp</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─────┐
│7 8│4 5 6│
└───┴─────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬───┐
│4 5 7│6 8│
└─────┴───┘
</span></div></div>
</div>
<p>A thing to note in the KK implementation above: it simply sorts the array at each iteration, instead of using a heap queue. As an exercise for the interested reader, try re-implementing it using a heap. However, and for similar reasons as we saw earlier, you will probably find that APL is likely faster at sorting a simple array than the complexity cost of maintaining a more nested data structure.</p>
</div>
<div class="section" id="merge">
<h2>Merge<a class="headerlink" href="#merge" title="Permalink to this headline">¶</a></h2>
<p>Ok, we’re on a roll. Problem 6 from the same year was a spin on the old “mail merge” concept: given a template file, expand templates with values from a corresponding merge file. For example, given a template of</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Hello @firstname@,
You have been selected to test drive a new @carmake@!
</pre></div>
</div>
<p>with a merge file of</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;firstname&quot;</span><span class="p">:</span> <span class="nt">&quot;Bob&quot;</span>
    <span class="nt">&quot;carmake&quot;</span><span class="p">:</span> <span class="s2">&quot;Aston Martin&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>the final output should be</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Hello Bob,
You have been selected to test drive a new Aston Martin!
</pre></div>
</div>
<p>A literal <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> is represented by <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code> in the template, and templates with no corresponding match in the merge file should be expanded to <code class="docutils literal notranslate"><span class="pre">???</span></code>.</p>
<p>We’ll try two different solutions. For the first approach, it’s hard not to think of regexes here – replace “templates” matching a defined pattern with corresponding values.</p>
<p>Let’s look at the two data files first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">template</span> <span class="kd">←</span> <span class="s1">&#39;/Users/stefan/template.txt&#39;</span>
<span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="nv">template</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">@salutation@ @firstname@ @lastname@;
Congratulations!  You have won a @prize@ worth over £@value@!
@firstname@, please come to our office to pick up your @prize@.
Please feel free to contact us at info@@contest.com.
Your email address in our domain is @firstname@@@contest.com

</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">merge</span> <span class="kd">←</span> <span class="s1">&#39;/Users/stefan/merge1.json&#39;</span>
<span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="nv">merge</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">{
    "firstname":"Drake",
    "lastname":"Mallard",
    "prize":"yoyo",
    "value":100
}

</span></div></div>
</div>
<p>So our patterns are defined by the keys in the JSON, plus the <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code> for literal <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> and any remaining templates that have no corresponding entry in the merge file, along the lines of <code class="docutils literal notranslate"><span class="pre">&#64;[^&#64;]+&#64;</span></code>. We’ll start with reading the JSON data into a namespace and pulling out the keys and values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">mrg</span><span class="kd">←</span><span class="nf">⎕JSON</span><span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="nv">merge</span>
<span class="nv">keys</span><span class="kd">←</span><span class="nv">mrg</span><span class="na">.</span><span class="nf">⎕NL¯2</span>
<span class="nv">vals</span><span class="kd">←</span><span class="nv">mrg</span><span class="na">.</span><span class="p">(</span><span class="o">⍎</span><span class="na">¨</span><span class="c1">#.keys)</span>
<span class="o">↑</span><span class="nv">keys</span> <span class="nv">vals</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────┬────────┬─────┬─────┐
│firstname│lastname│prize│value│
├─────────┼────────┼─────┼─────┤
│Drake    │Mallard │yoyo │100  │
└─────────┴────────┴─────┴─────┘
</span></div></div>
</div>
<p>and our patterns and replacements then become:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↑</span><span class="p">((</span><span class="kt">{</span><span class="s1">&#39;@&#39;</span><span class="o">,</span><span class="p">(</span><span class="o">⍕</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="s1">&#39;@&#39;</span><span class="kt">}</span><span class="na">¨</span><span class="nv">keys</span><span class="p">)</span><span class="o">,</span> <span class="p">(</span><span class="o">⊂</span><span class="s1">&#39;@@&#39;</span><span class="p">)</span><span class="o">,</span> <span class="o">⊂</span><span class="s1">&#39;@[^@]+@&#39;</span><span class="p">)</span> <span class="p">((</span><span class="o">⍕</span><span class="na">¨</span><span class="nv">vals</span><span class="p">)</span><span class="o">,</span> <span class="p">(</span><span class="o">⊂,</span><span class="s1">&#39;@&#39;</span><span class="p">)</span><span class="o">,</span> <span class="o">⊂</span><span class="s1">&#39;???&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────┬──────────┬───────┬───────┬──┬───────┐
│@firstname@│@lastname@│@prize@│@value@│@@│@[^@]+@│
├───────────┼──────────┼───────┼───────┼──┼───────┤
│Drake      │Mallard   │yoyo   │100    │@ │???    │
└───────────┴──────────┴───────┴───────┴──┴───────┘
</span></div></div>
</div>
<p>Putting it all together we get:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Merge</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">mrg</span><span class="kd">←</span><span class="nf">⎕JSON</span><span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="bp">⍺</span>
    <span class="nv">keys</span><span class="kd">←</span><span class="nv">mrg</span><span class="na">.</span><span class="nf">⎕NL¯2</span>
    <span class="nv">vals</span><span class="kd">←</span><span class="nv">mrg</span><span class="na">.</span><span class="p">(</span><span class="o">⍎</span><span class="na">¨</span><span class="c1">#.keys)</span>
    
    <span class="p">((</span><span class="kt">{</span><span class="s1">&#39;@&#39;</span><span class="o">,</span><span class="p">(</span><span class="o">⍕</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="s1">&#39;@&#39;</span><span class="kt">}</span><span class="na">¨</span><span class="nv">keys</span><span class="p">)</span><span class="o">,</span> <span class="p">(</span><span class="o">⊂</span><span class="s1">&#39;@@&#39;</span><span class="p">)</span><span class="o">,</span> <span class="o">⊂</span><span class="s1">&#39;@[^@]+@&#39;</span><span class="p">)</span><span class="nf">⎕R</span><span class="p">((</span><span class="o">⍕</span><span class="na">¨</span><span class="nv">vals</span><span class="p">)</span><span class="o">,</span> <span class="p">(</span><span class="o">⊂,</span><span class="s1">&#39;@&#39;</span><span class="p">)</span><span class="o">,</span> <span class="o">⊂</span><span class="s1">&#39;???&#39;</span><span class="p">)</span><span class="o">⊢⊃</span><span class="nf">⎕NGET</span> <span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">merge</span> <span class="nv">Merge</span> <span class="nv">template</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">??? Drake Mallard;
Congratulations!  You have won a yoyo worth over £100!
Drake, please come to our office to pick up your yoyo.
Please feel free to contact us at info@contest.com.
Your email address in our domain is Drake@contest.com

</span></div></div>
</div>
<p>All well and good, but not very “array-oriented” now, is it? Let’s remedy that, and forget about cheaty regexes.</p>
<p>If we partition the data such that each partition begins with <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> we get this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;@&#39;</span> <span class="p">(</span><span class="o">=⊂⊢</span><span class="p">)</span> <span class="s1">&#39;aaaa @bbb@ ccc @@ @ddd@&#39;</span> <span class="c1">⍝ Partitions starting at @</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬──────┬─┬──┬────┬─┐
│@bbb│@ ccc │@│@ │@ddd│@│
└────┴──────┴─┴──┴────┴─┘
</span></div></div>
</div>
<p>in fact, let’s drop the leading <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">tmpls</span><span class="kd">←</span><span class="s1">&#39;@&#39;</span><span class="p">(</span><span class="m">1</span><span class="o">↓</span><span class="na">¨</span><span class="o">=⊂⊢</span><span class="p">)</span><span class="s1">&#39;aaaa @bbb@ ccc @@ @ddd@&#39;</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─────┬┬─┬───┬┐
│bbb│ ccc ││ │ddd││
└───┴─────┴┴─┴───┴┘
</span></div></div>
</div>
<p>What we have now is a nested vector where every other element is a template.</p>
<p>Our replacement values will again come from a namespace</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">mrg</span><span class="kd">←</span><span class="nf">⎕NS</span><span class="no">⍬</span><span class="p">)</span><span class="na">.</span><span class="p">(</span><span class="nv">bbb</span> <span class="nv">ccc</span> <span class="nv">ddd</span><span class="p">)</span> <span class="kd">←</span> <span class="s1">&#39;bees&#39;</span> <span class="s1">&#39;cees&#39;</span> <span class="s1">&#39;dees&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>and we’ll make a little helper function to look up value by key, with the added functionality to return <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> for `` and <code class="docutils literal notranslate"><span class="pre">???</span></code> for non-present keys:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">val</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="o">,</span><span class="s1">&#39;@&#39;</span>
    <span class="o">~</span><span class="p">(</span><span class="o">⊂</span><span class="bp">⍵</span><span class="p">)</span><span class="o">∊</span><span class="nv">mrg</span><span class="na">.</span><span class="nf">⎕NL¯2</span><span class="bp">:</span> <span class="s1">&#39;???&#39;</span>
    <span class="o">⍕</span><span class="nv">mrg</span><span class="o">⍎</span><span class="bp">⍵</span>
<span class="kt">}</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">val</span><span class="na">¨</span><span class="s1">&#39;bbb&#39;</span> <span class="s1">&#39;ddd&#39;</span> <span class="s1">&#39;ccc&#39;</span> <span class="s1">&#39;&#39;</span> <span class="s1">&#39;hubba&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬────┬────┬─┬───┐
│bees│dees│cees│@│???│
└────┴────┴────┴─┴───┘
</span></div></div>
</div>
<p>We can use Dyalog’s handy <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> operator to  make the replacements. Recall that the <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> operator can take a right operand function which must return a Boolean vector, which in our case should select every other element, starting with the first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">val</span><span class="na">¨@</span><span class="kt">{</span><span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span><span class="kt">}</span><span class="o">⊢</span><span class="nv">tmpls</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬─────┬─┬─┬────┬┐
│bees│ ccc │@│ │dees││
└────┴─────┴─┴─┴────┴┘
</span></div></div>
</div>
<p>Finally, we’d need to tack on anything prior to the first <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> and enlist.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Merge</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">mrg</span> <span class="kd">←</span> <span class="nf">⎕JSON</span><span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="bp">⍺</span>
    <span class="nv">templ</span> <span class="kd">←</span> <span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="bp">⍵</span>
    <span class="nv">first</span> <span class="kd">←</span> <span class="nv">templ</span><span class="o">⍳</span><span class="s1">&#39;@&#39;</span>
    <span class="nv">first</span><span class="o">&gt;≢</span><span class="nv">templ</span><span class="bp">:</span> <span class="nv">templ</span>    <span class="c1">⍝ No templates at all</span>
    <span class="nv">prefix</span> <span class="kd">←</span> <span class="nv">first</span><span class="o">↑</span><span class="nv">templ</span>
    <span class="nv">val</span> <span class="kd">←</span> <span class="kt">{</span>
        <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="o">,</span><span class="s1">&#39;@&#39;</span>
        <span class="o">~</span><span class="p">(</span><span class="o">⊂</span><span class="bp">⍵</span><span class="p">)</span><span class="o">∊</span><span class="nv">mrg</span><span class="na">.</span><span class="nf">⎕NL¯2</span><span class="bp">:</span> <span class="s1">&#39;???&#39;</span>
        <span class="o">⍕</span><span class="nv">mrg</span><span class="o">⍎</span><span class="bp">⍵</span>
    <span class="kt">}</span>
    <span class="o">∊</span><span class="nv">prefix</span><span class="o">,</span><span class="nv">val</span><span class="na">¨@</span><span class="kt">{</span><span class="m">1</span> <span class="m">0</span><span class="o">⍴</span><span class="na">⍨</span><span class="o">≢</span><span class="bp">⍵</span><span class="kt">}</span><span class="s1">&#39;@&#39;</span><span class="p">(</span><span class="m">1</span><span class="o">↓</span><span class="na">¨</span><span class="o">=⊂⊢</span><span class="p">)</span><span class="nv">templ</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">merge</span> <span class="nv">Merge</span> <span class="nv">template</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">??? Drake Mallard;
Congratulations!  You have won a yoyo worth over £100!
Drake, please come to our office to pick up your yoyo.
Please feel free to contact us at info@contest.com.
Your email address in our domain is Drake@contest.com

</span></div></div>
</div>
</div>
<div class="section" id="right-align-a-block-of-text">
<h2>Right-align a block of text<a class="headerlink" href="#right-align-a-block-of-text" title="Permalink to this headline">¶</a></h2>
<p>Let’s work through a more comprehensive problem. Here’s a tweaked version of one of the Phase 1 tasks from the <a class="reference external" href="https://www.dyalog.com/student-competition.htm">Dyalog Problem Solving Competition</a>, 2021:</p>
<p>Write a function that:</p>
<ul class="simple">
<li><p>has a right argument <code class="docutils literal notranslate"><span class="pre">T</span></code> which is a character scalar, vector or a vector of character vectors</p></li>
<li><p>has a left argument <code class="docutils literal notranslate"><span class="pre">W</span></code> which is a positive integer specifying the width of the result</p></li>
<li><p>returns a right-aligned character array of shape <code class="docutils literal notranslate"><span class="pre">((2=≡T)/≢T),W</span></code>.</p></li>
<li><p>if an element of T has length greater than <code class="docutils literal notranslate"><span class="pre">W</span></code>, truncate it after <code class="docutils literal notranslate"><span class="pre">W</span></code> characters.</p></li>
</ul>
<p>The challenge here is not resorting to ‘eaching’ the rows, or employing some creative regexing. So let’s treat this as an exercise in array-oriented problem solving.</p>
<p>We’re given a couple of examples of how the solution should behave for arrays of different ranks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="c1">⍝ 6 Align &#39;⍒&#39;</span>
<span class="s1">&#39;     ⍒&#39;</span>

<span class="c1">⍝ 10 Align &#39;Parade&#39;</span>
<span class="s1">&#39;    Parade&#39;</span>

<span class="c1">⍝ 8 Align &#39;Longer Phrase&#39; &#39;APL&#39; &#39;Parade&#39;</span>
<span class="m">3</span> <span class="m">8</span><span class="o">⍴</span><span class="s1">&#39;Longer P     APL  Parade&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">     ⍒
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">    Parade
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Longer P
     APL
  Parade
</span></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The last example above is different from the way the problem was published. For extra points, solve it as it was presented in the competition:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>3 8⍴&#39;r Phrase     APL  Parade&#39;
</pre></div>
</div>
</div>
<p>A hint is given in the problem statement on where we could start: we’re told what the shape should be of the resulting array: <code class="docutils literal notranslate"><span class="pre">((2=≡T)/≢T),W</span></code>. Given the result shape, we can try the following approach:</p>
<p>Figure out the result shape, and squeeze the data into this shape, truncating if we need to. Locate trailing spaces. Prepend a space on each line, and then replicate by the number of trailing spaces.</p>
<p>We’re given the shape. In order for this to work for character scalars, a character vector, or vector of character vectors, we need to operate on the ravel of the right argument when finding the shape:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">6</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;⍋&#39;</span>
<span class="m">10</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;Parade&#39;</span>
<span class="m">8</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;Longer Phrase&#39;</span> <span class="s1">&#39;APL&#39;</span> <span class="s1">&#39;Parade&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">6
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">10
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">3 8
</span></div></div>
</div>
<p>To fit the data into that shape, we need to <em>Mix</em> the ravel (<code class="docutils literal notranslate"><span class="pre">↑,⍵</span></code>) to increase the rank and then <em>Take</em> <code class="docutils literal notranslate"><span class="pre">⍺</span></code> elements, rank 1 (along vectors), and then reshape. Let’s explore what this means:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="s1">&#39;Parade&#39;</span>
<span class="o">⊢</span><span class="nv">sh</span> <span class="kd">←</span> <span class="m">10</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="nv">data</span> <span class="c1">⍝ Shape</span>
<span class="o">↑,</span><span class="nv">data</span>                         <span class="c1">⍝ Mix ravel (no change for a char vector)</span>
<span class="m">10</span><span class="o">↑</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢↑,</span><span class="nv">data</span>                   <span class="c1">⍝ (over)take, rank-1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">10
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Parade
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Parade    
</span></div></div>
</div>
<p>More interesting to consider is the nested vector case:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="s1">&#39;Longer Phrase&#39;</span> <span class="s1">&#39;APL&#39;</span> <span class="s1">&#39;Parade&#39;</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">sh</span> <span class="kd">←</span> <span class="m">8</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="nv">data</span> <span class="c1">⍝ Shape</span>
<span class="o">↑,</span><span class="nv">data</span>                           <span class="c1">⍝ Mix ravel</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">mat</span> <span class="kd">←</span> <span class="m">8</span><span class="o">↑</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢↑,</span><span class="nv">data</span>            <span class="c1">⍝ (over)take, rank 1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 8
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Longer Phrase
APL          
Parade       
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Longer P
APL     
Parade  
</span></div></div>
</div>
<p>So far, so array-oriented! Now we need to find trailing spaces. The equal sign makes for an excellent search function! Where are the spaces?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39; &#39;</span><span class="o">=</span><span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0 0 0 0 1 0
0 0 0 1 1 1 1 1
0 0 0 0 0 0 1 1
</span></div></div>
</div>
<p>All well and good, but we need the <em>trailing</em> spaces. A handy technique here is to <em>and-scan</em>, which is one of those APLisms that is so obvious (once someone pointed it out to you, you found it on APLCart, or you’re a genius). It keeps all 1s from the beginning, and zeros everything  after the first zero:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">∧</span><span class="na">\</span><span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1 1 0 0 0 0 0 0 0
</span></div></div>
</div>
<p>but that looks at <em>leading</em> not trailing spaces, so we need to flip, and-scan, flip back:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⌽∧</span><span class="na">\</span><span class="o">⌽</span><span class="s1">&#39; &#39;</span><span class="o">=</span><span class="nv">mat</span>   <span class="c1">⍝ We&#39;re keeping on arraying</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0 0 0 0 0 0
0 0 0 1 1 1 1 1
0 0 0 0 0 0 1 1
</span></div></div>
</div>
<p>Conceptually, we’ll add extra spaces at the beginning of each line, the same number as any trailing spaces. In practice, we’ll add a single space, and then use a replication vector to clone it the relevant number of times. Recall:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">data</span> <span class="kd">←</span> <span class="s1">&#39; ABCDEFGHIK&#39;</span>         <span class="c1">⍝ Note: leading space</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">repl</span> <span class="kd">←</span> <span class="m">5</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="c1">⍝ Five spaces, one of everything else</span>
<span class="nv">repl</span><span class="na">/</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> ABCDEFGHIK
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">5 1 1 1 1 1 1 1 1 1 1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">     ABCDEFGHIK
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">trailing</span> <span class="kd">←</span> <span class="o">⌽∧</span><span class="na">\</span><span class="o">⌽</span><span class="s1">&#39; &#39;</span><span class="o">=</span><span class="nv">mat</span>     <span class="c1">⍝ Find trailing spaces, as per above</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">spaced</span> <span class="kd">←</span> <span class="s1">&#39; &#39;</span><span class="o">,</span><span class="nv">mat</span>       <span class="c1">⍝ Add a space as the first char of each row</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">keepers</span> <span class="kd">←</span> <span class="o">~</span><span class="nv">trailing</span>    <span class="c1">⍝ Everything not a trailing space</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">padding</span> <span class="kd">←</span> <span class="o">+</span><span class="na">/</span><span class="nv">trailing</span>   <span class="c1">⍝ Amount of leading padding to be inserted per row</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">repl</span> <span class="kd">←</span> <span class="nv">padding</span><span class="o">,</span><span class="nv">keepers</span> <span class="c1">⍝ Number of replications per character</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> Longer P
 APL     
 Parade  
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1 1 1 1 1 1 1
1 1 1 0 0 0 0 0
1 1 1 1 1 1 0 0
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0 5 2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 1 1 1 1 1 1 1
5 1 1 1 0 0 0 0 0
2 1 1 1 1 1 1 0 0
</span></div></div>
</div>
<p>Now what remains is to do the replication and ensure that everything gets the shape it should have.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">repl</span><span class="na">/⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">spaced</span> <span class="c1">⍝ Replicate along vectors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Longer P
     APL
  Parade
</span></div></div>
</div>
<p>That’s it! Putting it all together, we get the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Align</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">shape</span> <span class="kd">←</span> <span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span>  <span class="c1">⍝ Shape, as specified</span>
    <span class="nv">mat</span> <span class="kd">←</span> <span class="bp">⍺</span><span class="o">↑</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢↑,</span><span class="bp">⍵</span>          <span class="c1">⍝ Truncate rank 1</span>
    <span class="nv">trailing</span> <span class="kd">←</span> <span class="o">⌽∧</span><span class="na">\</span><span class="o">⌽</span><span class="s1">&#39; &#39;</span><span class="o">=</span><span class="nv">mat</span>  <span class="c1">⍝ Find trailing spaces</span>
    <span class="nv">spaced</span> <span class="kd">←</span> <span class="s1">&#39; &#39;</span><span class="o">,</span><span class="nv">mat</span>        <span class="c1">⍝ Add a space as the first char of each row</span>
    <span class="nv">keepers</span> <span class="kd">←</span> <span class="o">~</span><span class="nv">trailing</span>     <span class="c1">⍝ Everything not a trailing space</span>
    <span class="nv">padding</span> <span class="kd">←</span> <span class="o">+</span><span class="na">/</span><span class="nv">trailing</span>    <span class="c1">⍝ Amount of leading padding to be inserted per row</span>
    <span class="nv">repl</span> <span class="kd">←</span> <span class="nv">padding</span><span class="o">,</span><span class="nv">keepers</span>  <span class="c1">⍝ Number of replications per character</span>
    <span class="nv">repl</span><span class="na">/⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">spaced</span>          <span class="c1">⍝ Replicate rank 1</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">6</span> <span class="nv">Align</span> <span class="s1">&#39;⍋&#39;</span>
<span class="m">10</span> <span class="nv">Align</span> <span class="s1">&#39;Parade&#39;</span>
<span class="m">8</span> <span class="nv">Align</span> <span class="s1">&#39;Longer Phrase&#39;</span> <span class="s1">&#39;APL&#39;</span> <span class="s1">&#39;Parade&#39;</span>
<span class="m">8</span> <span class="nv">Align</span> <span class="s1">&#39;K&#39;</span> <span class="s1">&#39;E&#39;</span> <span class="s1">&#39;Iverson&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">     ⍋
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">    Parade
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Longer P
     APL
  Parade
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">       K
       E
 Iverson
</span></div></div>
</div>
<p>Pretty cool, eh? As an exercise, now shrink that to a one-liner suitable for submitting as a competition entry.</p>
<p>Shall we do one more?</p>
</div>
<div class="section" id="fizzbuzz">
<h2>FizzBuzz<a class="headerlink" href="#fizzbuzz" title="Permalink to this headline">¶</a></h2>
<p>Adám Brudzewski used the classic FizzBuzz problem – the darling of technical interviewers everywhere – as an illustration in one of his Cultivation lessons, <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-39-array-programming-techniques">Lesson 39 - Array programming techniques</a>.</p>
<p>Wikipedia has the following to say about <a class="reference external" href="https://en.wikipedia.org/wiki/Fizz_buzz">FizzBuzz</a>:</p>
<blockquote>
<div><p>Fizz buzz is a group word game for children to teach them about division. Players take turns to count incrementally, replacing any number divisible by three with the word “fizz”, and any number divisible by five with the word “buzz”.</p>
</div></blockquote>
<p>but most programmers will be familiar with it as a task frequently set as a technical challenge in job interviews. In fact, we’ve seen an APL version of this already. Right at the beginning it was used as an illustration of a <em>trad function</em>.</p>
<p>Here’s a “loopy” version as an APL dfn, for context:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="o">∊</span><span class="p">(</span><span class="m">3</span><span class="o">↑</span><span class="p">(</span><span class="m">0</span><span class="o">=</span><span class="m">3</span> <span class="m">5</span><span class="o">|</span><span class="bp">⍵</span><span class="p">)</span><span class="o">∪</span><span class="m">1</span><span class="p">)</span><span class="na">/</span><span class="s1">&#39;Fizz&#39;</span> <span class="s1">&#39;Buzz&#39;</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">¨</span><span class="m">1</span><span class="o">+⍳</span><span class="m">16</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬─┬────┬─┬────┬────┬─┬─┬────┬────┬──┬────┬──┬──┬────────┬──┐
│1│2│Fizz│4│Buzz│Fizz│7│8│Fizz│Buzz│11│Fizz│13│14│FizzBuzz│16│
└─┴─┴────┴─┴────┴────┴─┴─┴────┴────┴──┴────┴──┴──┴────────┴──┘
</span></div></div>
</div>
<p>Can we do without the <code class="docutils literal notranslate"><span class="pre">each</span></code>, given what we’ve already learnt? Let’s ponder what an array solution might look like.</p>
<p>Let’s begin by creating a Boolean mask showing the positions of the numbers which are divisible by 3 (the “fizzes”) and those divisible by 5 (the “buzzes”). We can do that as an outer product:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="m">1</span><span class="o">+⍳</span><span class="m">16</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">fizzbuzz</span> <span class="kd">←</span> <span class="m">0</span><span class="o">=</span><span class="m">3</span> <span class="m">5</span><span class="na">∘.</span><span class="o">|</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0
0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0
</span></div></div>
</div>
<p>So the columns that have only zeros in them represent the “numbers” - the “non-fizzbuzzy” bits. Let’s add a new row to our matrix to make this clear:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">mat</span> <span class="kd">←</span> <span class="p">(</span><span class="o">⍱</span><span class="na">⌿</span><span class="o">⍪⊢</span><span class="p">)</span><span class="nv">fizzbuzz</span>  <span class="c1">⍝ Tacit for {(⍱⌿⍵)⍪⍵} -- column-wise logical NOR as the new first row</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1 0 1 0 0 1 1 0 0 1 0 1 1 0 1
0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0
0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0
</span></div></div>
</div>
<p>If we now multiply the first row by our input numbers, we have the numbers that aren’t “fizzbuzzy”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">mat</span><span class="o">×</span><span class="na">@</span><span class="m">0</span><span class="na">⍨</span><span class="kd">←</span><span class="nv">data</span> <span class="c1">⍝ Check that out! Modified assignment</span>
<span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 0 4 0 0 7 8 0 0 11 0 13 14 0 16
0 0 1 0 0 1 0 0 1 0  0 1  0  0 1  0
0 0 0 0 1 0 0 0 0 1  0 0  0  0 1  0
</span></div></div>
</div>
<p>Now we substitute all 1s for “fizz” in the second row, and for “buzz” in the third row:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">mat</span><span class="sr">[</span><span class="o">↓</span><span class="m">1</span><span class="o">,</span><span class="na">⍤</span><span class="m">0</span> <span class="m">0</span><span class="o">⊢⍸</span><span class="m">1</span><span class="o">⌷</span><span class="nv">mat</span><span class="sr">]</span><span class="kd">←</span><span class="o">⊂</span><span class="s1">&#39;fizz&#39;</span>
<span class="nv">mat</span><span class="sr">[</span><span class="o">↓</span><span class="m">2</span><span class="o">,</span><span class="na">⍤</span><span class="m">0</span> <span class="m">0</span><span class="o">⊢⍸</span><span class="m">2</span><span class="o">⌷</span><span class="nv">mat</span><span class="sr">]</span><span class="kd">←</span><span class="o">⊂</span><span class="s1">&#39;buzz&#39;</span>
<span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬─┬────┬─┬────┬────┬─┬─┬────┬────┬──┬────┬──┬──┬────┬──┐
│1│2│0   │4│0   │0   │7│8│0   │0   │11│0   │13│14│0   │16│
├─┼─┼────┼─┼────┼────┼─┼─┼────┼────┼──┼────┼──┼──┼────┼──┤
│0│0│fizz│0│0   │fizz│0│0│fizz│0   │0 │fizz│0 │0 │fizz│0 │
├─┼─┼────┼─┼────┼────┼─┼─┼────┼────┼──┼────┼──┼──┼────┼──┤
│0│0│0   │0│buzz│0   │0│0│0   │buzz│0 │0   │0 │0 │buzz│0 │
└─┴─┴────┴─┴────┴────┴─┴─┴────┴────┴──┴────┴──┴──┴────┴──┘
</span></div></div>
</div>
<p>Merge columns, remove zeros:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="o">~</span><span class="na">⍨¨</span><span class="o">,</span><span class="na">⌿</span><span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬─┬────┬─┬────┬────┬─┬─┬────┬────┬──┬────┬──┬──┬────────┬──┐
│1│2│fizz│4│buzz│fizz│7│8│fizz│buzz│11│fizz│13│14│fizzbuzz│16│
└─┴─┴────┴─┴────┴────┴─┴─┴────┴────┴──┴────┴──┴──┴────────┴──┘
</span></div></div>
</div>
<p>Nice. So in this case, is the longer array solution better than the clever loopy one we showed in the beginning? Well, the intention was to demonstrate how to approach solutions in a data-parallel way, but the problem was of a magnitude that probably made this unnecessary. But practice makes perfect.</p>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "dyalog-kernel"
        },
        kernelOptions: {
            kernelName: "dyalog-kernel",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'dyalog-kernel'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'> 
    <a class='left-prev' id="prev-link" href="errors.html" title="previous page">
        <i class="fas fa-angle-left"></i>
        <div class="prev-next-info">
            <p class="prev-next-subtitle">previous</p>
            <p class="prev-next-title">Error handling</p>
        </div>
    </a>
    <a class='right-next' id="next-link" href="namespaces.html" title="next page">
    <div class="prev-next-info">
        <p class="prev-next-subtitle">next</p>
        <p class="prev-next-title">Namespaces <code class="docutils literal notranslate"><span class="pre">⎕NS</span></code></p>
    </div>
    <i class="fas fa-angle-right"></i>
    </a>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Stefan Kruger, Computational Array and Magic<br/>
        
          <div class="extra_footer">
            <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
</a></p>
<p>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p>

          </div>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>