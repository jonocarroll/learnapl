
<!DOCTYPE html>

<html>
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Learning APL</title>
    
  <link href="_static/css/theme.css" rel="stylesheet">
  <link href="_static/css/index.ff1ffe594081f20da1ef19478df9384b.css" rel="stylesheet">

    
  <link rel="stylesheet"
    href="_static/vendor/fontawesome/5.13.0/css/all.min.css">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-solid-900.woff2">
  <link rel="preload" as="font" type="font/woff2" crossorigin
    href="_static/vendor/fontawesome/5.13.0/webfonts/fa-brands-400.woff2">

    
      

    
    <link rel="stylesheet" type="text/css" href="_static/pygments.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-book-theme.css?digest=c3fdc42140077d1ad13ad2f1588a4309" />
    <link rel="stylesheet" type="text/css" href="_static/togglebutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/copybutton.css" />
    <link rel="stylesheet" type="text/css" href="_static/mystnb.css" />
    <link rel="stylesheet" type="text/css" href="_static/sphinx-thebe.css" />
    <link rel="stylesheet" type="text/css" href="_static/custom.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-main.c949a650a448cc0ae9fd3441c0e17fb0.css" />
    <link rel="stylesheet" type="text/css" href="_static/panels-variables.06eb56fa6e07937060861dad626602ad.css" />
    
  <link rel="preload" as="script" href="_static/js/index.be7d3bbb2ef33a8344ce.js">

    <script data-url_root="./" id="documentation_options" src="_static/documentation_options.js"></script>
    <script src="_static/jquery.js"></script>
    <script src="_static/underscore.js"></script>
    <script src="_static/doctools.js"></script>
    <script src="_static/togglebutton.js"></script>
    <script src="_static/clipboard.min.js"></script>
    <script src="_static/copybutton.js"></script>
    <script>var togglebuttonSelector = '.toggle, .admonition.dropdown, .tag_hide_input div.cell_input, .tag_hide-input div.cell_input, .tag_hide_output div.cell_output, .tag_hide-output div.cell_output, .tag_hide_cell.cell, .tag_hide-cell.cell';</script>
    <script src="_static/sphinx-book-theme.12a9622fbb08dcb3a2a40b2c02b83a57.js"></script>
    <script async="async" src="https://unpkg.com/thebe@0.5.1/lib/index.js"></script>
    <script>
        const thebe_selector = ".thebe"
        const thebe_selector_input = "pre"
        const thebe_selector_output = ".output"
    </script>
    <script async="async" src="_static/sphinx-thebe.js"></script>
    <link rel="shortcut icon" href="_static/favicon.ico"/>
    <link rel="index" title="Index" href="genindex.html" />
    <link rel="search" title="Search" href="search.html" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <meta name="docsearch:language" content="None">
    

    <!-- Google Analytics -->
    
  </head>
  <body data-spy="scroll" data-target="#bd-toc-nav" data-offset="80">
    
    <div class="container-fluid" id="banner"></div>

    

    <div class="container-xl">
      <div class="row">
          
<div class="col-12 col-md-2 bd-sidebar site-navigation show single-page" id="site-navigation">
    
</div>


          


          
<main class="col py-md-3 pl-md-4 bd-content overflow-auto" role="main">
    
    <div class="topbar container-xl fixed-top">
    <div class="topbar-contents row">
        <div class="col-12 col-md-3 bd-topbar-whitespace site-navigation show"></div>
        <div class="col pl-md-4 topbar-main">
            
            
            <!-- Source interaction buttons -->

<div class="dropdown-buttons-trigger">
    <button id="dropdown-buttons-trigger" class="btn btn-secondary topbarbtn"
        aria-label="Connect with source repository"><i class="fab fa-github"></i></button>
    <div class="dropdown-buttons sourcebuttons">
        <a class="repository-button"
            href="https://github.com/xpqz/learnapl"><button type="button" class="btn btn-secondary topbarbtn"
                data-toggle="tooltip" data-placement="left" title="Source repository"><i
                    class="fab fa-github"></i>repository</button></a>
        <a class="issues-button"
            href="https://github.com/xpqz/learnapl/issues/new?title=Issue%20on%20page%20%2Fintro.html&body=Your%20issue%20content%20here."><button
                type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip" data-placement="left"
                title="Open an issue"><i class="fas fa-lightbulb"></i>open issue</button></a>
        
    </div>
</div>

            <!-- Full screen (wrap in <a> to have style consistency -->

<a class="full-screen-button"><button type="button" class="btn btn-secondary topbarbtn" data-toggle="tooltip"
        data-placement="bottom" onclick="toggleFullScreen()" aria-label="Fullscreen mode"
        title="Fullscreen mode"><i
            class="fas fa-expand"></i></button></a>

            <!-- Launch buttons -->

        </div>

        <!-- Table of contents -->
        <div class="d-none d-md-block col-md-2 bd-toc show">
            
            <div class="tocsection onthispage pt-5 pb-3">
                <i class="fas fa-list"></i> Contents
            </div>
            <nav id="bd-toc-nav" aria-label="Page">
                <ul class="visible nav section-nav flex-column">
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-array">
   It’s arrays all the way down
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-indexing">
   Indexing
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-manip">
   Glyphiary
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-functions">
   Direct functions and operators
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-iteration">
   Iteration
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-key">
   The Key operator:
   <code class="docutils literal notranslate">
    <span class="pre">
     ⌸
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-at">
   The At operator:
   <code class="docutils literal notranslate">
    <span class="pre">
     @
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-rank">
   The Rank/Atop operator:
   <code class="docutils literal notranslate">
    <span class="pre">
     ⍤
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-stencil">
   The Stencil operator:
   <code class="docutils literal notranslate">
    <span class="pre">
     ⌺
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-over">
   The Över operator:
   <code class="docutils literal notranslate">
    <span class="pre">
     ⍥
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-dyadictrn">
   Dyadic transpose:
   <code class="docutils literal notranslate">
    <span class="pre">
     A⍉B
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-decode">
   Encode decode:
   <code class="docutils literal notranslate">
    <span class="pre">
     ⊤⊥
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-products">
   Products
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-tacit">
   Trainspotting
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-find">
   Finding things
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-cookbook1">
   Partitions
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-errors">
   Error handling
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-aplway">
   The APL Way
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-namespaces">
   Namespaces
   <code class="docutils literal notranslate">
    <span class="pre">
     ⎕NS
    </span>
   </code>
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-io">
   Dealing with real data
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-http">
   HttpCommand
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-dfnsws">
   The dfns workspace
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-testing">
   Testing
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-workflow">
   A Dyalog workflow. Or two.
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-next">
   What now?
  </a>
 </li>
 <li class="toctree-l1 toc-h1 nav-item toc-entry">
  <a class="reference internal nav-link" href="intro.html#document-tldr">
   Too long; didn’t read
  </a>
 </li>
</ul>

            </nav>
        </div>
    </div>
</div>
    <div id="main-content" class="row">
        <div class="col-12 col-md-9 pl-md-3 pr-md-0">
        
              <div>
                
  <div class="tex2jax_ignore mathjax_ignore section" id="introduction">
<h1>Introduction<a class="headerlink" href="#introduction" title="Permalink to this headline">¶</a></h1>
<blockquote>
<div><p>A language that doesn’t affect the way you think about programming is not worth knowing.
–<em>Alan Perlis</em></p>
</div></blockquote>
<div class="section" id="who-is-this-for">
<h2>Who is this for?<a class="headerlink" href="#who-is-this-for" title="Permalink to this headline">¶</a></h2>
<p>I wrote this to be the book I would have wanted to read when I started to learn APL. An introduction to APL for an experienced practitioner from a different programming language or two. We all learn in different ways, and I prefer the fundamental concepts laid bare first, and then learn by example.</p>
<p>I came to APL after discovering a file of <a class="reference external" href="https://github.com/KxSystems/kdb/blob/master/ad.k">solutions</a> to the <a class="reference external" href="https://adventofcode.com/">Advent of Code</a> 2015 challenge in <a class="reference external" href="https://en.wikipedia.org/wiki/K_(programming_language)">K</a>, an APL derivative. That’s around 100 lines of actual code, and whilst I didn’t understand any of it, I kept looking at it, trying to figure out which of the 50 problems (well, 49) this was a solution to. Each of my Python solutions typically ran to 50-100 lines+ for the bulk of the problems.</p>
<p>Turns out it was the whole lot. That blew my mind.</p>
</div>
<div class="section" id="what-is-apl">
<h2>What is APL?<a class="headerlink" href="#what-is-apl" title="Permalink to this headline">¶</a></h2>
<p>APL is an <a class="reference external" href="https://en.wikipedia.org/wiki/Array_programming">array language</a>, and one of the oldest programming languages still in use today, next to <a class="reference external" href="https://fortran-lang.org/">FORTRAN</a>, <a class="reference external" href="https://lisp-lang.org/">Lisp</a> and <a class="reference external" href="https://en.wikipedia.org/wiki/COBOL">COBOL</a>. APL uses its own curious-looking symbols, like <code class="docutils literal notranslate"><span class="pre">⍎⌽⍕⌈*○≡⍬</span></code>, rather than reserved words written out in English like most other languages, like <a class="reference external" href="https://en.wikipedia.org/wiki/C_(programming_language)">C</a> or <a class="reference external" href="https://www.python.org/">Python</a>. As a language, APL sits at a very high level of abstraction, making it well suited to ultra-concise formulations of algorithms.</p>
<p>APL is a language that time is only now beginning to catch up with. Modern processors sport dedicated vector-oriented instructions and APL presents a high degree of mechanical sympathy ideally suited to <a class="reference external" href="https://en.wikipedia.org/wiki/SIMD">SIMD instructions</a> and by often being completely branchless in nature. APL, and its more punk rock little sister, K, really <em>fly</em>. APL can offer unprecedented programmer efficiency, as well as all-out execution speed.</p>
<p>But isn’t <a class="reference external" href="https://www.sacrideo.us/is-apl-dead/">APL dead</a>? APL is alive and well.</p>
</div>
<div class="section" id="why-should-i-learn-apl">
<h2>Why should I learn APL?<a class="headerlink" href="#why-should-i-learn-apl" title="Permalink to this headline">¶</a></h2>
<p>You will have your own motivations for wanting to learn APL. If you’re searching for the hottest thing on the market right now, to land a job at a <a class="reference external" href="https://www.investopedia.com/terms/f/faang-stocks.asp">FAANG</a> or pad your resumé with the most marketable skills, there are many other programming languages that will offer a better return: <a class="reference external" href="https://golang.org/">Go</a>, <a class="reference external" href="https://docs.oracle.com/javase/7/docs/technotes/guides/language/">Java</a>, <a class="reference external" href="https://www.rust-lang.org/">Rust</a>… APL doesn’t make a show in the <a class="reference external" href="https://www.tiobe.com/tiobe-index/">TIOBE index</a> in the top 100 “most popular” programming languages. Apparently, COBOL, <a class="reference external" href="https://el.media.mit.edu/logo-foundation/what_is_logo/logo_programming.html">Logo</a> and <a class="reference external" href="https://en.wikipedia.org/wiki/AWK">AWK</a> are all more “popular” than APL, at the time of writing. That’s not to say there aren’t extremely well-paid jobs around for engineers with skills in the “Iverson-family” languages (<a class="reference external" href="https://www.dyalog.com">APL</a>, <a class="reference external" href="https://www.jsoftware.com/#/">J</a>, <a class="reference external" href="https://shakti.sh/">K</a>, <a class="reference external" href="https://code.kx.com/q/learn/startingkdb/language/">Q</a> etc), especially in finance. There are.</p>
<p>However, learning APL will reward you in other ways. Perhaps the old trope about “expanding your mind” is tired, but if your background is “C-like” – C, <a class="reference external" href="https://www.cplusplus.com/">C++</a>, Java, Python etc – you will be exposed to a new way of solving problems. In fact, learning new programming languages that come from a different paradigm is a force multiplier for your brain.</p>
<p>Talking about Lisp, but equally applicable to APL, <a class="reference external" href="http://www.catb.org/~esr/">Eric S. Raymond</a> says in his essay <a class="reference external" href="http://www.catb.org/~esr/faqs/hacker-howto.html">How to become a hacker</a>:</p>
<blockquote>
<div><p>Lisp is worth learning for a different reason — the profound enlightenment experience you will have when you finally get it. That experience will make you a better programmer for the rest of your days, even if you never actually use Lisp itself a lot.</p>
</div></blockquote>
<p>On the topic of Lisp, one of my <a class="reference external" href="https://xkcd.com/297/">favorite xkcd strips</a> talks about Lisp’s parentheses as ‘elegant weapons for a more civilized age’, paraphrasing <a class="reference external" href="https://www.youtube.com/watch?v=7hb8AYnRb-4">Star Wars</a>. It could also have been said about APL.</p>
<p><img alt="lisp" src="https://imgs.xkcd.com/comics/lisp_cycles.png" /></p>
<p>APL was conceived as a <em>notation for thought</em>. It actually took years before it even had an actual implementation as a programming language. APL is a very natural way to express algorithms. <a class="reference external" href="https://en.wikipedia.org/wiki/Kenneth_E._Iverson">Ken Iverson</a>, the creator of APL, was awarded the <a class="reference external" href="https://amturing.acm.org/award_winners/iverson_9147499.cfm">ACM Turing Award</a> in 1979 for his work on APL, and his accompanying paper, <a class="reference external" href="https://dl.acm.org/doi/pdf/10.1145/358896.358899">Notation as a Tool of Thought</a> is somewhat of a computer science milestone. <a class="reference external" href="https://www.dyalog.com">Dyalog</a>, a leading commercial APL solutions provider, make a reference to this in their corporate tag-line: “The Tool of Thought for Software Solutions”.</p>
<p>If you persist, you may discover an added bonus: code you write in <em>other</em> languages suddenly becomes more concise and efficient, too.</p>
</div>
<div class="section" id="but-it-s-unreadable">
<h2>…but it’s unreadable!<a class="headerlink" href="#but-it-s-unreadable" title="Permalink to this headline">¶</a></h2>
<p>Every time APL gets a mention on <a class="reference external" href="https://hn.algolia.com/?dateRange=all&amp;page=0&amp;prefix=false&amp;query=apl&amp;sort=byDate&amp;type=story">Hacker News</a> (it happens regularly), someone chirps up in the comments that “APL is unreadable”, so let’s deal with that upfront.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">crt</span><span class="kd">←</span><span class="kt">{</span><span class="nv">m</span><span class="o">|</span><span class="bp">⍵</span><span class="o">+</span><span class="na">.</span><span class="o">×</span><span class="bp">⍺</span><span class="p">(</span><span class="o">⊣×⊢|</span><span class="na">∘</span><span class="o">⊃</span><span class="kt">{</span><span class="m">0</span><span class="o">=</span><span class="bp">⍵:</span><span class="m">1</span> <span class="m">0</span> <span class="p">⋄</span> <span class="p">(</span><span class="bp">⍵∇⍵</span><span class="o">|</span><span class="bp">⍺</span><span class="p">)</span><span class="o">+</span><span class="na">.</span><span class="o">×</span><span class="m">0</span> <span class="m">1</span><span class="o">,⍪</span><span class="m">1</span><span class="o">,-⌊</span><span class="bp">⍺</span><span class="o">÷</span><span class="bp">⍵</span><span class="kt">}</span><span class="p">)</span><span class="na">¨⍨</span><span class="bp">⍺</span><span class="o">÷</span><span class="na">⍨</span><span class="nv">m</span><span class="kd">←</span><span class="o">×</span><span class="na">/</span><span class="bp">⍺</span><span class="kt">}</span> <span class="c1">⍝ From APL Cart</span>
</pre></div>
</div>
</div>
</div>
<p>There it is – perfectly readable: squiggle, squiggle, greek letter, weird symbol….</p>
<p>The key is that readability is in the eye of the beholder. To an APL programmer, the above implementation of the <a class="reference external" href="https://en.wikipedia.org/wiki/Chinese_remainder_theorem">Chinese Remainder Theorem</a> is perfectly readable. Claiming that something is unreadable because <em>you</em> can’t read it is intellectually dishonest. I don’t speak, or indeed read, Japanese, but that doesn’t make Japanese in any way unreadable. As master haiku smith, Bashō (松尾 金作), exclaimed:</p>
<p><center>
夏草や　兵どもが　夢の跡
</center></p>
<p>The summer grasses. // All that remains // Of warriors’ dreams.</p>
<p>What is a fairer observation is that APL <em>doesn’t look anything like</em> the other programming languages you know, and yes, learning APL sure presents a different kind of challenge. If you’re a seasoned (say) Python programmer, and you decide to pick up <a class="reference external" href="https://www.ruby-lang.org/en/">Ruby</a>, you can reasonably expect to follow code written by others from day 1, and learn enough syntax within a day or two to write code yourself. Sure, it takes a bit longer to find your way around the standard library and learn how to write idiomatic Ruby, but still. If you’ve learned a few languages like that, picking up another represents known and quantifiable effort.</p>
<p>Let’s be honest: there <em>will</em> be more initial friction when learning APL – for starters, your keyboard doesn’t even have the squiggly symbols! Having said that, APL is a <em>tiny</em> language – there is negligible amounts of syntax to pick up, and believe it or not, actually quite easy to learn at a superficial level, once you get past the practical barriers.</p>
<p>What takes longer is to grasp the <a class="reference external" href="https://www.youtube.com/watch?v=myoK22rq1jk">APL <em>way</em></a> – how to wield it idiomatically, if you like. Learning how to solve problems the data-parallel way, no loops, no branching, is the key to writing APL that rocks.</p>
<p>Once you get used to it, APL is <em>more</em> readable than more verbose languages [ <em>citation needed</em> ]. It strips away all the fluff, leaving only the algorithmic intent. <a class="reference external" href="https://beyondloom.com/about/index.html">John Earnest</a>, creator of <a class="reference external" href="http://johnearnest.github.io/ok/index.html">oK</a>, wrote a humorous <a class="reference external" href="http://beyondloom.com/blog/denial.html">blog post</a> on the topic, and <a class="reference external" href="https://www.sacrideo.us/">Aaron Hsu</a>’s presentation on <a class="reference external" href="https://www.sacrideo.us/apl-style-patterns-and-anti-patterns-in-apl/">APL patterns and anti-patterns</a> make some of the same points in a more serious vein.</p>
<p>The last example from John Earnest’s blog post poses the hypothetical question – which is more readable, the JavaScript</p>
<div class="highlight-js notranslate"><div class="highlight"><pre><span></span><span class="kd">let</span> <span class="nx">max</span> <span class="o">=</span> <span class="nx">list</span><span class="p">[</span><span class="mf">0</span><span class="p">];</span>
<span class="k">for</span> <span class="p">(</span><span class="kd">let</span> <span class="nx">i</span><span class="o">=</span><span class="mf">0</span><span class="p">;</span> <span class="nx">i</span><span class="o">&lt;</span><span class="nx">list</span><span class="p">.</span><span class="nx">length</span><span class="p">;</span> <span class="nx">i</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
    <span class="nx">max</span> <span class="o">=</span> <span class="nb">Math</span><span class="p">.</span><span class="nx">max</span><span class="p">(</span><span class="nx">list</span><span class="p">[</span><span class="nx">i</span><span class="p">],</span> <span class="nx">max</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>
</div>
<p>or the APL (although John used the corresponding K version)</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="o">⌈</span><span class="na">/</span>
</pre></div>
</div>
</div>
<div class="section" id="don-t-i-need-a-lot-of-mathematics">
<h2>Don’t I need a lot of mathematics?<a class="headerlink" href="#don-t-i-need-a-lot-of-mathematics" title="Permalink to this headline">¶</a></h2>
<p>No, not really, no.</p>
<p>Whilst APL can be traced back to Iverson’s attempts at fixing some of the shortcomings of traditional mathematical notation, you don’t have to be a math-wiz to understand, or benefit from, APL. If you’re familiar with sums and products, or if you know another programming language, that’s all you need. If you <em>do</em> have a background in maths, especially in linear algebra, you’ll no doubt recognize some concepts along the way.</p>
</div>
<div class="section" id="a-note-on-our-apl-subset">
<h2>A note on our APL subset<a class="headerlink" href="#a-note-on-our-apl-subset" title="Permalink to this headline">¶</a></h2>
<p>Dyalog’s APL dialect, which we’ll chiefly work with here, has been around for a long time, and carries with it a lot of history in the shape of backwards compatibility. APL has also evolved a lot over the years. Dyalog’s APL is really two rather different languages rolled into one: <em>traditional</em> style, which is procedural, and the newer <em>dfn</em> (pronouced <em>DEE-fun</em>) style, which is functional(ish, but let’s not quibble). For the purposes of this exercise, we’re going to pretend that the traditional style doesn’t exist.</p>
<p>When we claim that there are no if-statements or loops in APL, how come one can write</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="bp">∇</span> <span class="nv">FizzBuzz</span> <span class="nv">end</span><span class="sr">;</span><span class="nv">i</span>
<span class="bp">:</span><span class="nv">For</span> <span class="nv">i</span> <span class="bp">:</span><span class="nv">In</span> <span class="o">⍳</span><span class="nv">end</span>
    <span class="bp">:</span><span class="nv">If</span> <span class="m">0</span><span class="o">=</span><span class="m">15</span><span class="o">|</span><span class="nv">i</span>
        <span class="vg">⎕</span><span class="kd">←</span><span class="s1">&#39;FizzBuzz&#39;</span>
    <span class="bp">:</span><span class="nv">ElseIf</span> <span class="m">0</span><span class="o">=</span><span class="m">3</span><span class="o">|</span><span class="nv">i</span>
        <span class="vg">⎕</span><span class="kd">←</span><span class="s1">&#39;Fizz&#39;</span>
    <span class="bp">:</span><span class="nv">ElseIf</span> <span class="m">0</span><span class="o">=</span><span class="m">5</span><span class="o">|</span><span class="nv">i</span>
        <span class="vg">⎕</span><span class="kd">←</span><span class="s1">&#39;Buzz&#39;</span>
    <span class="bp">:</span><span class="nv">Else</span>
        <span class="vg">⎕</span><span class="kd">←</span><span class="nv">i</span>
    <span class="bp">:</span><span class="nv">EndIf</span>
<span class="bp">:</span><span class="nv">EndFor</span>
<span class="bp">∇</span>
</pre></div>
</div>
</div>
</div>
<p>which certainly looks both iffy and loopy – and dare I say even moderately readable, almost <a class="reference external" href="https://en.wikipedia.org/wiki/Pascal_(programming_language)">Pascal</a>-chic? This is an example of an APL trad-function, which we from now onwards will pretend doesn’t exist. This isn’t a value judgment so much as a practical one in the context of this book. We will not cover the traditional style, nor Dyalog’s object orientation extensions, and for simplicity’s sake, when we from now on talk about APL, take that to mean “our subset of APL”.</p>
<p>As an historical aside, the “newer” <a class="reference external" href="http://archive.vector.org.uk/art10007770">dfn style</a> first appeared in Dyalog 8.1, from early 1997, according to <a class="reference external" href="https://en.wikipedia.org/wiki/John_M._Scholes">John Scholes</a>. So not <em>that</em> new.</p>
<div class="section" id="not-covered">
<h3>Not covered<a class="headerlink" href="#not-covered" title="Permalink to this headline">¶</a></h3>
<p>Specifically, we’re not going to cover tradfns, OO, inverses, the trigonometric functions, complex numbers, variant, I-beams, spawn, threads, isolates, format, most of the ⎕-fns, .NET integration and probably many more.</p>
</div>
</div>
<div class="section" id="is-terser-better">
<h2>Is terser better?<a class="headerlink" href="#is-terser-better" title="Permalink to this headline">¶</a></h2>
<p>APL’s <em>raison d’être</em> is to cut out the noise, to become an extension of thought. A lofty aim, for sure. APL code can be exceptionally compact; no other general-purpose programming language (apart from its siblings) gets close. No bit of code we write here will likely be longer than a few lines, and anecdotally, from personal experience, the difference runs to perhaps an order of magnitude compared with Python.</p>
<p>Is terser better? Opinions differ here. APLers, only half-jokingly, say they never scroll. <a class="reference external" href="https://en.wikipedia.org/wiki/Arthur_Whitney_(computer_scientist)">Arthur Whitney</a>, the creator of K, reputedly <em>hates</em> scrolling, even when writing in C:</p>
<blockquote>
<div><p>The K binary weighs in at about 50Kb. Someone asked about the interpreter source code. A frown flickered across the face of our visitor from Microsoft: what could be interesting about that? “The source is currently 264 lines of C,” said Arthur. I thought I heard a sotto voce “that’s not possible.” Arthur showed us how he had arranged his source code in five files so that he could edit any one of them without scrolling. “Hate scrolling,” he mumbled.</p>
</div></blockquote>
<p>(from <a class="reference external" href="http://archive.vector.org.uk/art10500700">Vector</a>)</p>
<p>Being able to see your whole implementation on a single page of code cuts down on context switching, and at least anecdotally makes mistakes easier to spot.</p>
</div>
<div class="section" id="other-resources">
<h2>Other resources<a class="headerlink" href="#other-resources" title="Permalink to this headline">¶</a></h2>
<p>If you’re interested in the history of APL, a good read is Kromberg and Hui’s weighty paper <a class="reference external" href="https://dl.acm.org/doi/pdf/10.1145/3386319">APL since 1978</a>. Morten and Roger do all their own stunts.</p>
<p><a class="reference external" href="https://www.jsoftware.com">J Software</a> maintains a rich collection of APL-related <a class="reference external" href="https://www.jsoftware.com/papers/">publications</a>.</p>
<p><a class="reference external" href="https://vector.org.uk/">Vector</a> is the journal of the British APL Association.</p>
<p>A comprehensive, but now a bit outdated, reference is Legrand’s door stopper <a class="reference external" href="https://www.dyalog.com/uploads/documents/MasteringDyalogAPL.pdf">Mastering Dyalog APL</a>, all 800+ pages of it. It covers a lot of ground that we’re not touching upon here. Work is afoot to update <a class="reference external" href="https://mastering.dyalog.com">MDAPL</a> to cover a more recent version of Dyalog.</p>
<p>As you get a bit further along your path to APL mastery, the <a class="reference external" href="https://aplcart.info/?w">APL Cart</a> indexed idiom collection is an <em>amazing</em> resource.</p>
<p>The chat room <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/the-apl-orchard">APL Orchard</a> on Stack Exchange features some of the sharpest minds on the array programming circuit. It’s a welcoming place for newbies, too, and every now and then hosts so called <em>cultivations</em> – impromptu interactive lessons. A list of old cultivations is <a class="reference external" href="https://chat.stackexchange.com/rooms/info/52405/the-apl-orchard?tab=conversations">here</a>. Drop in and say ‘hi’ – chances are that you will be given a private APL intro lesson (in public).</p>
<p>The <a class="reference external" href="https://aplwiki.com/">APL Wiki</a> is a rich and growing source of knowledge.</p>
<p>Dyalog’s own developer <a class="reference external" href="http://help.dyalog.com/18.0/index.htm">documentation</a> is a reference - rich depth, but not the easiest place to learn new things from. <a class="reference external" href="https://dyalog.tv/">Dyalog TV</a> hosts Dyalog’s back catalog of webinars and lots of conference presentations with a lot of varied nuggets. There is also the Dyalog <a class="reference external" href="https://forums.dyalog.com/">forums</a> although a bit low-volume.</p>
<p>Dyalog’s docs for the <a class="reference external" href="http://dfns.dyalog.com/">dfns</a> workspace is a treasure trove of APL exotica. It’s what passes as a “standard library” for Dyalog, and some of it is useful for everyday coding (like <a class="reference external" href="http://dfns.dyalog.com/n_segs.htm">segs</a> and <a class="reference external" href="http://dfns.dyalog.com/n_iotag.htm">iotag</a>), and other stuff perhaps less so – but you can learn a lot by looking at its implementations to see what “real APL” looks like.</p>
<p>Speaking of “real APL”, Dyalog has a lot of public code in their <a class="reference external" href="https://github.com/Dyalog">github</a>, which is a great resource.</p>
</div>
<div class="section" id="ok-i-m-convinced-how-do-i-get-started">
<h2>Ok, I’m convinced, how do I get started?<a class="headerlink" href="#ok-i-m-convinced-how-do-i-get-started" title="Permalink to this headline">¶</a></h2>
<p>There are a couple of options. To get started right now, you can head to <a class="reference external" href="https://tryapl.org/">TryAPL</a>, which is a web version of Dyalog APL’s latest and greatest release. That should work for most of the stuff we’ll do here.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Dyalog APL is a commercial product, not open source. Fortunately, they offer a generous non-commercial free to use clause in their licensing terms, so you can <a class="reference external" href="https://www.dyalog.com/download-zone.htm">download and install Dyalog APL</a> locally without cost, as long as you’re not making money from it.</p>
</div>
<p>Dyalog consists of the APL interpreter itself, and an IDE. You’ll also need to install a font with the APL glyphs (as the “squiggles” are actually called) and a keyboard layout, depending on your platform. I am using Dyalog version 18 on MacOS, which comes with an IDE called <a class="reference external" href="https://github.com/Dyalog/ride">RIDE</a>. On Windows you get a different IDE.</p>
<p>There is also <a class="reference external" href="https://www.gnu.org/software/apl/">GNU APL</a>, and whilst there are similarities, its dialect is a bit different. GNU APL was made to be a <em>libre</em> software reimplementation of IBM’s APL2, and Dyalog has moved on quite a bit from this. The examples we present here are unlikely to all function as-is in GNU APL. Other options are <a class="reference external" href="https://aplwiki.com/wiki/Ngn/apl">ngn/apl</a> and <a class="reference external" href="https://github.com/dzaima/APL">dzaima/apl</a>, both hobbyist implementations that roughly implement the subset we’re interested in.</p>
<p>Dyalog also has an excellent <a class="reference external" href="https://jupyter.org/">Jupyter</a> <a class="reference external" href="https://github.com/Dyalog/dyalog-jupyter-kernel">kernel</a> that allows you to use APL in the Jupyter notebook interface – which indeed is how this book is written.</p>
<p>Assuming you’ve managed to get the APL keyboard layout installed, you’ll be hunting and pecking for a while. It takes a few days to learn where the most useful glyphs reside. The Dyalog IDE has the <em>language bar</em> at the top which you can also use – and hovering over a glyph will indicate where it resides on the keyboard. Here’s what my RIDE shows in terms of keyboard layout:</p>
<p><img alt="keys" src="_images/keyboard.png" /></p>
<p>Are you ready? Let’s begin.</p>
</div>
<div class="section" id="our-first-tentative-steps">
<h2>Our first tentative steps<a class="headerlink" href="#our-first-tentative-steps" title="Permalink to this headline">¶</a></h2>
<p>The first thing we’ll do is to specify our <em>index origin</em>. In most programming languages in use today, arrays are indexed starting from 0, with a few notable exceptions (for example <a class="reference external" href="https://julialang.org/">Julia</a> and <a class="reference external" href="http://www.lua.org/">Lua</a>). In APL, the index origin is a configurable option. Leaving aside for a moment as to if this is a good idea or not, it’s one of those things that sooner or later will catch you out. We’ll try to always be explicit. If, when trying to run code someone else wrote, you’re faced with an <code class="docutils literal notranslate"><span class="pre">INDEX</span> <span class="pre">ERROR</span></code>, it’s worth changing the index origin to see if that makes a difference.</p>
<p>Dyalog’s default index origin is 1, but we’ll set it to 0 for the least possible surprise. We won’t use anything where this actually matters for a while, but let’s get used to it from the beginning.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span> <span class="c1">⍝ Index origin gets 0</span>
</pre></div>
</div>
</div>
</div>
<p>We pronounce this as “quad-eye-oh gets zero”. The left-arrow, <code class="docutils literal notranslate"><span class="pre">←</span></code>, called <em>Gets</em>, is the symbol for assignment. The green text following the <code class="docutils literal notranslate"><span class="pre">⍝</span></code> symbol is a comment. APL’s comment symbol is called <em>Lamp</em> – and a bit of an <em>aide-memoire</em> – comments should illuminate the code. On my keyboard, it lives on the comma-key, and is a useful first APL key sequence to memorise. Does it look like a lamp?</p>
<p><img alt="lamps" src="_images/threelamps.png" /></p>
<p>Maybe an LED? Or a kerosene lamp, depending on how long you’ve been doing APL for. Anyway - a comment.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="c1">⍝ This line does nothing!</span>
</pre></div>
</div>
</div>
</div>
<p>The usual arithmetic operations work as expected, don’t they?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="o">*</span><span class="m">5</span> <span class="c1">⍝ Wait... wot?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">32
</span></div></div>
</div>
<p>Ok, that may have come as a surprise. It turns out that <code class="docutils literal notranslate"><span class="pre">*</span></code> is the symbol for exponentiation, not multiplication. If we want to multiply, we need to use <code class="docutils literal notranslate"><span class="pre">×</span></code> (which lives on the <code class="docutils literal notranslate"><span class="pre">-</span></code> key):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="o">×</span><span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">10
</span></div></div>
</div>
<p>Ok, what about division?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">6</span><span class="na">/</span><span class="m">2</span> <span class="c1">⍝....?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2 2 2 2 2 2
</span></div></div>
</div>
<p>Nope. The slash does something decidedly not-division. We’ll get back to that one later. Division is <code class="docutils literal notranslate"><span class="pre">÷</span></code>, not <code class="docutils literal notranslate"><span class="pre">/</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">20</span><span class="o">÷</span><span class="m">4</span> <span class="c1">⍝ Division is ÷, not /</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5
</span></div></div>
</div>
<p>Negative numbers are not written with the traditional minus-sign, but with a special glyph, the <em>High minus</em>: <code class="docutils literal notranslate"><span class="pre">¯</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">¯87</span> <span class="c1">⍝ Note: not -87</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">¯87
</span></div></div>
</div>
<p>Here’s another surprise:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="o">×</span><span class="m">5</span><span class="o">+</span><span class="m">7</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">24
</span></div></div>
</div>
<p>In any other language, or indeed on a calculator, that would have given 17. So what’s going on here? We’re taught that multiplication goes before addition since year 1 in school. We’ve stumbled on one of the things in mathematical notation that motivated Iverson to create APL: in mathematics, operator precedence is kind of awkward and irregular.</p>
<p>In APL, everything evaluates strictly right to left. If you want to bend this evaluation order, you’ll need parentheses.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">2</span><span class="o">×</span><span class="m">5</span><span class="p">)</span><span class="o">+</span><span class="m">7</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">17
</span></div></div>
</div>
<p>We can assign a value to a variable using <em>Gets</em> (<code class="docutils literal notranslate"><span class="pre">←</span></code>) that we met earlier:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">a</span> <span class="kd">←</span> <span class="p">(</span><span class="m">2</span><span class="o">×</span><span class="m">5</span><span class="p">)</span><span class="o">+</span><span class="m">7</span> <span class="c1">⍝ a gets 17. </span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">a</span> <span class="c1">⍝ Just evaluating the variable returns its value</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">17
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊢</span><span class="nv">a</span> <span class="kd">←</span> <span class="m">42</span> <span class="c1">⍝ a gets 42, and please evaluate it so I can see the value</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">42
</span></div></div>
</div>
<p>The glyph <code class="docutils literal notranslate"><span class="pre">⊢</span></code> is called <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Symbols/Right%20Tack.htm"><em>Right tack</em></a>, and is a function referred to as <em>Same</em>. It simply returns its argument. Used like this it allows us to show the result of an expression even if the expression itself wouldn’t normally return a result. <em>Right tack</em> might seem like a pretty pointless function, but we’ll put it to good use later in different contexts. To “print” the value of a variable we can also use <em>Quad gets</em>, <code class="docutils literal notranslate"><span class="pre">⎕</span> <span class="pre">←</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">42
</span></div></div>
</div>
<p>As a mnemonic, you can think of the <em>Quad</em> (<code class="docutils literal notranslate"><span class="pre">⎕</span></code>) glyph representing your computer screen (or a piece of printer paper) in this context. And for the avoidance of any doubt, the <em>Quad</em> glyph really <em>is</em> a little rectangle, and not the symbol used to show a character set mismatch on badly formed web pages.</p>
<p>APL variable names follow mostly similar rules to other programming languages – any combination of letters (upper, and lower case), digits (apart from the first character), and the underscore symbol (<code class="docutils literal notranslate"><span class="pre">_</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">fiftySeven</span> <span class="kd">←</span> <span class="m">57</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">five38</span> <span class="kd">←</span> <span class="m">538</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">My_Variable_Name</span> <span class="kd">←</span> <span class="s1">&#39;hello world&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">57
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">538
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">hello world
</span></div></div>
</div>
<p>One convention you’ll occasionally see is the <code class="docutils literal notranslate"><span class="pre">_</span></code> variable, which is sometimes used to denote a value we don’t care about. There is nothing special about a variable called <code class="docutils literal notranslate"><span class="pre">_</span></code> – it’s just a convention.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">a</span> <span class="nv">b</span> <span class="nv">_</span> <span class="nv">d</span><span class="p">)</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">1</span> <span class="m">4</span> <span class="m">1</span> <span class="c1">⍝ Don&#39;t care about the third value</span>
<span class="nv">a</span> <span class="nv">b</span> <span class="nv">d</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 1 1
</span></div></div>
</div>
<p>There are two additional characters you can use in names, <code class="docutils literal notranslate"><span class="pre">⍙</span></code> and <code class="docutils literal notranslate"><span class="pre">∆</span></code>, if you feel the need to add extra spice in the lives of others reading your code. An advantage of APL’s use of glyphs instead of reserved words is that it’s impossible to create names that clash with internal or reserved words in APL.</p>
<p>You can of course use whatever naming convention that pleases you, but <a class="reference external" href="https://aplwiki.com/wiki/Ad%C3%A1m_Brudzewsky">Adám</a> from Dyalog has written up an informal <a class="reference external" href="https://abrudz.github.io/style/">style guide</a> that’s useful reading. As APL lends itself to a terse style, long, rambling, Java-esque variable names are frowned upon. Here are some <a class="reference external" href="https://github.com/the-carlisle-group/Dado/wiki/How-Not-To-Code-In-Dyalog-APL">opinionated home truths</a> from the Carlisle Group, too, to consider on your APL journey.</p>
</div>
<div class="section" id="valence">
<h2>Valence<a class="headerlink" href="#valence" title="Permalink to this headline">¶</a></h2>
<p><em>Valence</em> (sometimes called <em>arity</em>, too) refers to the way that functions expect arguments. In APL, we talk about <em>monadic</em> and <em>dyadic</em> functions and operators (and occasionally <em>niladic</em>, too).</p>
<p>There is a central tenet when writing about programming that for every mention of the word <a class="reference external" href="https://stackoverflow.com/questions/44965/what-is-a-monad">monad</a> you lose half your readership. We can blame Team <a class="reference external" href="http://learnyouahaskell.com">Haskell</a> for that. Fear not – we’re staying right out of <a class="reference external" href="https://en.wikipedia.org/wiki/Category_theory">category theory</a>. Whilst APL has monadic functions and operators, the term predates Haskell by some margin, and really refers to something different altogether. Hey, Haskell, make up your own words, will you? Just kidding, we’re huge Haskell fans.</p>
<p>APL functions can take arguments on either side, just like you’re perfectly used to with arithmetic operators in many other languages (not Lisps):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="o">+</span> <span class="m">1</span> <span class="c1">⍝ Infix function application, dyadic +</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div></div>
</div>
<p>In a Lispy language, function application is always monadic, even for arithmetic, so you’d write</p>
<div class="highlight-scheme notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nb">+ </span><span class="mi">1</span> <span class="mi">1</span><span class="p">)</span>
</pre></div>
</div>
<p>When we say that a function is <code class="docutils literal notranslate"><span class="pre">dyadic</span></code> in APL, all we mean is that the function takes both a left, and a right argument, like the <code class="docutils literal notranslate"><span class="pre">+</span></code> example above. A <code class="docutils literal notranslate"><span class="pre">monadic</span></code> function, conversely, is a function that only takes a right argument, for example, <em>Factorial</em>, <code class="docutils literal notranslate"><span class="pre">!</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">!</span><span class="m">7</span> <span class="c1">⍝ Monadic ! is factorial: 1×2×3×4×5×6×7</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5040
</span></div></div>
</div>
<p>Some APL functions can be either monadic or dyadic, and in many cases these have different meanings – an endless source of <s>confusion</s> joy for the beginner. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">7</span><span class="o">×</span><span class="m">3</span> <span class="c1">⍝ Dyadic × is multiplication</span>
<span class="o">×</span><span class="m">¯7</span> <span class="c1">⍝ Monadic × is &#39;direction&#39;, or signum (the sign, in our case). Thanks.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">21
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">¯1
</span></div></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>In the Dyalog IDE, if you hover over a glyph in the language bar, it will show brief examples of both its monadic and dyadic uses, where applicable. Some claim you can learn the whole language by hovering over this bar.</p>
</div>
</div>
<div class="toctree-wrapper compound">
<span id="document-array"></span><div class="tex2jax_ignore mathjax_ignore section" id="it-s-arrays-all-the-way-down">
<h2>It’s arrays all the way down<a class="headerlink" href="#it-s-arrays-all-the-way-down" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>There are two ways of constructing a software design: One way is to make it so simple that there are obviously no deficiencies, and the other way is to make it so complicated that there are no obvious deficiencies. The first method is far more difficult. –<em>Tony Hoare</em></p>
</div></blockquote>
<p>Dyalog APL is an <em>array language</em>. Chances are that you have not come across this programming language paradigm before. In APL, the array is the only data structure that’s available to us. In terms of terminology, this can get a bit confusing. Both in mathematics and other programming languages there are many different words used to refer to what might ultimately end up implemented as an array in APL – vector, matrix, list, string etc. We’ll use some of these interchangeably where the problem domain makes this convenient: the APL character array <code class="docutils literal notranslate"><span class="pre">'hello</span> <span class="pre">world'</span></code> is most likely intended to be a string.</p>
<p>But first things first: we promised to be explicit about our index origin, so let’s set that to zero upfront:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
</pre></div>
</div>
</div>
</div>
<p>A large part of programming in APL becomes a matter of data wrangling. Instead of looping and branching, you use simple primitives to transform your data, perhaps from a big vector into a multi-dimensional array which you then reduce back down along a different axis. As a simple example, say we have a nested vector, and we want to know the sum of all the first elements.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">data</span> <span class="kd">←</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)</span> <span class="p">(</span><span class="m">2</span> <span class="m">5</span> <span class="m">8</span> <span class="m">6</span><span class="p">)</span> <span class="p">(</span><span class="m">8</span> <span class="m">6</span> <span class="m">2</span> <span class="m">3</span><span class="p">)</span> <span class="p">(</span><span class="m">8</span> <span class="m">7</span> <span class="m">6</span> <span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────┬───────┬───────┬───────┐
│1 2 3 4│2 5 8 6│8 6 2 3│8 7 6 1│
└───────┴───────┴───────┴───────┘
</span></div></div>
</div>
<p>In naïve Python, we’d say something like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">sumfirst</span><span class="p">(</span><span class="n">d</span><span class="p">):</span>
    <span class="n">total</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">d</span><span class="p">:</span>
        <span class="n">total</span> <span class="o">+=</span> <span class="n">item</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">total</span>
</pre></div>
</div>
<p>The APL version turns the vector into a 2D array, <em>sum-reduces</em> (we’ll explain properly what this means later) along the leading axis and picks the first value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊃+</span><span class="na">⌿</span><span class="o">↑</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">19
</span></div></div>
</div>
<p>Wow. Ok, let’s take that apart. Starting from the right, first step is to “trade depth for rank” – turning the nested vector into a 2D array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↑</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 3 4
2 5 8 6
8 6 2 3
8 7 6 1
</span></div></div>
</div>
<p>Now we sum each column, <em>reducing</em> the dimensionality by 1, turning our matrix into a vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">⌿</span><span class="o">↑</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">19 20 19 14
</span></div></div>
</div>
<p>Finally, we pick the first value:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊃+</span><span class="na">⌿</span><span class="o">↑</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">19
</span></div></div>
</div>
<div class="section" id="let-s-get-in-shape">
<h3>Let’s get in shape<a class="headerlink" href="#let-s-get-in-shape" title="Permalink to this headline">¶</a></h3>
<p>The first concept we need to understand is that data is defined in terms of its <em>shape</em>. The shape defines the dimensionality of our data, and we can investigate that using the APL function <code class="docutils literal notranslate"><span class="pre">⍴</span></code> – the Greek letter “rho”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍴</span><span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">
</span></div></div>
</div>
<p>Oh, ok – nothing? That was rather uninteresting, right? Let’s ask Dyalog to help us a bit by displaying output with borders indicating shape, type and structure, and try that again:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="c1">⍝ Some visualisation help, please.</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span> <span class="o">-</span><span class="nv">style</span><span class="o">=</span><span class="nv">max</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────┐
│Was ON -style=min│
└─────────────────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍴</span><span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌⊖┐
│0│
└~┘
</span></div></div>
</div>
<p>Well, at least that’s something to go on. That particular output is worth committing to memory. It’s the empty vector, which actually has its own symbol called <em>Zilde</em>, from zero-tilde, a <code class="docutils literal notranslate"><span class="pre">0</span></code> overstruck by <code class="docutils literal notranslate"><span class="pre">~</span></code> – <code class="docutils literal notranslate"><span class="pre">⍬</span></code>.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Expressions that start with a close square bracket, like <code class="docutils literal notranslate"><span class="pre">]box</span></code> are called <em>user commands</em>. We’ll encounter a few of those throughout this book. Typically, user commands will give you a help text if you pass them a <code class="docutils literal notranslate"><span class="pre">-??</span></code>. Give that a go with <code class="docutils literal notranslate"><span class="pre">]box</span> <span class="pre">-??</span></code> – there is a lot of useful information there.</p>
</div>
<p>We can glean a lot of useful information from the boxed output. Here, the <code class="docutils literal notranslate"><span class="pre">⊖</span></code> symbol at the top of the box means that the vector’s axis is of length 0. The <code class="docutils literal notranslate"><span class="pre">~</span></code> at the bottom means that the vector is <em>non-nested</em>, and the 0 in the middle is the empty vector’s <em>prototype element</em> – we can for now think of this as the vector’s <em>type</em>. So we have an <em>empty numerical vector</em>.</p>
<p>Running with <code class="docutils literal notranslate"><span class="pre">]box</span> <span class="pre">-style=max</span></code> gets very noisy after a while, so let’s dial that back a bit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span> <span class="o">-</span><span class="nv">style</span><span class="o">=</span><span class="nv">min</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON -style=max
</span></div></div>
</div>
<p>We can always get verbose boxing by using the command <code class="docutils literal notranslate"><span class="pre">]DISPLAY</span></code> before any expression.</p>
<p>We can check that the shape of 5 is indeed <em>Zilde</em> by saying:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="no">⍬</span><span class="o">≡⍴</span><span class="m">5</span> <span class="c1">⍝ Does zilde match shape of 5?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div></div>
</div>
<p>So it would seem. What does <em>that</em> mean, then? Well, it means that the scalar <code class="docutils literal notranslate"><span class="pre">5</span></code> has “no shape” – it has no dimensional extent. It is a point, which makes a degree of sense.</p>
<p>Let’s instead consider a vector – in other words, something that <em>has</em> dimensional extent. Here’s a vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="m">8</span> <span class="m">5</span> <span class="m">2</span> <span class="m">3</span> <span class="c1">⍝ A vector, yay</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
│8 5 2 3│
└~──────┘
</span></div></div>
</div>
<p>We made a vector by simply listing a bunch of scalars with spaces between them. Our verbose visualisation shows the vector as a box with an arrow on top. “Arrow on top” is a notation borrowed from mathematics to denote vectors.</p>
<p>So, what shape does a vector have?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">⍴</span> <span class="m">8</span> <span class="m">5</span> <span class="m">2</span> <span class="m">3</span> <span class="c1">⍝ What&#39;s the shape of my vector?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→┐
│4│
└~┘
</span></div></div>
</div>
<p>The shape is a <em>vector</em> with a single element, the integer 4. We suspected already that shape is a vector. A scalar’s shape is an empty vector, and a vector’s shape is a vector containing a single integer representing the number of elements.</p>
<p>Ok, let’s try a matrix – or a 2D array, disregarding for the moment the APL mechanics of its creation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">m</span> <span class="kd">←</span> <span class="o">↑</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span><span class="p">)(</span><span class="m">9</span> <span class="m">10</span> <span class="m">11</span> <span class="m">12</span><span class="p">)</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────────┐
↓1  2  3  4│
│5  6  7  8│
│9 10 11 12│
└~─────────┘
</span></div></div>
</div>
<p>That gives us a 3×4 matrix called <code class="docutils literal notranslate"><span class="pre">m</span></code>, holding the integers 1-12. APL helps us by now showing two arrows on the surrounding box. What is its shape?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍴</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 4
</span></div></div>
</div>
<p>The shape vector now has <em>two</em> components – as our matrix has two axes – the first axis, y, of length 3, and the second, x, of length 4. In other words, the <em>shape of the shape</em> tells us something about our array: its dimensionality, or its number of axes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">⍴⍴</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→┐
│2│
└~┘
</span></div></div>
</div>
<p>The <em>shape-of-shape</em> thing has a name: <em>rank</em>, although it’s usually thought of as the <em>length</em> of the shape vector, as it’s more convenient to have it as a scalar, rather than as a 1-element vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">≢⍴</span><span class="nv">m</span> <span class="c1">⍝ Rank</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div></div>
</div>
</div>
<div class="section" id="rank-and-reshape">
<h3>Rank and reshape <code class="docutils literal notranslate"><span class="pre">⍴</span></code><a class="headerlink" href="#rank-and-reshape" title="Permalink to this headline">¶</a></h3>
<p>Rank is a central concept in APL. APL’s functions are said to be rank-polymorphic, meaning that operations extend seamlessly to any-rank arguments where this is possible.</p>
<p>For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="o">+</span> <span class="m">1</span>          <span class="c1">⍝ Scalar + scalar</span>
<span class="m">1</span> <span class="o">+</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span>      <span class="c1">⍝ Scalar + vector</span>
<span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="o">+</span> <span class="m">9</span> <span class="m">3</span> <span class="m">2</span>  <span class="c1">⍝ Vector + vector</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">2 3 4
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">10 5 5
</span></div></div>
</div>
<p>This is an extraordinarily powerful concept, and one of the reasons why APL leads to such compact code. We’ll return to this time and again.</p>
<p>When used dyadically, the <em>Shape</em> (<code class="docutils literal notranslate"><span class="pre">⍴</span></code>) function <em>reshapes</em> data. A typical use for this is to take data from some raw format and use <code class="docutils literal notranslate"><span class="pre">⍴</span></code> to bend it into the shape we want. Here’s an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="m">2</span> <span class="m">4</span><span class="o">⍴⍳</span><span class="m">8</span> <span class="c1">⍝ Reshape vector to 2×4 matrix</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
↓0 1 2 3│
│4 5 6 7│
└~──────┘
</span></div></div>
</div>
<p>A couple of things to note here. First, the <em>iota</em> primitive <code class="docutils literal notranslate"><span class="pre">⍳</span></code>, which is a function called <em>Index generator</em>. It’s what might be called <a class="reference external" href="https://docs.python.org/3/library/stdtypes.html?highlight=range#range">range</a> in other languages. It makes a sequence of consecutive integers, starting at the current <em>index origin</em>, <code class="docutils literal notranslate"><span class="pre">⎕IO</span></code>, which we set to zero in the beginning of this chapter, as you may recall.</p>
<p>In the example above, it creates a vector of 8 consecutive integers, starting with zero: <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">1</span> <span class="pre">2</span> <span class="pre">3</span> <span class="pre">4</span> <span class="pre">5</span> <span class="pre">6</span> <span class="pre">7</span></code>. We then <em>reshape</em> this into a 2×4 array.</p>
<p>Here’s another example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">v</span> <span class="kd">←</span> <span class="m">8</span> <span class="m">6</span> <span class="m">2</span> <span class="m">9</span>     <span class="c1">⍝ Vector of length 4</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">1</span> <span class="m">4</span><span class="o">⍴</span><span class="nv">v</span>       <span class="c1">⍝ Reshape vector to 1×4 matrix</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
│8 6 2 9│
└~──────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
↓8 6 2 9│
└~──────┘
</span></div></div>
</div>
<p>In case the difference isn’t obvious, let’s look at the ranks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">≢⍴</span><span class="nv">v</span>
<span class="o">≢⍴</span><span class="nv">m</span>

<span class="nv">v</span><span class="o">≡</span><span class="nv">m</span> <span class="c1">⍝ Does v match m?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div></div>
</div>
<p>This is an issue that bites everyone at some stage of their APL journey. We can see from the rank that <code class="docutils literal notranslate"><span class="pre">v</span></code> is a <em>vector</em> – rank 1, but <code class="docutils literal notranslate"><span class="pre">m</span></code> is a 1×4 matrix – rank 2, even if they look the same. The visualisation shows this with two arrows on the box for <code class="docutils literal notranslate"><span class="pre">m</span></code>, but only one arrow on the box for <code class="docutils literal notranslate"><span class="pre">v</span></code>. If we switch off the verbose visualisation, it gets <em>much</em> trickier to spot:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">v</span> 
<span class="nv">m</span>

<span class="nv">v</span><span class="o">≡</span><span class="nv">m</span> <span class="c1">⍝ ?????</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">8 6 2 9
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">8 6 2 9
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div></div>
</div>
<p>We can conclude that higher arrays is a first-order concept in APL. A 2D array in APL is <em>not</em> a list-of-lists, as it would be in, for example, Python.</p>
<p><img alt="rankdepth" src="_images/rankdepth.png" /></p>
<p>The other thing that is worth re-highlighting is how the array axes are enumerated in APL. We saw from a previous example that the shape of a 2D array lists y before x in the shape vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">2</span> <span class="m">4</span><span class="o">⍴</span><span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="c1">⍝ y=2, x=4</span>
<span class="o">⍴</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 2 3
4 5 6 7
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">2 4
</span></div></div>
</div>
<p>This idea extends to higher dimensions, too. A 3D matrix would have its shape vector represent z, y and x axes in that order. A 57D matrix would.. you get the point.</p>
</div>
<div class="section" id="enclose-disclose">
<h3>Enclose, disclose <code class="docutils literal notranslate"><span class="pre">⊂⊃</span></code><a class="headerlink" href="#enclose-disclose" title="Permalink to this headline">¶</a></h3>
<p><img alt="kk" src="_images/karatekid.png" /></p>
<p>Arrays in Dyalog APL are always collections of scalars, regardless of rank. However, we can create arbitrarily complex scalars by a process known as <em>enclosing</em>. This means putting something in a “box”. It looks like so:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">v</span> <span class="kd">←</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span>
<span class="o">⊂</span><span class="nv">v</span>         <span class="c1">⍝ Enclose the vector 1 2 3</span>
<span class="nv">v</span><span class="o">≡⊂</span><span class="nv">v</span>       <span class="c1">⍝ Does the vector v match the enclosed v? Of course not!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 3
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┐
│1 2 3│
└─────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div></div>
</div>
<p>We can check that enclosing creates a scalar by inspecting the rank:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">≢⍴</span><span class="nv">v</span>  <span class="c1">⍝ Rank of vector should be 1</span>
<span class="o">≢⍴⊂</span><span class="nv">v</span> <span class="c1">⍝ Rank of scalar should be 0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div></div>
</div>
<p>This actually allows us to create a Python-style “list of lists” – or in APL terms, a vector of enclosed vectors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">v</span> <span class="kd">←</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">)</span> <span class="p">(</span><span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)</span> <span class="p">(</span><span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────┐
│ ┌→────┐ ┌→────┐ ┌→────┐ │
│ │1 2 3│ │2 3 4│ │2 3 4│ │
│ └~────┘ └~────┘ └~────┘ │
└∊────────────────────────┘
</span></div></div>
</div>
<p>See the little epsilon <code class="docutils literal notranslate"><span class="pre">∊</span></code> in the lower edge of the box? It indicates that the elements of the vector are enclosed. We’ll discuss indexing in depth later on, but for now, let’s get a cell out of that vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">v</span><span class="sr">[</span><span class="m">1</span><span class="sr">]</span> <span class="c1">⍝ Get position 1 -- we get back an enclosed vector</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┐
│2 3 4│
└─────┘
</span></div></div>
</div>
<p>We can create arbitrary levels of nesting:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">1</span> <span class="p">(</span><span class="s1">&#39;hello&#39;</span> <span class="m">2</span><span class="p">))</span> <span class="p">(</span><span class="m">3</span> <span class="p">(</span><span class="s1">&#39;world&#39;</span> <span class="m">4</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────────┬─────────────┐
│┌─┬─────────┐│┌─┬─────────┐│
││1│┌─────┬─┐│││3│┌─────┬─┐││
││ ││hello│2││││ ││world│4│││
││ │└─────┴─┘│││ │└─────┴─┘││
│└─┴─────────┘│└─┴─────────┘│
└─────────────┴─────────────┘
</span></div></div>
</div>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Non-simple, a.k.a nested, arrays can be detrimental to APL performance!</p>
<p>It’s best to bear this in mind from the beginning: if you can, choose multiple simple vectors, rather than a single vector of complex scalars.</p>
</div>
</div>
</div>
<span id="document-indexing"></span><p><img alt="indexing" src="_images/indexing.jpg" />
<span>Photo by <a href="https://unsplash.com/@jbsinger1970?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Jonathan Singer</a> on <a href="https://unsplash.com/s/photos/bookshelf?utm_source=unsplash&amp;utm_medium=referral&amp;utm_content=creditCopyText">Unsplash</a></span></p>
<div class="tex2jax_ignore mathjax_ignore section" id="indexing">
<h2>Indexing<a class="headerlink" href="#indexing" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Elegance is not a dispensable luxury but a factor that decides between success and failure. –<em>Edsger Dijkstra</em></p>
</div></blockquote>
<p>There are several ways of indexing into arrays and vectors. Some might even say “too many”. A good start point is to read up on <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Functions/Indexing.htm">indexing</a> in Dyalog’s documentation, and Richard Park’s <a class="reference external" href="https://dyalog.tv/Webinar/?v=AgYDvSF2FfU">webinar</a> on the topic is extremely helpful, too.</p>
<p>But as before, we begin by setting our <em>index origin</em>, extra important as we’re about to discuss indexing. Whilst we’re at it, let’s also ensure we have output boxing turned on.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div></div>
</div>
<p>Anyway – back to indexing. Crucially, elements of vectors and matrices are always scalars, but a scalar can be an enclosed vector or matrix. Indexing with <code class="docutils literal notranslate"><span class="pre">[]</span></code> or <code class="docutils literal notranslate"><span class="pre">⌷</span></code> returns the <em>box</em>, not the element <em>in</em> the box. However, if the element is a simple scalar, it’s the same thing.</p>
<p>Let’s look at <em>bracket indexing</em> first.</p>
<div class="section" id="bracket-indexing">
<h3>Bracket indexing <code class="docutils literal notranslate"><span class="pre">[</span> <span class="pre">]</span></code><a class="headerlink" href="#bracket-indexing" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Indexing.htm"><em>Bracket indexing</em></a> is similar to how C-like languages index into arrays:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">v</span> <span class="kd">←</span> <span class="m">9</span> <span class="m">2</span> <span class="m">6</span> <span class="m">3</span> <span class="m">5</span> <span class="m">8</span> <span class="m">7</span> <span class="m">4</span> <span class="m">0</span> <span class="m">1</span>
<span class="nv">v</span><span class="sr">[</span><span class="m">5</span><span class="sr">]</span>    <span class="c1">⍝ Grab the cell at index 5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">9 2 6 3 5 8 7 4 0 1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">8
</span></div></div>
</div>
<p>However, unlike C (and its ilk), the indexing expression can be a vector, or even a higher-rank array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">v</span><span class="sr">[</span><span class="m">5</span> <span class="m">2</span><span class="sr">]</span>  <span class="c1">⍝ Grab the cells at indices 5 and 2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">8 6
</span></div></div>
</div>
<p>We can mutate the vector or array via a bracket index, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">v</span><span class="sr">[</span><span class="m">3</span><span class="sr">]</span> <span class="kd">←</span> <span class="m">¯1</span>
<span class="nv">v</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">9 2 6 ¯1 5 8 7 4 0 1
</span></div></div>
</div>
<p>Of course, this being APL, this idea extends to any shape of array, either by separating the axes by semi-colon:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">4</span> <span class="m">1</span> <span class="m">6</span> <span class="m">5</span> <span class="m">2</span> <span class="m">9</span> <span class="m">7</span> <span class="m">8</span> <span class="m">3</span> <span class="c1">⍝ a 3×3 matrix</span>
<span class="nv">m</span><span class="sr">[</span><span class="m">1</span><span class="sr">;</span><span class="m">1</span><span class="sr">]</span>  <span class="c1">⍝ Row 1, col 1</span>
<span class="nv">m</span><span class="sr">[</span><span class="m">1</span><span class="sr">;]</span>   <span class="c1">⍝ Row 1</span>
<span class="nv">m</span><span class="sr">[;</span><span class="m">1</span><span class="sr">]</span>   <span class="c1">⍝ Col 1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓4 1 6│
│5 2 9│
│7 8 3│
└~────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">5 2 9
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 8
</span></div></div>
</div>
<p>or by supplying one or more <em>enclosed vectors</em>, each with shape equal to the <em>rank of the array</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">m</span><span class="sr">[</span><span class="o">⊂</span><span class="m">1</span> <span class="m">1</span><span class="sr">]</span> <span class="c1">⍝ Centre</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">m</span><span class="sr">[</span><span class="p">(</span><span class="m">0</span> <span class="m">0</span><span class="p">)(</span><span class="m">1</span> <span class="m">1</span><span class="p">)(</span><span class="m">2</span> <span class="m">2</span><span class="p">)</span><span class="sr">]</span> <span class="c1">⍝ Three points along the main diagonal</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">4 2 3
</span></div></div>
</div>
<p>As indicated above, bracket indexing references <em>cells</em>, not the <em>values</em> enclosed in the cells. For numeric or character scalars, there is no difference, but the difference is clear for a nested array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">)(</span><span class="m">3</span> <span class="m">2</span> <span class="m">1</span><span class="p">)(</span><span class="m">4</span> <span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">5</span> <span class="m">3</span> <span class="m">1</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span> <span class="m">8</span><span class="p">)(</span><span class="m">7</span> <span class="m">1</span> <span class="m">2</span><span class="p">)(</span><span class="m">4</span> <span class="m">3</span> <span class="m">9</span><span class="p">)(</span><span class="m">3</span> <span class="m">7</span> <span class="m">6</span><span class="p">)(</span><span class="m">4</span> <span class="m">5</span> <span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│1 2 3│3 2 1│4 5 6│
├─────┼─────┼─────┤
│5 3 1│5 6 8│7 1 2│
├─────┼─────┼─────┤
│4 3 9│3 7 6│4 5 1│
└─────┴─────┴─────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">m</span><span class="sr">[</span><span class="m">1</span><span class="sr">;</span><span class="m">1</span><span class="sr">]</span> <span class="c1">⍝ Note the returned enclosure.</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────┐
│ ┌→────┐ │
│ │5 6 8│ │
│ └~────┘ │
└∊────────┘
</span></div></div>
</div>
</div>
<div class="section" id="functional-indexing">
<h3>Functional indexing <code class="docutils literal notranslate"><span class="pre">⌷</span></code><a class="headerlink" href="#functional-indexing" title="Permalink to this headline">¶</a></h3>
<p>Whilst bracket-style indexing feels immediately familiar for those of us coming from a different programming language tradition, it is somewhat frowned upon amongst APLers. One reason for this is that it doesn’t follow APL’s normal strict right-to-left evaluation order as the indexing expression always must be evaluated first. As a consequence, it just stands out a bit: it’s neither a monadic or dyadic function call. Another reason is that bracket indexing doesn’t work in <em>tacit</em> functions, a topic we’ll cover in a <a class="reference internal" href="intro.html#document-tacit"><span class="doc std std-doc">later chapter</span></a>.</p>
<p>There is an alternative native indexing method: <em>functional</em>, or <a class="reference external" href="https://aplwiki.com/wiki/Index_(function)"><em>Squad indexing</em></a>. <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Index.htm"><em>Squad</em></a>, “squashed quad”, is the glyph <code class="docutils literal notranslate"><span class="pre">⌷</span></code>. It can be seen mnemonically as the two square indexing brackets pushed together. <em>Squad</em> fixes some of the issues surrounding the bracket indexing method above (but introduces some new ones, too). As <em>Squad</em> is a normal dyadic function, it behaves just like any other of APL’s dyadic functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">)(</span><span class="m">3</span> <span class="m">2</span> <span class="m">1</span><span class="p">)(</span><span class="m">4</span> <span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">5</span> <span class="m">3</span> <span class="m">1</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span> <span class="m">8</span><span class="p">)(</span><span class="m">7</span> <span class="m">1</span> <span class="m">2</span><span class="p">)(</span><span class="m">4</span> <span class="m">3</span> <span class="m">9</span><span class="p">)(</span><span class="m">3</span> <span class="m">7</span> <span class="m">6</span><span class="p">)(</span><span class="m">4</span> <span class="m">5</span> <span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│1 2 3│3 2 1│4 5 6│
├─────┼─────┼─────┤
│5 3 1│5 6 8│7 1 2│
├─────┼─────┼─────┤
│4 3 9│3 7 6│4 5 1│
└─────┴─────┴─────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="o">⌷</span><span class="nv">m</span>       <span class="c1">⍝ Row 1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│5 3 1│5 6 8│7 1 2│
└─────┴─────┴─────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span><span class="o">⌷</span><span class="nv">m</span>     <span class="c1">⍝ Cell 1 1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┐
│5 6 8│
└─────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">⊂</span><span class="m">1</span> <span class="m">2</span><span class="p">)</span><span class="o">⌷</span><span class="nv">m</span>  <span class="c1">⍝ Rows 1 and 2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│5 3 1│5 6 8│7 1 2│
├─────┼─────┼─────┤
│4 3 9│3 7 6│4 5 1│
└─────┴─────┴─────┘
</span></div></div>
</div>
<p>However, selecting cells from other axes than the first requires you to specify the axes explicitly with square brackets, which arguably looks a bit clumsy. Note that this isn’t a bracket index, even though it looks like one. For example, here’s how we select cell 2 from axis 1 (i.e. third column):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="o">⌷</span><span class="sr">[</span><span class="m">1</span><span class="sr">]</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│4 5 6│7 1 2│4 5 1│
└─────┴─────┴─────┘
</span></div></div>
</div>
<p>or we could avoid the bracketed axis specification by picking the row from the matrix’s <em>Transpose</em>, <code class="docutils literal notranslate"><span class="pre">⍉</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="o">⌷⍉</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│4 5 6│7 1 2│4 5 1│
└─────┴─────┴─────┘
</span></div></div>
</div>
<p><em>Squad index</em> does not let you mutate the array.</p>
<p>Another issue with <em>Squad</em> is that it flips the conventions established by the bracket indexing method. Let’s return to a couple of our examples from the bracket indexing section, and compare those with how you’d achieve the same thing with <em>Squad</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">n</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">4</span> <span class="m">1</span> <span class="m">6</span> <span class="m">5</span> <span class="m">2</span> <span class="m">9</span> <span class="m">7</span> <span class="m">8</span> <span class="m">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">n</span><span class="sr">[</span><span class="o">⊂</span><span class="m">1</span> <span class="m">1</span><span class="sr">]</span> <span class="c1">⍝ Centre</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">n</span><span class="sr">[</span><span class="p">(</span><span class="m">0</span> <span class="m">0</span><span class="p">)(</span><span class="m">1</span> <span class="m">1</span><span class="p">)(</span><span class="m">2</span> <span class="m">2</span><span class="p">)</span><span class="sr">]</span> <span class="c1">⍝ Three points along the main diagonal</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">4 2 3
</span></div></div>
</div>
<p><em>Squad</em>’s indexing expression, unlike that of bracket indexing’s, specifies the coordinate for each axis in turn:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span><span class="o">⌷</span><span class="nv">n</span> <span class="c1">⍝ Centre</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div></div>
</div>
<p>If we enclose the indexing expression we pick major cells, which arguably “feels” odd compared with how bracket indexing behaves:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">⊂</span><span class="m">1</span> <span class="m">1</span><span class="p">)</span><span class="o">⌷</span><span class="nv">n</span> <span class="c1">⍝ Repeat row 1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5 2 9
5 2 9
</span></div></div>
</div>
<p>So, how do we choose the three diagonal cells with <em>Squad</em>? With great difficulty, as it turns out. For this we need <em>Sane indexing</em>, up next.</p>
</div>
<div class="section" id="sane-indexing">
<h3>Sane indexing<a class="headerlink" href="#sane-indexing" title="Permalink to this headline">¶</a></h3>
<p>Some APLers are unhappy with <em>Squad</em>’s semantics, and have proposed yet another mechanism, called <em>Sane indexing</em> or <a class="reference external" href="https://aplwiki.com/wiki/Select"><em>Select</em></a>. It’s not yet built into Dyalog, but it can be defined as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">I</span><span class="kd">←</span><span class="o">⌷</span><span class="na">⍨∘</span><span class="o">⊃</span><span class="na">⍨⍤</span><span class="m">0</span> <span class="m">99</span> <span class="c1">⍝ Sane indexing</span>
</pre></div>
</div>
</div>
</div>
<p>For the purposes of this explanation, it matters less how that incantation hangs together (we’ll return to how this works in the section on the <a class="reference internal" href="intro.html#document-rank"><span class="doc std std-doc"><em>Rank</em></span></a> operator, <code class="docutils literal notranslate"><span class="pre">⍤</span></code>, later), but it does have a set of nice properties for the user.</p>
<p>Compare and contrast <em>Squad</em> and <em>Sane indexing</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">)(</span><span class="m">3</span> <span class="m">2</span> <span class="m">1</span><span class="p">)(</span><span class="m">4</span> <span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">5</span> <span class="m">3</span> <span class="m">1</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span> <span class="m">8</span><span class="p">)(</span><span class="m">7</span> <span class="m">1</span> <span class="m">2</span><span class="p">)(</span><span class="m">4</span> <span class="m">3</span> <span class="m">9</span><span class="p">)(</span><span class="m">3</span> <span class="m">7</span> <span class="m">6</span><span class="p">)(</span><span class="m">4</span> <span class="m">5</span> <span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│1 2 3│3 2 1│4 5 6│
├─────┼─────┼─────┤
│5 3 1│5 6 8│7 1 2│
├─────┼─────┼─────┤
│4 3 9│3 7 6│4 5 1│
└─────┴─────┴─────┘
</span></div></div>
</div>
<p>Index with a vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span><span class="nv">I</span> <span class="nv">m</span>   <span class="c1">⍝ Sane:  select leading axis cells 1 and 2, or m[1 2;]</span>
<span class="m">1</span> <span class="m">2</span><span class="o">⌷</span> <span class="nv">m</span>   <span class="c1">⍝ Squad: select m[⊂1 2]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│5 3 1│5 6 8│7 1 2│
├─────┼─────┼─────┤
│4 3 9│3 7 6│4 5 1│
└─────┴─────┴─────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┐
│7 1 2│
└─────┘
</span></div></div>
</div>
<p>Index with an <em>enclosed</em> vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">⊂</span><span class="m">1</span> <span class="m">2</span><span class="p">)</span><span class="nv">I</span> <span class="nv">m</span>  <span class="c1">⍝ Sane:  select m[⊂1 2]</span>
<span class="p">(</span><span class="o">⊂</span><span class="m">1</span> <span class="m">2</span><span class="p">)</span><span class="o">⌷</span> <span class="nv">m</span>  <span class="c1">⍝ Squad: select m[1 2;]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┐
│7 1 2│
└─────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│5 3 1│5 6 8│7 1 2│
├─────┼─────┼─────┤
│4 3 9│3 7 6│4 5 1│
└─────┴─────┴─────┘
</span></div></div>
</div>
<p>So you can think of <em>Sane indexing</em> as <em>Squad</em>, but closer to the behaviour of the bracket indexing expression. We can finally select a bunch of cells by index:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">0</span> <span class="m">0</span><span class="p">)(</span><span class="m">1</span> <span class="m">2</span><span class="p">)(</span><span class="m">2</span> <span class="m">2</span><span class="p">)</span><span class="nv">I</span> <span class="nv">m</span> <span class="c1">⍝ Multiple cells by index, like m[(0 0)(1 2)(2 2)]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│1 2 3│7 1 2│4 5 1│
└─────┴─────┴─────┘
</span></div></div>
</div>
</div>
<div class="section" id="boolean-indexing-compress">
<h3>Boolean indexing: compress<a class="headerlink" href="#boolean-indexing-compress" title="Permalink to this headline">¶</a></h3>
<p>But wait! There’s more to APL indexing. In fact, much of APL’s expressive power comes from its central application of bit-Boolean arrays, and it’s typically highly optimised. It’s a concept you don’t often see in non-array languages, but you may have been exposed to limited forms of it from bolt-on array libraries such as Python’s <a class="reference external" href="https://numpy.org/">NumPy</a>. Similar functionality can be achieved using a <a class="reference external" href="https://docs.python.org/3/library/functions.html#filter">filter</a> function taking a predicate in other languages.</p>
<p>The core idea is actually quite simple: select cells from an array by using a Boolean array as the indexing method, where a 1 means “yes, this one” and a 0 means “nope, not this one”. We use <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Replicate.htm"><em>Compress</em></a> to do this in APL, one of the several things represented by a forward slash <code class="docutils literal notranslate"><span class="pre">/</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span>   <span class="kd">←</span> <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span>
<span class="nv">select</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="c1">⍝ Select elements 2, 4, 5, 7 and 8</span>
<span class="nv">select</span><span class="na">/</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2 4 5 7 8
</span></div></div>
</div>
<p><em>Compress</em> is really a special case of the <em>Replicate</em> function, where the left argument is a Boolean vector. However, we can view the left argument more generally as a specification of how many times we should pick each element. In the compression case, that’s either 1 or 0. In the more general case we need not constrain ourselves to binary – we can pick <em>any</em> number:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">select</span> <span class="kd">←</span> <span class="m">1</span> <span class="m">3</span> <span class="m">0</span> <span class="m">0</span> <span class="m">5</span> <span class="m">0</span> <span class="m">7</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span>
<span class="nv">select</span><span class="na">/</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 1 1 4 4 4 4 4 6 6 6 6 6 6 6 9
</span></div></div>
</div>
<p><em>Replicate</em> and <em>Compress</em> apply along the given axis in higher-rank arrays, either via <em>Replicate first</em> (<code class="docutils literal notranslate"><span class="pre">⌿</span></code>) or by specifiying the axis explicitly with the <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/Axis%20with%20Dyadic%20Operand.htm"><em>bracket axis notation</em></a>, <code class="docutils literal notranslate"><span class="pre">/[axis]</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">9</span><span class="o">?</span><span class="m">9</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓3 0 5│
│4 1 8│
│6 7 2│
└~────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">select</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">select</span><span class="na">⌿</span><span class="nv">m</span> <span class="c1">⍝ Replicate first</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">4 1 8
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">select</span><span class="na">/</span><span class="nv">m</span> <span class="c1">⍝ Replicate</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0
1
7
</span></div></div>
</div>
</div>
<div class="section" id="pick">
<h3>Pick <code class="docutils literal notranslate"><span class="pre">⊃</span></code><a class="headerlink" href="#pick" title="Permalink to this headline">¶</a></h3>
<p>Yet another way to index into arrays is to use <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Pick.htm"><em>Pick</em></a>. <em>Pick</em> eh… picks <em>elements</em>, not boxes, which often comes in handy. A monadic <em>Pick</em> picks the first element.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">)(</span><span class="m">3</span> <span class="m">2</span> <span class="m">1</span><span class="p">)(</span><span class="m">4</span> <span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">5</span> <span class="m">3</span> <span class="m">1</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span> <span class="m">8</span><span class="p">)(</span><span class="m">7</span> <span class="m">1</span> <span class="m">2</span><span class="p">)(</span><span class="m">4</span> <span class="m">3</span> <span class="m">9</span><span class="p">)(</span><span class="m">3</span> <span class="m">7</span> <span class="m">6</span><span class="p">)(</span><span class="m">4</span> <span class="m">5</span> <span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┐
│1 2 3│3 2 1│4 5 6│
├─────┼─────┼─────┤
│5 3 1│5 6 8│7 1 2│
├─────┼─────┼─────┤
│4 3 9│3 7 6│4 5 1│
└─────┴─────┴─────┘
</span></div></div>
</div>
<p>Element at 1;1 - note, no box:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">⊂</span><span class="m">1</span> <span class="m">1</span><span class="p">)</span><span class="o">⊃</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5 6 8
</span></div></div>
</div>
<p>First element - note, no box:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊃</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 3
</span></div></div>
</div>
</div>
<div class="section" id="reach-indexing">
<h3>Reach indexing<a class="headerlink" href="#reach-indexing" title="Permalink to this headline">¶</a></h3>
<p><em>Reach indexing</em> is how you access elements of nested arrays. Note that nested arrays carry with them performance penalties and are best avoided if at all possible.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">G</span> <span class="kd">←</span> <span class="m">2</span> <span class="m">3</span><span class="o">⍴</span><span class="p">(</span><span class="s1">&#39;Adam&#39;</span> <span class="m">1</span><span class="p">)(</span><span class="s1">&#39;Bob&#39;</span> <span class="m">2</span><span class="p">)(</span><span class="s1">&#39;Carl&#39;</span> <span class="m">3</span><span class="p">)(</span><span class="s1">&#39;Danni&#39;</span> <span class="m">4</span><span class="p">)(</span><span class="s1">&#39;Eve&#39;</span> <span class="m">5</span><span class="p">)(</span><span class="s1">&#39;Frank&#39;</span> <span class="m">6</span><span class="p">)</span>
<span class="nv">G</span><span class="sr">[</span><span class="o">⊂</span><span class="p">(</span><span class="m">0</span> <span class="m">1</span><span class="p">)</span><span class="m">0</span><span class="sr">]</span> <span class="c1">⍝ First element of the vector nested at ⊂0 1 of G</span>
<span class="nv">G</span><span class="sr">[</span><span class="p">((</span><span class="m">0</span> <span class="m">0</span><span class="p">)</span><span class="m">0</span><span class="p">)((</span><span class="m">1</span> <span class="m">2</span><span class="p">)</span><span class="m">1</span><span class="p">)</span><span class="sr">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────┬───────┬─────────┐
│┌────┬─┐ │┌───┬─┐│┌────┬─┐ │
││Adam│1│ ││Bob│2│││Carl│3│ │
│└────┴─┘ │└───┴─┘│└────┴─┘ │
├─────────┼───────┼─────────┤
│┌─────┬─┐│┌───┬─┐│┌─────┬─┐│
││Danni│4│││Eve│5│││Frank│6││
│└─────┴─┘│└───┴─┘│└─────┴─┘│
└─────────┴───────┴─────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┐
│Bob│
└───┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬─┐
│Adam│6│
└────┴─┘
</span></div></div>
</div>
</div>
<div class="section" id="assignable-indexing-expressions">
<h3>Assignable indexing expressions<a class="headerlink" href="#assignable-indexing-expressions" title="Permalink to this headline">¶</a></h3>
<p>As we saw above, bracket indexing is <em>assignable</em>, meaning that we can mutate the array. It is not the only assignable indexing expression in APL. The full list of <em>selective assignment functions</em> is available from the Dyalog <a class="reference external" href="http://help.dyalog.com/latest/index.htm#Language/Primitive%20Functions/Assignment%20Selective.htm">documentation</a>. It’s worth studying this manual page, as it unlocks quite a few crafty ways of getting data into arrays.</p>
<p>For example, we can change the diagonal of a matrix by assigning directly to a <a class="reference internal" href="intro.html#document-dyadictrn"><span class="doc std std-doc">dyadic <em>Transpose</em></span></a> by noting that <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">0⍉m</span></code> is the main diagonal of the matrix <code class="docutils literal notranslate"><span class="pre">m</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">9</span><span class="o">?</span><span class="m">9</span>
<span class="p">(</span><span class="m">0</span> <span class="m">0</span><span class="o">⍉</span><span class="nv">m</span><span class="p">)</span> <span class="kd">←</span> <span class="m">¯1</span> <span class="m">¯1</span> <span class="m">¯1</span> <span class="c1">⍝ 0 0⍉m is the main diagonal.</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓1 2 3│
│4 8 0│
│6 5 7│
└~────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────┐
↓¯1  2  3│
│ 4 ¯1  0│
│ 6  5 ¯1│
└~───────┘
</span></div></div>
</div>
<p>Indeed, we can even assign via Boolean indexing expressions, which might not be immediately obvious:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span>   <span class="kd">←</span> <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span>
<span class="nv">select</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span>

<span class="p">(</span><span class="nv">select</span><span class="na">/</span><span class="nv">data</span><span class="p">)</span> <span class="kd">←</span> <span class="m">¯1</span> <span class="m">¯1</span> <span class="m">¯1</span> <span class="m">¯1</span> <span class="m">¯1</span>
<span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 ¯1 3 ¯1 ¯1 6 ¯1 ¯1 9
</span></div></div>
</div>
<p>Perhaps even less obvious is assigning to <em>Take</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">s</span> <span class="kd">←</span> <span class="s1">&#39;This is a string&#39;</span>
<span class="p">(</span><span class="m">2</span><span class="o">↑</span><span class="nv">s</span><span class="p">)</span> <span class="kd">←</span> <span class="s1">&#39;**&#39;</span>
<span class="nv">s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">This is a string
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">**is is a string
</span></div></div>
</div>
<p>…or even <em>Compress each</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">s</span><span class="kd">←</span><span class="s1">&#39;This&#39;</span> <span class="s1">&#39;is&#39;</span> <span class="p">(</span><span class="o">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span> <span class="s1">&#39;string&#39;</span> <span class="s1">&#39;without&#39;</span> <span class="s1">&#39;is.&#39;</span>
<span class="p">((</span><span class="nv">s</span><span class="o">=</span><span class="s1">&#39;i&#39;</span><span class="p">)</span><span class="na">/¨</span><span class="nv">s</span><span class="p">)</span><span class="kd">←</span><span class="s1">&#39;*&#39;</span>
<span class="nv">s</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬──┬─┬──────┬───────┬───┐
│Th*s│*s│a│str*ng│w*thout│*s.│
└────┴──┴─┴──────┴───────┴───┘
</span></div></div>
</div>
</div>
</div>
<span id="document-manip"></span><div class="tex2jax_ignore mathjax_ignore section" id="glyphiary">
<h2>Glyphiary<a class="headerlink" href="#glyphiary" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Are you quite sure that all those bells and whistles, all those wonderful facilities of your so called powerful programming languages, belong to the solution set rather than the problem set?
–<em>Edsger Dijkstra</em></p>
</div></blockquote>
<p>Learning what each glyph does is an unavoidable chunk of time investment. However, there are some mnemonic cues sometimes based on where they sit on the keyboard, or that related functions sometimes have glyphs that are visually similar. Other times all bets are off: here’s looking at you, <code class="docutils literal notranslate"><span class="pre">/</span></code>…</p>
<p>We’re not going to cover them all. Learn them a few at a time as the need arises. Use the language bar in RIDE. But let’s run through some of the immediately handy ones.</p>
<p>But first, the usual dance:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>            <span class="c1">⍝ Index origin is zero</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span> <span class="o">-</span><span class="nv">style</span><span class="o">=</span><span class="nv">max</span> <span class="c1">⍝ Show boxes at max verbosity</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>           <span class="c1">⍝ Don&#39;t wrap long output lines</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────┐
│Was ON -style=min│
└─────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
│Was OFF│
└───────┘
</span></div></div>
</div>
<p>Let’s have a random matrix for our demonstration purposes. We’ve met <em>Shape</em> (<code class="docutils literal notranslate"><span class="pre">⍴</span></code>) already, but we’ll get dyadic <code class="docutils literal notranslate"><span class="pre">?</span></code> – called <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Deal.htm"><em>Deal</em></a> – for free. It gives us a random selection of numbers from a set, without replacement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">mat</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴</span><span class="m">12</span><span class="o">?</span><span class="m">12</span> <span class="c1">⍝ Ladies and gentlemen: our matrix</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓3  0  5 1│
│7  9  8 6│
│2 10 11 4│
└~────────┘
</span></div></div>
</div>
<div class="section" id="tally-depth-match">
<h3>Tally, Depth, Match: <code class="docutils literal notranslate"><span class="pre">≢≡</span></code><a class="headerlink" href="#tally-depth-match" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Tally.htm"><em>Tally</em></a>, monadic <code class="docutils literal notranslate"><span class="pre">≢</span></code>, gives the number of major cells in an array, kind of like Python’s <a class="reference external" href="https://docs.python.org/3/library/functions.html#len">len()</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">≢</span><span class="m">7</span> <span class="m">5</span> <span class="m">1</span> <span class="m">2</span> <span class="m">9</span>
<span class="o">≢</span><span class="s1">&#39;Hello world&#39;</span>
<span class="o">≢</span><span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
5

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">  
11

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
3

</span></div></div>
</div>
<p>Pretty straight-forward. Monadic <em>Equal underbar</em>, <code class="docutils literal notranslate"><span class="pre">≡</span></code> is <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Depth.htm"><em>Depth</em></a> – the max level of nesting:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">≡</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span>
<span class="o">≡</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span><span class="p">)(</span><span class="m">3</span> <span class="m">4</span><span class="p">)</span>
<span class="o">≡</span><span class="p">((</span><span class="m">1</span> <span class="m">2</span><span class="p">)(</span><span class="m">2</span> <span class="m">3</span><span class="p">))((</span><span class="m">4</span> <span class="m">5</span><span class="p">)(</span><span class="m">6</span> <span class="m">7</span><span class="p">))</span>
<span class="o">≡</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span><span class="p">)(</span><span class="m">3</span> <span class="m">4</span><span class="p">)</span><span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
1

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
2

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
3

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">  
¯2

</span></div></div>
</div>
<p>The last case, giving <code class="docutils literal notranslate"><span class="pre">¯2</span></code>, means that the max depth is 2, but that not all cells are at the same depth. Depth is not rank. Say it with me: depth is not rank, depth is not rank, depth is not rank…</p>
<p>Turning to the dyadic forms, <code class="docutils literal notranslate"><span class="pre">≡</span></code> is <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Match.htm"><em>Match</em></a>, and with a pleasing visual symmetry, <code class="docutils literal notranslate"><span class="pre">≢</span></code> is <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Not%20Match.htm"><em>Not match</em></a>. We can think of <em>Match</em> being “deep equals for arrays”: same rank, same order, same depth, every element the same:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="o">≡</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span>
<span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="o">≡</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span>
<span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="o">≡</span> <span class="m">4</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span>
<span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="o">≡</span> <span class="m">1</span> <span class="m">4</span><span class="o">⍴</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
0

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
1

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
0

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
0

</span></div></div>
</div>
</div>
<div class="section" id="transpose-reverse-and-rotate">
<h3>Transpose, Reverse and Rotate: <code class="docutils literal notranslate"><span class="pre">⍉⊖⌽</span></code><a class="headerlink" href="#transpose-reverse-and-rotate" title="Permalink to this headline">¶</a></h3>
<p>Three glyphs used to change arrays around are <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Transpose%20Monadic.htm"><em>Transpose</em></a> (<code class="docutils literal notranslate"><span class="pre">⍉</span></code>), <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Reverse%20First.htm"><em>Reverse</em></a> (<code class="docutils literal notranslate"><span class="pre">⊖</span></code>) and <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Rotate.htm"><em>Rotate</em></a> (<code class="docutils literal notranslate"><span class="pre">⌽</span></code>). They all look like a circle overstruck with a line. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍉</span><span class="nv">mat</span> <span class="c1">⍝ Transpose</span>
<span class="o">⌽</span><span class="nv">mat</span> <span class="c1">⍝ Reverse</span>
<span class="o">⊖</span><span class="nv">mat</span> <span class="c1">⍝ Reverse first</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────┐
↓3 7  2│
│0 9 10│
│5 8 11│
│1 6  4│
└~─────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓1  5  0 3│
│6  8  9 7│
│4 11 10 2│
└~────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓2 10 11 4│
│7  9  8 6│
│3  0  5 1│
└~────────┘
</span></div></div>
</div>
<p>The two reverse glyphs mirror the issue we’ve seen with <em>Replicate</em> (<code class="docutils literal notranslate"><span class="pre">/</span></code>) vs <em>Replicate first</em> (<code class="docutils literal notranslate"><span class="pre">⌿</span></code>) – if you can, use the -first versions (the leading axis versions), and if you want to apply them along other axes, use either <a class="reference internal" href="intro.html#document-rank"><span class="doc std std-doc"><em>Rank</em></span></a> <code class="docutils literal notranslate"><span class="pre">⍤</span></code> or the <code class="docutils literal notranslate"><span class="pre">[axis]</span></code> notation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊖</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">mat</span> <span class="c1">⍝ Apply reverse-first to second axis using Rank</span>
<span class="o">⊖</span><span class="sr">[</span><span class="m">1</span><span class="sr">]</span><span class="nv">mat</span> <span class="c1">⍝ Apply reverse-first to second axis bracket-axis</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓1  5  0 3│
│6  8  9 7│
│4 11 10 2│
└~────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓1  5  0 3│
│6  8  9 7│
│4 11 10 2│
└~────────┘
</span></div></div>
</div>
<p>Both <em>Transpose</em> and <em>Reverse</em> can be applied dyadically, too, which presents us with a slight conundrum: the dyadic form of <em>Transpose</em> requires a deeper understanding of APL that we don’t yet have – we’ll push that one to its own <a class="reference internal" href="intro.html#document-dyadictrn"><span class="doc std std-doc">chapter</span></a> later on.</p>
<p>Dyadic <code class="docutils literal notranslate"><span class="pre">⊖</span></code> is actually <em>Rotate first</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span> <span class="m">¯1</span> <span class="m">0</span><span class="o">⊖</span><span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓7 10 11 1│
│2  0  5 6│
│3  9  8 4│
└~────────┘
</span></div></div>
</div>
<p>Here, the left argument vector specifies the per-column magnitude and direction of the rotation.</p>
</div>
<div class="section" id="mix-split-take-and-drop">
<h3>Mix, Split, Take and Drop: <code class="docutils literal notranslate"><span class="pre">↓↑</span></code><a class="headerlink" href="#mix-split-take-and-drop" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Mix.htm"><em>Mix</em></a> <code class="docutils literal notranslate"><span class="pre">↑</span></code> raises the rank by 1. Easiest to visualise as a means of turning a nested vector into a matrix (but works for any rank):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">v</span> <span class="kd">←</span> <span class="s1">&#39;Hello&#39;</span> <span class="s1">&#39;world&#39;</span>
<span class="o">↑</span><span class="nv">v</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────┐
│ ┌→────┐ ┌→────┐ │
│ │Hello│ │world│ │
│ └─────┘ └─────┘ │
└∊────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓Hello│
│world│
└─────┘
</span></div></div>
</div>
<p><a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Split.htm"><em>Split</em></a> <code class="docutils literal notranslate"><span class="pre">↓</span></code>, unsurprisingly, goes the other way; reducing rank:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">9</span><span class="o">?</span><span class="m">9</span>
<span class="o">↓</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓8 0 3│
│6 5 2│
│7 1 4│
└~────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────┐
│ ┌→────┐ ┌→────┐ ┌→────┐ │
│ │8 0 3│ │6 5 2│ │7 1 4│ │
│ └~────┘ └~────┘ └~────┘ │
└∊────────────────────────┘
</span></div></div>
</div>
<p><em>Mix</em> and <em>Split</em>, when combined with <em>Transpose</em>, make for a bit of a power-combo, <code class="docutils literal notranslate"><span class="pre">↓⍉↑</span></code>, occasionally dubbed <em>Remix</em>, or <em>Zip</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">v</span> <span class="kd">←</span> <span class="p">(</span><span class="m">0</span> <span class="m">6</span> <span class="m">3</span><span class="p">)(</span><span class="m">2</span> <span class="m">5</span> <span class="m">1</span><span class="p">)(</span><span class="m">4</span> <span class="m">7</span> <span class="m">8</span><span class="p">)</span>
<span class="o">↓⍉↑</span><span class="nv">v</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────┐
│ ┌→────┐ ┌→────┐ ┌→────┐ │
│ │0 6 3│ │2 5 1│ │4 7 8│ │
│ └~────┘ └~────┘ └~────┘ │
└∊────────────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────┐
│ ┌→────┐ ┌→────┐ ┌→────┐ │
│ │0 2 4│ │6 5 7│ │3 1 8│ │
│ └~────┘ └~────┘ └~────┘ │
└∊────────────────────────┘
</span></div></div>
</div>
<p>Whilst it’s tempting to think of <em>Remix</em> as the <a class="reference external" href="https://docs.python.org/3/library/functions.html#zip">zip()</a> found in, for example, Python, note that it most likely behaves differently to what you’re used to:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↓⍉↑</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────────────────────────────────┐
│ ┌→────┐ ┌→────┐ ┌→────┐ ┌→─────┐ │
│ │1 5 7│ │2 6 8│ │3 0 9│ │4 0 10│ │
│ └~────┘ └~────┘ └~────┘ └~─────┘ │
└∊─────────────────────────────────┘
</span></div></div>
</div>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Python</span> <span class="mf">3.9.0</span> <span class="p">(</span><span class="n">default</span><span class="p">,</span> <span class="n">Nov</span> <span class="mi">15</span> <span class="mi">2020</span><span class="p">,</span> <span class="mi">06</span><span class="p">:</span><span class="mi">25</span><span class="p">:</span><span class="mi">35</span><span class="p">)</span> 
<span class="p">[</span><span class="n">Clang</span> <span class="mf">10.0.0</span> <span class="p">]</span> <span class="p">::</span> <span class="n">Anaconda</span><span class="p">,</span> <span class="n">Inc</span><span class="o">.</span> <span class="n">on</span> <span class="n">darwin</span>
<span class="n">Type</span> <span class="s2">&quot;help&quot;</span><span class="p">,</span> <span class="s2">&quot;copyright&quot;</span><span class="p">,</span> <span class="s2">&quot;credits&quot;</span> <span class="ow">or</span> <span class="s2">&quot;license&quot;</span> <span class="k">for</span> <span class="n">more</span> <span class="n">information</span><span class="o">.</span>
<span class="o">&gt;&gt;&gt;</span> <span class="n">l</span> <span class="o">=</span> <span class="p">[[</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">],[</span><span class="mi">5</span><span class="p">,</span><span class="mi">6</span><span class="p">],[</span><span class="mi">7</span><span class="p">,</span><span class="mi">8</span><span class="p">,</span><span class="mi">9</span><span class="p">,</span><span class="mi">10</span><span class="p">]]</span>
<span class="o">&gt;&gt;&gt;</span> <span class="nb">list</span><span class="p">(</span><span class="nb">zip</span><span class="p">(</span><span class="o">*</span><span class="n">l</span><span class="p">))</span>
<span class="p">[(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">),</span> <span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">8</span><span class="p">)]</span>
</pre></div>
</div>
<p>APL abhors ragged arrays and will inject the “prototype” element for whatever the element type is to ensure that all cells are the same size – Python has no concept of array as such, and so abandons play if an element can’t be filled. Mixing a vector with cells of unequal numbers of elements in each cell will show us what happens:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↑</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────┐
↓1 2 3  4│
│5 6 0  0│
│7 8 9 10│
└~───────┘
</span></div></div>
</div>
<p>Dyadically, <em>Mix</em> and <em>Split</em> become <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Take.htm"><em>Take</em></a> and <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Drop.htm"><em>Drop</em></a>. <em>Take</em> … takes cells:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="o">↑</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span><span class="p">)</span> <span class="c1">⍝ Take 1</span>
<span class="m">2</span><span class="o">↑</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span><span class="p">)</span> <span class="c1">⍝ Take 2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────┐
│ ┌→──────┐ │
│ │1 2 3 4│ │
│ └~──────┘ │
└∊──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────┐
│ ┌→──────┐ ┌→──┐ │
│ │1 2 3 4│ │5 6│ │
│ └~──────┘ └~──┘ │
└∊────────────────┘
</span></div></div>
</div>
<p>Note carefully the fact that <em>Take</em> returns <em>cells</em>, not elements, even if you take 1. Recalling the <a class="reference internal" href="intro.html#document-indexing"><span class="doc std std-doc">indexing</span></a> chapter, <em>Take</em> 1 is equivalent to <em>Squad</em> 0, not <em>Pick</em> 0:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="o">⌷</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span><span class="p">)</span> <span class="c1">⍝ Squad 0 returns a cell</span>
<span class="m">0</span><span class="o">⊃</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span><span class="p">)</span> <span class="c1">⍝ Pick 0 returns an element</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────┐
│ ┌→──────┐ │
│ │1 2 3 4│ │
│ └~──────┘ │
└∊──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
│1 2 3 4│
└~──────┘
</span></div></div>
</div>
<p>We can also use negative numbers to take from the rear:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">¯1</span><span class="o">↑</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span><span class="p">)</span> <span class="c1">⍝ Take 1 from the back</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────────┐
│ ┌→───────┐ │
│ │7 8 9 10│ │
│ └~───────┘ │
└∊───────────┘
</span></div></div>
</div>
<p><em>Drop</em> does what we hopefully expect:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="o">↓</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span><span class="p">)</span>  <span class="c1">⍝ Drop 1 from the front</span>
<span class="m">¯1</span><span class="o">↓</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="m">10</span><span class="p">)</span> <span class="c1">⍝ Drop 1 from the back</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────────────────┐
│ ┌→──┐ ┌→───────┐ │
│ │5 6│ │7 8 9 10│ │
│ └~──┘ └~───────┘ │
└∊─────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────┐
│ ┌→──────┐ ┌→──┐ │
│ │1 2 3 4│ │5 6│ │
│ └~──────┘ └~──┘ │
└∊────────────────┘
</span></div></div>
</div>
<p><em>Take</em> and <em>Drop</em> work on any rank array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">mat</span>
<span class="m">1</span><span class="o">↑</span><span class="nv">mat</span> <span class="c1">⍝ Take first cell</span>
<span class="m">1</span><span class="o">↓</span><span class="nv">mat</span> <span class="c1">⍝ Drop first cell</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓3  0  5 1│
│7  9  8 6│
│2 10 11 4│
└~────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
↓3 0 5 1│
└~──────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓7  9  8 6│
│2 10 11 4│
└~────────┘
</span></div></div>
</div>
</div>
<div class="section" id="index-generator-and-index-of">
<h3>Index generator and Index of: <code class="docutils literal notranslate"><span class="pre">⍳</span></code><a class="headerlink" href="#index-generator-and-index-of" title="Permalink to this headline">¶</a></h3>
<p><em>Iota</em>, <code class="docutils literal notranslate"><span class="pre">⍳</span></code>, called <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Index%20Generator.htm"><em>Index generator</em></a> (or <em>Interval</em>) when used monadically and <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Index%20Of.htm"><em>Index of</em></a> when used dyadically is one to figure out early. Note that there is another glyph that looks similar, <em>iota underbar</em>, <code class="docutils literal notranslate"><span class="pre">⍸</span></code>, that does something entirely different, so don’t confuse the two!</p>
<p>The monadic case generates an integer interval, starting from the currently set <code class="docutils literal notranslate"><span class="pre">⎕IO</span></code> (0 in our case, remember):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────────────┐
│0 1 2 3 4 5 6 7 8 9│
└~──────────────────┘
</span></div></div>
</div>
<p>Thinking of this as a monadic function taking a shape vector, this generalises to more complex shapes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍳</span><span class="m">3</span> <span class="m">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────┐
↓ ┌→──┐ ┌→──┐ ┌→──┐ ┌→──┐ │
│ │0 0│ │0 1│ │0 2│ │0 3│ │
│ └~──┘ └~──┘ └~──┘ └~──┘ │
│ ┌→──┐ ┌→──┐ ┌→──┐ ┌→──┐ │
│ │1 0│ │1 1│ │1 2│ │1 3│ │
│ └~──┘ └~──┘ └~──┘ └~──┘ │
│ ┌→──┐ ┌→──┐ ┌→──┐ ┌→──┐ │
│ │2 0│ │2 1│ │2 2│ │2 3│ │
│ └~──┘ └~──┘ └~──┘ └~──┘ │
└∊────────────────────────┘
</span></div></div>
</div>
<p>In other words, <em>iota</em> generates all possible <em>indices</em> into an array with the shape of its argument.</p>
<p>In the dyadic form, <em>iota</em> becomes <em>Index of</em>, another useful thing to know. <em>Index of</em> tells us the index of the first occurrence of an element:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Hello world&#39;</span><span class="o">⍳</span><span class="s1">&#39;o&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
4

</span></div></div>
</div>
<p>The right argument can have any shape, but the left argument is usually a vector.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Hello world&#39;</span><span class="o">⍳</span><span class="s1">&#39;od&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───┐
│4 10│
└~───┘
</span></div></div>
</div>
<p>A nifty feature is that if the right element isn’t found, the returned index is <code class="docutils literal notranslate"><span class="pre">1+≢⍺</span></code> – one more than the length of the left argument. This can be used to provide a default match for items not found:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">staff</span> <span class="kd">←</span> <span class="s1">&#39;Adam&#39;</span> <span class="s1">&#39;Bob&#39;</span> <span class="s1">&#39;Charlotte&#39;</span>
<span class="nv">lookup</span> <span class="kd">←</span> <span class="nv">staff</span><span class="o">,⊂</span><span class="s1">&#39;Not found&#39;</span>
<span class="nv">lookup</span><span class="sr">[</span><span class="nv">staff</span><span class="o">⍳</span><span class="s1">&#39;Bob&#39;</span> <span class="s1">&#39;David&#39;</span><span class="sr">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────────────────────────┐
│ ┌→───┐ ┌→──┐ ┌→────────┐ │
│ │Adam│ │Bob│ │Charlotte│ │
│ └────┘ └───┘ └─────────┘ │
└∊─────────────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────────────┐
│ ┌→──┐ ┌→────────┐ │
│ │Bob│ │Not found│ │
│ └───┘ └─────────┘ │
└∊──────────────────┘
</span></div></div>
</div>
</div>
<div class="section" id="where-interval-index">
<h3>Where, Interval Index: <code class="docutils literal notranslate"><span class="pre">⍸</span></code><a class="headerlink" href="#where-interval-index" title="Permalink to this headline">¶</a></h3>
<p>Iota-underbar, <code class="docutils literal notranslate"><span class="pre">⍸</span></code>, is <a class="reference external" href="http://help.dyalog.com/latest/index.htm#Language/Primitive%20Functions/Where.htm"><em>Where</em></a> as a monad, and <a class="reference external" href="http://help.dyalog.com/latest/index.htm#Language/Primitive%20Functions/Interval%20Index.htm"><em>Interval Index</em></a> as a dyad.</p>
<p><em>Where</em> gives the indices of an array where the value is non-zero. For example,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍸</span><span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────┐
│0 3 5 7 8 9 11 13│
└~────────────────┘
</span></div></div>
</div>
<p>This can be combined with indexing to select a subset that matches some criterion:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span><span class="kd">←</span><span class="nv">nums</span><span class="kd">←</span><span class="o">⍳</span><span class="m">20</span>
<span class="nv">nums</span><span class="sr">[</span><span class="o">⍸</span><span class="m">0</span><span class="o">=</span><span class="m">5</span><span class="o">|</span><span class="nv">nums</span><span class="sr">]</span> <span class="c1">⍝ Find all numbers divisible by 5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────────────────────────────┐
│0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19│
└~────────────────────────────────────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
│0 5 10 15│
└~────────┘
</span></div></div>
</div>
<p>It works for any rank, of course:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span>
<span class="o">⍸</span><span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓1 0 0│
│1 1 0│
│0 1 0│
└~────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────┐
│ ┌→──┐ ┌→──┐ ┌→──┐ ┌→──┐ │
│ │0 0│ │1 0│ │1 1│ │2 1│ │
│ └~──┘ └~──┘ └~──┘ └~──┘ │
└∊────────────────────────┘
</span></div></div>
</div>
<p>You probably expected that. Perhaps more surprising is that the right argument array does not have to be Boolean:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍸</span><span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">2</span> <span class="m">0</span> <span class="m">3</span> <span class="m">0</span> <span class="m">4</span> <span class="m">0</span> <span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────────┐
│1 3 3 5 5 5 7 7 7 7 9 9 9 9 9│
└~────────────────────────────┘
</span></div></div>
</div>
<p>It still finds the indices of non-zero elements, but this time it uses the element itself as the repeat count. In the result in example above, we have a single 1, as the right argument array has a 1 at index 1. We have four 7s, as the array has a 4 in index 7.</p>
<p>When used dyadically, we have <em>interval index</em>. Interval index is a <em>binning algorithm</em> – given a set of ranged bins in order, it picks the bin corresponding to the arguments. Here’s how it works:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">3</span> <span class="m">5</span> <span class="m">7</span> <span class="m">9</span><span class="o">⍸</span><span class="m">8</span> <span class="m">9</span> <span class="m">0</span>  <span class="c1">⍝ bin 8, 9 and 0 over the intervals 1 3 5 7 9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────┐
│3 4 ¯1│
└~─────┘
</span></div></div>
</div>
<p>Consider the gaps between the elements to the left. The first interval is then [1, 3), the second is [3, 5), the third is [5, 7) etc. An element belongs to the bin where it is greater than or equal to the lower end, and less than the upper end.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">3</span> <span class="m">5</span> <span class="m">7</span> <span class="m">9</span><span class="o">⍸</span><span class="m">5</span>      <span class="c1">⍝ elements on on boundary goes in the higher bin</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
2

</span></div></div>
</div>
<p>As we saw above, elements smaller than the first bin goes in the -1 bin, which is assumed to cover every number lower than the first bin. Similarly, elements greater than the last bin will end up with a bin number equal to the number of elements (note: not the number of bins) to the left:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="m">5</span> <span class="m">7</span> <span class="m">9</span><span class="o">⍸</span><span class="m">0</span> <span class="m">100</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───┐
│¯1 3│
└~───┘
</span></div></div>
</div>
<p>It works for other types, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;AEIOU&#39;</span><span class="o">⍸</span><span class="s1">&#39;HELLO WORLD&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────────────────────┐
│1 1 2 2 3 ¯1 4 3 3 2 0│
└~─────────────────────┘
</span></div></div>
</div>
<p>In other words, “H” comes on or after “E” but not after “I”, “E” is on or after “E” etc.</p>
<p>Typical use cases for <em>bin search</em> involves various kinds of classification. For example, in the UK, alcoholic beverages are <a class="reference external" href="https://www.gov.uk/government/publications/uk-trade-tariff-excise-duties-reliefs-drawbacks-and-allowances/uk-trade-tariff-excise-duties-reliefs-drawbacks-and-allowances">taxed</a> based on their <em>alcohol by volume</em> (abv) percentage. Let’s consider cider and perry:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Class or description</p></th>
<th class="text-align:right head"><p>Tax type code</p></th>
<th class="text-align:right head"><p>Rate of excise duty/hl</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>abv does not exceed 1.2%</p></td>
<td class="text-align:right"><p>431</p></td>
<td class="text-align:right"><p>£0</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>abv exceeding 1.2% but less than 6.9%</p></td>
<td class="text-align:right"><p>481</p></td>
<td class="text-align:right"><p>£40.38</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>abv at least 6.9% but not exceeding 7.5%</p></td>
<td class="text-align:right"><p>487</p></td>
<td class="text-align:right"><p>£50.71</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>abv at least 7.5% but not exceeding 8.5%</p></td>
<td class="text-align:right"><p>483</p></td>
<td class="text-align:right"><p>£61.04</p></td>
</tr>
</tbody>
</table>
<p>Given the following ciders with the associated abv, what are their respective tax code and tax rate per hecto-litre?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">ciders</span><span class="kd">←</span><span class="s1">&#39;Kopparberg Sparkling Rose&#39;</span> <span class="s1">&#39;Bulmers Original&#39;</span> <span class="s1">&#39;Crispin the Jacket&#39;</span> <span class="s1">&#39;Old Mout Cherries &amp; Berries&#39;</span>
<span class="nv">abv</span><span class="kd">←</span><span class="m">7.0</span> <span class="m">4.5</span> <span class="m">8.3</span> <span class="m">0.0</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s encode the table above into a set of vectors first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">code</span><span class="kd">←</span><span class="m">431</span> <span class="m">481</span> <span class="m">487</span> <span class="m">486</span>
<span class="nv">rate</span><span class="kd">←</span><span class="m">0</span> <span class="m">40.38</span> <span class="m">50.71</span> <span class="m">61.04</span>
<span class="nv">limits</span><span class="kd">←</span><span class="m">1.2</span> <span class="m">6.9</span> <span class="m">7.5</span> <span class="m">8.5</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s find the bins from the limits, and add one to capture the -1 bin appropriately:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span><span class="kd">←</span><span class="nv">bin</span><span class="kd">←</span><span class="m">1</span><span class="o">+</span><span class="nv">limits</span><span class="o">⍸</span><span class="nv">abv</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
│2 1 3 0│
└~──────┘
</span></div></div>
</div>
<p>Now we can lay this out nicely,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍕</span><span class="p">(</span><span class="s1">&#39;Name&#39;</span> <span class="s1">&#39;Rate&#39;</span> <span class="s1">&#39;Code&#39;</span><span class="p">)</span><span class="o">⍪⍉↑</span><span class="p">(</span><span class="nv">ciders</span> <span class="p">(</span><span class="nv">rate</span><span class="sr">[</span><span class="nv">bin</span><span class="sr">]</span><span class="p">)</span> <span class="p">(</span><span class="nv">code</span><span class="sr">[</span><span class="nv">bin</span><span class="sr">]</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────────────────────────────────────────┐
↓ Name                          Rate  Code │
│ Kopparberg Sparkling Rose    50.71   487 │
│ Bulmers Original             40.38   481 │
│ Crispin the Jacket           61.04   486 │
│ Old Mout Cherries &amp; Berries   0      431 │
└──────────────────────────────────────────┘
</span></div></div>
</div>
</div>
<div class="section" id="ravel-catenate-enlist-member">
<h3>Ravel, Catenate, Enlist, Member: <code class="docutils literal notranslate"><span class="pre">,⍪∊</span></code><a class="headerlink" href="#ravel-catenate-enlist-member" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Ravel.htm"><em>Ravel</em></a>, monadic <code class="docutils literal notranslate"><span class="pre">,</span></code> and <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Enlist.htm"><em>Enlist</em></a>, monadic <code class="docutils literal notranslate"><span class="pre">∊</span></code>, do related things: <em>Ravel</em> creates a vector of the major cells of its argument, and <em>Enlist</em> creates a vector of the <em>elements</em> of its argument. For non-nested arrays, there is no difference:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">simple</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴</span><span class="m">3</span> <span class="m">0</span> <span class="m">5</span> <span class="m">1</span> <span class="m">7</span> <span class="m">9</span> <span class="m">8</span> <span class="m">6</span> <span class="m">2</span> <span class="m">10</span> <span class="m">11</span> <span class="m">4</span>
<span class="o">,</span><span class="nv">simple</span> <span class="c1">⍝ Ravel</span>
<span class="o">∊</span><span class="nv">simple</span> <span class="c1">⍝ Enlist</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────┐
│3 0 5 1 7 9 8 6 2 10 11 4│
└~────────────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────┐
│3 0 5 1 7 9 8 6 2 10 11 4│
└~────────────────────────┘
</span></div></div>
</div>
<p>For a nested array, the difference is clearer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">nested</span> <span class="kd">←</span> <span class="o">↑</span><span class="p">((</span><span class="m">2</span> <span class="m">3</span><span class="p">)(</span><span class="m">4</span> <span class="m">5</span><span class="p">))((</span><span class="m">6</span> <span class="m">7</span><span class="p">)(</span><span class="m">8</span> <span class="m">9</span><span class="p">))</span>
<span class="o">,</span><span class="nv">nested</span> <span class="c1">⍝ Ravel</span>
<span class="o">∊</span><span class="nv">nested</span> <span class="c1">⍝ Enlist</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────┐
↓ ┌→──┐ ┌→──┐ │
│ │2 3│ │4 5│ │
│ └~──┘ └~──┘ │
│ ┌→──┐ ┌→──┐ │
│ │6 7│ │8 9│ │
│ └~──┘ └~──┘ │
└∊────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────┐
│ ┌→──┐ ┌→──┐ ┌→──┐ ┌→──┐ │
│ │2 3│ │4 5│ │6 7│ │8 9│ │
│ └~──┘ └~──┘ └~──┘ └~──┘ │
└∊────────────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────────┐
│2 3 4 5 6 7 8 9│
└~──────────────┘
</span></div></div>
</div>
<p>In their dyadic guises, <code class="docutils literal notranslate"><span class="pre">,</span></code> becomes <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Catenate%20Laminate.htm"><em>Catenate</em></a>, and <code class="docutils literal notranslate"><span class="pre">∊</span></code> becomes <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Membership.htm"><em>Membership</em></a>.</p>
<p><em>Catenate</em> merges its left and right arguments:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="o">,</span> <span class="m">5</span> <span class="m">6</span> <span class="s1">&#39;hello&#39;</span>
<span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="o">,</span> <span class="s1">&#39;hello&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────┐
│             ┌→────┐ │
│ 1 2 3 4 5 6 │hello│ │
│             └─────┘ │
└∊────────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────┐
│1 2 3 4 5 6 hello│
└+────────────────┘
</span></div></div>
</div>
<p>The distinction above is perhaps not obvious - and without <code class="docutils literal notranslate"><span class="pre">]box</span> <span class="pre">on</span></code> they would look identical. In the first case, <em>Catenate</em>’s right argument is a nested vector, whereas in the second case, it’s a simple character vector.</p>
<p>Note that <em>Catenate</em> is trailling axis. There is a leading axis version, too, <code class="docutils literal notranslate"><span class="pre">⍪</span></code>, called <em>Laminate</em> – or, perhaps more logically – <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Catenate%20First.htm"><em>Catenate first</em></a>.</p>
<p>We can catenate higher-rank arrays, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">3</span> <span class="m">3</span><span class="o">⍴⍳</span><span class="m">9</span><span class="p">)</span><span class="o">,</span><span class="p">(</span><span class="m">3</span> <span class="m">3</span><span class="o">⍴⍳</span><span class="m">9</span><span class="p">)</span> <span class="c1">⍝ Catenate-last (new cols)</span>
<span class="p">(</span><span class="m">3</span> <span class="m">3</span><span class="o">⍴⍳</span><span class="m">9</span><span class="p">)</span><span class="o">⍪</span><span class="p">(</span><span class="m">3</span> <span class="m">3</span><span class="o">⍴⍳</span><span class="m">9</span><span class="p">)</span> <span class="c1">⍝ Catenate-first/laminate (new rows)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────┐
↓0 1 2 0 1 2│
│3 4 5 3 4 5│
│6 7 8 6 7 8│
└~──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓0 1 2│
│3 4 5│
│6 7 8│
│0 1 2│
│3 4 5│
│6 7 8│
└~────┘
</span></div></div>
</div>
<p>Dyadic <code class="docutils literal notranslate"><span class="pre">∊</span></code> is <em>Membership</em>, another handy glyph in your arsenal:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;l&#39;</span><span class="o">∊</span><span class="s1">&#39;Hello world&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
1

</span></div></div>
</div>
<p>It’s not unlike Python’s <code class="docutils literal notranslate"><span class="pre">in</span></code>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s1">&#39;l&#39;</span> <span class="ow">in</span> <span class="s1">&#39;Hello world&#39;</span>
<span class="go">True</span>
</pre></div>
</div>
<p>at least at a superficial level. The APL version extends naturally to higher-rank arrays:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;lo w&#39;</span><span class="o">∊</span><span class="s1">&#39;Hello world&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
│1 1 1 1│
└~──────┘
</span></div></div>
</div>
<p>whereas Python would see that as <em>is substring</em>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="s1">&#39;lo w&#39;</span> <span class="ow">in</span> <span class="s1">&#39;Hello world&#39;</span>
<span class="go">True</span>
</pre></div>
</div>
<p>You can, of course, get a similar substring behaviour in APL, too, but you need a different approach:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;lo&#39;</span><span class="p">(</span><span class="o">⍸⍷</span><span class="p">)</span><span class="s1">&#39;Hello world&#39;</span> <span class="c1">⍝ Index of start of substring</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→┐
│3│
└~┘
</span></div></div>
</div>
<p>but we need a bit more flesh on our APL bones before we’re ready for that – see the <a class="reference internal" href="intro.html#document-find"><span class="doc std std-doc">Finding things</span></a> section later!</p>
</div>
<div class="section" id="selfie-commute-constant">
<h3>Selfie, Commute, Constant: <code class="docutils literal notranslate"><span class="pre">⍨</span></code><a class="headerlink" href="#selfie-commute-constant" title="Permalink to this headline">¶</a></h3>
<p>A firm favourite, the <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Operators/Commute.htm"><em>Selfie</em></a> (although it’s really called <em>Commute</em>), mirroring the confused look of the APL neophyte: <code class="docutils literal notranslate"><span class="pre">⍨</span></code>. A monadic operator, the selfie commutes the left and right arguments of its operand function. At first, this seems beyond pointless – worse, in fact: it seems to offer nothing but added, deliberate obfuscation:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">v</span> <span class="kd">←</span> <span class="m">6</span> <span class="m">9</span> <span class="m">5</span> <span class="m">2</span> <span class="m">0</span> <span class="m">9</span>
<span class="nv">v</span><span class="o">↑</span><span class="na">⍨</span><span class="m">1</span>     <span class="c1">⍝ Take 1 but commute arguments ⍨</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────┐
│6 9 5 2 0 9│
└~──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→┐
│6│
└~┘
</span></div></div>
</div>
<p>As it turns out, it has its legitimate uses. Consider the consequences of APL’s right to left evaluation order. If you have a dyadic function application with a complex expression to the <em>left</em>, you’re forced to introduce parenthesis to ensure that the left side is fully evaluated before it is passed to the function. The commute operator, by shifting the complex expression to the <em>right</em> side, avoids this.</p>
<p>Compare the following two equivalent forms (disregarding for the moment what they mean):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⊂</span><span class="na">⍨</span><span class="m">1</span><span class="o">,</span><span class="m">2</span><span class="o">≠</span><span class="na">/</span><span class="bp">⍵</span><span class="kt">}</span>
<span class="kt">{</span><span class="p">(</span><span class="m">1</span><span class="o">,</span><span class="m">2</span><span class="o">≠</span><span class="na">/</span><span class="bp">⍵</span><span class="p">)</span><span class="o">⊂</span><span class="bp">⍵</span><span class="kt">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">{⍵⊂⍨1,2≠/⍵}
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">{(1,2≠/⍵)⊂⍵}
</span></div></div>
</div>
<p>So you could say “big deal, <em>one</em> glyph fewer to type”, and you’d have a point. But the main advantage is that, by commuting, we preserve the right-to-left evaluation order. By having parenthesised part of the expression, we have an unnatural evaluation order. With a few well-placed selfies we can read the expression as Ken intended.</p>
<p>As with anything, there’s a balance to be struck here. For the learner, selfies do make expressions harder, not easier, to read. The process of “flipping selfied expressions” occasionally helps when trying to deconstruct something someone else wrote.</p>
<p>If we give no left argument to the dyadic function derived by <em>Selfie</em> we echo the right argument to its left:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">=</span><span class="na">⍨</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
│1 1 1 1 1│
└~────────┘
</span></div></div>
</div>
<p>which is the same as saying:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="o">=</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
│1 1 1 1 1│
└~────────┘
</span></div></div>
</div>
<p>If APL didn’t already have a <em>Tally</em> function built in (<code class="docutils literal notranslate"><span class="pre">≢</span></code>) we could make one as the sum-reduction of self-equals to count the number of elements in a vector, say:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">tally</span> <span class="kd">←</span> <span class="o">+</span><span class="na">/</span><span class="o">=</span><span class="na">⍨</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">tally</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
5

</span></div></div>
</div>
<p>If <em>Selfie</em> is given an <em>array</em> operand, it becomes <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Operators/Constant.htm"><em>Constant</em></a>: it always returns its operand:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="na">⍨</span> <span class="m">2</span>
<span class="m">3</span> <span class="p">(</span><span class="m">1</span><span class="na">⍨</span><span class="p">)</span> <span class="m">2</span>
<span class="m">1</span><span class="na">⍨</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span>
<span class="m">1</span><span class="na">⍨¨</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
1

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
1

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
1

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
│1 1 1 1│
└~──────┘
</span></div></div>
</div>
<p>You can be excused for thinking that this is pretty pointless, but you’d be surprised how handy it can be. For example, you often find yourself wanting to create a vector of all the same value matching the shape of some other array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">9</span><span class="o">?</span><span class="m">9</span> 
<span class="m">5</span><span class="na">⍨¨</span><span class="nv">m</span> <span class="c1">⍝ Make an array that looks like m, but will all elements 5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓0 6 3│
│2 5 1│
│4 7 8│
└~────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓5 5 5│
│5 5 5│
│5 5 5│
└~────┘
</span></div></div>
</div>
<p>There are many other ways we could achieve the same thing, for example</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">5</span><span class="o">⍴</span><span class="na">⍨</span><span class="o">⍴</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓5 5 5│
│5 5 5│
│5 5 5│
└~────┘
</span></div></div>
</div>
<p>but if you pronounce <code class="docutils literal notranslate"><span class="pre">5⍨¨m</span></code> as “constant 5 for each element in <code class="docutils literal notranslate"><span class="pre">m</span></code>” it matches the problem description nicely.</p>
</div>
<div class="section" id="unique-union-intersection-without">
<h3>Unique, Union, Intersection, Without: <code class="docutils literal notranslate"><span class="pre">∪∩~</span></code><a class="headerlink" href="#unique-union-intersection-without" title="Permalink to this headline">¶</a></h3>
<p>We have the full complement of set operations at our disposal. Starting with <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Unique.htm"><em>Unique</em></a>, monadic <code class="docutils literal notranslate"><span class="pre">∪</span></code>, it does exactly what it says on the tin:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">∪</span><span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">2</span> <span class="m">3</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">5</span> <span class="m">5</span> <span class="m">6</span> <span class="m">6</span>
<span class="o">∪</span><span class="s1">&#39;hello world&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────┐
│1 2 3 4 5 6│
└~──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────┐
│helo wrd│
└────────┘
</span></div></div>
</div>
<p>In its dyadic version, <code class="docutils literal notranslate"><span class="pre">∪</span></code> becomes <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Union.htm"><em>Union</em></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="o">∪</span> <span class="m">1</span> <span class="m">2</span> <span class="m">5</span> <span class="m">6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────┐
│1 1 2 3 4 5 6│
└~────────────┘
</span></div></div>
</div>
<p>Note that the arguments aren’t proper sets. The above says “take ALL elements in the left argument, and add any element from the right which isn’t already present”.</p>
<p><a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Intersection.htm"><em>Intersection</em></a>, dyadic <code class="docutils literal notranslate"><span class="pre">∩</span></code>, works similarly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="o">∩</span> <span class="m">1</span> <span class="m">2</span> <span class="m">5</span> <span class="m">6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
│1 1 2│
└~────┘
</span></div></div>
</div>
<p>For each element to the left, keep it if it’s also in the right.</p>
<p>Dyadic <code class="docutils literal notranslate"><span class="pre">~</span></code> is <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Excluding.htm"><em>Without</em></a> – set difference:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="o">~</span> <span class="m">1</span> <span class="m">3</span> <span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──┐
│2 4│
└~──┘
</span></div></div>
</div>
<p>The monadic <code class="docutils literal notranslate"><span class="pre">~</span></code> is Boolean <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Not.htm"><em>Not</em></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">~</span><span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────┐
│0 1 0 0 1 1 0│
└~────────────┘
</span></div></div>
</div>
</div>
<div class="section" id="grade-up-down">
<h3>Grade up/down: <code class="docutils literal notranslate"><span class="pre">⍋⍒</span></code><a class="headerlink" href="#grade-up-down" title="Permalink to this headline">¶</a></h3>
<p>To me, it’s a Christmas tree and a carrot, but these twins are called <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Grade%20Up%20Monadic.htm"><em>Grade up</em></a> (<code class="docutils literal notranslate"><span class="pre">⍋</span></code>) and <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Grade%20Down%20Monadic.htm"><em>Grade down</em></a> (<code class="docutils literal notranslate"><span class="pre">⍒</span></code>). They are APL’s very clever mechanisms for ordering arrays. To sort an array, we do:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">data</span> <span class="kd">←</span> <span class="m">110</span> <span class="m">109</span> <span class="m">204</span> <span class="m">40</span> <span class="m">105</span> <span class="m">201</span> <span class="m">2</span> <span class="m">208</span> <span class="m">160</span> <span class="m">143</span> <span class="m">213</span> <span class="m">31</span> <span class="m">21</span> <span class="m">317</span> <span class="m">132</span> <span class="m">242</span> <span class="m">164</span> <span class="m">176</span> <span class="m">67</span> <span class="m">18</span> <span class="m">75</span> <span class="m">89</span> <span class="m">18</span> <span class="m">7</span> <span class="m">20</span>
<span class="nv">data</span><span class="sr">[</span><span class="o">⍋</span><span class="nv">data</span><span class="sr">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────────────────────────────────────────────────────────────────────────────────────┐
│110 109 204 40 105 201 2 208 160 143 213 31 21 317 132 242 164 176 67 18 75 89 18 7 20│
└~─────────────────────────────────────────────────────────────────────────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────────────────────────────────────────────────────────────────────────────────────┐
│2 7 18 18 20 21 31 40 67 75 89 105 109 110 132 143 160 164 176 201 204 208 213 242 317│
└~─────────────────────────────────────────────────────────────────────────────────────┘
</span></div></div>
</div>
<p>So what does the <em>Grade-up</em> actually do? Let’s have a look:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍋</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────────────────────────────────────────────────────────────┐
│6 23 19 22 24 12 11 3 18 20 21 4 1 0 14 9 8 16 17 5 2 7 10 15 13│
└~───────────────────────────────────────────────────────────────┘
</span></div></div>
</div>
<p>Grading an array (up or down) produces a set of <em>indices</em>, not values. Consider the first element in the grade array. It says: the smallest element is to be found at index 6. The second-smallest is at index 23. The third smallest at index 19 etc.</p>
<p>At first blush, this seems like a roundabout way to sort something. First generate an indexing expression, then select elements according to this indexing expression. However, doing it this way – separating the determining of the order from the reordering of elements – has a number of advantages, chiefly that we can as easily apply the ordering to another array, not just the one that we generated the ordering from.</p>
<p>In any sort of data processing or analysis, this crops up all the time: give the customer names, ordered by contract date. Sort the keys based on the values. That sort of thing. You can also answer questions such as <em>where</em> is the smallest value?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">minidx</span> <span class="kd">←</span> <span class="o">⊃⍋</span><span class="nv">data</span> <span class="c1">⍝ Index of smallest value: first element of Grade-up</span>
<span class="nv">data</span><span class="sr">[</span><span class="nv">minidx</span><span class="sr">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
6

</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 
2

</span></div></div>
</div>
</div>
</div>
<span id="document-functions"></span><div class="tex2jax_ignore mathjax_ignore section" id="direct-functions-and-operators">
<h2>Direct functions and operators<a class="headerlink" href="#direct-functions-and-operators" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>I made up the term “object-oriented,” and I can tell you I did not have C++ in mind.
–<em>Alan Kay</em></p>
</div></blockquote>
<p>Until now, we’ve mainly used APL as a toolkit for array manipulation using its built-in primitives. Sure, it goes a long way, but to fully take advantage of it, we also need to be able to create our own functions and operators. Fortunately, the syntax – if we can even call it that – for user-defined functions, is super-simple. As someone said on the APL Orchard chat room, all you need to do is “slap curly braces around your code, and you’re done”. It’s not <em>quite</em> that simple, but not too far off.</p>
<p>The definition of a <em>dfn</em> (direct function) is enclosed in a pair of curly braces. It’s what’s known as an anonymous function, or a lambda, in other languages, meaning that there is no syntactic sugar for naming a function beyond ordinary assignment using <em>Gets</em>, <code class="docutils literal notranslate"><span class="pre">←</span></code>:</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="nv">name</span> <span class="kd">←</span> <span class="kt">{</span> 
   <span class="c1">⍝ expressions</span>
<span class="kt">}</span>
</pre></div>
</div>
<p>First a bit of unavoidable <a class="reference external" href="https://xkcd.com/349/">yak shaving</a>: if a dfn fits entirely on a single line, you can type it out directly in the RIDE IDE. So far, so expected. If your dfn extends across multiple lines, you can’t (at the time of writing) just type it in. Dyalog is working on enhancing this.</p>
<p>Instead, the most convenient way to enter such a function is to say</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>)ed name
</pre></div>
</div>
<p>if you want to create a function called <code class="docutils literal notranslate"><span class="pre">name</span></code>. RIDE will open its function editor and let you enter your code there. Once you want to test your function, you first need to save it, which in APL-speak is called “to fix your function”. The default way (and you’re unlikely to ever discover this by yourself) to fix (save) your function is to hit <kbd>esc</kbd>. Yes, really. Fortunately – and I recommend you do so right now – RIDE allows you to re-bind keystrokes by clicking on the little keyboard symbol in the top-right corner.</p>
<p>Locate the row that says “Fix the current function” and map that to the key combo that is <code class="docutils literal notranslate"><span class="pre">save</span></code> on your platform. And whilst you’re there, make a note of the keys binding to “Forward” and “Backward” – they default to <kbd>ctrl-shift-enter</kbd> and <kbd>ctrl-shift-backspace</kbd>. In the REPL, these mean forward/back in the history of executed lines, like the arrow keys in the shell. The arrow keys instead move up and down spatially, in the <em>output</em>, still, to me an incomprehensible design decision. You might also want to rebind “Strong interrupt” to <kbd>ctrl-c</kbd> while you’re at it.</p>
<p>The other thing to note is that in RIDE there is no visual cue that an editor window contains unsaved changes. This is sure to bite you sooner or later.</p>
<p>In a Jupyter notebook, like here, entering functions might feel a bit more familiar: just type them into a cell. The only quirk is that in order to enter a multi-line dfn, you need to start the cell with <code class="docutils literal notranslate"><span class="pre">]dinput</span></code> (which isn’t needed in a RIDE edit window). You <em>can</em> actually use the <code class="docutils literal notranslate"><span class="pre">]dinput</span></code> way of entering a multi-line function in the interpreter REPL, too, but (in my opinion) it’s rather cumbersome unless you’re just cutting and pasting from somewhere else. In the upcoming (at the time of writing) version 18.1 there is experimental support for being able to type in multi-line functions directly in the REPL, similar to how that works in Python’s REPL.</p>
<p>First, our now familiar prelude:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<p>We’re also going to make some assertions, so let’s have a helper function for that, courtesy of APL legend Roger Hui (and not speculating on its inner workings for now):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">assert</span> <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍺</span> <span class="kd">←</span> <span class="s1">&#39;assertion failure&#39;</span> <span class="p">⋄</span> <span class="m">0</span><span class="o">∊</span><span class="bp">⍵:</span> <span class="bp">⍺</span> <span class="nf">⎕signal</span> <span class="m">8</span> <span class="p">⋄</span> <span class="nv">shy</span> <span class="kd">←</span> <span class="m">0</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="left-and-right-arguments">
<h3>Left and right arguments: <code class="docutils literal notranslate"><span class="pre">⍺</span></code>, <code class="docutils literal notranslate"><span class="pre">⍵</span></code><a class="headerlink" href="#left-and-right-arguments" title="Permalink to this headline">¶</a></h3>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">MyFirstFunction</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="c1">⍝ Add left and right</span>
    <span class="bp">⍺</span><span class="o">+</span><span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">32</span> <span class="nv">MyFirstFunction</span> <span class="m">98</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">130
</span></div></div>
</div>
<p>The first thing to note is the glyphs <code class="docutils literal notranslate"><span class="pre">⍺</span></code> and <code class="docutils literal notranslate"><span class="pre">⍵</span></code>; the Greek letters alpha and omega. Alpha, the first letter of the Greek alphabet, is bound to the function’s left argument, and omega, the last letter of the Greek alphabet, is bound to the function’s right argument.</p>
<p>The second thing to learn is that APL expressions are separated by newline (or the diamond glyph, <code class="docutils literal notranslate"><span class="pre">⋄</span></code> which we’ll get to later). We could rewrite the above function to use an intermediate variable:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Sum</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="c1">⍝ Add left and right</span>
    <span class="nv">total</span> <span class="kd">←</span> <span class="bp">⍺</span><span class="o">+</span><span class="bp">⍵</span>
    <span class="nv">total</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">32</span> <span class="nv">Sum</span> <span class="m">98</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">130
</span></div></div>
</div>
<p>The third thing is that there is no “return” statement. The function returns the first non-assigned value. It’s worth letting this sink in: a function returns at the first point you do anything that isn’t an assignment. In the function above, the return point is us just stating the variable <code class="docutils literal notranslate"><span class="pre">total</span></code>.</p>
</div>
<div class="section" id="default-left-argument">
<h3>Default left argument<a class="headerlink" href="#default-left-argument" title="Permalink to this headline">¶</a></h3>
<p>A useful feature is that you can set a default value for the left argument, <code class="docutils literal notranslate"><span class="pre">⍺</span></code>. Compare:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍺</span> <span class="kd">←</span> <span class="m">¯99</span> <span class="p">⋄</span> <span class="bp">⍺</span><span class="o">+</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">99</span>
<span class="m">57</span> <span class="kt">{</span><span class="bp">⍺</span> <span class="kd">←</span> <span class="m">¯99</span> <span class="p">⋄</span> <span class="bp">⍺</span><span class="o">+</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">99</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">156
</span></div></div>
</div>
<p>This way a function can behave in different ways depending on if it is called monadically or dyadically. If you give a value to <code class="docutils literal notranslate"><span class="pre">⍺</span></code> with <code class="docutils literal notranslate"><span class="pre">←</span></code>, then <code class="docutils literal notranslate"><span class="pre">⍺</span></code> will have this value if you didn’t pass a left argument to the function. On the other hand, if you <em>do</em> pass a left argument, the “alpha gets” line has no effect. When defaulting the left argument this way, note that this only works for the <em>first</em> time you give a value to alpha, which is perhaps obvious when you think of it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍺</span> <span class="kd">←</span> <span class="m">¯99</span> <span class="p">⋄</span> <span class="bp">⍺</span> <span class="kd">←</span> <span class="m">¯999999</span> <span class="p">⋄</span> <span class="bp">⍺</span><span class="o">+</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">99</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div></div>
</div>
<p>Setting a default value for the left argument is a useful tool if you write recursive dfns, which typically accumulate their result on the left argument. This way you can call the function monadically to start, but subsequent iterations can use the left argument to build up the result. We’ll talk more about recursion later in the chapter on <a class="reference internal" href="intro.html#document-iteration"><span class="doc std std-doc">iteration techniques</span></a>, but here’s a taster to demonstrate the default left argument technique. The glyph <em>Del</em> (<code class="docutils literal notranslate"><span class="pre">∇</span></code>) is a reference to the innermost function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">sum</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="bp">⍺</span> <span class="kd">←</span> <span class="m">0</span>       <span class="c1">⍝ Initialise the accumulator</span>
    <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:⍺</span>      <span class="c1">⍝ If right arg empty vector, return accumulator, see below!</span>
    <span class="p">(</span><span class="bp">⍺</span><span class="o">+⊃</span><span class="bp">⍵</span><span class="p">)</span><span class="bp">∇</span><span class="m">1</span><span class="o">↓</span><span class="bp">⍵</span>  <span class="c1">⍝ Add head to accumulator, recurse over tail</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">sum</span> <span class="o">⍳</span><span class="m">10</span>
<span class="m">100</span> <span class="nv">sum</span> <span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">45
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">145
</span></div></div>
</div>
</div>
<div class="section" id="alternation">
<h3>Alternation<a class="headerlink" href="#alternation" title="Permalink to this headline">¶</a></h3>
<p>What about alternation? We got a brief view of a conditional return in the example just above – a <a class="reference external" href="https://help.dyalog.com/latest/#Language/Defined%20Functions%20and%20Operators/DynamicFunctions/Guards.htm"><em>guard statement</em></a>. Recall that there is no if-statement for us. A <em>guard</em>, defined with a colon, says, if the expression to the left of the colon is true, return from the function with the value to the right of the colon. A contrived example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Palinish</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">rev</span> <span class="kd">←</span> <span class="o">⊖</span><span class="bp">⍵</span> <span class="c1">⍝ Reverse the right arg</span>
    <span class="nv">rev</span><span class="o">≡</span><span class="bp">⍵:</span> <span class="m">1</span> <span class="c1">⍝ If right arg matches its own reverse, return 1</span>
    <span class="m">0</span>        <span class="c1">⍝ Else, return 0</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Palinish</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span>
<span class="nv">Palinish</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span>
<span class="nv">Palinish</span> <span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div></div>
</div>
<p>For the avoidance of doubt, we could of course have written that as</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">≡⊖</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span> <span class="c1">⍝ Anonymous (unnamed) version</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div></div>
</div>
<p>Note that execution flow does <em>not</em> carry on after a guard expression, even if that was an assignment. This requires some thought when writing code that needs to conditionally “do something” and then carry on, as illustrated in the following meaningless Python-like snippet:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">foo</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="n">fum</span> <span class="o">=</span> <span class="mi">57</span>
    <span class="n">fee</span> <span class="o">=</span> <span class="mi">8</span>
    <span class="k">if</span> <span class="n">flerp</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">47</span><span class="p">:</span>
        <span class="n">fee</span> <span class="o">=</span> <span class="mi">92</span>
        <span class="n">fum</span> <span class="o">=</span> <span class="n">flumm</span><span class="p">(</span><span class="n">arg</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">fee</span> <span class="o">+</span> <span class="n">fum</span>
</pre></div>
</div>
<p>Actually, we can turn that into APL trivially, using only what we already know:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">foo</span> <span class="kd">←</span> <span class="kt">{</span><span class="m">47</span><span class="o">&gt;</span><span class="nv">flerp</span> <span class="bp">⍵:</span> <span class="m">92</span><span class="o">+</span><span class="nv">flumm</span> <span class="bp">⍵</span> <span class="p">⋄</span> <span class="m">57</span><span class="o">+</span><span class="m">8</span><span class="kt">}</span> <span class="c1">⍝ Note: diamond separator</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s investigate some possible patterns for achieving a flow where execution carries on following an “if-then-else” branch. On way is to use an anonymous function, in essence like Python’s</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">a</span> <span class="o">=</span> <span class="mi">42</span> <span class="k">if</span> <span class="n">answer</span> <span class="k">else</span> <span class="o">-</span><span class="mi">99</span>
</pre></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">foo</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">answer</span> <span class="kd">←</span> <span class="bp">⍵</span>
    <span class="nv">a</span> <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍵:</span><span class="m">42</span> <span class="p">⋄</span> <span class="m">¯99</span><span class="kt">}</span> <span class="nv">answer</span>
    <span class="c1">⍝ ...execution follows here</span>
    <span class="c1">⍝ do something with a</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>In this case, as <code class="docutils literal notranslate"><span class="pre">answer</span></code> is a boolean, we could have avoided the inner function entirely by simply picking the values from a 2-element vector (note: need <code class="docutils literal notranslate"><span class="pre">⎕IO←0</span></code> for this to work):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">foo</span> <span class="kd">←</span> <span class="kt">{</span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">0</span>
    <span class="nv">answer</span> <span class="kd">←</span> <span class="bp">⍵</span>
    <span class="nv">a</span> <span class="kd">←</span> <span class="nv">answer</span><span class="o">⊃</span><span class="m">¯99</span> <span class="m">42</span>
    <span class="c1">⍝ ...execution follows here</span>
    <span class="c1">⍝ do something with a</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>With the first technique (the anonymous function) we have scope to extend the work done in each branch by making the function more complex, but ultimately it still returns a value. What if we need to modify multiple values? We could of course return an array of things, that’s a perfectly valid approach.</p>
<p>Name scoping rules in Dyalog are a mixture between dynamic and lexical scope. Here’s what Dyalog’s <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Defined%20Functions%20and%20Operators/DynamicFunctions/Static%20Name%20Scope.htm">docs</a> say about it:</p>
<blockquote>
<div><p>When an inner (nested) dfn refers to a name, the interpreter searches for it by looking outwards through enclosing dfns, rather than searching back along the state indicator.</p>
</div></blockquote>
<p>Lexical scope is almost certainly “what you expect”. However, as Dyalog has no dedicated syntax for declaring a variable beyond giving it a value, if you need to modify a variable not introduced in the innermost dfn, we need a way to indicate this.</p>
<p>Consider the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">foo</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">a</span> <span class="kd">←</span> <span class="m">45</span>
    <span class="nv">_</span> <span class="kd">←</span> <span class="kt">{</span><span class="nv">a</span><span class="kd">←</span><span class="m">¯99</span><span class="kt">}</span><span class="no">⍬</span>
    <span class="nv">a</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">foo</span> <span class="no">⍬</span> <span class="c1">⍝ Note: 45, not ¯99</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">45
</span></div></div>
</div>
<p>The innermost function creates a <em>new</em> variable with lexical scope, with the name <em>a</em>. So how <em>do</em> you modify state defined outside a function? This is where <em>modified assignment</em> comes in.</p>
</div>
<div class="section" id="modified-assignment">
<h3>Modified Assignment<a class="headerlink" href="#modified-assignment" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/Assignment%20Modified.htm"><em>Modified assignment</em></a> should feel familiar to any C or Python programmers amongst you:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># Modified assignment, Python-style</span>
<span class="n">a</span> <span class="o">=</span> <span class="mi">45</span>
<span class="n">a</span> <span class="o">+=</span> <span class="mi">45</span> <span class="c1"># a is now 90</span>
</pre></div>
</div>
<p>In APL, we can also modify an existing variable’s value via a function, for example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">foo</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">a</span> <span class="kd">←</span> <span class="m">45</span>
    <span class="nv">_</span> <span class="kd">←</span> <span class="kt">{</span><span class="nv">a</span> <span class="o">+</span><span class="kd">←</span> <span class="m">45</span><span class="kt">}</span><span class="no">⍬</span>
    <span class="nv">a</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">r</span> <span class="kd">←</span> <span class="nv">foo</span> <span class="no">⍬</span>
<span class="nv">assert</span> <span class="nv">r</span><span class="o">=</span><span class="m">90</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">90
</span></div></div>
</div>
<p>The supremely useful, but perhaps non-intuitive kicker: you can use modified assignment with <em>Right tack</em> (<code class="docutils literal notranslate"><span class="pre">⊢</span></code>) to <em>set</em> values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">foo</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">a</span> <span class="kd">←</span> <span class="m">45</span>
    <span class="nv">_</span> <span class="kd">←</span> <span class="kt">{</span><span class="nv">a</span> <span class="o">⊢</span><span class="kd">←</span> <span class="m">¯99</span><span class="kt">}</span><span class="no">⍬</span>
    <span class="nv">a</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">r</span> <span class="kd">←</span> <span class="nv">foo</span> <span class="no">⍬</span>
<span class="nv">assert</span> <span class="nv">r</span><span class="o">=</span><span class="m">¯99</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">¯99
</span></div></div>
</div>
<p>We’ve already met a bunch of <a class="reference external" href="http://help.dyalog.com/18.0/Content/Language/Primitive%20Functions/Assignment%20Selective.htm#SelectiveAssignment">selectable assignment</a> expressions when we talked about <a class="reference internal" href="intro.html#document-indexing"><span class="doc std std-doc">indexing</span></a>. We can use all of those here. For example, we can mutate cells in a matrix using bracket indexing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">foo</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">a</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">1</span> <span class="c1">⍝ 3×3 matrix of all 1</span>
    <span class="nv">_</span> <span class="kd">←</span> <span class="kt">{</span><span class="nv">a</span><span class="sr">[</span><span class="m">1</span><span class="sr">;</span><span class="m">1</span><span class="sr">]</span> <span class="kd">←</span> <span class="m">0</span><span class="kt">}</span><span class="no">⍬</span>
    <span class="nv">a</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">r</span> <span class="kd">←</span> <span class="nv">foo</span> <span class="no">⍬</span>
<span class="nv">assert</span> <span class="nv">r</span><span class="o">≡</span><span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1 1
1 0 1
1 1 1
</span></div></div>
</div>
</div>
<div class="section" id="direct-operators">
<h3>Direct operators<a class="headerlink" href="#direct-operators" title="Permalink to this headline">¶</a></h3>
<p>We’ve met some of APL’s built-in operators already, like <em>Reduce</em> and <em>Selfie</em>. Operators are perhaps the closest APL gets to the functional programming paradigm. An <em>operator</em> is a function that returns a derived function. An operator can take other functions as its <em>operands</em>.</p>
<p>Consider <em>Reduce</em>, <code class="docutils literal notranslate"><span class="pre">/</span></code>. It’s a <em>monadic</em> operator that returns a derived function that can be called both monadically and dyadically:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span> <span class="p">(</span><span class="o">+</span><span class="na">/</span><span class="p">)</span> <span class="o">⍳</span><span class="m">10</span> <span class="c1">⍝ Parentheses not required, added for illustrative purposes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 3 5 7 9 11 13 15 17
</span></div></div>
</div>
<p>Here we see the monadic reduction operator, its sole operand being the plus function. The derived function it returns, plus-reduce, is called dyadically, with 2 to its left and <code class="docutils literal notranslate"><span class="pre">⍳10</span></code> to its right. In this case, a windowed reduction. We could have said</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">sumred</span> <span class="kd">←</span> <span class="o">+</span><span class="na">/</span>
<span class="m">2</span> <span class="nv">sumred</span> <span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 3 5 7 9 11 13 15 17
</span></div></div>
</div>
<p>to emphasize the fact that the operator really returns a function.</p>
<p>Dyalog lets us write our own operators, too, in a very similar way to how we write dfns. We call our own operators <a class="reference external" href="https://help.dyalog.com/latest/#Language/Defined%20Functions%20and%20Operators/DynamicFunctions/Dynamic%20Operators.htm"><em>direct operators</em></a>, henceforth just <em>dops</em>. Operators can be powerful, but the need for them actually rarely arises in practice. The reason for this is that the built-in operators already let you apply your own functions in various ways.</p>
<p>A few things to note with operators:</p>
<ul class="simple">
<li><p>In a <em>dop</em>, <code class="docutils literal notranslate"><span class="pre">⍺⍺</span></code> represents the left operand, and <code class="docutils literal notranslate"><span class="pre">⍵⍵</span></code> is the right operand.</p></li>
<li><p>Unlike a monadic <em>dfn</em>, which takes a <em>right</em> argument, a monadic <em>dop</em> takes a <em>left</em> argument, like we just saw in the case of reduce.</p></li>
<li><p>The operator can refer to itself for recursion using <code class="docutils literal notranslate"><span class="pre">∇∇</span></code>, analogously to the dfn’s <code class="docutils literal notranslate"><span class="pre">∇</span></code>.</p></li>
</ul>
<p>Here’s an example monadic dop from the <a class="reference external" href="http://dfns.dyalog.com/n_foldl.htm">dfns</a> workspace, a left-to-right version of reduce:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">foldl</span> <span class="kd">←</span> <span class="kt">{</span>                 <span class="c1">⍝ Fold (reduce) from the left.</span>
    <span class="bp">⍺</span> <span class="kd">←</span> <span class="o">⊃</span><span class="m">0</span><span class="o">⍴</span><span class="bp">⍵</span>              <span class="c1">⍝ Default initial value for accumulator</span>
    <span class="o">↑</span><span class="bp">⍺⍺</span><span class="na">⍨/</span><span class="p">(</span><span class="o">⌽</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,⊂</span><span class="bp">⍺</span>        
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>This implements <code class="docutils literal notranslate"><span class="pre">foldl</span></code> in terms of the standard <code class="docutils literal notranslate"><span class="pre">foldr</span></code> by reversing the list and appending an accumulator element.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="nv">foldl</span> <span class="o">⍳</span><span class="m">10</span>
<span class="o">+</span><span class="na">/</span><span class="o">⍳</span><span class="m">10</span>
<span class="o">-</span><span class="nv">foldl</span> <span class="o">⍳</span><span class="m">10</span>
<span class="o">-</span><span class="na">/</span><span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">45
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">45
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">¯45
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">¯5
</span></div></div>
</div>
<p>This version takes an optional left argument that can be used to initialise the accumulator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">99</span> <span class="o">+</span><span class="nv">foldl</span> <span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">144
</span></div></div>
</div>
<p>Whilst there isn’t anything overly complex about writing your own operators as such, we probably won’t need to use many of them for the rest of this book, but at least now you have seen them.</p>
</div>
</div>
<span id="document-iteration"></span><div class="tex2jax_ignore mathjax_ignore section" id="iteration">
<h2>Iteration<a class="headerlink" href="#iteration" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>As long as I’m alive, APL will never be used in Munich –<em>Fritz Bauer</em><br>
Nor in Holland –<em>Edsger Dijkstra (as told by Alan Perlis)</em></p>
</div></blockquote>
<p>We started all this by claiming that there are no loops in APL. This is of course not entirely true: there are plenty of ways of achieving iteration, some of which are more efficient than others.</p>
<p>In order to get the best possible performance out of APL, it’s worth seeking data-parallel algorithms, typically employing Boolean masks. However, it’s not always possible, or sometimes performance matters less than code complexity, and a more iterative solution can be both clearer and fast enough.</p>
<p>We have at least four, maybe five different kinds of iteration mechanisms at our disposal: <em>Each</em> (<code class="docutils literal notranslate"><span class="pre">¨</span></code>), <em>Reduce</em> (<code class="docutils literal notranslate"><span class="pre">⌿</span></code>), <em>Del</em> (<code class="docutils literal notranslate"><span class="pre">∇</span></code>) and <em>Power</em> (<code class="docutils literal notranslate"><span class="pre">⍣</span></code>). The fifth is that of <em>scalar pervasion</em>, which can either be seen as a way of achieving iteration, or as a way of <em>avoiding</em> iteration, depending on your point of view. Wait, is it six? Maybe we should count <em>Rank</em> (<code class="docutils literal notranslate"><span class="pre">⍤</span></code>), too? <em>Rank</em> deserves its own separate <a class="reference internal" href="intro.html#document-rank"><span class="doc std std-doc">section</span></a>! Oh, and <em>Scan</em> (<code class="docutils literal notranslate"><span class="pre">⍀</span></code>), don’t forget <em>Scan</em>!</p>
<p>Let’s introduce them.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
<span class="nv">assert</span> <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍺</span> <span class="kd">←</span> <span class="s1">&#39;assertion failure&#39;</span> <span class="p">⋄</span> <span class="m">0</span><span class="o">∊</span><span class="bp">⍵:</span> <span class="bp">⍺</span> <span class="nf">⎕signal</span> <span class="m">8</span> <span class="p">⋄</span> <span class="nv">shy</span> <span class="kd">←</span> <span class="m">0</span><span class="kt">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<div class="section" id="each-a-k-a-map">
<h3>Each (a.k.a map): <code class="docutils literal notranslate"><span class="pre">¨</span></code><a class="headerlink" href="#each-a-k-a-map" title="Permalink to this headline">¶</a></h3>
<p>Most languages nowadays have a <code class="docutils literal notranslate"><span class="pre">map</span></code> construct. In fact, it’s occasionally touted – erroneously – as sufficient evidence that a language is “functional” if it has a map function.</p>
<p>Perhaps you’ve seen Python’s somewhat cumbersome version of map:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="gp">&gt;&gt;&gt; </span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="k">lambda</span> <span class="n">x</span><span class="p">:</span> <span class="n">x</span><span class="o">*</span><span class="n">x</span><span class="p">,</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">8</span><span class="p">,</span> <span class="mi">9</span><span class="p">]))</span> <span class="c1"># Square elements</span>
<span class="go">[1, 4, 9, 16, 25, 36, 49, 64, 81]</span>
</pre></div>
</div>
<p>which in Python corresponds to something like</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">mymap</span><span class="p">(</span><span class="n">func</span><span class="p">,</span> <span class="n">iterable</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">item</span> <span class="ow">in</span> <span class="n">iterable</span><span class="p">:</span>
        <span class="k">yield</span> <span class="n">func</span><span class="p">(</span><span class="n">item</span><span class="p">)</span>
</pre></div>
</div>
<p>Of course, seasoned Pythonistas would rightly frown at the above and instead recommend a <em>list comprehension</em>.</p>
<p>A map takes a function and applies it to every element in an array, creating a result array of the same length as its argument.</p>
<p>In APL, the glyph for map – referred to as <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/Each%20with%20Monadic%20Operand.htm"><em>Each</em></a> – is two high dots: <code class="docutils literal notranslate"><span class="pre">¨</span></code>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">×</span><span class="na">⍨¨</span><span class="m">1</span><span class="o">+⍳</span><span class="m">9</span>  <span class="c1">⍝ Square elements via each (but see below!)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4 9 16 25 36 49 64 81
</span></div></div>
</div>
<p>This wasn’t actually a great example, this is one of those cases where using a scalar function already does the job for us:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">×</span><span class="na">⍨</span><span class="m">1</span><span class="o">+⍳</span><span class="m">9</span>  <span class="c1">⍝ Square elements via scalar pervasion</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4 9 16 25 36 49 64 81
</span></div></div>
</div>
<p>Scalar pervasion means that functions in certain cases already know how to penetrate arrays.</p>
<p>Let’s try another. Given a nested vector, what are the lengths of the elements?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">V</span> <span class="kd">←</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="p">)(</span><span class="m">1</span> <span class="m">2</span><span class="p">)(</span><span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span><span class="p">)(</span><span class="o">,</span><span class="m">2</span><span class="p">)(</span><span class="m">5</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span><span class="p">)</span>
<span class="o">≢</span><span class="na">¨</span><span class="nv">V</span> <span class="c1">⍝ Tally-each</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────┬───┬─────────┬─┬─────────┐
│1 2 3 4│1 2│3 4 5 6 7│2│5 4 3 2 1│
└───────┴───┴─────────┴─┴─────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">4 2 5 1 5
</span></div></div>
</div>
<p>If you’re used to a different language, <em>Each</em> has a seductive quality, as it maps conceptually onto constructs you already know how to use. Beware though that in APL it’s often inefficient, and that there are usually better alternatives.</p>
</div>
<div class="section" id="reduce-a-k-a-foldr">
<h3>Reduce (a.k.a foldr): <code class="docutils literal notranslate"><span class="pre">⌿</span></code>, <code class="docutils literal notranslate"><span class="pre">/</span></code><a class="headerlink" href="#reduce-a-k-a-foldr" title="Permalink to this headline">¶</a></h3>
<p>Most languages today sport some kind of variety of <em>fold</em> or <em>reduce</em>, regardless of the level of “functional” they claim to be.</p>
<p>In APL, <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/Reduce.htm"><em>Reduce</em></a> is a central feature, which somewhat unhelpfully hijacks the glyph also used by <em>Compress/Replicate</em>, <code class="docutils literal notranslate"><span class="pre">/</span></code>.  This is one, albeit not the main, reason why we prefer to use its close cousin, <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/Reduce%20First.htm"><em>Reduce first</em></a>, <code class="docutils literal notranslate"><span class="pre">⌿</span></code>, where we can. Reduction has a bit of an unfair reputation of being hard to understand. Guido reportedly hates <code class="docutils literal notranslate"><span class="pre">reduce()</span></code> in Python so much that it was demoted down to the dusty <a class="reference external" href="https://docs.python.org/3/library/functools.html#functools.reduce">functools</a> module:</p>
<blockquote>
<div><p>So now reduce(). This is actually the one I’ve always hated most, because, apart from a few examples involving + or *, almost every time I see a reduce() call with a non-trivial function argument, I need to grab pen and paper to diagram what’s actually being fed into that function before I understand what the reduce() is supposed to do. So in my mind, the applicability of reduce() is pretty much limited to associative operators, and in all other cases it’s better to write out the accumulation loop explicitly. –<em>Guido van Rossum</em></p>
</div></blockquote>
<p>Despite what Guido thinks, reduction is actually a pretty simple idea, and APL may even have been the first programming language <a class="reference external" href="https://www.jsoftware.com/papers/APL1.htm#1.8">with reduce in it</a> (some Lispers disagree). Think of the operation of summing a bunch of numbers – this is an example of a reduction.</p>
<p>In APL, <em>Reduce</em> applies a function to elements in an array, producing a result which is rank-reduced by 1. In other words, reducing a vector (rank 1) produces a scalar (rank 0). In the example of <code class="docutils literal notranslate"><span class="pre">+</span></code>, summing the elements of a vector obviously produces a scalar: the total.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="c1">⍝ sum-reduce-first integers 1-9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">45
</span></div></div>
</div>
<p>Simplifying a bit, we can think of <em>Reduce first</em> as an operator that injects its left operand function in the gaps between elements of the argument:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="o">+</span><span class="m">2</span><span class="o">+</span><span class="m">3</span><span class="o">+</span><span class="m">4</span><span class="o">+</span><span class="m">5</span><span class="o">+</span><span class="m">6</span><span class="o">+</span><span class="m">7</span><span class="o">+</span><span class="m">8</span><span class="o">+</span><span class="m">9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">45
</span></div></div>
</div>
<p>When using <em>Reduce</em> in APL, you need to take extra care to ensure that it works with its strict right to left evaluation order. A reduce is also called a <em>fold</em> in other languages (Lisp, Erlang etc), and APL’s <em>Reduce</em> is a so-called <em>foldr</em> – it reduces right to left, which makes sense for APL, but occasionally less sense for the programmer.</p>
<p>Again, it can help writing it out in long-hand to see what’s going on:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="c1">⍝ difference-reduction -- take care: right to left fold!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5
</span></div></div>
</div>
<p>If that was the result you expected, you’re well on your way to mastery. Inject the operand between items:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="o">-</span><span class="m">2</span><span class="o">-</span><span class="m">3</span><span class="o">-</span><span class="m">4</span><span class="o">-</span><span class="m">5</span><span class="o">-</span><span class="m">6</span><span class="o">-</span><span class="m">7</span><span class="o">-</span><span class="m">8</span><span class="o">-</span><span class="m">9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5
</span></div></div>
</div>
<p>Reduction is especially useful when working with higher-rank arrays. <em>Reduce first</em> is called so because it reduces along the <em>first</em> axis. So a sum-reduce-first of a rank 2 integer array will sum its columns to produce a <em>vector</em> (rank 1) of the columnar sums:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">9</span><span class="o">?</span><span class="m">9</span>
<span class="o">+</span><span class="na">⌿</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 0 5
4 1 8
6 7 2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">13 8 15
</span></div></div>
</div>
<p>If we wanted to sum-reduce along the rows, we can either use <code class="docutils literal notranslate"><span class="pre">/</span></code> (which for historical reasons does just that):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">/</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">8 13 15
</span></div></div>
</div>
<p>or we can explicitly tell <code class="docutils literal notranslate"><span class="pre">⌿</span></code> to apply along a different axis, using bracket axis:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">⌿</span><span class="sr">[</span><span class="m">1</span><span class="sr">]</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">8 13 15
</span></div></div>
</div>
<p>For consistency, it’s best to prefer operators and functions that default to applying to the leading axis where possible. The fact that APL, unlike J, has a mixture is an unhelpful side-effect of backwards compatibility.</p>
</div>
<div class="section" id="windowed-reduction">
<h3>Windowed reduction<a class="headerlink" href="#windowed-reduction" title="Permalink to this headline">¶</a></h3>
<p><em>Reduce</em> has a few more handy tricks up its sleeve. Instead of reducing the whole argument array, we can employ a sliding window. This lets us compute a set of reductions over shorter stretches of the data. The derived function returned by the reduction operators can be called dyadically, specifying as the left argument the size of the sliding window.</p>
<p>For example, to calculate the sum of each element in a vector with its subsequent element, we employ a reduction with a sliding window of size 2:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 5 7 9 11 13 15 17
</span></div></div>
</div>
</div>
<div class="section" id="scan">
<h3>Scan: <code class="docutils literal notranslate"><span class="pre">\,</span> <span class="pre">⍀</span></code><a class="headerlink" href="#scan" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/Scan.htm"><em>Scan/Scan first</em></a> blurrs the distinction between <em>Each</em> and <em>Reduce</em>. In right hands, it can be a true APL super power, but beware that scans tend to be slow: most scans run to O(n²), although the interpreter can optimise some to the O(n) you perhaps expected.</p>
<p><em>Scan</em> is just like <em>Reduce</em>, but instead returns every intermediate state, not just the end state. A sum-reduce of a vector of numbers returns the sum total. A sum-scan of the same vector returns the running sums:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="c1">⍝ Sum-reduce first</span>
<span class="o">+</span><span class="na">⍀</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="c1">⍝ Sum-scan first</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">45
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1 3 6 10 15 21 28 36 45
</span></div></div>
</div>
<p>One way we can think of scan is that it’s the amalgamation of all possible calls to <em>Reduce</em> with the same operand, taking in increasing lengths of the argument array. In the case above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">⌿</span><span class="m">1</span>
<span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span>
<span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span>
<span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span>
<span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span>
<span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span>
<span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> 
<span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span>
<span class="o">+</span><span class="na">⌿</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">6
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">10
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">15
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">21
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">28
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">36
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">45
</span></div></div>
</div>
<p>As with <em>Reduce</em>, it’s worth re-emphasizing that <em>Scan</em> still is evaluated right-to-left, as with everything else APL, no matter how much you’d prefer it to run left to right instead. You can, of course, roll your own <a class="reference external" href="https://aplcart.info/?q=left%20scan">scan-left</a> if you really need it.</p>
</div>
<div class="section" id="power">
<h3>Power: <code class="docutils literal notranslate"><span class="pre">⍣</span></code><a class="headerlink" href="#power" title="Permalink to this headline">¶</a></h3>
<p>One of my favourite glyphs! It looks like a happy starfish! The <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/Power%20Operator.htm"><em>Power</em></a> operator is… powerful. Conceptually it should be easy to grasp, but there are some aspects that take time to understand. Formally, it’s defined as a function repeatedly applied to the output of itself, until some stopping criterion is fulfilled. If you pass it an integer as its right operand, it’s basically a for-loop:</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="nv">f</span> <span class="kd">←</span> <span class="kt">{</span> <span class="na">...</span> <span class="kt">}</span>               <span class="c1">⍝ some function or other</span>
<span class="nv">f</span> <span class="nv">f</span> <span class="nv">f</span> <span class="nv">f</span> <span class="nv">f</span> <span class="nv">f</span> <span class="nv">f</span> <span class="nv">f</span> <span class="nv">argvector</span> <span class="c1">⍝ repeatedly apply function to itself, eh 8 times</span>
<span class="nv">f</span><span class="na">⍣</span><span class="m">8</span> <span class="o">⊢</span> <span class="nv">argvector</span>           <span class="c1">⍝ power-8</span>
</pre></div>
</div>
<p>If you give it a function as the right operand, it can be used as a while-loop. One example is to find a function’s <em>fixed point</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="o">÷</span><span class="na">⍨⍣</span><span class="o">=</span><span class="m">10</span> <span class="c1">⍝ Divide by 2 until we reach a fixed point</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div></div>
</div>
<p>Here the right operand function is <em>equals</em> <code class="docutils literal notranslate"><span class="pre">=</span></code>. This says: repeatedly apply the left operand (<code class="docutils literal notranslate"><span class="pre">2÷⍨</span></code>) until two subsequent applications return the same value.</p>
<p>We can explicitly refer to the left and right arguments of the right operand function. The left argument, <code class="docutils literal notranslate"><span class="pre">⍺</span></code>, refers to the result of the function application to the right argument, <code class="docutils literal notranslate"><span class="pre">⍵</span></code>.</p>
<p>Keep generating random numbers between 1 and 10 until we get a 6:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span> <span class="kt">{</span><span class="vg">⍞</span> <span class="kd">←</span> <span class="o">?</span><span class="m">10</span><span class="kt">}</span><span class="na">⍣</span><span class="kt">{</span><span class="m">6</span><span class="o">=</span><span class="bp">⍺</span><span class="kt">}</span> <span class="m">0</span> <span class="c1">⍝ Keep generating random numbers between 1 and 10 until we get a 6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1991487931157990989988905581516
6
</span></div></div>
</div>
<p>The <a class="reference external" href="https://help.dyalog.com/latest/#Language/System%20Functions/Character%20Input%20Output.htm"><em>Quad-quote-gets</em></a> (<code class="docutils literal notranslate"><span class="pre">⍞←</span></code>) combo prints values without newlines. The final result is also returned, the expected 6.</p>
</div>
<div class="section" id="del">
<h3>Del: <code class="docutils literal notranslate"><span class="pre">∇</span></code><a class="headerlink" href="#del" title="Permalink to this headline">¶</a></h3>
<p>Dyalog has a most excellent, concise and efficient <a class="reference external" href="https://help.dyalog.com/latest/#Language/Defined%20Functions%20and%20Operators/DynamicFunctions/Recursion.htm">recursion operator</a>, <code class="docutils literal notranslate"><span class="pre">∇</span></code>. It allows you to express recursive algorithms in a natural, almost Lisp-like fashion. The interpreter has a very good <a class="reference external" href="https://en.wikipedia.org/wiki/Tail_call">TCO</a> implementation.</p>
<p>Let’s start with making our own version of sum-reduce, this time without actually using the <em>Reduce</em> operator.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Sum</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="bp">⍺</span> <span class="kd">←</span> <span class="m">0</span>        <span class="c1">⍝ Left arg defaults to 0 if not given</span>
    <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="bp">⍺</span>      <span class="c1">⍝ If right arg is empty, return left arg</span>
    <span class="p">(</span><span class="bp">⍺</span><span class="o">+⊃</span><span class="bp">⍵</span><span class="p">)</span><span class="bp">∇</span><span class="m">1</span><span class="o">↓</span><span class="bp">⍵</span>   <span class="c1">⍝ Add head to acc, recur over tail</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">mysum</span> <span class="kd">←</span> <span class="nv">Sum</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span>
<span class="nv">assert</span> <span class="nv">mysum</span><span class="o">=+</span><span class="na">/</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">45
</span></div></div>
</div>
<p>Yup, that seems to work; good.</p>
<p>The glyph <a class="reference external" href="https://help.dyalog.com/latest/#Language/Defined%20Functions%20and%20Operators/DynamicFunctions/Recursion.htm"><em>Del</em></a> (<code class="docutils literal notranslate"><span class="pre">∇</span></code>) is a reference to the current innermost dfn. If your dfn has a name, you can substitute it for the actual function name. In our case, the last line could equally well have been written:</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="bp">⍺</span><span class="o">+⊃</span><span class="bp">⍵</span><span class="p">)</span><span class="nv">Sum</span> <span class="m">1</span><span class="o">↓</span><span class="bp">⍵</span>
</pre></div>
</div>
<p>However, using the glyph has a number of advantages: it’s more concise, immune to function name changes, and works equally well for anonymous dfns.</p>
<p>Our <code class="docutils literal notranslate"><span class="pre">Sum</span></code> dfn follows a common pattern: we accumulate something as the left argument, and decrease the right argument, either by magnitude, or as in this case, by dropping items off the front of a vector.</p>
<p>The recursion termination guard,</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="bp">⍺</span>
</pre></div>
</div>
<p>simply states that, if the right argument is empty, we should return our accumulator. The recursive call itself is:</p>
<ul class="simple">
<li><p>Add the head of the right argument to the accumulator.</p></li>
<li><p>Recur with the updated accumulator as the new left argument and with the tail as the right argument.</p></li>
</ul>
<p>If the last thing the function does is a function call, and this includes <em>Del</em>, this is what’s called a <a class="reference external" href="https://help.dyalog.com/latest/#Language/Defined%20Functions%20and%20Operators/DynamicFunctions/Tail%20Calls.htm"><em>tail call</em></a> which the Dyalog interpreter can handle without the addition of an extra stack frame. If you’re using <em>Del</em>, strive to make all your recursive functions tail calls – avoid making your function do any work on the value you get back from the recurring line – for example, note that <code class="docutils literal notranslate"><span class="pre">1+⍺∇⍵</span></code> isn’t a tail call, as the last thing that happens is the <code class="docutils literal notranslate"><span class="pre">1+...</span></code> not the <code class="docutils literal notranslate"><span class="pre">⍺∇⍵</span></code>.</p>
<p>For a fractionally more involved example, let’s write our own <em>sum-scan</em>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Sscan</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="bp">⍺</span> <span class="kd">←</span> <span class="no">⍬</span>              <span class="c1">⍝ Left arg defaults to ⍬ if not given</span>
    <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="bp">⍺</span>            <span class="c1">⍝ If right arg is empty, return left arg</span>
    <span class="p">(</span><span class="bp">⍺</span><span class="o">,⊃</span><span class="bp">⍵</span><span class="o">+⊃</span><span class="m">¯1</span><span class="o">↑</span><span class="bp">⍺</span><span class="p">)</span><span class="bp">∇</span><span class="m">1</span><span class="o">↓</span><span class="bp">⍵</span>   <span class="c1">⍝ Append the sum of the head and the last element of acc and recur on tail</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">myscan</span> <span class="kd">←</span> <span class="nv">Sscan</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span>
<span class="nv">assert</span> <span class="nv">myscan</span><span class="o">≡+</span><span class="na">⍀</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 3 6 10 15 21 28 36 45
</span></div></div>
</div>
<p>No discourse on recursion is complete without mentioning the <a class="reference external" href="https://en.wikipedia.org/wiki/Fibonacci_number">Fibonacci</a> sequence. You know which one I mean – every number is the sum of its two direct predecessors:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>0 1 1 2 3 5 8 13 21 34 ⍝ etc, something about rabbits
</pre></div>
</div>
<p>Here’s one possible formulation where the right argument is the Fibonacci ordinal.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Fib</span> <span class="kd">←</span> <span class="kt">{</span> <span class="c1">⍝ Tail-recursive Fibonacci.</span>
    <span class="bp">⍺</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">1</span>
    <span class="bp">⍵</span><span class="o">=</span><span class="m">0</span><span class="bp">:</span> <span class="o">⊃</span><span class="bp">⍺</span>
    <span class="p">(</span><span class="m">1</span><span class="o">↓</span><span class="bp">⍺</span><span class="o">,+</span><span class="na">/</span><span class="bp">⍺</span><span class="p">)</span><span class="bp">∇⍵</span><span class="o">-</span><span class="m">1</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Fib</span><span class="na">¨</span><span class="o">⍳</span><span class="m">10</span> <span class="c1">⍝ The 10 first Fibonacci numbers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 1 2 3 5 8 13 21 34
</span></div></div>
</div>
<p>The pattern is still the same: set a default for the accumulator, <code class="docutils literal notranslate"><span class="pre">⍺</span></code>. Terminate on some condition on <code class="docutils literal notranslate"><span class="pre">⍵</span></code>, returning a function of the accumulator. Modify the accumulator, given the head of the right argument, and recur on the tail.</p>
<p>The guts of the function is the last line. To the right, we decrease the right argument – this is our loop counter if you like. To the left is our accumulator, which basically is a sliding window of size 2 over the Fib sequence. We append the sum of the two numbers, and drop the first, and recur over the tail.</p>
<p>Here’s a pretty neat implementation of the <a class="reference external" href="https://en.wikipedia.org/wiki/Quicksort">Quicksort</a> algorithm:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Quicksort</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="m">1</span><span class="o">≥≢</span><span class="bp">⍵:</span> <span class="bp">⍵</span>
    <span class="nv">S</span> <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍺</span><span class="na">⌿⍨</span><span class="bp">⍺</span> <span class="bp">⍺⍺</span> <span class="bp">⍵</span><span class="kt">}</span>
    <span class="bp">⍵</span><span class="p">((</span><span class="bp">∇</span><span class="o">&lt;</span><span class="nv">S</span><span class="p">)</span><span class="o">,=</span><span class="nv">S</span><span class="o">,</span><span class="p">(</span><span class="bp">∇</span><span class="o">&gt;</span><span class="nv">S</span><span class="p">))</span><span class="bp">⍵</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">?≢</span><span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>Here <code class="docutils literal notranslate"><span class="pre">⍵⌷⍨?≢⍵</span></code> is the pivot element, picked at random, and the <code class="docutils literal notranslate"><span class="pre">S</span></code> operator partitions its left argument array based on its left operand function and the pivot element to the right. The whole idea of quicksort is pretty clearly visible in the <a class="reference internal" href="intro.html#document-tacit"><span class="doc std std-doc">tacit</span></a> fork <code class="docutils literal notranslate"><span class="pre">(∇&lt;S),=S,(∇&gt;S)</span></code> – elements <em>less than</em> the pivot, the pivot, elements <em>greater than</em> the pivot, recursively applied.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Quicksort</span> <span class="vg">⎕</span><span class="kd">←</span><span class="m">20</span><span class="o">?</span><span class="m">20</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 10 4 15 9 11 0 7 6 14 13 5 2 19 18 12 8 1 17 16
0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19
</span></div></div>
</div>
<p>Another example is binary search: locate an element in an array that is known to be sorted. Here’s a function to do that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">bsearch</span> <span class="kd">←</span> <span class="kt">{</span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">0</span>
    <span class="nv">_bs_</span> <span class="kd">←</span> <span class="kt">{</span>                 <span class="c1">⍝ Operator: ⍺,⍵ - lower,upper index. ⍺⍺ - item, ⍵⍵ - array</span>
        <span class="bp">⍺</span><span class="o">&gt;</span><span class="bp">⍵:</span> <span class="no">⍬</span>               <span class="c1">⍝ If lower index has moved past upper, item&#39;s not present</span>
        <span class="nv">mid</span> <span class="kd">←</span> <span class="o">⌈</span><span class="m">0.5</span><span class="o">×</span><span class="bp">⍺</span><span class="o">+</span><span class="bp">⍵</span>       <span class="c1">⍝ New midpoint  </span>
        <span class="bp">⍺⍺</span><span class="o">=</span><span class="nv">mid</span><span class="o">⊃</span><span class="bp">⍵⍵:</span> <span class="nv">mid</span>       <span class="c1">⍝ Check if item is at the new midpoint</span>
        <span class="bp">⍺⍺</span><span class="o">&lt;</span><span class="nv">mid</span><span class="o">⊃</span><span class="bp">⍵⍵:</span> <span class="bp">⍺∇</span><span class="m">¯1</span><span class="o">+</span><span class="nv">mid</span>  <span class="c1">⍝ Drill into lower half</span>
        <span class="bp">⍵∇</span><span class="na">⍨</span><span class="m">1</span><span class="o">+</span><span class="nv">mid</span>             <span class="c1">⍝ Upper half</span>
    <span class="kt">}</span>
    <span class="m">0</span> <span class="p">(</span><span class="bp">⍺</span> <span class="nv">_bs_</span> <span class="p">(</span><span class="o">,</span><span class="bp">⍵</span><span class="p">))</span> <span class="m">¯1</span><span class="o">+≢,</span><span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">5</span> <span class="nv">bsearch</span> <span class="m">0</span> <span class="m">2</span> <span class="m">3</span> <span class="m">5</span> <span class="m">8</span> <span class="m">12</span> <span class="m">75</span>
<span class="m">5</span> <span class="nv">bsearch</span> <span class="m">0</span> <span class="m">2</span> <span class="m">3</span> <span class="m">5</span> <span class="m">8</span> <span class="m">12</span>
<span class="m">5</span> <span class="nv">bsearch</span> <span class="m">5</span> <span class="m">5</span>
<span class="m">5</span> <span class="nv">bsearch</span> <span class="m">5</span>
<span class="sr">]</span><span class="nv">display</span> <span class="m">1</span> <span class="nv">bsearch</span> <span class="m">0</span> <span class="m">2</span> <span class="m">3</span> <span class="m">5</span> <span class="m">8</span> <span class="m">12</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌⊖┐
│0│
└~┘
</span></div></div>
</div>
<div class="section" id="performance-considerations">
<h4>Performance considerations<a class="headerlink" href="#performance-considerations" title="Permalink to this headline">¶</a></h4>
<p>The pattern we’ve used in some of the examples above,</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="c1">⍝ some stuff</span>
<span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:⍺</span>
<span class="nv">head</span> <span class="kd">←</span> <span class="m">1</span><span class="o">↑</span><span class="bp">⍵</span>
<span class="nv">tail</span> <span class="kd">←</span> <span class="m">1</span><span class="o">↓</span><span class="bp">⍵</span>
<span class="p">(</span><span class="nv">head</span> <span class="nv">f</span> <span class="bp">⍺</span><span class="p">)</span><span class="bp">∇</span><span class="nv">tail</span>
</pre></div>
</div>
<p>has a …sting in the tail, especially if you come from a functional language where that pattern is the expectation, like <a class="reference external" href="https://racket-lang.org/">Racket</a>, <a class="reference external" href="https://www.erlang.org/">Erlang</a> or <a class="reference external" href="https://clojure.org/">Clojure</a>. In such languages, vectors/lists are either implemented as linked lists, slices, or are immutable, meaning that dropping an element from the front is an <code class="docutils literal notranslate"><span class="pre">O(1)</span></code> operation. In APL, like in Python, that’s an <code class="docutils literal notranslate"><span class="pre">O(n)</span></code> operation. When combined with recursion, this can be crushing for performance. Here’s an example.</p>
<p>The <a class="reference external" href="https://brilliant.org/wiki/knuth-morris-pratt-algorithm/">Knuth-Morris-Pratt algorithm</a> is an efficient string search algorithm. In one of its forms it pre-calculates a prefix table, which is a metric of how well a string matches against shifts of itself. The <a class="reference external" href="http://brilliant.org">brilliant.org</a> article linked to above has this written out in Python as:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">prefix</span><span class="p">(</span><span class="n">p</span><span class="p">):</span>
    <span class="c1"># https://brilliant.org/wiki/knuth-morris-pratt-algorithm/</span>
    <span class="n">m</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
    <span class="n">pi</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">*</span><span class="n">m</span>
    <span class="n">j</span><span class="o">=</span><span class="mi">0</span> 
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="n">m</span><span class="p">):</span>
        <span class="k">while</span> <span class="n">j</span><span class="o">&gt;=</span><span class="mi">0</span> <span class="ow">and</span> <span class="n">p</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="o">!=</span><span class="n">p</span><span class="p">[</span><span class="n">i</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="o">&gt;=</span><span class="mi">0</span><span class="p">:</span>
                <span class="n">j</span><span class="o">=</span><span class="n">pi</span><span class="p">[</span><span class="n">j</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">j</span><span class="o">=-</span><span class="mi">1</span> 
        <span class="n">j</span><span class="o">+=</span><span class="mi">1</span>
        <span class="n">pi</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">=</span><span class="n">j</span>
    <span class="k">return</span> <span class="n">pi</span>
</pre></div>
</div>
<p>Here’s an example running that:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span>Stefans-MacBook-Pro:~ stefan$ python
Python 3.8.5 (default, Sep 17 2020, 11:24:17) 
[Clang 11.0.3 (clang-1103.0.32.62)] on darwin
Type &quot;help&quot;, &quot;copyright&quot;, &quot;credits&quot; or &quot;license&quot; for more information.
&gt;&gt;&gt; from kmp import prefix
&gt;&gt;&gt; prefix(&#39;CAGCATGGTATCACAGCAGAG&#39;)
[0, 0, 0, 1, 2, 0, 0, 0, 0, 0, 0, 1, 2, 1, 2, 3, 4, 5, 3, 0, 0]
&gt;&gt;&gt; 
</pre></div>
</div>
<p>We can write that as an APL dfn like so:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">prefix1</span> <span class="kd">←</span> <span class="kt">{</span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">0</span>
    <span class="nv">p</span> <span class="kd">←</span> <span class="bp">⍵</span>
    <span class="nv">pi</span> <span class="kd">←</span> <span class="m">0</span><span class="o">⍴</span><span class="na">⍨</span><span class="o">≢</span><span class="bp">⍵</span>
    <span class="nv">j</span> <span class="kd">←</span> <span class="m">0</span>
    <span class="kt">{</span>
        <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="nv">pi</span>
        <span class="nv">i</span> <span class="kd">←</span> <span class="o">⊃</span><span class="bp">⍵</span> <span class="c1">⍝ head</span>
        <span class="nv">pi</span><span class="sr">[</span><span class="nv">i</span><span class="sr">]</span> <span class="kd">←</span> <span class="nv">j</span><span class="o">⊢</span><span class="kd">←</span><span class="m">1</span><span class="o">+</span><span class="kt">{</span><span class="bp">⍵</span><span class="o">&lt;</span><span class="m">0</span><span class="bp">:⍵</span><span class="p">⋄</span><span class="nv">p</span><span class="sr">[</span><span class="bp">⍵</span><span class="sr">]</span><span class="o">=</span><span class="nv">p</span><span class="sr">[</span><span class="nv">i</span><span class="sr">]</span><span class="bp">:⍵</span><span class="p">⋄</span><span class="m">0</span><span class="o">≤</span><span class="bp">⍵</span><span class="o">-</span><span class="m">1</span><span class="bp">:∇</span><span class="nv">pi</span><span class="sr">[</span><span class="bp">⍵</span><span class="o">-</span><span class="m">1</span><span class="sr">]</span><span class="p">⋄</span><span class="m">¯1</span><span class="kt">}</span> <span class="nv">j</span> <span class="c1">⍝ while j&gt;=0 and p[j] != p[i]</span>
        <span class="bp">∇</span><span class="m">1</span><span class="o">↓</span><span class="bp">⍵</span> <span class="c1">⍝ tail</span>
    <span class="kt">}</span> <span class="m">1</span><span class="o">+⍳</span><span class="m">¯1</span><span class="o">+≢</span><span class="bp">⍵</span> <span class="c1">⍝ for i in range(1, m)</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>and we’d hope it produces the same result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">prefix1</span> <span class="s1">&#39;CAGCATGGTATCACAGCAGAG&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0 1 2 0 0 0 0 0 0 1 2 1 2 3 4 5 3 0 0
</span></div></div>
</div>
<p>So that’s two nested “loops”, both nicely tail recursive, and probably similar to how you’d construct it in Clojure or Racket. However, as the argument string grows, the performance tanks. We can illustrate this by tweaking it a tiny bit to avoid the reallocation of the argument to the recursive call in the outer loop:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">prefix2</span> <span class="kd">←</span> <span class="kt">{</span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">0</span>
    <span class="nv">p</span> <span class="kd">←</span> <span class="bp">⍵</span>
    <span class="nv">pi</span> <span class="kd">←</span> <span class="m">0</span><span class="o">⍴</span><span class="na">⍨</span><span class="o">≢</span><span class="bp">⍵</span>
    <span class="nv">j</span> <span class="kd">←</span> <span class="m">0</span>
    <span class="m">0</span> <span class="kt">{</span>
        <span class="bp">⍺</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="nv">pi</span>
        <span class="nv">i</span> <span class="kd">←</span> <span class="bp">⍺</span><span class="o">⊃</span><span class="bp">⍵</span> <span class="c1">⍝ Note: pick ⍺, not first</span>
        <span class="nv">pi</span><span class="sr">[</span><span class="nv">i</span><span class="sr">]</span> <span class="kd">←</span> <span class="nv">j</span><span class="o">⊢</span><span class="kd">←</span><span class="m">1</span><span class="o">+</span><span class="kt">{</span><span class="bp">⍵</span><span class="o">&lt;</span><span class="m">0</span><span class="bp">:⍵</span> <span class="p">⋄</span> <span class="nv">p</span><span class="sr">[</span><span class="bp">⍵</span><span class="sr">]</span><span class="o">=</span><span class="nv">p</span><span class="sr">[</span><span class="nv">i</span><span class="sr">]</span><span class="bp">:⍵</span> <span class="p">⋄</span> <span class="m">0</span><span class="o">≤</span><span class="bp">⍵</span><span class="o">-</span><span class="m">1</span><span class="bp">:∇</span> <span class="nv">pi</span><span class="sr">[</span><span class="bp">⍵</span><span class="o">-</span><span class="m">1</span><span class="sr">]</span> <span class="p">⋄</span> <span class="m">¯1</span><span class="kt">}</span> <span class="nv">j</span>
        <span class="p">(</span><span class="bp">⍺</span><span class="o">+</span><span class="m">1</span><span class="p">)</span><span class="bp">∇</span> <span class="bp">⍵</span> <span class="c1">⍝ Note: no tail!</span>
    <span class="kt">}</span> <span class="m">1</span><span class="o">+⍳</span><span class="m">¯1</span><span class="o">+≢</span><span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>Instead of taking the tail of <code class="docutils literal notranslate"><span class="pre">⍵</span></code>, we pass the current index as <code class="docutils literal notranslate"><span class="pre">⍺</span></code>. Let’s see if that works before we proceed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">prefix2</span> <span class="s1">&#39;CAGCATGGTATCACAGCAGAG&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0 1 2 0 0 0 0 0 0 1 2 1 2 3 4 5 3 0 0
</span></div></div>
</div>
<p>To demonstrate the difference, let’s compare performance on a long string. Here’s one taken from Project Rosalind:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="o">⊃⊃</span><span class="nf">⎕NGET</span><span class="s1">&#39;../kmp.txt&#39;</span><span class="m">1</span> <span class="c1">⍝ From http://rosalind.info/problems/kmp/</span>
<span class="o">≢</span><span class="nv">data</span> <span class="c1">⍝ LONG STRING!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">99972
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;cmpx&#39;</span><span class="nf">⎕CY</span><span class="s1">&#39;dfns&#39;</span> <span class="c1">⍝ Load `cmpx` - comparative benchmarking</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">cmpx</span> <span class="s1">&#39;prefix1 data&#39;</span> <span class="s1">&#39;prefix2 data&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  prefix1 data → 1.0E0  |   0% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕
  prefix2 data → 2.4E¯1 | -76% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕                              
</span></div></div>
</div>
<p>Quite a staggering difference for such an innocuous change, perhaps.</p>
<p>The binary search implementation we concluded the previous section with already ‘does the right thing’ – it doesn’t cut off the data array on each iteration. So it should be fast, right? Searching for a number amongst a hundred thousand or so <em>must</em> be faster than the APL primitive function that examines every element looking for a match. Surely…? In <code class="docutils literal notranslate"><span class="pre">Algorithms</span> <span class="pre">101</span></code> they taught you that <code class="docutils literal notranslate"><span class="pre">O(log</span> <span class="pre">n)</span></code> always beats <code class="docutils literal notranslate"><span class="pre">O(n)</span></code>!</p>
<p>Except when it doesn’t:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="o">⍳</span><span class="m">100000</span> <span class="c1">⍝ A loooot of numbers</span>
<span class="nv">cmpx</span> <span class="s1">&#39;data ⍳ 17777&#39;</span> <span class="s1">&#39;17777 bsearch data&#39;</span> <span class="c1">⍝ Look for the number 17777</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  data ⍳ 17777       → 1.6E¯6 |    0% ⎕⎕⎕⎕                                    
  17777 bsearch data → 1.6E¯5 | +926% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕
</span></div></div>
</div>
<p>Ouch… a lesson for the APL neophyte here. Your intuition for what’s efficient and what isn’t is almost certainly wrong. But wait, we can do even better. Let’s have a randomised array for APL to go at:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">randInts</span> <span class="kd">←</span> <span class="m">100000</span> <span class="o">?</span> <span class="m">100000</span> 
<span class="nv">cmpx</span> <span class="s1">&#39;randInts⍳1&#39;</span> <span class="s1">&#39;randInts⍳19326&#39;</span> <span class="s1">&#39;randInts⍳46729&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  randInts⍳1     → 8.4E¯6 |   0% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕
* randInts⍳19326 → 2.3E¯6 | -73% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕                             
* randInts⍳46729 → 6.6E¯7 | -93% ⎕⎕⎕                                     
</span></div></div>
</div>
<p>We can make this even faster by pre-binding the array to the <em>Index Of</em> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">find</span><span class="kd">←</span><span class="nv">randInts</span><span class="na">∘</span><span class="o">⍳</span>
<span class="nv">cmpx</span> <span class="s1">&#39;find 1&#39;</span> <span class="s1">&#39;find 19326&#39;</span> <span class="s1">&#39;find 46729&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  find 1     → 2.5E¯7 |   0% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕
* find 19326 → 1.6E¯7 | -38% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕               
* find 46729 → 1.7E¯7 | -35% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕              
</span></div></div>
</div>
<p>What’s happening there is that Dyalog takes the binding to mean that as the lookup array is now fixed, it can make a hashed index behind the scenes. You can see that the times taken don’t vary much with the argument.</p>
<p>But there is more performance to squeeze out here. If our search array is ordered, we can use <em>Interval Index</em>, dyadic <code class="docutils literal notranslate"><span class="pre">⍸</span></code>, as a binary search (which it is!):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">cmpx</span> <span class="s1">&#39;data⍸1&#39;</span> <span class="s1">&#39;data⍸19326&#39;</span> <span class="s1">&#39;data⍸46729&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  data⍸1     → 1.3E¯7 |   0% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕    
* data⍸19326 → 1.4E¯7 |  +8% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕ 
* data⍸46729 → 1.5E¯7 | +10% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕
</span></div></div>
</div>
<p><em>Interval Index</em> is very optimised in the 18.0/1 versions of Dyalog. Sadly, this optimisation had to be dropped in 18.2.</p>
<p>Key point: simple APL primitives on simple arrays are always faster than anything you can write in APL. Only ever iterate or recurse if there are no other alternatives.</p>
<p>Exercise for the reader: as the data grows, sooner or later the <code class="docutils literal notranslate"><span class="pre">bsearch</span></code> function will win out. How large does the array need to be for that to happen?</p>
</div>
</div>
<div class="section" id="scalar-pervasion">
<h3>Scalar pervasion<a class="headerlink" href="#scalar-pervasion" title="Permalink to this headline">¶</a></h3>
<p>We touched briefly on <em>scalar pervasion</em> above, but it’s an important topic, so let’s dive in a little bit deeper. It’s worth reading what Dyalog has to say on the topic in the <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Scalar%20Functions.htm">docs</a>.</p>
<p>The idea is that a certain class of functions is <em>pervasive</em>. This means that a function that operates on a scalar will operate on scalars at any level of nesting if applied to an array. Recall that the level of nesting is <em>not</em> the same as the rank in APL.</p>
<p>Consider a nested vector that contains both numbers and other vectors of numbers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">nesty</span> <span class="kd">←</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="p">(</span><span class="m">3</span> <span class="m">4</span> <span class="p">(</span><span class="m">5</span> <span class="m">6</span><span class="p">))</span> <span class="m">7</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬─┬─┬─────────┬─┐
│1│2│3│┌─┬─┬───┐│7│
│ │ │ ││3│4│5 6││ │
│ │ │ │└─┴─┴───┘│ │
└─┴─┴─┴─────────┴─┘
</span></div></div>
</div>
<p>As an obvious and simple example, let’s say we want to negate all the numbers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="nv">nesty</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬──┬──┬─────────────┬──┐
│¯1│¯2│¯3│┌──┬──┬─────┐│¯7│
│  │  │  ││¯3│¯4│¯5 ¯6││  │
│  │  │  │└──┴──┴─────┘│  │
└──┴──┴──┴─────────────┴──┘
</span></div></div>
</div>
<p>Where it can be applied, scalar pervasion is an efficient operation in Dyalog APL. It works for dyads, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">1</span> <span class="m">2</span><span class="p">)</span> <span class="m">3</span> <span class="o">+</span> <span class="m">4</span> <span class="p">(</span><span class="m">5</span> <span class="m">6</span><span class="p">)</span>
<span class="p">(</span><span class="m">1</span> <span class="m">1</span><span class="o">⍴</span><span class="m">5</span><span class="p">)</span> <span class="o">-</span> <span class="m">1</span> <span class="p">(</span><span class="m">2</span> <span class="m">3</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┐
│5 6│8 9│
└───┴───┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬───┐
│4│3 2│
└─┴───┘
</span></div></div>
</div>
</div>
</div>
<span id="document-key"></span><div class="tex2jax_ignore mathjax_ignore section" id="the-key-operator">
<h2>The Key operator: <code class="docutils literal notranslate"><span class="pre">⌸</span></code><a class="headerlink" href="#the-key-operator" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Overemphasis of efficiency leads to an unfortunate circularity in design: for reasons of efficiency early programming languages reflected the characteristics of the early computers, and each generation of computers reflects the needs of the programming languages of the preceding generation. –<em>Kenneth E. Iverson</em></p>
</div></blockquote>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<p>The monadic operator <em>Key</em> (<code class="docutils literal notranslate"><span class="pre">⌸</span></code>) groups things. It can, for example, be used to generate histograms, or if you are so inclined, you can think of it as similar to SQL’s <a class="reference external" href="https://en.wikipedia.org/wiki/Group_by_(SQL)">GROUP BY</a> clause.</p>
<p>Other resources on <em>Key</em>:</p>
<ul class="simple">
<li><p>Dyalog <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Operators/Key.htm">docs</a></p></li>
<li><p>APL Orchard <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-5-even-more-apl-operators--">cultivation</a> (also covering <em>Stencil</em>)</p></li>
</ul>
<p>The function derived by <em>Key</em> is ambivalent (can be called either monadically or dyadically). The operand function can be any dyadic function returning a value.</p>
<p>Let’s look at the derived function, when called monadically:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍺⍵</span><span class="kt">}</span><span class="na">⌸</span> <span class="s1">&#39;bill&#39;</span> <span class="s1">&#39;bob&#39;</span> <span class="s1">&#39;bill&#39;</span> <span class="s1">&#39;eric&#39;</span> <span class="s1">&#39;bill&#39;</span> <span class="s1">&#39;bob&#39;</span> <span class="s1">&#39;eric&#39;</span> <span class="s1">&#39;sue&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──────┬─────┐
│┌────┐│0 2 4│
││bill││     │
│└────┘│     │
├──────┼─────┤
│┌───┐ │1 5  │
││bob│ │     │
│└───┘ │     │
├──────┼─────┤
│┌────┐│3 6  │
││eric││     │
│└────┘│     │
├──────┼─────┤
│┌───┐ │7    │
││sue│ │     │
│└───┘ │     │
└──────┴─────┘
</span></div></div>
</div>
<p>In this case, the operator function is called with each unique element from the argument array in turn as the left argument, and a vector of indices where they occur. If we wanted this to be a histogram, all we need to to is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍺</span> <span class="p">(</span><span class="o">≢</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span><span class="na">⌸</span> <span class="s1">&#39;bill&#39;</span> <span class="s1">&#39;bob&#39;</span> <span class="s1">&#39;bill&#39;</span> <span class="s1">&#39;eric&#39;</span> <span class="s1">&#39;bill&#39;</span> <span class="s1">&#39;bob&#39;</span> <span class="s1">&#39;eric&#39;</span> <span class="s1">&#39;sue&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──────┬─┐
│┌────┐│3│
││bill││ │
│└────┘│ │
├──────┼─┤
│┌───┐ │2│
││bob│ │ │
│└───┘ │ │
├──────┼─┤
│┌────┐│2│
││eric││ │
│└────┘│ │
├──────┼─┤
│┌───┐ │1│
││sue│ │ │
│└───┘ │ │
└──────┴─┘
</span></div></div>
</div>
<p>In the dyadic form, <em>Key</em> takes each unique element to the left, and groups the corresponding elements from the right. In other words, the following two formulations do the same thing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">names</span> <span class="kd">←</span> <span class="s1">&#39;bill&#39;</span> <span class="s1">&#39;bob&#39;</span> <span class="s1">&#39;bill&#39;</span> <span class="s1">&#39;eric&#39;</span> <span class="s1">&#39;bill&#39;</span> <span class="s1">&#39;bob&#39;</span> <span class="s1">&#39;eric&#39;</span> <span class="s1">&#39;sue&#39;</span>
<span class="kt">{</span><span class="bp">⍺⍵</span><span class="kt">}</span><span class="na">⌸</span> <span class="nv">names</span>
<span class="nv">names</span> <span class="kt">{</span><span class="bp">⍺⍵</span><span class="kt">}</span><span class="na">⌸</span> <span class="o">⍳≢</span><span class="nv">names</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──────┬─────┐
│┌────┐│0 2 4│
││bill││     │
│└────┘│     │
├──────┼─────┤
│┌───┐ │1 5  │
││bob│ │     │
│└───┘ │     │
├──────┼─────┤
│┌────┐│3 6  │
││eric││     │
│└────┘│     │
├──────┼─────┤
│┌───┐ │7    │
││sue│ │     │
│└───┘ │     │
└──────┴─────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──────┬─────┐
│┌────┐│0 2 4│
││bill││     │
│└────┘│     │
├──────┼─────┤
│┌───┐ │1 5  │
││bob│ │     │
│└───┘ │     │
├──────┼─────┤
│┌────┐│3 6  │
││eric││     │
│└────┘│     │
├──────┼─────┤
│┌───┐ │7    │
││sue│ │     │
│└───┘ │     │
└──────┴─────┘
</span></div></div>
</div>
<p>Let’s look at a slightly more involved example. Here are the Rugby Union Gallagher English Premiership results for Jan, 2021, home fixtures only. The 0-0 games were COVID cancellations.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">results</span> <span class="kd">←</span> <span class="s1">&#39;London Irish,31-22&#39;</span> <span class="s1">&#39;Wasps,17-49&#39;</span> <span class="s1">&#39;Gloucester,26-31&#39;</span> <span class="s1">&#39;Worcester Warriors,17-21&#39;</span> <span class="s1">&#39;Bristol,48-3&#39;</span> <span class="s1">&#39;Leicester Tigers,15-25&#39;</span> <span class="s1">&#39;Harlequins,27-27&#39;</span> <span class="s1">&#39;Newcastle Falcons,22-10&#39;</span> <span class="s1">&#39;Exeter Chiefs,7-20&#39;</span> <span class="s1">&#39;Northampton Saints,0-0&#39;</span> <span class="s1">&#39;Bath,44-52&#39;</span> <span class="s1">&#39;Sale,20-13&#39;</span> <span class="s1">&#39;London Irish,0-0&#39;</span> <span class="s1">&#39;Leicester Tigers,36-31&#39;</span> <span class="s1">&#39;Wasps,34-5&#39;</span> <span class="s1">&#39;Gloucester,19-22&#39;</span> <span class="s1">&#39;Bristol,29-17&#39;</span> <span class="s1">&#39;Worcester Warriors,0-0&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>We’ll do some quick and dirty slicing and dicing to separate team names from results.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">table</span> <span class="kd">←</span> <span class="nf">⎕CSV</span> <span class="p">(</span><span class="s1">&#39;-&#39;</span><span class="nf">⎕R</span><span class="s1">&#39;,&#39;</span><span class="o">⊢</span><span class="nv">results</span><span class="p">)</span><span class="s1">&#39;&#39;</span><span class="m">4</span>
<span class="nv">teams</span> <span class="kd">←</span> <span class="o">⊣</span><span class="na">/</span><span class="nv">table</span>
<span class="nv">scores</span> <span class="kd">←</span> <span class="nv">table</span><span class="sr">[;</span><span class="m">1</span> <span class="m">2</span><span class="sr">]</span>
</pre></div>
</div>
</div>
</div>
<p>which gives us</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="m">6</span><span class="o">⍴</span><span class="nv">teams</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────────────┬─────────────────┬─────────────┬──────────────────┬───────┬──────────────────┐
│London Irish│Wasps            │Gloucester   │Worcester Warriors│Bristol│Leicester Tigers  │
├────────────┼─────────────────┼─────────────┼──────────────────┼───────┼──────────────────┤
│Harlequins  │Newcastle Falcons│Exeter Chiefs│Northampton Saints│Bath   │Sale              │
├────────────┼─────────────────┼─────────────┼──────────────────┼───────┼──────────────────┤
│London Irish│Leicester Tigers │Wasps        │Gloucester        │Bristol│Worcester Warriors│
└────────────┴─────────────────┴─────────────┴──────────────────┴───────┴──────────────────┘
</span></div></div>
</div>
<p>and</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="m">6</span><span class="o">⍴↓</span><span class="nv">scores</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┬─────┬─────┬─────┐
│31 22│17 49│26 31│17 21│48 3 │15 25│
├─────┼─────┼─────┼─────┼─────┼─────┤
│27 27│22 10│7 20 │0 0  │44 52│20 13│
├─────┼─────┼─────┼─────┼─────┼─────┤
│0 0  │36 31│34 5 │19 22│29 17│0 0  │
└─────┴─────┴─────┴─────┴─────┴─────┘
</span></div></div>
</div>
<p>To illustrate the similarity with SQL’s <code class="docutils literal notranslate"><span class="pre">GROUP</span> <span class="pre">BY</span></code>, by using dyadic <em>Key</em>, we can group the scores under each team:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">teams</span> <span class="kt">{</span><span class="bp">⍺⍵</span><span class="kt">}</span><span class="na">⌸</span> <span class="nv">scores</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────────────────────┬─────┐
│┌────────────┐      │31 22│
││London Irish│      │ 0  0│
│└────────────┘      │     │
├────────────────────┼─────┤
│┌─────┐             │17 49│
││Wasps│             │34  5│
│└─────┘             │     │
├────────────────────┼─────┤
│┌──────────┐        │26 31│
││Gloucester│        │19 22│
│└──────────┘        │     │
├────────────────────┼─────┤
│┌──────────────────┐│17 21│
││Worcester Warriors││ 0  0│
│└──────────────────┘│     │
├────────────────────┼─────┤
│┌───────┐           │48  3│
││Bristol│           │29 17│
│└───────┘           │     │
├────────────────────┼─────┤
│┌────────────────┐  │15 25│
││Leicester Tigers│  │36 31│
│└────────────────┘  │     │
├────────────────────┼─────┤
│┌──────────┐        │27 27│
││Harlequins│        │     │
│└──────────┘        │     │
├────────────────────┼─────┤
│┌─────────────────┐ │22 10│
││Newcastle Falcons│ │     │
│└─────────────────┘ │     │
├────────────────────┼─────┤
│┌─────────────┐     │7 20 │
││Exeter Chiefs│     │     │
│└─────────────┘     │     │
├────────────────────┼─────┤
│┌──────────────────┐│0 0  │
││Northampton Saints││     │
│└──────────────────┘│     │
├────────────────────┼─────┤
│┌────┐              │44 52│
││Bath│              │     │
│└────┘              │     │
├────────────────────┼─────┤
│┌────┐              │20 13│
││Sale│              │     │
│└────┘              │     │
└────────────────────┴─────┘
</span></div></div>
</div>
<p>One more example. Given a vector, return the most frequent element, or if there are several, return all of those:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;Mississippi&#39;</span> <span class="c1">⍝ Most frequent from APLCart</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">is
</span></div></div>
</div>
<p>Ouch.</p>
<p>A lot of stuff there we haven’t seen yet, and rather ‘golfy’. Let’s unpick it, and see how far we get. From the right we first have our <em>Key</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊢</span><span class="na">⌸</span> <span class="s1">&#39;Mississippi&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0  0
1 4 7 10
2 3 5  6
8 9 0  0
</span></div></div>
</div>
<p>That’s just the indices of each unique element in turn, as if we’d written</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌸</span> <span class="s1">&#39;Mississippi&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0  0
1 4 7 10
2 3 5  6
8 9 0  0
</span></div></div>
</div>
<p>We then prepend a 0 column</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span> <span class="s1">&#39;Mississippi&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0 0  0
0 1 4 7 10
0 2 3 5  6
0 8 9 0  0
</span></div></div>
</div>
<p>Why is this? It doesn’t seem to be necessary?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="o">⊢</span><span class="na">⌸</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;Mississippi&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">is
</span></div></div>
</div>
<p>This is just guarding against a special case – should the function be passed an empty argument, we don’t want to error:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="o">⊢</span><span class="na">⌸</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;&#39;</span> <span class="c1">⍝ Note: DOMAIN ERROR</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>DOMAIN ERROR
      {⍵⌷⍨⊂0~⍨⊢/⊢⌸⍵}&#39;&#39; ⍝ Note: DOMAIN ERROR
              ∧
</pre></div>
</div>
</div>
</div>
<p>whereas with the prepended zeros it does the right thing:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">
</span></div></div>
</div>
<p>Anyway. After prepending a zero-col, we pick the <em>last</em> column:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊢</span><span class="na">/</span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span> <span class="s1">&#39;Mississippi&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 10 6 0
</span></div></div>
</div>
<p>This is how we can find the most frequent element(s) without any sorting – the vector(s) of indices of the most frequent elements will be the longest, and hence the non-zero elements in the last column will be corresponding to the last occurrence of the most frequent elements. We need to exclude the zeros first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="o">⊢</span><span class="na">⌸</span> <span class="s1">&#39;Mississippi&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">10 6
</span></div></div>
</div>
<p>and then enclose and index:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;Mississippi&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">is
</span></div></div>
</div>
<p>Pretty cool, eh? But there is one gotcha here –</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span><span class="bp">⍵</span><span class="kt">}</span><span class="s1">&#39;abc&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">bc
</span></div></div>
</div>
<p>If the argument array contains only unique cells, we get the wrong result if we run under <code class="docutils literal notranslate"><span class="pre">⎕IO←0</span></code>. Set it to 1 and it works:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">1</span><span class="p">⋄</span><span class="bp">⍵</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span><span class="bp">⍵</span><span class="kt">}</span><span class="s1">&#39;abc&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">abc
</span></div></div>
</div>
<p>This is, of course, to do with the excluding of zeros from the last column. Unfortunately, as we rely on 0 being the <a class="reference external" href="help.dyalog.com/18.0/index.htm#Language/Introduction/Variables/Prototypes%20and%20Fill%20Items.htm">fill item</a> for the array, so sadly we can’t prepend, say, a negative number instead of 0 for ⎕IO-independence:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">¯1</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">¯1</span><span class="o">,⊢</span><span class="na">⌸</span><span class="bp">⍵</span><span class="kt">}</span><span class="s1">&#39;abc&#39;</span> <span class="c1">⍝ Whilst this works....</span>
<span class="kt">{</span><span class="bp">⍵</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">¯1</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">¯1</span><span class="o">,⊢</span><span class="na">⌸</span><span class="bp">⍵</span><span class="kt">}</span><span class="s1">&#39;Mississippi&#39;</span> <span class="c1">⍝ This breaks!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">abc
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">MisM
</span></div></div>
</div>
<p>Here are some drills on <em>Key</em>, suggested by Roger Hui in his <a class="reference external" href="https://www.jsoftware.com/papers/APL_exercises/">APL Exercises</a>. Try to work out in your head what the answers are before you reveal:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">x</span> <span class="kd">←</span> <span class="s1">&#39;Supercalifragilisticexpialidocious&#39;</span>

<span class="kt">{</span><span class="bp">⍺⍵</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">x</span>
<span class="kt">{</span><span class="bp">⍺</span> <span class="p">(</span><span class="o">≢</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">x</span>
<span class="kt">{</span><span class="o">≢</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">x</span>
<span class="kt">{</span><span class="bp">⍺</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">x</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬───────────────────┐
│S│0                  │
├─┼───────────────────┤
│u│1 32               │
├─┼───────────────────┤
│p│2 22               │
├─┼───────────────────┤
│e│3 20               │
├─┼───────────────────┤
│r│4 10               │
├─┼───────────────────┤
│c│5 19 29            │
├─┼───────────────────┤
│a│6 11 24            │
├─┼───────────────────┤
│l│7 14 25            │
├─┼───────────────────┤
│i│8 13 15 18 23 26 30│
├─┼───────────────────┤
│f│9                  │
├─┼───────────────────┤
│g│12                 │
├─┼───────────────────┤
│s│16 33              │
├─┼───────────────────┤
│t│17                 │
├─┼───────────────────┤
│x│21                 │
├─┼───────────────────┤
│d│27                 │
├─┼───────────────────┤
│o│28 31              │
└─┴───────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">S 1
u 2
p 2
e 2
r 2
c 3
a 3
l 3
i 7
f 1
g 1
s 2
t 1
x 1
d 1
o 2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 2 2 2 3 3 3 7 1 1 2 1 1 1 2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Supercalifgstxdo
</span></div></div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">x</span> <span class="kd">←</span> <span class="s1">&#39;abcdefghijk&#39;</span>
<span class="nv">y</span> <span class="kd">←</span> <span class="m">10</span><span class="o">+</span><span class="m">11</span> <span class="m">2</span><span class="o">⍴⍳</span><span class="m">22</span>

<span class="nv">x</span><span class="kt">{</span><span class="bp">⍺⍵</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">y</span>
<span class="nv">x</span><span class="kt">{</span><span class="bp">⍺</span> <span class="p">(</span><span class="o">≢</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">y</span>
<span class="nv">x</span><span class="kt">{</span><span class="o">≢</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">y</span>
<span class="nv">x</span><span class="kt">{</span><span class="bp">⍺</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">y</span>
<span class="nv">x</span><span class="kt">{</span><span class="bp">⍺</span><span class="p">(</span><span class="o">+</span><span class="na">/</span><span class="o">,</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">y</span>
<span class="nv">x</span><span class="kt">{</span><span class="bp">⍺</span><span class="p">(</span><span class="o">⌈</span><span class="na">/</span><span class="o">,</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">y</span>
<span class="nv">x</span><span class="kt">{</span><span class="bp">⍺</span><span class="p">(</span><span class="o">⌊</span><span class="na">/</span><span class="o">,</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span><span class="na">⌸</span><span class="nv">y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬─────┐
│a│10 11│
├─┼─────┤
│b│12 13│
├─┼─────┤
│c│14 15│
├─┼─────┤
│d│16 17│
├─┼─────┤
│e│18 19│
├─┼─────┤
│f│20 21│
├─┼─────┤
│g│22 23│
├─┼─────┤
│h│24 25│
├─┼─────┤
│i│26 27│
├─┼─────┤
│j│28 29│
├─┼─────┤
│k│30 31│
└─┴─────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">a 1
b 1
c 1
d 1
e 1
f 1
g 1
h 1
i 1
j 1
k 1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1 1 1 1 1 1 1 1 1 1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">abcdefghijk
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">a 21
b 25
c 29
d 33
e 37
f 41
g 45
h 49
i 53
j 57
k 61
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">a 11
b 13
c 15
d 17
e 19
f 21
g 23
h 25
i 27
j 29
k 31
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">a 10
b 12
c 14
d 16
e 18
f 20
g 22
h 24
i 26
j 28
k 30
</span></div></div>
</div>
</div>
<span id="document-at"></span><div class="tex2jax_ignore mathjax_ignore section" id="the-at-operator">
<h2>The At operator: <code class="docutils literal notranslate"><span class="pre">&#64;</span></code><a class="headerlink" href="#the-at-operator" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Once you understand how to write a program get someone else to write it.
–<em>Alan Perlis</em></p>
</div></blockquote>
<p>Let’s look at the powerful immutable array update operator, <em>At</em> (<code class="docutils literal notranslate"><span class="pre">&#64;</span></code>). By “immutable”, in this context, we mean non-destructive – it creates a new array, rather than mutating in place. Immutability is a good thing.</p>
<p>The dyadic <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> operator has a lot of moving parts, and we won’t cover all possible combinations here.</p>
<p>References for <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://aplcart.info/?q=%40">APL Cart</a> has loads of examples</p></li>
<li><p>The APL Cultivations covered it in <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-4-more-apl-operators--">Lesson 4</a> (amongst other things)</p></li>
<li><p>Dyalog <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/At.htm">docs</a></p></li>
</ul>
<p>Our usual prelude:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">&#64;</span></code> can take both functions and arrays as either operand. In its simplest form, the left operand specifies values, and the right operand indices:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="na">@</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="o">⊢</span><span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 0 0 0 1 1 1
</span></div></div>
</div>
<p>Recall from the introduction to operators that an operator returns a derived function. We inserted a <em>Right tack</em> to make clear the distinction – to stop stranding – between the operator’s right operand and the derived function’s argument. We could equally well have written:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">0</span><span class="na">@</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">)</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 0 0 0 1 1 1
</span></div></div>
</div>
<p>We can think of the right operand as defining a selection criteria. For example, it can be a <em>function</em> that when called with the derived function’s argument returns a Boolean array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;*&#39;</span><span class="na">@</span><span class="kt">{</span><span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span><span class="kt">}</span> <span class="s1">&#39;Hello world&#39;</span> <span class="c1">⍝ Right operand: function returning Boolean array</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">H***o world
</span></div></div>
</div>
<p>The left operand is either an array providing the new values for every value selected by the right argument, or a function which will be called with each selected element to produce the replacement value. For example, let’s add 5 to every even element:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="m">5</span><span class="o">+</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">@</span><span class="kt">{</span><span class="m">0</span><span class="o">=</span><span class="m">2</span><span class="o">|</span><span class="bp">⍵</span><span class="kt">}</span> <span class="o">⍳</span><span class="m">12</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5 1 7 3 9 5 11 7 13 9 15 11
</span></div></div>
</div>
<p>In this case, the right operand is the function <code class="docutils literal notranslate"><span class="pre">{0=2|⍵}</span></code>, which is called as such:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="m">0</span><span class="o">=</span><span class="m">2</span><span class="o">|</span><span class="bp">⍵</span><span class="kt">}</span> <span class="o">⍳</span><span class="m">12</span> <span class="c1">⍝ Return Boolean mask indicating the even numbers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 0 1 0 1 0 1 0 1 0 1 0
</span></div></div>
</div>
<p>The selected numbers are then:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="kt">{</span><span class="m">0</span><span class="o">=</span><span class="m">2</span><span class="o">|</span><span class="bp">⍵</span><span class="kt">}</span> <span class="o">⍳</span><span class="m">12</span><span class="p">)</span><span class="na">/</span><span class="o">⍳</span><span class="m">12</span> <span class="c1">⍝ Compress</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 2 4 6 8 10
</span></div></div>
</div>
<p>which are passed to the left operand:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="m">5</span><span class="o">+</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">0</span> <span class="m">2</span> <span class="m">4</span> <span class="m">6</span> <span class="m">8</span> <span class="m">10</span> <span class="c1">⍝ Left operand applied to elements selected by right operand</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5 7 9 11 13 15
</span></div></div>
</div>
<p>Finally, &#64; will make the substitution.</p>
<p>Let’s write our own naive, overly verbose, partial implementation of &#64; for illustrative purposes.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">_At_</span> <span class="kd">←</span> <span class="kt">{</span> <span class="c1">⍝ Partial @ - left and right operands must be functions, and the right arg a vector</span>
    <span class="nv">mutator</span> <span class="kd">←</span> <span class="bp">⍺⍺</span>                   <span class="c1">⍝ Left operand -- function only</span>
    <span class="nv">selector</span> <span class="kd">←</span> <span class="bp">⍵⍵</span>                  <span class="c1">⍝ Right operand -- function only</span>
    <span class="nv">data</span> <span class="kd">←</span> <span class="bp">⍵</span>                       <span class="c1">⍝ Derived function right argument -- vector only. Note: copy</span>
    <span class="nv">mask</span> <span class="kd">←</span> <span class="nv">selector</span> <span class="nv">data</span>
    <span class="nv">selection</span> <span class="kd">←</span> <span class="nv">mask</span><span class="na">/</span><span class="nv">data</span>          <span class="c1">⍝ Compress the data according to boolean mask</span>
    <span class="nv">newvals</span> <span class="kd">←</span> <span class="nv">mutator</span> <span class="nv">selection</span>    <span class="c1">⍝ Mutate our selection</span>
    <span class="p">(</span><span class="nv">mask</span><span class="na">/</span><span class="nv">data</span><span class="p">)</span> <span class="kd">←</span> <span class="nv">newvals</span>          <span class="c1">⍝ Replace with the mutated values in copy</span>
    <span class="nv">data</span>                           <span class="c1">⍝ Return result</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="m">5</span><span class="o">+</span><span class="bp">⍵</span><span class="kt">}</span><span class="nv">_At_</span><span class="kt">{</span><span class="m">0</span><span class="o">=</span><span class="m">2</span><span class="o">|</span><span class="bp">⍵</span><span class="kt">}</span> <span class="o">⍳</span><span class="m">12</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5 1 7 3 9 5 11 7 13 9 15 11
</span></div></div>
</div>
<p>We can shrink that down a bit without any real loss of clarity:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">_At_</span> <span class="kd">←</span> <span class="kt">{</span> <span class="c1">⍝ Partial @ - left and right operands must be functions, and the right arg a vector</span>
    <span class="nv">data</span> <span class="kd">←</span> <span class="bp">⍵</span>
    <span class="p">(</span><span class="nv">mask</span><span class="na">/</span><span class="nv">data</span><span class="p">)</span> <span class="kd">←</span> <span class="bp">⍺⍺</span> <span class="p">(</span><span class="nv">mask</span><span class="kd">←</span><span class="bp">⍵⍵</span> <span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="bp">⍵</span>
    <span class="nv">data</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="m">5</span><span class="o">+</span><span class="bp">⍵</span><span class="kt">}</span><span class="nv">_At_</span><span class="kt">{</span><span class="m">0</span><span class="o">=</span><span class="m">2</span><span class="o">|</span><span class="bp">⍵</span><span class="kt">}</span> <span class="o">⍳</span><span class="m">12</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5 1 7 3 9 5 11 7 13 9 15 11
</span></div></div>
</div>
<p>We used leading and trailing underscores when naming our operator to indicate visually that it’s a dyad, as suggested by Adám Brudzewsky’s unofficial <a class="reference external" href="https://abrudz.github.io/style/#cc">style guide</a>.</p>
<div class="section" id="higher-rank-choose-and-reach">
<h3>Higher rank: choose and reach<a class="headerlink" href="#higher-rank-choose-and-reach" title="Permalink to this headline">¶</a></h3>
<p>The real <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> has many more tricks up its sleeve, of course. It can also be applied to arrays of any rank, not just vectors.</p>
<p>If we look at <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/At.htm">Dyalog’s specification</a> of <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> we have</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="nv">R</span><span class="kd">←</span><span class="kt">{</span><span class="nv">X</span><span class="kt">}</span><span class="p">(</span><span class="nv">f</span><span class="na">@</span><span class="nv">g</span><span class="p">)</span><span class="nv">Y</span>
</pre></div>
</div>
<p>If <code class="docutils literal notranslate"><span class="pre">g</span></code> is a simple vector, it chooses <em>major cells</em> in <code class="docutils literal notranslate"><span class="pre">Y</span></code>. If <code class="docutils literal notranslate"><span class="pre">g</span></code> is nested, it specifies indices for <em>choose</em> or <em>reach</em> indexing. What does that mean, then? One way to think of it is that the <code class="docutils literal notranslate"><span class="pre">g</span></code> vector behaves just as if it had been inserted between square brackets.</p>
<p>The first case is straightforward: the major cells of an array are those given by the first axis of the shape. In the case of a 2D matrix, its rows:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="na">@</span><span class="m">0</span> <span class="m">2</span> <span class="o">⊢</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="c1">⍝ Negate rows 0 and 2: major cells</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">¯1 ¯2 ¯3
 4  5  6
¯7 ¯8 ¯9
</span></div></div>
</div>
<p>If we want to access individual elements we can use <em>choose indexing</em> – which is a nested vector of indices:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="na">@</span><span class="p">(</span><span class="m">0</span> <span class="m">0</span><span class="p">)(</span><span class="m">2</span> <span class="m">2</span><span class="p">)</span> <span class="o">⊢</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span> <span class="m">9</span> <span class="c1">⍝ Negate corners of main diagonal by choose indexing</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">¯1 2  3
 4 5  6
 7 8 ¯9
</span></div></div>
</div>
<p>We can also access elements that are deeply nested using <em>reach indexing</em>, which we met briefly in the <a class="reference internal" href="intro.html#document-indexing"><span class="doc std std-doc">indexing</span></a> section:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">G</span> <span class="kd">←</span> <span class="m">2</span> <span class="m">3</span><span class="o">⍴</span><span class="p">(</span><span class="s1">&#39;Adam&#39;</span> <span class="m">1</span><span class="p">)(</span><span class="s1">&#39;Bob&#39;</span> <span class="m">2</span><span class="p">)(</span><span class="s1">&#39;Carl&#39;</span> <span class="m">3</span><span class="p">)(</span><span class="s1">&#39;Danni&#39;</span> <span class="m">4</span><span class="p">)(</span><span class="s1">&#39;Eve&#39;</span> <span class="m">5</span><span class="p">)(</span><span class="s1">&#39;Frank&#39;</span> <span class="m">6</span><span class="p">)</span>
<span class="s1">&#39;***&#39;</span> <span class="m">¯999</span><span class="na">@</span><span class="p">((</span><span class="m">0</span> <span class="m">0</span><span class="p">)</span><span class="m">0</span><span class="p">)((</span><span class="m">1</span> <span class="m">2</span><span class="p">)</span><span class="m">1</span><span class="p">)</span><span class="o">⊢</span><span class="nv">G</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────┬───────┬─────────┐
│┌────┬─┐ │┌───┬─┐│┌────┬─┐ │
││Adam│1│ ││Bob│2│││Carl│3│ │
│└────┴─┘ │└───┴─┘│└────┴─┘ │
├─────────┼───────┼─────────┤
│┌─────┬─┐│┌───┬─┐│┌─────┬─┐│
││Danni│4│││Eve│5│││Frank│6││
│└─────┴─┘│└───┴─┘│└─────┴─┘│
└─────────┴───────┴─────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────┬───────┬────────────┐
│┌───┬─┐  │┌───┬─┐│┌────┬─┐    │
││***│1│  ││Bob│2│││Carl│3│    │
│└───┴─┘  │└───┴─┘│└────┴─┘    │
├─────────┼───────┼────────────┤
│┌─────┬─┐│┌───┬─┐│┌─────┬────┐│
││Danni│4│││Eve│5│││Frank│¯999││
│└─────┴─┘│└───┴─┘│└─────┴────┘│
└─────────┴───────┴────────────┘
</span></div></div>
</div>
</div>
<div class="section" id="examples">
<h3>Examples<a class="headerlink" href="#examples" title="Permalink to this headline">¶</a></h3>
<p>Here’s a random collection of handy <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> expressions. Many more on <a class="reference external" href="https://aplcart.info/?q=%40">APLCart</a>, too.</p>
<p><strong>Replace dashes with spaces</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39; &#39;</span><span class="na">@</span><span class="p">(</span><span class="o">=</span><span class="na">∘</span><span class="s1">&#39;-&#39;</span><span class="p">)</span> <span class="s1">&#39;Hello-World-One-Two&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Hello World One Two
</span></div></div>
</div>
<p><strong>Pad an array with zeros</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="na">@</span><span class="p">(</span><span class="m">1</span><span class="o">+⍳⍴</span><span class="bp">⍵</span><span class="p">)</span><span class="o">⊢</span><span class="m">0</span><span class="o">⍴</span><span class="na">⍨</span><span class="m">2</span><span class="o">+⍴</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">2</span> <span class="m">2</span><span class="o">⍴</span><span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0 0
0 1 1 0
0 1 1 0
0 0 0 0
</span></div></div>
</div>
<p><strong>Array search and replace</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">array</span> <span class="kd">←</span> <span class="o">?</span><span class="m">10</span> <span class="m">3</span><span class="o">⍴</span><span class="m">10</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="kt">{</span><span class="bp">⍺⍺</span><span class="p">(</span><span class="bp">⍵⍵</span><span class="o">⌷</span><span class="na">⍨∘</span><span class="o">⊂⍳</span><span class="p">)</span><span class="na">@</span><span class="p">(</span><span class="o">∊</span><span class="na">∘</span><span class="bp">⍺⍺</span><span class="p">)</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">0</span> <span class="m">10</span> <span class="m">100</span> <span class="m">1000</span> <span class="o">⊢</span> <span class="nv">array</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓3 2 3│
│9 0 4│
│2 1 9│
│9 1 4│
│8 7 9│
│3 1 1│
│5 7 9│
│9 0 9│
│8 9 9│
│8 8 9│
└~────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────┐
↓100 10  100│
│  9  0 1000│
│ 10  0    9│
│  9  0 1000│
│  8  7    9│
│100  0    0│
│  5  7    9│
│  9  0    9│
│  8  9    9│
│  8  8    9│
└~──────────┘
</span></div></div>
</div>
<p><strong>Boolean alternating selection</strong></p>
<p>Here’s a creative use of <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> that <a class="reference external" href="https://aplwiki.com/wiki/Ad%C3%A1m_Brudzewsky">Adám Brudzewsky</a> posted on <a class="reference external" href="https://chat.stackexchange.com/transcript/message/57882002#57882002">APL Orchard</a>.</p>
<p>Given two arrays A, B and a boolean filter C, select items from A where C is false and from B where C is true:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">A</span> <span class="kd">←</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span>
<span class="nv">B</span> <span class="kd">←</span> <span class="m">11</span> <span class="m">22</span> <span class="m">33</span> <span class="m">44</span>
<span class="nv">C</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span>
<span class="p">(</span><span class="nv">C</span><span class="na">/⍥</span><span class="o">,</span><span class="nv">B</span><span class="p">)</span><span class="na">@</span><span class="kt">{</span><span class="nv">C</span><span class="kt">}</span><span class="nv">A</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 22 3 44
</span></div></div>
</div>
<p>If that looks puzzling (we haven’t met the <code class="docutils literal notranslate"><span class="pre">⍥</span></code> operator yet!), for vectors, it’s just</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">C</span><span class="na">/</span><span class="nv">B</span><span class="p">)</span><span class="na">@</span><span class="kt">{</span><span class="nv">C</span><span class="kt">}</span><span class="nv">A</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 22 3 44
</span></div></div>
</div>
<p>All that says is: replace the true spots (as defined by C) in A with the true spots (as defined by C) from B, which we could also do as an assignable indexing expression if we don’t mind mutating A:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">C</span><span class="na">/</span><span class="nv">A</span><span class="p">)</span> <span class="kd">←</span> <span class="nv">C</span><span class="na">/</span><span class="nv">B</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">A</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 22 3 44
</span></div></div>
</div>
</div>
</div>
<span id="document-rank"></span><div class="tex2jax_ignore mathjax_ignore section" id="the-rank-atop-operator">
<h2>The Rank/Atop operator: <code class="docutils literal notranslate"><span class="pre">⍤</span></code><a class="headerlink" href="#the-rank-atop-operator" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>An algorithm must be seen to be believed.
–<em>Don Knuth</em></p>
</div></blockquote>
<p>The somewhat startled-looking <em>Rank</em> operator, <code class="docutils literal notranslate"><span class="pre">⍤</span></code>, has a reputation for being one of the harder ones to grasp. It sits on the ‘J’ key, a handy mnemonic, as it was an invention borrowed from the <a class="reference external" href="https://www.jsoftware.com/#/">J-language</a>. Well, it makes sense to <em>me</em>.</p>
<p>If <code class="docutils literal notranslate"><span class="pre">⍤</span></code> is given a right operand <em>function</em> it becomes <em>Atop</em>. We’ll talk about that after we’ve covered the <em>Rank</em> version.</p>
<p>Other resources on <em>Rank</em> and <em>Atop</em>:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://aplwiki.com/wiki/Rank_(operator)">APL Wiki</a></p></li>
<li><p>Dyalog docs <a class="reference external" href="https://help.dyalog.com/latest/Content/Language/Primitive%20Operators/Rank.htm">Rank</a>, <a class="reference external" href="https://help.dyalog.com/latest/index.htm#Language/Primitive%20Operators/Atop.htm">Atop</a></p></li>
<li><p>Webinars: <a class="reference external" href="https://dyalog.tv/Webinar/?v=IBct81IopRk">Rank Operator</a>, <a class="reference external" href="https://dyalog.tv/Webinar/?v=5wW76XX0kqk">Advanced Rank</a>, <a class="reference external" href="https://dyalog.tv/Webinar/?v=zBqdeDJPPRc">Rank and Dyadic Transpose</a></p></li>
<li><p>APL Orchard cultivations: <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-32-basic-use-of-">Basic Rank</a>, <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-33-advanced-use-of-">Advanced Rank</a>, <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-47-atop--and-over-">Atop and Over</a></p></li>
<li><p>Roger Hui: <a class="reference external" href="https://www.jsoftware.com/papers/rank/">Rank Operator: An Idea Worth <s>Stealing</s> Borrowing</a></p></li>
</ul>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">
Rebuilding user command cache... 
done
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<p>In essence, the simple use of <em>Rank</em> drills into the argument array and applies its operand to sub-cells of a specified rank only.</p>
<p>Consider the following rank 3 array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">27</span><span class="o">?</span><span class="m">27</span>
<span class="o">≢⍴</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→───────┐
↓↓ 3  0 21│
││19 15  9│
││24  6 17│
││        │
││26  8 20│
││ 4 14 12│
││11 23  5│
││        │
││18  7  2│
││13 16  1│
││22 25 10│
└└~───────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div></div>
</div>
<p>Let’s say we want to drop the first row of each layer of this array. In this case, we could use a bracket-axis specification to drop:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="o">↓</span><span class="sr">[</span><span class="m">1</span><span class="sr">]</span><span class="nv">m</span> <span class="c1">⍝ Apply drop ↓ to axis 1, i.e. the y-axis, with ⎕IO←0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">19 15  9
24  6 17

 4 14 12
11 23  5

13 16  1
22 25 10
</span></div></div>
</div>
<p>However, this is now <code class="docutils literal notranslate"><span class="pre">⎕IO</span></code> dependent, and the bracket-axis spec has some other undesirable properties, including the fact that it cannot be applied to user-defined functions.</p>
<p>The <em>Rank</em> operator allows us to solve this in a different way:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="o">↓</span><span class="na">⍤</span><span class="m">2</span><span class="o">⊢</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">19 15  9
24  6 17

 4 14 12
11 23  5

13 16  1
22 25 10
</span></div></div>
</div>
<p>You can think of <em>Rank</em> in this case being closer to the problem statement: drop the first major cell of each <em>sub-cell</em> that has a rank one less than the argument. Or: in our 3D array, apply the drop to each of its constituent 2D arrays.</p>
<p>Note that <em>Rank</em> doesn’t equal <em>depth</em>, and this is part of the reason why the <em>Rank</em> operator can be confusing. So given a complex vector that contains a variety of scalars and higher-rank arrays, you can’t use the <em>Rank</em> operator to selectively apply a function to, say, just the vectors.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">V</span> <span class="kd">←</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">)(</span><span class="m">2</span> <span class="m">2</span><span class="o">⍴</span><span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span><span class="p">)(</span><span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬───┬─┐
│1 2 3│1 1│1│
│     │1 1│ │
└─────┴───┴─┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">≢</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">V</span> <span class="c1">⍝ NOTE: this is wrong!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div></div>
</div>
<p>In this case, <code class="docutils literal notranslate"><span class="pre">V</span></code> is of course already a rank 1 array (i.e. a vector). But wait, there is more confusion to be had! The right operand doesn’t even have to be a scalar at all.</p>
<p>We already saw that if the right operand of <code class="docutils literal notranslate"><span class="pre">⍤</span></code> is a scalar, we are specifying which rank sub cells we want a function to apply to. For dyadic usage, we instead specify which sub-cells of the left argument should be paired up with which sub-cells of the right argument. It takes a while to wrap your head around this.</p>
<p>Here’s an example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="o">,</span><span class="na">⍤</span><span class="m">0</span> <span class="m">1</span> <span class="o">⊢</span> <span class="s1">&#39;hello&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 hello
2 hello
3 hello
</span></div></div>
</div>
<p>This says that the <em>left</em> argument of the derived function should be paired at rank 0 (that is each element) with the <em>right</em> argument at rank 1 (that is the whole vector in this case). If this feels reminiscent of an outer product, you’re not wrong.</p>
<p>In other words, <em>Rank pairs up</em> the arguments of the function it derives. We can examine which elements would be paired up by using the following incantation in place of our function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">rankpairs</span> <span class="kd">←</span> <span class="o">⊂</span><span class="na">⍤</span><span class="o">,</span><span class="na">⍥</span><span class="o">⊂</span>
</pre></div>
</div>
</div>
</div>
<p>if you know what that means, you probably don’t need to read this tutorial. If not, don’t worry – treat it as a debug statement:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="nv">rankpairs</span><span class="na">⍤</span><span class="m">0</span> <span class="m">1</span> <span class="o">⊢</span> <span class="s1">&#39;hello&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────┬─────────┬─────────┐
│┌─┬─────┐│┌─┬─────┐│┌─┬─────┐│
││1│hello│││2│hello│││3│hello││
│└─┴─────┘│└─┴─────┘│└─┴─────┘│
└─────────┴─────────┴─────────┘
</span></div></div>
</div>
<p>In the section on <a class="reference internal" href="intro.html#document-indexing"><span class="doc std std-doc">array indexing</span></a> earlier, we introduced the concept of <em>Sane Indexing</em> without any further explanation on how it was working. Here it is again, as a <a class="reference internal" href="intro.html#document-tacit"><span class="doc std std-doc">tacit</span></a> function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">I</span><span class="kd">←</span><span class="o">⌷</span><span class="na">⍨∘</span><span class="o">⊃</span><span class="na">⍨⍤</span><span class="m">0</span> <span class="m">99</span> <span class="c1">⍝ Sane indexing, a.k.a select</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we understand a bit about <em>Rank</em>, we can at least make a start in taking that apart. So we have a <em>Rank</em> 0 99 to the right, stating that we should combine the left argument at rank 0 (scalars) with the right argument at “rank 99”. Rank 99 means “full rank” (Dyalog has an <em>actual</em> max rank of 15, so we could have used any number greater than or equal to 15). So we should combine “each scalar” to the left with “the whole thing, at whatever rank it happens to be” to the right.</p>
<p>The actual indexing is done by the leading <em>Squad</em> (<code class="docutils literal notranslate"><span class="pre">⌷</span></code>). Let’s de-selfie the expression and make it a dfn. Although we haven’t covered <a class="reference internal" href="intro.html#document-tacit"><span class="doc std std-doc">tacit</span></a> functions yet, we can have the interpreter help us out a bit to see how that expression actually parses:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span> <span class="o">-</span><span class="nv">trains</span><span class="o">=</span><span class="nv">tree</span> <span class="c1">⍝ Visualise tacit functions as a parse tree</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON -trains=tree
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⌷</span><span class="na">⍨∘</span><span class="o">⊃</span><span class="na">⍨⍤</span><span class="m">0</span> <span class="m">99</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">      ⍤
     ┌┴┐
     ⍨ 0 99
   ┌─┘
   ∘
  ┌┴┐
  ⍨ ⊃
┌─┘
⌷
</span></div></div>
</div>
<p>If we separate out the <em>Rank</em> expression, after a bit of head-scratching, we arrive at</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">sane</span><span class="kd">←</span><span class="kt">{</span><span class="p">(</span><span class="o">⊃</span><span class="bp">⍺</span><span class="p">)</span><span class="o">⌷</span><span class="bp">⍵</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="nv">sane</span> <span class="s1">&#39;abcdefg&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">d
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="nv">sane</span><span class="na">⍤</span><span class="m">0</span> <span class="m">99</span><span class="o">⊢</span><span class="s1">&#39;abcdefg&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">bcd
</span></div></div>
</div>
<p>Hopefully, we can now see a bit clearer how it works – we simply pass the disclosed left argument vector to <em>Squad</em>, and <em>Rank</em> does the appropriate combination of left and right: each left element, to the whole (full-rank) of the right.</p>
<p>Here’s another example. Given two integer arrays of the same shape, can we replicate (or compress) the rows of one from the other? We might be excused if we think that we can replicate-reduce, but this doesn’t work:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">A</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴</span><span class="m">2</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">1</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">B</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
↓2 1 1 1│
│1 2 1 1│
│1 1 2 1│
└~──────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
↓1 2 3 4│
│1 2 3 4│
│1 2 3 4│
└~──────┘
</span></div></div>
</div>
<p>(note: all expressions in the next cell will generate syntax or rank errors)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">A</span><span class="na">∘//</span><span class="nv">B</span>     <span class="c1">⍝ Nope... SYNTAX ERROR</span>
<span class="kt">{</span><span class="nv">A</span><span class="na">/</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">/</span><span class="nv">B</span>   <span class="c1">⍝ Nope... RANK ERROR</span>
<span class="nv">A</span><span class="na">∘</span><span class="kt">{</span><span class="bp">⍺</span><span class="na">/</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">/</span><span class="nv">B</span> <span class="c1">⍝ Nope... SYNTAX ERROR</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SYNTAX ERROR: The function does not take a left argument
      A∘//B     ⍝ Nope... SYNTAX ERROR
        ∧
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>RANK ERROR
      {A/⍵}/B   ⍝ Nope... RANK ERROR
        ∧
</pre></div>
</div>
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>SYNTAX ERROR: The function does not take a left argument
      A∘{⍺/⍵}/B ⍝ Nope... SYNTAX ERROR
            ∧
</pre></div>
</div>
</div>
</div>
<p>Instead, we need to reach for <em>Rank</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">A</span><span class="na">/⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">B</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1 2 3 4
1 2 2 3 4
1 2 3 3 4
</span></div></div>
</div>
<p>If we spell it out in plain words, perhaps the use of <em>Rank</em> suggests itself: combine each major cell on the left with the corresponding major cell on the right, and apply the dyadic function “replicate”. Every time you think “combine each major cell on the left…”, you should think <em>Rank</em>.</p>
<p>As we’ve seen elsewhere, APL has a somewhat unholy mix of leading and trailing axis operators, mainly for historical reasons. <em>Rank</em> allows us to stick to the leading axis versions [<a class="reference external" href="https://dl.acm.org/doi/pdf/10.1145/3386319">Kromberg and Hui</a>]:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Leading axis</p></th>
<th class="text-align:left head"><p>Trailling axis</p></th>
<th class="text-align:left head"><p>Operation</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p>(⊖⍤1)⍵</p></td>
<td class="text-align:left"><p>⌽⍵</p></td>
<td class="text-align:left"><p>reverse</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>⍺(⊖⍤1)⍵</p></td>
<td class="text-align:left"><p>⍺⌽⍵</p></td>
<td class="text-align:left"><p>rotate (scalar ⍺)</p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p>(f⌿⍤1)⍵</p></td>
<td class="text-align:left"><p>f/⍵</p></td>
<td class="text-align:left"><p>reduce</p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p>(f⍀⍤1)⍵</p></td>
<td class="text-align:left"><p>f\⍵</p></td>
<td class="text-align:left"><p>scan</p></td>
</tr>
</tbody>
</table>
<div class="section" id="relative-rank">
<h3>Relative rank<a class="headerlink" href="#relative-rank" title="Permalink to this headline">¶</a></h3>
<p>The right operand can also contain negative numbers, which are taken to be rank relative to the argument, rather than an absolute specification:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">/⍤</span><span class="m">¯1</span><span class="o">⊢</span><span class="m">3</span> <span class="m">3</span><span class="o">⍴⍳</span><span class="m">9</span>              <span class="c1">⍝ Sum at rank one less than the rank of the matrix, i.e. along each row</span>
<span class="sr">]</span><span class="nv">display</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴⍳</span><span class="m">24</span>
<span class="sr">]</span><span class="nv">display</span> <span class="o">+</span><span class="na">/⍤</span><span class="m">¯2</span><span class="o">⊢</span><span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴⍳</span><span class="m">24</span>  <span class="c1">⍝ Sum at rank two less than the rank of the cube, i.e. along rows of each layer</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 12 21
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→──────────┐
↓↓ 0  1  2  3│
││ 4  5  6  7│
││ 8  9 10 11│
││           │
││12 13 14 15│
││16 17 18 19│
││20 21 22 23│
└└~──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────┐
↓ 6 22 38│
│54 70 86│
└~───────┘
</span></div></div>
</div>
</div>
<div class="section" id="rank-drills">
<h3>Rank drills<a class="headerlink" href="#rank-drills" title="Permalink to this headline">¶</a></h3>
<p>In his paper <a class="reference external" href="https://www.jsoftware.com/papers/APL_exercises/">APL Excercises</a>, Roger Hui sets out the following drills for <em>Rank</em>. See if you can predict the results before revealing the answers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">,</span><span class="nv">t</span><span class="kd">←</span><span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴⍳</span><span class="m">24</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23
</span></div></div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">,</span><span class="na">⍤</span><span class="m">3</span><span class="o">⊢</span><span class="nv">t</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">,</span><span class="na">⍤</span><span class="m">2</span><span class="o">⊢</span><span class="nv">t</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">,</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────────────────────────────┐
↓ 0  1  2  3  4  5  6  7  8  9 10 11│
│12 13 14 15 16 17 18 19 20 21 22 23│
└~──────────────────────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→──────────┐
↓↓ 0  1  2  3│
││ 4  5  6  7│
││ 8  9 10 11│
││           │
││12 13 14 15│
││16 17 18 19│
││20 21 22 23│
└└~──────────┘
</span></div></div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊂</span><span class="na">⍤</span><span class="m">3</span><span class="o">⊢</span><span class="nv">t</span>
<span class="o">⊂</span><span class="na">⍤</span><span class="m">2</span><span class="o">⊢</span><span class="nv">t</span>
<span class="o">⊂</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────┐
│ 0  1  2  3│
│ 4  5  6  7│
│ 8  9 10 11│
│           │
│12 13 14 15│
│16 17 18 19│
│20 21 22 23│
└───────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────┬───────────┐
│0 1  2  3│12 13 14 15│
│4 5  6  7│16 17 18 19│
│8 9 10 11│20 21 22 23│
└─────────┴───────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────┬───────────┬───────────┐
│0 1 2 3    │4 5 6 7    │8 9 10 11  │
├───────────┼───────────┼───────────┤
│12 13 14 15│16 17 18 19│20 21 22 23│
└───────────┴───────────┴───────────┘
</span></div></div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↑</span> <span class="o">,</span><span class="na">¨</span> <span class="o">⊂</span><span class="na">⍤</span><span class="m">3</span><span class="o">⊢</span><span class="nv">t</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">↑</span> <span class="o">,</span><span class="na">¨</span> <span class="o">⊂</span><span class="na">⍤</span><span class="m">2</span><span class="o">⊢</span><span class="nv">t</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">↑</span> <span class="o">,</span><span class="na">¨</span> <span class="o">⊂</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────────────────────────────┐
↓ 0  1  2  3  4  5  6  7  8  9 10 11│
│12 13 14 15 16 17 18 19 20 21 22 23│
└~──────────────────────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→──────────┐
↓↓ 0  1  2  3│
││ 4  5  6  7│
││ 8  9 10 11│
││           │
││12 13 14 15│
││16 17 18 19│
││20 21 22 23│
└└~──────────┘
</span></div></div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">+</span><span class="na">⌿⍤</span><span class="m">3</span><span class="o">⊢</span><span class="nv">t</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">+</span><span class="na">⌿⍤</span><span class="m">2</span><span class="o">⊢</span><span class="nv">t</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">+</span><span class="na">⌿⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────┐
↓12 14 16 18│
│20 22 24 26│
│28 30 32 34│
└~──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────┐
↓12 15 18 21│
│48 51 54 57│
└~──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────┐
↓ 6 22 38│
│54 70 86│
└~───────┘
</span></div></div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">⊖</span><span class="na">⍤</span><span class="m">3</span><span class="o">⊢</span><span class="nv">t</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">⊖</span><span class="na">⍤</span><span class="m">2</span><span class="o">⊢</span><span class="nv">t</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">⊖</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">t</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→──────────┐
↓↓12 13 14 15│
││16 17 18 19│
││20 21 22 23│
││           │
││ 0  1  2  3│
││ 4  5  6  7│
││ 8  9 10 11│
└└~──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→──────────┐
↓↓ 8  9 10 11│
││ 4  5  6  7│
││ 0  1  2  3│
││           │
││20 21 22 23│
││16 17 18 19│
││12 13 14 15│
└└~──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→──────────┐
↓↓ 3  2  1  0│
││ 7  6  5  4│
││11 10  9  8│
││           │
││15 14 13 12│
││19 18 17 16│
││23 22 21 20│
└└~──────────┘
</span></div></div>
</div>
<p>If you got all those right, well done – Roger’s paper has got many more for you to pit your wits against.</p>
</div>
<div class="section" id="atop">
<h3>Atop<a class="headerlink" href="#atop" title="Permalink to this headline">¶</a></h3>
<p>As we mentioned above, from version 18 of Dyalog, <code class="docutils literal notranslate"><span class="pre">⍤</span></code> can also be <em>Atop</em> if given a right operand function instead of array. We’ll see more of different kinds of <em>Atop</em> later in the <a class="reference internal" href="intro.html#document-tacit"><span class="doc std std-doc">tacit</span></a> chapter, but for now it’s a functional composition rule, stating that (for the dyadic case),</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="nv">X</span> <span class="nv">f</span><span class="na">⍤</span><span class="nv">g</span> <span class="nv">Y</span> <span class="kd">→</span> <span class="nv">f</span> <span class="nv">X</span> <span class="nv">g</span> <span class="nv">Y</span>
</pre></div>
</div>
<p>It is similar enough to <em>Jot</em>, <code class="docutils literal notranslate"><span class="pre">∘</span></code>, to be confusing. Whilst monadic <code class="docutils literal notranslate"><span class="pre">∘</span></code> is an atop, dyadic <code class="docutils literal notranslate"><span class="pre">∘</span></code> is a <em>beside</em>. Behold:</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="nv">f</span><span class="na">∘</span><span class="nv">g</span> <span class="nv">X</span> <span class="kd">→</span> <span class="nv">f</span><span class="p">(</span><span class="nv">gX</span><span class="p">)</span> <span class="kd">→</span> <span class="nv">fgX</span>
<span class="nv">f</span><span class="na">⍤</span><span class="nv">g</span> <span class="nv">X</span> <span class="kd">→</span> <span class="nv">f</span><span class="p">(</span><span class="nv">gX</span><span class="p">)</span> <span class="kd">→</span> <span class="nv">fgX</span>
<span class="nv">X</span> <span class="nv">f</span><span class="na">∘</span><span class="nv">g</span> <span class="nv">Y</span> <span class="kd">→</span> <span class="nv">X</span> <span class="nv">f</span> <span class="nv">g</span> <span class="nv">Y</span>
<span class="nv">X</span> <span class="nv">f</span><span class="na">⍤</span><span class="nv">g</span> <span class="nv">Y</span> <span class="kd">→</span> <span class="nv">f</span> <span class="nv">X</span> <span class="nv">g</span> <span class="nv">Y</span>
</pre></div>
</div>
<p>Another way to think about it is that in the dyadic case, the difference between <code class="docutils literal notranslate"><span class="pre">∘</span></code> and <code class="docutils literal notranslate"><span class="pre">⍤</span></code> is which operand function (<code class="docutils literal notranslate"><span class="pre">f</span></code> or <code class="docutils literal notranslate"><span class="pre">g</span></code>) gets the left argument. In the monadic case, <em>Atop</em> is equivalent for <code class="docutils literal notranslate"><span class="pre">∘</span></code> and <code class="docutils literal notranslate"><span class="pre">⍤</span></code>, so it’s worth using <code class="docutils literal notranslate"><span class="pre">⍤</span></code> for both monadic and dyadic atops for consistency.</p>
<p>Here is a simple example of a dyadic <em>Atop</em>,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="o">-</span><span class="na">⍤</span><span class="o">+</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="c1">⍝ Negate the sum of two vectors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">¯5 ¯7 ¯9
</span></div></div>
</div>
<p>which, following the <code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">f⍤g</span> <span class="pre">Y</span> <span class="pre">→</span> <span class="pre">f</span> <span class="pre">X</span> <span class="pre">g</span> <span class="pre">Y</span></code> rule, is the same as</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">-</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="o">+</span><span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="c1">⍝ Negate the sum of two vectors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">¯5 ¯7 ¯9
</span></div></div>
</div>
<p>or, as a tacit formulation (which we’ll cover in more detail later),</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="p">(</span><span class="o">-+</span><span class="p">)</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="c1">⍝ Negate the sum of two vectors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">¯5 ¯7 ¯9
</span></div></div>
</div>
</div>
</div>
<span id="document-stencil"></span><div class="tex2jax_ignore mathjax_ignore section" id="the-stencil-operator">
<h2>The Stencil operator: <code class="docutils literal notranslate"><span class="pre">⌺</span></code><a class="headerlink" href="#the-stencil-operator" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Every time I see some piece of medical research saying that caffeine is good for you, I high-five myself. Because I’m going to live forever.
–<em>Linus Torvalds</em></p>
</div></blockquote>
<p>Are you familiar with Conway’s <a class="reference external" href="https://en.wikipedia.org/wiki/Conway%27s_Game_of_Life"><em>Game of Life</em></a>? If not, it’s a cellular automaton with a deceptively simple set of rules:</p>
<ol class="simple">
<li><p>Any live cell with two or three live neighbours survives.</p></li>
<li><p>Any dead cell with three live neighbours becomes a live cell.</p></li>
<li><p>All other live cells die in the next generation.</p></li>
</ol>
<p>yet <em>Game of Life</em> gives rise to extraordinary complex patterns. It’s fun to implement – try it in your favourite language! Some good ones can be found on <a class="reference external" href="https://rosettacode.org/wiki/Conway%27s_Game_of_Life">Rosettacode</a>.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<p><em>Game of Life</em> is a bit of an APL party trick, to the extent that it may be the only application of APL that people have heard of after seeing a <a class="reference external" href="https://www.youtube.com/watch?v=a9xAKttWgP4">famous video</a> of John Scholes’.</p>
<p>Here’s the current champion, all 17 symbols of it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">gol</span> <span class="kd">←</span> <span class="kt">{</span><span class="o">≢⍸</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌺</span><span class="m">3</span> <span class="m">3</span><span class="o">∊</span><span class="na">¨</span><span class="m">3</span><span class="o">+</span><span class="m">0</span><span class="o">,</span><span class="na">¨</span><span class="o">⊢</span> <span class="c1">⍝ Generate the next generation</span>
</pre></div>
</div>
</div>
</div>
<p>To run it, we first need an array with some live cells in it. Here’s an 8×8 petri dish containing a “glider”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">glider</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span>
<span class="nv">dish</span> <span class="kd">←</span> <span class="m">8</span> <span class="m">8</span><span class="o">⍴</span><span class="m">0</span>
<span class="nv">dish</span><span class="sr">[</span><span class="p">(</span><span class="o">⊂</span><span class="m">3</span> <span class="m">3</span><span class="p">)</span><span class="o">+⍸</span><span class="nv">glider</span><span class="sr">]</span> <span class="kd">←</span> <span class="m">1</span>
<span class="nv">dish</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0 0 0 0 0 0
0 0 0 0 0 0 0 0
0 0 0 0 0 0 0 0
0 0 0 0 0 1 0 0
0 0 0 1 0 1 0 0
0 0 0 0 1 1 0 0
0 0 0 0 0 0 0 0
0 0 0 0 0 0 0 0
</span></div></div>
</div>
<p>The glider pattern is called so because it glides across the dish. Here’s a full cycle:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">4</span><span class="o">⍴</span><span class="p">(</span><span class="nv">gol</span><span class="na">⍣</span><span class="m">1</span><span class="o">⊢</span><span class="nv">dish</span><span class="p">)(</span><span class="nv">gol</span><span class="na">⍣</span><span class="m">2</span><span class="o">⊢</span><span class="nv">dish</span><span class="p">)(</span><span class="nv">gol</span><span class="na">⍣</span><span class="m">3</span><span class="o">⊢</span><span class="nv">dish</span><span class="p">)(</span><span class="nv">gol</span><span class="na">⍣</span><span class="m">4</span><span class="o">⊢</span><span class="nv">dish</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────────┬───────────────┬───────────────┬───────────────┐
│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│
│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│
│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│
│0 0 0 0 1 0 0 0│0 0 0 0 0 1 0 0│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│
│0 0 0 0 0 1 1 0│0 0 0 0 0 0 1 0│0 0 0 0 1 0 1 0│0 0 0 0 0 0 1 0│
│0 0 0 0 1 1 0 0│0 0 0 0 1 1 1 0│0 0 0 0 0 1 1 0│0 0 0 0 1 0 1 0│
│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│0 0 0 0 0 1 0 0│0 0 0 0 0 1 1 0│
│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│0 0 0 0 0 0 0 0│
└───────────────┴───────────────┴───────────────┴───────────────┘
</span></div></div>
</div>
<p>If you’d like to have the above Game of Life implementation dissected in detail, head over to <a class="reference external" href="https://dyalog.tv/Webinar/?v=3FjYly2G_QI">dyalog.tv</a>.</p>
<p>Anyway – this APL <em>Game of Life</em> implementation is primarily a demonstration of the power and versatility of the <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Operators/Stencil.htm"><em>Stencil</em></a> operator, <code class="docutils literal notranslate"><span class="pre">⌺</span></code>. In simple terms, the dyadic <em>Stencil</em> operator lets you specify a sliding window of a rank of your choice to the right and a function operating over this sliding window to the left. It makes it trivial to implement image processing filters or <a class="reference external" href="https://en.wikipedia.org/wiki/Convolution">convolution</a>. In essence, for the 2D case, it’s four nested for-loops, the outermost two moving the window, and the innermost two visiting every data point within the window.</p>
<p>This is obviously a good fit for <em>Game of Life</em>: the rules are defined within a 3×3 neighbourhood, so all we need to do is count the 1s in the windows that <em>Stencil</em> delivers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="o">≢⍸</span><span class="bp">⍵</span><span class="kt">}</span> <span class="nv">glider</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5
</span></div></div>
</div>
<p>Let’s look at <em>Stencil</em> in a bit more detail. We can illustrate the sliding window using enclose as the left operand and a size 2 window over a vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊂</span><span class="na">⍤</span><span class="o">⊢</span><span class="na">⌺</span><span class="m">2</span><span class="o">⊢⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬───┬───┬───┬───┬───┬───┬───┐
│0 1│1 2│2 3│3 4│4 5│5 6│6 7│7 8│8 9│
└───┴───┴───┴───┴───┴───┴───┴───┴───┘
</span></div></div>
</div>
<p>But now look what happens if we increase the window size to 3:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊂</span><span class="na">⍤</span><span class="o">⊢</span><span class="na">⌺</span><span class="m">3</span><span class="o">⊢⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┬─────┐
│0 0 1│0 1 2│1 2 3│2 3 4│3 4 5│4 5 6│5 6 7│6 7 8│7 8 9│8 9 0│
└─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┴─────┘
</span></div></div>
</div>
<p>The first and last windows now “overhang” the edge, filling the overhang with zeros. The way to think of it is that each data point in the argument array must line up with the <em>centre</em> of the window.</p>
<p><em>Stencil</em> has a few more tricks up its sleeve. The right operand can be an array, where the first row defines the shape of the window, and the second row defines the <em>step size</em>. Again, using the vector above, we can say that we want a size 3 window, but instead of moving it one step (the default), we want to shift it three steps each time:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊂</span><span class="na">⍤</span><span class="o">⊢</span><span class="na">⌺</span><span class="p">(</span><span class="o">⍪</span><span class="m">3</span> <span class="m">3</span><span class="p">)</span><span class="o">⊢⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┬─────┐
│0 0 1│2 3 4│5 6 7│8 9 0│
└─────┴─────┴─────┴─────┘
</span></div></div>
</div>
<p>We still have an odd-size window, and the first is centered over the first item as before. The step size, 3, dictates how far the center of the window moves, so the next window is centered over item 3 etc.</p>
<p>With an even size we can create non-overlapping windows that don’t overhang,</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊂</span><span class="na">⍤</span><span class="o">⊢</span><span class="na">⌺</span><span class="p">(</span><span class="o">⍪</span><span class="m">2</span> <span class="m">2</span><span class="p">)</span><span class="o">⊢⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬───┬───┬───┐
│0 1│2 3│4 5│6 7│8 9│
└───┴───┴───┴───┴───┘
</span></div></div>
</div>
<p>and, of course, even-sized, non-overlapping windows that <em>do</em> overhang, too, if that’s what we want:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊂</span><span class="na">⍤</span><span class="o">⊢</span><span class="na">⌺</span><span class="p">(</span><span class="o">⍪</span><span class="m">4</span> <span class="m">4</span><span class="p">)</span><span class="o">⊢⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────┬───────┬───────┐
│0 0 1 2│3 4 5 6│7 8 9 0│
└───────┴───────┴───────┘
</span></div></div>
</div>
<div class="section" id="the-left-argument">
<h3>The left argument<a class="headerlink" href="#the-left-argument" title="Permalink to this headline">¶</a></h3>
<p>The left operand function is actually called with a left argument; a vector indicating the number of fill arguments per axis: positive for the “before”, and negative for the “after”.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="o">⊂</span><span class="bp">⍺</span> <span class="bp">⍵</span><span class="kt">}</span><span class="na">⌺</span><span class="m">3</span> <span class="m">3</span><span class="o">⊢</span><span class="m">3</span> <span class="m">5</span><span class="o">⍴</span><span class="nf">⎕A</span> <span class="c1">⍝ Show the left argument vector</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──────────┬──────────┬──────────┬──────────┬───────────┐
│┌───┬───┐ │┌───┬───┐ │┌───┬───┐ │┌───┬───┐ │┌────┬───┐ │
││1 1│   │ ││1 0│   │ ││1 0│   │ ││1 0│   │ ││1 ¯1│   │ │
││   │ AB│ ││   │ABC│ ││   │BCD│ ││   │CDE│ ││    │DE │ │
││   │ FG│ ││   │FGH│ ││   │GHI│ ││   │HIJ│ ││    │IJ │ │
│└───┴───┘ │└───┴───┘ │└───┴───┘ │└───┴───┘ │└────┴───┘ │
├──────────┼──────────┼──────────┼──────────┼───────────┤
│┌───┬───┐ │┌───┬───┐ │┌───┬───┐ │┌───┬───┐ │┌────┬───┐ │
││0 1│ AB│ ││0 0│ABC│ ││0 0│BCD│ ││0 0│CDE│ ││0 ¯1│DE │ │
││   │ FG│ ││   │FGH│ ││   │GHI│ ││   │HIJ│ ││    │IJ │ │
││   │ KL│ ││   │KLM│ ││   │LMN│ ││   │MNO│ ││    │NO │ │
│└───┴───┘ │└───┴───┘ │└───┴───┘ │└───┴───┘ │└────┴───┘ │
├──────────┼──────────┼──────────┼──────────┼───────────┤
│┌────┬───┐│┌────┬───┐│┌────┬───┐│┌────┬───┐│┌─────┬───┐│
││¯1 1│ FG│││¯1 0│FGH│││¯1 0│GHI│││¯1 0│HIJ│││¯1 ¯1│IJ ││
││    │ KL│││    │KLM│││    │LMN│││    │MNO│││     │NO ││
││    │   │││    │   │││    │   │││    │   │││     │   ││
│└────┴───┘│└────┴───┘│└────┴───┘│└────┴───┘│└─────┴───┘│
└──────────┴──────────┴──────────┴──────────┴───────────┘
</span></div></div>
</div>
<p>Another way to think of it is as what you need to drop to get rid of all the fillers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="o">⊂</span><span class="bp">⍺</span><span class="o">↓</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌺</span><span class="m">3</span> <span class="m">3</span><span class="o">⊢</span><span class="m">3</span> <span class="m">5</span><span class="o">⍴</span><span class="nf">⎕A</span> <span class="c1">⍝ Drop all fillers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬───┬───┬───┬──┐
│AB│ABC│BCD│CDE│DE│
│FG│FGH│GHI│HIJ│IJ│
├──┼───┼───┼───┼──┤
│AB│ABC│BCD│CDE│DE│
│FG│FGH│GHI│HIJ│IJ│
│KL│KLM│LMN│MNO│NO│
├──┼───┼───┼───┼──┤
│FG│FGH│GHI│HIJ│IJ│
│KL│KLM│LMN│MNO│NO│
└──┴───┴───┴───┴──┘
</span></div></div>
</div>
</div>
</div>
<span id="document-over"></span><div class="tex2jax_ignore mathjax_ignore section" id="the-over-operator">
<h2>The Över operator: <code class="docutils literal notranslate"><span class="pre">⍥</span></code><a class="headerlink" href="#the-over-operator" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Last week I was listening to a podcast on Hanselminutes, with Robert Martin talking about the SOLID principles… They all sounded to me like extremely bureaucratic programming that came from the mind of somebody that has not written a lot of code, frankly. –<em>Joel Spolsky</em></p>
</div></blockquote>
<p>If you thought <em>rank</em> looked startled, <code class="docutils literal notranslate"><span class="pre">⍤</span></code>, wait until you meet his big sister, <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Symbols/Circle%20Dieresis.htm">over</a>: <code class="docutils literal notranslate"><span class="pre">⍥</span></code>, <em>nom de guerre</em> for <em>Circle Diaresis</em>. <code class="docutils literal notranslate"><span class="pre">Over</span></code> was introduced to Dyalog in version 18. Over is a function composition rule, similar to those that govern <a class="reference internal" href="intro.html#document-tacit"><span class="doc std std-doc">tacit</span></a> programming. Once you “see” this pattern, you’ll see it everywhere. Let’s take a look.</p>
<p><code class="docutils literal notranslate"><span class="pre">Over</span></code> complements jot <code class="docutils literal notranslate"><span class="pre">∘</span></code> and the atop version of <code class="docutils literal notranslate"><span class="pre">⍤</span></code> in that it specifies how a set of functions should be applied to common arguments. If we compare <code class="docutils literal notranslate"><span class="pre">f∘g</span></code> and <code class="docutils literal notranslate"><span class="pre">f⍤g</span></code>, when given a left argument, <code class="docutils literal notranslate"><span class="pre">∘</span></code> gives it to the left-hand function and <code class="docutils literal notranslate"><span class="pre">⍤</span></code> gives it to the right-hand function. Other than that, they are the same. For the monadic case, these are all the same:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">f∘g</span> <span class="pre">Y</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">f⍤g</span> <span class="pre">Y</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">f⍥g</span> <span class="pre">Y</span></code></p></li>
</ul>
<p>In the dyadic case, look at the order of the leftmost two tokens:</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">f∘g</span> <span class="pre">Y</span></code> → <code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">f</span> <span class="pre">g</span> <span class="pre">Y</span></code></p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">f⍤g</span> <span class="pre">Y</span></code> → <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">X</span> <span class="pre">g</span> <span class="pre">Y</span></code></p></li>
</ul>
<p>and <code class="docutils literal notranslate"><span class="pre">over</span></code> completes this by</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">f⍥g</span> <span class="pre">Y</span></code> → <code class="docutils literal notranslate"><span class="pre">(g</span> <span class="pre">X)f(g</span> <span class="pre">Y)</span></code></p></li>
</ul>
<p>Clear as mud? But this really is a common pattern. For example, let’s say we want to know if one vector is longer than another, we would previously have written:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">X</span> <span class="kd">←</span> <span class="o">⍳</span><span class="m">7</span>
<span class="nv">Y</span> <span class="kd">←</span> <span class="o">⍳</span><span class="m">9</span>
<span class="p">(</span><span class="o">≢</span><span class="nv">X</span><span class="p">)</span><span class="o">&gt;</span><span class="p">(</span><span class="o">≢</span><span class="nv">Y</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">done

Rebuilding user command cache... done
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div></div>
</div>
<p>Using <code class="docutils literal notranslate"><span class="pre">over</span></code> we can instead now write</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">X</span> <span class="o">&gt;</span><span class="na">⍥</span><span class="o">≢</span> <span class="nv">Y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div></div>
</div>
<p>In words: first apply the right function to both arguments, then apply the left between the results. And of course, either side can be a user-defined function, too. Which vector have the most even numbers?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">X</span> <span class="o">&gt;</span><span class="na">⍥</span><span class="kt">{</span><span class="o">+</span><span class="na">/</span><span class="m">0</span><span class="o">=</span><span class="m">2</span><span class="o">|</span><span class="bp">⍵</span><span class="kt">}</span> <span class="nv">Y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div></div>
</div>
</div>
<span id="document-dyadictrn"></span><div class="tex2jax_ignore mathjax_ignore section" id="dyadic-transpose-ab">
<h2>Dyadic transpose: <code class="docutils literal notranslate"><span class="pre">A⍉B</span></code><a class="headerlink" href="#dyadic-transpose-ab" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>The development of mathematics toward greater precision has led, as is well known, to the formalization of large tracts of it, so that one can prove any theorem using nothing but a few mechanical rules… One might therefore conjecture that these axioms and rules of inference are sufficient to decide any mathematical question that can at all be formally expressed in these systems. It will be shown below that this is not the case, that on the contrary there are in the two systems mentioned relatively simple problems in the theory of integers that cannot be decided on the basis of the axioms. –<em>Kurt Gödel</em></p>
</div></blockquote>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span> <span class="o">-</span><span class="nv">style</span><span class="o">=</span><span class="nv">max</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
<span class="nv">assert</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍺</span><span class="kd">←</span><span class="s1">&#39;assertion failure&#39;</span> <span class="p">⋄</span> <span class="m">0</span><span class="o">∊</span><span class="bp">⍵:⍺</span> <span class="nf">⎕signal</span> <span class="m">8</span> <span class="p">⋄</span> <span class="nv">shy</span><span class="kd">←</span><span class="m">0</span><span class="kt">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────┐
│Was ON -style=min│
└─────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
│Was OFF│
└───────┘
</span></div></div>
</div>
<p>Mastery of the dyadic form of <em>Transpose</em> (<code class="docutils literal notranslate"><span class="pre">A⍉B</span></code>) – together with <a class="reference internal" href="intro.html#document-rank"><span class="doc std std-doc"><em>Rank</em></span></a> (<code class="docutils literal notranslate"><span class="pre">⍤</span></code>) – is considered the mark of the accomplished array programmer. Let’s see if it’s as hard to grasp as its reputation suggests.</p>
<p>Some other resources on dyadic transpose:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://aplwiki.com/wiki/Transpose#Dyadic_usage">APLWiki</a></p></li>
<li><p>Dyalog <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Functions/Transpose%20Dyadic.htm">docs</a></p></li>
<li><p>Webinar: <a class="reference external" href="https://dyalog.tv/Webinar/?v=zBqdeDJPPRc">The Rank Operator and Dyadic Transpose</a></p></li>
</ul>
<p>Most programmers have probably had at least some exposure to linear algebra, and so have internalised the concept of the transpose of a matrix: the x-axis becomes the y-axis, and vice-versa. We’ve alreay met the monadic form:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">B</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴</span><span class="m">9</span> <span class="m">4</span> <span class="m">2</span> <span class="m">7</span> <span class="m">2</span> <span class="m">5</span> <span class="m">4</span> <span class="m">7</span> <span class="m">8</span> <span class="m">6</span> <span class="m">1</span> <span class="m">2</span> <span class="m">6</span> <span class="m">8</span> <span class="m">2</span> <span class="m">9</span>
<span class="o">⍉</span><span class="nv">B</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
↓9 4 2 7│
│2 5 4 7│
│8 6 1 2│
└~──────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓9 2 8│
│4 5 6│
│2 4 1│
│7 7 2│
└~────┘
</span></div></div>
</div>
<p>We can see what was the x-axis is now the y-axis as we said. If we generalise this a bit, transpose is an operation that <em>reorders</em> axes. It just happens to be the case that in the rank-2 case, there is only one other possible ordering.</p>
<p>In the dyadic form of transpose, we are explicit about the new axis order:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">0</span><span class="o">⍉</span><span class="nv">B</span> <span class="c1">⍝ Same result as the monadic form: x-is-y</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓9 2 8│
│4 5 6│
│2 4 1│
│7 7 2│
└~────┘
</span></div></div>
</div>
<p>So far, so obvious. However… once the rank increases, it becomes harder to visualise perhaps what’s going on. One tip is to not think of the array itself having its axes pulled and moved, but to instead think of the <em>observer</em> (you, or “the camera”) moving around the array.</p>
<p>Consider rank-3:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">2</span> <span class="m">2</span> <span class="m">2</span> <span class="m">2</span> <span class="m">2</span> <span class="m">2</span> <span class="m">2</span> <span class="m">2</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span>
</pre></div>
</div>
</div>
</div>
<p><img alt="dtr" src="_images/dyadic.png" /></p>
<p>Imagine if we want to rearrange this array such that the new view is that indicated by the camera symbol, to see the array as three slices each of:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓1 2 3│
│1 2 3│
│1 2 3│
└~────┘
</span></div></div>
</div>
<p>We’d need to rotate the scene 90 degrees clockwise around the current axis 1. So axis 1 stays the same, but axes 0 and 2 changes position:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span> <span class="m">1</span> <span class="m">0</span><span class="o">⍉</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→────┐
↓↓1 2 3│
││1 2 3│
││1 2 3│
││     │
││1 2 3│
││1 2 3│
││1 2 3│
││     │
││1 2 3│
││1 2 3│
││1 2 3│
└└~────┘
</span></div></div>
</div>
<p>When rank goes above 3, it becomes tricker to visualise this way, but instead, think about what each resulting major cell should look like – typically, when you need dyadic transpose, you have an idea what shape each cell should take, and you can usually work backwards from there to deduce the correct axis ordering.</p>
<p>But perhaps the main question remains – what is this all useful for? A <em>great deal</em>, as it turns out. One helpful clue is that <em>Transpose</em>, including its dyadic form, is one of the functions allowing for modified assignment. We talked about that in the section on indexing earlier. By assigning to the dyadic transpose of an array we can “fill” it from a data source that has the elements laid out in a different arrangement.</p>
<p>We can use the same example data as above to illustrate this. Let’s say that our data is a ravel of recurring 1, 2, 3 to give 27 elements, but we want it organised as our original matrix we used above, with the major cells being <code class="docutils literal notranslate"><span class="pre">3</span> <span class="pre">3⍴9/1</span></code>, <code class="docutils literal notranslate"><span class="pre">3</span> <span class="pre">3⍴9/2</span></code> and <code class="docutils literal notranslate"><span class="pre">3</span> <span class="pre">3⍴9/3</span></code> respectively</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">data</span> <span class="kd">←</span> <span class="o">∊</span><span class="m">9</span><span class="na">/</span><span class="o">⊂</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span>
<span class="nv">mat</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="m">0</span>             <span class="c1">⍝ Empty matrix</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────────────────────────────────┐
│1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3 1 2 3│
└~────────────────────────────────────────────────────┘
</span></div></div>
</div>
<p>We can now assign through the dyadic <em>Transpose</em> to fill our empty matrix in a different axis order:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">2</span> <span class="m">1</span> <span class="m">0</span><span class="o">⍉</span><span class="nv">mat</span><span class="p">)</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="nv">data</span>  
<span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→────┐
↓↓1 1 1│
││1 1 1│
││1 1 1│
││     │
││2 2 2│
││2 2 2│
││2 2 2│
││     │
││3 3 3│
││3 3 3│
││3 3 3│
└└~────┘
</span></div></div>
</div>
<p>Let’s look at a higher-rank example. Given a 6×6 matrix, partition it into four non-overlapping partitions of size 3×3. Can we achieve this using dyadic <em>Transpose</em>? Here’s our matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">mat</span> <span class="kd">←</span> <span class="m">6</span> <span class="m">6</span><span class="o">⍴⍳</span><span class="m">36</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────┐
↓ 0  1  2  3  4  5│
│ 6  7  8  9 10 11│
│12 13 14 15 16 17│
│18 19 20 21 22 23│
│24 25 26 27 28 29│
│30 31 32 33 34 35│
└~────────────────┘
</span></div></div>
</div>
<p>Let’s reshape this into an array of shape 2 3 2 3 (rank 4), like so:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">r4</span> <span class="kd">←</span> <span class="m">2</span> <span class="m">3</span> <span class="m">2</span> <span class="m">3</span><span class="o">⍴</span><span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌┌→───────┐
↓↓↓ 0  1  2│
│││ 3  4  5│
│││        │
│││ 6  7  8│
│││ 9 10 11│
│││        │
│││12 13 14│
│││15 16 17│
│││        │
│││        │
│││18 19 20│
│││21 22 23│
│││        │
│││24 25 26│
│││27 28 29│
│││        │
│││30 31 32│
│││33 34 35│
└└└~───────┘
</span></div></div>
</div>
<p>The first cell has turned the first three rows of our original matrix into a rank 3 array where the cells are shape 2 3, essentially “folding” each row in half:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="o">⌷</span><span class="nv">r4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→───────┐
↓↓ 0  1  2│
││ 3  4  5│
││        │
││ 6  7  8│
││ 9 10 11│
││        │
││12 13 14│
││15 16 17│
└└~───────┘
</span></div></div>
</div>
<p>We can now look to reorder the axes. After a bit of thought we can say that we need the shape to be 2 2 3 3 before we have a go at partitioning. If we think of the 3×3 at the end as given by the task at hand (our partition sizes), we know that we’ll ultimately need two “rows” and two “cols” of those. So we currently have a shape of 2 3 2 3, so we flip the middle two axes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">reorder</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">2</span> <span class="m">1</span> <span class="m">3</span><span class="o">⍉</span><span class="nv">r4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌┌→───────┐
↓↓↓ 0  1  2│
│││ 6  7  8│
│││12 13 14│
│││        │
│││ 3  4  5│
│││ 9 10 11│
│││15 16 17│
│││        │
│││        │
│││18 19 20│
│││24 25 26│
│││30 31 32│
│││        │
│││21 22 23│
│││27 28 29│
│││33 34 35│
└└└~───────┘
</span></div></div>
</div>
<p>That looks right: each 3×3 cell is correct. We just need to enclose each rank-2 cell:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊂</span><span class="na">⍤</span><span class="m">2</span><span class="o">⊢</span><span class="nv">reorder</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────────────────┐
↓ ┌→───────┐ ┌→───────┐ │
│ ↓ 0  1  2│ ↓ 3  4  5│ │
│ │ 6  7  8│ │ 9 10 11│ │
│ │12 13 14│ │15 16 17│ │
│ └~───────┘ └~───────┘ │
│ ┌→───────┐ ┌→───────┐ │
│ ↓18 19 20│ ↓21 22 23│ │
│ │24 25 26│ │27 28 29│ │
│ │30 31 32│ │33 34 35│ │
│ └~───────┘ └~───────┘ │
└∊──────────────────────┘
</span></div></div>
</div>
<div class="section" id="translating-rna-into-protein">
<h3>Translating RNA into Protein<a class="headerlink" href="#translating-rna-into-protein" title="Permalink to this headline">¶</a></h3>
<p>Here’s an example from <a class="reference external" href="http://rosalind.info/problems/list-view/">Project Rosalind</a> – a great problem collection in the field of bioinformatics: <a class="reference external" href="http://rosalind.info/problems/prot/">http://rosalind.info/problems/prot/</a></p>
<p>The ask is to take an mRNA sequence and encode specific “codons” into the amino acid alphabet. No, I don’t know what that means either, but it doesn’t matter: we have a sequence of letters, which when grouped into triplets define a point in a 4×4×4 matrix.</p>
<p>The “codon table” is given as:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UUU</span> <span class="n">F</span>      <span class="n">CUU</span> <span class="n">L</span>      <span class="n">AUU</span> <span class="n">I</span>      <span class="n">GUU</span> <span class="n">V</span>
<span class="n">UUC</span> <span class="n">F</span>      <span class="n">CUC</span> <span class="n">L</span>      <span class="n">AUC</span> <span class="n">I</span>      <span class="n">GUC</span> <span class="n">V</span>
<span class="n">UUA</span> <span class="n">L</span>      <span class="n">CUA</span> <span class="n">L</span>      <span class="n">AUA</span> <span class="n">I</span>      <span class="n">GUA</span> <span class="n">V</span>
<span class="n">UUG</span> <span class="n">L</span>      <span class="n">CUG</span> <span class="n">L</span>      <span class="n">AUG</span> <span class="n">M</span>      <span class="n">GUG</span> <span class="n">V</span>
<span class="n">UCU</span> <span class="n">S</span>      <span class="n">CCU</span> <span class="n">P</span>      <span class="n">ACU</span> <span class="n">T</span>      <span class="n">GCU</span> <span class="n">A</span>
<span class="n">UCC</span> <span class="n">S</span>      <span class="n">CCC</span> <span class="n">P</span>      <span class="n">ACC</span> <span class="n">T</span>      <span class="n">GCC</span> <span class="n">A</span>
<span class="n">UCA</span> <span class="n">S</span>      <span class="n">CCA</span> <span class="n">P</span>      <span class="n">ACA</span> <span class="n">T</span>      <span class="n">GCA</span> <span class="n">A</span>
<span class="n">UCG</span> <span class="n">S</span>      <span class="n">CCG</span> <span class="n">P</span>      <span class="n">ACG</span> <span class="n">T</span>      <span class="n">GCG</span> <span class="n">A</span>
<span class="n">UAU</span> <span class="n">Y</span>      <span class="n">CAU</span> <span class="n">H</span>      <span class="n">AAU</span> <span class="n">N</span>      <span class="n">GAU</span> <span class="n">D</span>
<span class="n">UAC</span> <span class="n">Y</span>      <span class="n">CAC</span> <span class="n">H</span>      <span class="n">AAC</span> <span class="n">N</span>      <span class="n">GAC</span> <span class="n">D</span>
<span class="n">UAA</span> <span class="n">Stop</span>   <span class="n">CAA</span> <span class="n">Q</span>      <span class="n">AAA</span> <span class="n">K</span>      <span class="n">GAA</span> <span class="n">E</span>
<span class="n">UAG</span> <span class="n">Stop</span>   <span class="n">CAG</span> <span class="n">Q</span>      <span class="n">AAG</span> <span class="n">K</span>      <span class="n">GAG</span> <span class="n">E</span>
<span class="n">UGU</span> <span class="n">C</span>      <span class="n">CGU</span> <span class="n">R</span>      <span class="n">AGU</span> <span class="n">S</span>      <span class="n">GGU</span> <span class="n">G</span>
<span class="n">UGC</span> <span class="n">C</span>      <span class="n">CGC</span> <span class="n">R</span>      <span class="n">AGC</span> <span class="n">S</span>      <span class="n">GGC</span> <span class="n">G</span>
<span class="n">UGA</span> <span class="n">Stop</span>   <span class="n">CGA</span> <span class="n">R</span>      <span class="n">AGA</span> <span class="n">R</span>      <span class="n">GGA</span> <span class="n">G</span>
<span class="n">UGG</span> <span class="n">W</span>      <span class="n">CGG</span> <span class="n">R</span>      <span class="n">AGG</span> <span class="n">R</span>      <span class="n">GGG</span> <span class="n">G</span>
</pre></div>
</div>
<p>and you’d be excused for not seeing the 4×4×4 matrix immediately popping out at you. However, the question links to a Wikipedia page which has the following helpful illustration:</p>
<p><img alt="codons" src="_images/3D_Genetic_Code.jpg" /></p>
<p>So let’s take the values from the table given and make the above 3D representation from it, and then solve this Rosalind problem. The “Stop” codons is basically just the “EOL” – we can call that ‘.’ for simplicity. Picking the values and reshaping those to 4×4×4:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">4</span> <span class="m">4</span> <span class="m">4</span><span class="o">⍴</span><span class="s1">&#39;FLIVFLIVLLIVLLMVSPTASPTASPTASPTAYHNDYHND.QKE.QKECRSGCRSG.RRGWRRG&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→───┐
↓↓FLIV│
││FLIV│
││LLIV│
││LLMV│
││    │
││SPTA│
││SPTA│
││SPTA│
││SPTA│
││    │
││YHND│
││YHND│
││.QKE│
││.QKE│
││    │
││CRSG│
││CRSG│
││.RRG│
││WRRG│
└└────┘
</span></div></div>
</div>
<p>Now let’s figure out the axis order. Looking at the table (and graph), the coordinate order is U, C, A, G. Let’s look at the first few entries in the table again:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">UUU</span> <span class="n">F</span>      <span class="n">CUU</span> <span class="n">L</span>      <span class="n">AUU</span> <span class="n">I</span>      <span class="n">GUU</span> <span class="n">V</span>
<span class="n">UUC</span> <span class="n">F</span>      <span class="n">CUC</span> <span class="n">L</span>      <span class="n">AUC</span> <span class="n">I</span>      <span class="n">GUC</span> <span class="n">V</span>
<span class="n">UUA</span> <span class="n">L</span>      <span class="n">CUA</span> <span class="n">L</span>      <span class="n">AUA</span> <span class="n">I</span>      <span class="n">GUA</span> <span class="n">V</span>
<span class="n">UUG</span> <span class="n">L</span>      <span class="n">CUG</span> <span class="n">L</span>      <span class="n">AUG</span> <span class="n">M</span>      <span class="n">GUG</span> <span class="n">V</span>
</pre></div>
</div>
<p>We can see that when the leading coordinate changes we get <code class="docutils literal notranslate"><span class="pre">FFLL</span></code>, <code class="docutils literal notranslate"><span class="pre">LLLL</span></code>, <code class="docutils literal notranslate"><span class="pre">IIIM</span></code>, <code class="docutils literal notranslate"><span class="pre">VVVV</span></code>, so our current axis ordering isn’t correct. Looking at the graph, we can see that this corresponds to placing the “camera” to the left, looking right – our first axis is probably where it should be. Let’s try to flip the other two:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">0</span> <span class="m">2</span> <span class="m">1</span><span class="o">⍉</span><span class="m">4</span> <span class="m">4</span> <span class="m">4</span><span class="o">⍴</span><span class="s1">&#39;FLIVFLIVLLIVLLMVSPTASPTASPTASPTAYHNDYHND.QKE.QKECRSGCRSG.RRGWRRG&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→───┐
↓↓FFLL│
││LLLL│
││IIIM│
││VVVV│
││    │
││SSSS│
││PPPP│
││TTTT│
││AAAA│
││    │
││YY..│
││HHQQ│
││NNKK│
││DDEE│
││    │
││CC.W│
││RRRR│
││SSRR│
││GGGG│
└└────┘
</span></div></div>
</div>
<p>Hmm, the first row of the first cell <em>is</em> correct, but not the rest, but if the first axis is correct we have no options left, right? Let’s try a monadic transpose, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">0</span> <span class="m">2</span> <span class="m">1</span><span class="o">⍉⍉</span><span class="m">4</span> <span class="m">4</span> <span class="m">4</span><span class="o">⍴</span><span class="s1">&#39;FLIVFLIVLLIVLLMVSPTASPTASPTASPTAYHNDYHND.QKE.QKECRSGCRSG.RRGWRRG&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→───┐
↓↓FFLL│
││SSSS│
││YY..│
││CC.W│
││    │
││LLLL│
││PPPP│
││HHQQ│
││RRRR│
││    │
││IIIM│
││TTTT│
││NNKK│
││SSRR│
││    │
││VVVV│
││AAAA│
││DDEE│
││GGGG│
└└────┘
</span></div></div>
</div>
<p>That looks correct. Now we can solve this problem:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">codon</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">2</span> <span class="m">1</span><span class="o">⍉⍉</span><span class="m">4</span> <span class="m">4</span> <span class="m">4</span><span class="o">⍴</span><span class="s1">&#39;FLIVFLIVLLIVLLMVSPTASPTASPTASPTAYHNDYHND.QKE.QKECRSGCRSG.RRGWRRG&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">prot</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">enc</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="sr">[</span><span class="s1">&#39;UCAG&#39;</span><span class="o">⍳</span><span class="bp">⍵</span><span class="sr">]</span>        <span class="c1">⍝ Convert RNA string from UCAG to 0123</span>
    <span class="m">¯1</span><span class="o">↓</span><span class="nv">codon</span><span class="sr">[</span><span class="o">⊂</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢</span><span class="p">(</span><span class="m">3</span><span class="o">÷</span><span class="na">⍨</span><span class="o">≢</span><span class="nv">enc</span><span class="p">)</span> <span class="m">3</span><span class="o">⍴</span><span class="nv">enc</span><span class="sr">]</span>  <span class="c1">⍝ Group into triplets and index into codon table, and drop Stop.</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>We can try this on the example given in the question:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">test</span> <span class="kd">←</span> <span class="s1">&#39;AUGGCCAUGGCGCCCAGAACUGAGAUCAAUAGUACCCGUAUUAACGGGUGA&#39;</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">r</span> <span class="kd">←</span> <span class="nv">prot</span> <span class="nv">test</span>
<span class="nv">assert</span> <span class="s1">&#39;MAMAPRTEINSTRING&#39;</span><span class="o">≡</span><span class="nv">r</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────────────┐
│MAMAPRTEINSTRING│
└────────────────┘
</span></div></div>
</div>
</div>
<div class="section" id="best-figures-in-month">
<h3>Best figures in $MONTH<a class="headerlink" href="#best-figures-in-month" title="Permalink to this headline">¶</a></h3>
<p>One more? Let’s say we have a team of sellers who report their results monthly. We have a set of historical data going back a number of years. Which seller produced the best results in a particular month in a particular year?</p>
<p>Here are the monthly figures for our twenty five sellers going back ten years (as a random selection, like all sales figures are):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="nv">sales</span> <span class="kd">←</span> <span class="o">?</span><span class="m">10</span> <span class="m">25</span> <span class="m">12</span><span class="o">⍴</span><span class="m">250</span>
</pre></div>
</div>
</div>
</div>
<p>Our array has the axes ordered year, seller id, month. So how can we pick the best performing seller in (say) April, year 6?</p>
<p>Most APLers would probably reach for bracket indexing, and rightly so – it feels natural:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">year</span> <span class="kd">←</span> <span class="m">6</span>
<span class="nv">month</span> <span class="kd">←</span> <span class="m">3</span>
<span class="nv">sales</span><span class="sr">[</span><span class="nv">year</span><span class="sr">;;</span><span class="nv">month</span><span class="sr">]</span> <span class="c1">⍝ Sales figures for month/year</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────────────────────────────────────────────────────────────────────┐
│120 73 153 208 22 152 223 111 47 169 145 154 190 161 158 72 221 164 155 214 8 1 55 36 234│
└~────────────────────────────────────────────────────────────────────────────────────────┘
</span></div></div>
</div>
<p>But we can also dyadic <em>Transpose</em> here to avoid the bracket indexing. We have a couple of options – we want to select sellers results over a specific month in a specific year, so one approach is to make the year the first axis, followed by the month and then seller id: first go to the filing cabinet for year 6. Pull out the April drawer. Rifle through the folders of sales results and pick the one with the largest total.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">year</span> <span class="nv">month</span><span class="o">⌷</span><span class="m">0</span> <span class="m">2</span> <span class="m">1</span><span class="o">⍉</span><span class="nv">sales</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────────────────────────────────────────────────────────────────────┐
│120 73 153 208 22 152 223 111 47 169 145 154 190 161 158 72 221 164 155 214 8 1 55 36 234│
└~────────────────────────────────────────────────────────────────────────────────────────┘
</span></div></div>
</div>
<p>Picking the best is the first item in the grade-down:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊢</span><span class="nv">employee_of_the_month</span><span class="kd">←</span><span class="o">⊃⍒</span><span class="nv">year</span> <span class="nv">month</span><span class="o">⌷</span><span class="m">0</span> <span class="m">2</span> <span class="m">1</span><span class="o">⍉</span><span class="nv">sales</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  
24

</span></div></div>
</div>
<p>We could have achieved the same thing with axes reversed, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">month</span> <span class="nv">year</span><span class="o">⌷</span><span class="m">1</span> <span class="m">2</span> <span class="m">0</span><span class="o">⍉</span><span class="nv">sales</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────────────────────────────────────────────────────────────────────┐
│120 73 153 208 22 152 223 111 47 169 145 154 190 161 158 72 221 164 155 214 8 1 55 36 234│
└~────────────────────────────────────────────────────────────────────────────────────────┘
</span></div></div>
</div>
</div>
<div class="section" id="repeated-axes">
<h3>Repeated axes<a class="headerlink" href="#repeated-axes" title="Permalink to this headline">¶</a></h3>
<p>It gets weirder. You can map axes together via dyadic transpose. Here’s an example.</p>
<p>APL Orchard regular &#64;rak1507 posed the following <a class="reference external" href="https://chat.stackexchange.com/transcript/message/59841725#59841725">challenge</a>:</p>
<blockquote>
<div><p>&#64;Adám so without trying it could you tell me what <code class="docutils literal notranslate"><span class="pre">1</span> <span class="pre">2</span> <span class="pre">1⍉2</span> <span class="pre">3</span> <span class="pre">4⍴⍳24</span></code> gives?</p>
</div></blockquote>
<p>Let’s work through &#64;Adám’s explanation. Let’s start with the answer, and then figure out what’s happening:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴⍳</span><span class="m">24</span>
<span class="m">0</span> <span class="m">1</span> <span class="m">0</span><span class="o">⍉</span><span class="m">2</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴⍳</span><span class="m">24</span>   <span class="c1">⍝ adjusted for ⎕IO←0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→──────────┐
↓↓ 0  1  2  3│
││ 4  5  6  7│
││ 8  9 10 11│
││           │
││12 13 14 15│
││16 17 18 19│
││20 21 22 23│
└└~──────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────┐
↓ 0  4  8│
│13 17 21│
└~───────┘
</span></div></div>
</div>
<p>The axis reordering vector is <code class="docutils literal notranslate"><span class="pre">0</span> <span class="pre">1</span> <span class="pre">0</span></code>. With that we’re mapping together the first and last axes, giving us a first axis with length <code class="docutils literal notranslate"><span class="pre">2⌊4</span></code> and a second axis with length 3.</p>
<p>When we increase the index of the first axis, we also have to increase it along the second axis. So the second “layer” (which will become a row; see below) picks up elements from <code class="docutils literal notranslate"><span class="pre">[;;1]</span></code> i.e. <code class="docutils literal notranslate"><span class="pre">[1;;1]</span></code>.</p>
<p>The first major cell is <code class="docutils literal notranslate"><span class="pre">[0;;0]</span></code> and the second is <code class="docutils literal notranslate"><span class="pre">[1;;1]</span></code> and since we’ve only got two dimensions left, the first dimension is rows, and the second is columns.</p>
<p>Another way to think of it is by elimination of indices. As we’re mapping together the first and third axes, any element that has unequal indices in those dimensions is eliminated:</p>
<p><img alt="axis" src="_images/axis-elim.png" /></p>
<p>The green boxes show the indices of the two major cells that make up the result.</p>
</div>
<div class="section" id="the-filling-order">
<h3>The filling order<a class="headerlink" href="#the-filling-order" title="Permalink to this headline">¶</a></h3>
<p>When we shape a matrix in APL, the “filling order” follows the axis order. When this filling order isn’t what you need, that’s another indication that you may want to consider dyadic transpose. Consider an example: let’s say you have a vector of integers</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊢</span><span class="nv">data</span><span class="kd">←</span><span class="o">⍳</span><span class="m">45</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┐
│0 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18 19 20 21 22 23 24 25 26 27 28 29 30 31 32 33 34 35 36 37 38 39 40 41 42 43 44│
└~───────────────────────────────────────────────────────────────────────────────────────────────────────────────────────────┘
</span></div></div>
</div>
<p>where each group of 9 has 3 sub-groups that we’d like to separate out. Without dyadic transpose, perhaps we’d try something like this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">m</span><span class="kd">←</span><span class="p">(</span><span class="m">9</span><span class="o">÷</span><span class="na">⍨</span><span class="o">≢</span><span class="nv">data</span><span class="p">)</span> <span class="m">9</span><span class="o">⍴</span><span class="nv">data</span>
<span class="o">↑</span><span class="p">(</span><span class="nv">m</span><span class="sr">[;</span><span class="m">0</span> <span class="m">1</span> <span class="m">2</span><span class="sr">]</span><span class="p">)(</span><span class="nv">m</span><span class="sr">[;</span><span class="m">3</span> <span class="m">4</span> <span class="m">5</span><span class="sr">]</span><span class="p">)(</span><span class="nv">m</span><span class="sr">[;</span><span class="m">6</span> <span class="m">7</span> <span class="m">8</span><span class="sr">]</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→─────────────────────────┐
↓ 0  1  2  3  4  5  6  7  8│
│ 9 10 11 12 13 14 15 16 17│
│18 19 20 21 22 23 24 25 26│
│27 28 29 30 31 32 33 34 35│
│36 37 38 39 40 41 42 43 44│
└~─────────────────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→───────┐
↓↓ 0  1  2│
││ 9 10 11│
││18 19 20│
││27 28 29│
││36 37 38│
││        │
││ 3  4  5│
││12 13 14│
││21 22 23│
││30 31 32│
││39 40 41│
││        │
││ 6  7  8│
││15 16 17│
││24 25 26│
││33 34 35│
││42 43 44│
└└~───────┘
</span></div></div>
</div>
<p>Looking at the fill order, we can see that the result fills cell 0, row 0, cell 1, row 0, cell 2, row 0, cell 0, row 1 etc, instead of following the axis order, which would have looked like</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="m">5</span> <span class="m">3</span><span class="o">⍴</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→───────┐
↓↓ 0  1  2│
││ 3  4  5│
││ 6  7  8│
││ 9 10 11│
││12 13 14│
││        │
││15 16 17│
││18 19 20│
││21 22 23│
││24 25 26│
││27 28 29│
││        │
││30 31 32│
││33 34 35│
││36 37 38│
││39 40 41│
││42 43 44│
└└~───────┘
</span></div></div>
</div>
<p>We know that we need to end up with the shape 5 3 3, and that we want to grab triplets in order from the data. So we first need to reshape the data to give us triplets in fill order as the rows its major cells:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">5</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→───────┐
↓↓ 0  1  2│
││ 3  4  5│
││ 6  7  8│
││        │
││ 9 10 11│
││12 13 14│
││15 16 17│
││        │
││18 19 20│
││21 22 23│
││24 25 26│
││        │
││27 28 29│
││30 31 32│
││33 34 35│
││        │
││36 37 38│
││39 40 41│
││42 43 44│
└└~───────┘
</span></div></div>
</div>
<p>We know the desired shape is 3-5-3, so our only option is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">0</span> <span class="m">2</span><span class="o">⍉</span><span class="m">5</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌┌→───────┐
↓↓ 0  1  2│
││ 9 10 11│
││18 19 20│
││27 28 29│
││36 37 38│
││        │
││ 3  4  5│
││12 13 14│
││21 22 23│
││30 31 32│
││39 40 41│
││        │
││ 6  7  8│
││15 16 17│
││24 25 26│
││33 34 35│
││42 43 44│
└└~───────┘
</span></div></div>
</div>
<p>There is an additional hard-won lesson here. Let’s look at the shapes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍴</span><span class="m">5</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
│5 3 3│
└~────┘
</span></div></div>
</div>
<p>No surprises there, right. So we reorder the first two axes, to get a shape of 3-5-3:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍴</span><span class="m">1</span> <span class="m">0</span> <span class="m">2</span><span class="o">⍉</span><span class="m">5</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
│3 5 3│
└~────┘
</span></div></div>
</div>
<p>The last two axes have the same dimensions, so we could equally well use the 2-0-1 order and maintain the 3-5-3 shape, right? Wrong:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍴</span><span class="m">2</span> <span class="m">0</span> <span class="m">1</span><span class="o">⍉</span><span class="m">5</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴</span><span class="nv">data</span> <span class="c1">⍝ SURPRISE!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
│3 3 5│
└~────┘
</span></div></div>
</div>
<p>This goes to the heart of the matter why dyadic <em>Transpose</em> is difficult to grasp. Morten Kromberg offered the following explanation on the <a class="reference external" href="https://chat.stackexchange.com/transcript/52405?m=57439754#57439754">APL Orchard</a>:</p>
<blockquote>
<div><p>Many people are confused by dyadic <em>Transpose</em> because the “intuitive” interpretation of the left argument is that it gives the order that you want to select dimensions of the right argument for the result, when in fact it gives the NEW position of each of the dimensions (he says nervously, hoping he got that right after 40 years of practice). –<em>Morten Kromberg</em></p>
</div></blockquote>
<p>In other words, the left argument 2 0 1 does <em>not</em> mean “take the old axis 2 and make that the new axis 0, take the old axis 0 and make that the new axis 1 and finally, take the old axis 1 and make that the new axis 2”.</p>
<p>Instead it means:</p>
<ul class="simple">
<li><p>The old axis 0 is now axis 2</p></li>
<li><p>The old axis 1 is now axis 0</p></li>
<li><p>The old axis 2 is now axis 1</p></li>
</ul>
<p>Perhaps this chapter should have started, rather than ended, with this.</p>
</div>
</div>
<span id="document-decode"></span><div class="tex2jax_ignore mathjax_ignore section" id="encode-decode">
<h2>Encode decode: <code class="docutils literal notranslate"><span class="pre">⊤⊥</span></code><a class="headerlink" href="#encode-decode" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Teaching peers is one of the best ways to develop mastery. –<em>Jeff Atwood</em></p>
</div></blockquote>
<p>Here’s some of APL’s secret sauce, not commonly encountered in other languages: <em>Encode</em>, <code class="docutils literal notranslate"><span class="pre">⊤</span></code> and <em>Decode</em>, <code class="docutils literal notranslate"><span class="pre">⊥</span></code>. <em>Encode</em> and <em>Decode</em> provide efficient basis conversion across potentially mixed radixes.</p>
<p>Other resources:</p>
<ul class="simple">
<li><p>Dyalog docs <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Encode.htm"><em>Encode</em></a>, <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Decode.htm"><em>Decode</em></a></p></li>
<li><p>Cultivations <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-6-apl-functions-----">Lesson 6</a>, <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-37--in-depth">Lesson 37</a>, <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-38--in-depth">Lesson 38</a></p></li>
<li><p>APL Wiki <a class="reference external" href="https://aplwiki.com/wiki/Encode"><em>Encode</em></a>, <a class="reference external" href="https://aplwiki.com/wiki/Decode"><em>Decode</em></a></p></li>
</ul>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span> <span class="c1">⍝ You know the drill</span>
</pre></div>
</div>
</div>
</div>
<p>The canonical example is to convert numbers between bases, for example, converting a base-10 number to 8-bit binary:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">8</span><span class="o">⍴</span><span class="m">2</span><span class="p">)</span><span class="o">⊤</span><span class="m">54</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 1 1 0 1 1 0
</span></div></div>
</div>
<p>…and back to base-10:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="o">⊥</span><span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">54
</span></div></div>
</div>
<p>I vowed not to mention magic inverses, but these few are too damned useful to leave out. Convert a base-10 number to binary, using the least number of bits:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="na">∘</span><span class="o">⊥</span><span class="na">⍣</span><span class="m">¯1</span> <span class="o">⊢</span> <span class="m">54</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1 0 1 1 0
</span></div></div>
</div>
<p>…and as a consequence, split a number into its constituent digits:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">10</span><span class="na">∘</span><span class="o">⊥</span><span class="na">⍣</span><span class="m">¯1</span> <span class="o">⊢</span> <span class="m">677398723</span> <span class="c1">⍝ Number to digit vector</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">6 7 7 3 9 8 7 2 3
</span></div></div>
</div>
<p>Those were all fixed radix. An example of <em>mixed</em> radix is converting between seconds and days, hours, mins and seconds, e.g “how many days, hours, mins and seconds is 10000 seconds”?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">24</span> <span class="m">60</span> <span class="m">60</span><span class="o">⊤</span><span class="m">10000</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 2 46 40
</span></div></div>
</div>
<p>and, conversely, how many seconds in 1 day (and night)?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">24</span> <span class="m">60</span> <span class="m">60</span><span class="o">⊥</span><span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">86400
</span></div></div>
</div>
<p>Here’s an example of <em>Decode</em> and <em>Encode</em>, borrowed from <a class="reference external" href="https://reference.wolfram.com/language/ref/MixedRadix.html">Mathematica’s</a> documentation for its corresponding <em>MixedRadix</em> function.</p>
<p>A Roman legion was made of 10 <em>cohorts</em>, a cohort of 6 <em>centuries</em>, a century of 10 <em>contuberniae</em>, and a contubernia of 8 soldiers.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">units</span> <span class="kd">←</span> <span class="s1">&#39;legion&#39;</span> <span class="s1">&#39;cohort&#39;</span> <span class="s1">&#39;century&#39;</span> <span class="s1">&#39;contubernia&#39;</span> <span class="s1">&#39;soldier&#39;</span>
<span class="nv">bases</span> <span class="kd">←</span> <span class="m">10</span> <span class="m">10</span> <span class="m">6</span> <span class="m">10</span> <span class="m">8</span>
</pre></div>
</div>
</div>
</div>
<p>Given 16,894 soldiers, how are they organized?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↑</span><span class="nv">units</span> <span class="p">(</span><span class="nv">bases</span><span class="o">⊤</span><span class="m">16894</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──────┬──────┬───────┬───────────┬───────┐
│legion│cohort│century│contubernia│soldier│
├──────┼──────┼───────┼───────────┼───────┤
│3     │5     │1      │1          │6      │
└──────┴──────┴───────┴───────────┴───────┘
</span></div></div>
</div>
<p>Going the other way, how many soldiers are there in a legion?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">bases</span><span class="o">⊥</span><span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">4800
</span></div></div>
</div>
<p>There are some less obvious uses, too. For example, we can use <code class="docutils literal notranslate"><span class="pre">1⊥</span></code> to sum vectors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="o">⊥⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">45
</span></div></div>
</div>
<p>The utility of that may not be obvious, but it comes very handy when writing <a class="reference internal" href="intro.html#document-tacit"><span class="doc std std-doc">tacit</span></a> code which we’ll cover in depth later, but here’s a taster – given a vector where all elements are the same, bar one, what’s the index of the “odd one out”?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">1</span><span class="o">⍳</span><span class="na">⍨</span><span class="m">1</span><span class="o">⊥</span><span class="na">∘.</span><span class="o">=</span><span class="na">⍨</span><span class="p">)</span> <span class="m">243</span> <span class="m">243</span> <span class="m">243</span> <span class="m">243</span> <span class="m">251</span> <span class="m">243</span> <span class="m">243</span> <span class="c1">⍝ Index of &quot;odd one out&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">4
</span></div></div>
</div>
<p>The enigmatic <code class="docutils literal notranslate"><span class="pre">⊥⍨</span></code> counts trailing 1s:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊥</span><span class="na">⍨</span><span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5
</span></div></div>
</div>
<p>We can also use <em>Encode</em> and <em>Decode</em> between indices of an array and its ravel:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">m</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">5</span> <span class="o">⍴</span><span class="m">15</span><span class="o">?</span><span class="m">15</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">rav</span> <span class="kd">←</span> <span class="o">,</span><span class="nv">m</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 3 0 5 12  4
 9 8 6  2 10
11 7 1 14 13
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">3 0 5 12 4 9 8 6 2 10 11 7 1 14 13
</span></div></div>
</div>
<p>Given <code class="docutils literal notranslate"><span class="pre">index</span> <span class="pre">←</span> <span class="pre">1</span> <span class="pre">4</span></code> into the above array, what’s the corresponding index into the ravel vector?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">index</span> <span class="kd">←</span> <span class="m">1</span> <span class="m">4</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">k</span> <span class="kd">←</span> <span class="p">(</span><span class="o">⍴</span><span class="nv">m</span><span class="p">)</span><span class="o">⊥</span><span class="nv">index</span> <span class="c1">⍝ 2D to 1D</span>
<span class="nv">m</span><span class="sr">[</span><span class="o">⊂</span><span class="nv">index</span><span class="sr">]</span>
<span class="nv">k</span><span class="o">⊃</span><span class="nv">rav</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">9
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">10
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">10
</span></div></div>
</div>
<p>And the reverse:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">i</span> <span class="nv">j</span><span class="kd">←</span><span class="p">(</span><span class="o">⍴</span><span class="nv">m</span><span class="p">)</span><span class="o">⊤</span><span class="nv">k</span> <span class="c1">⍝ 1D to 2D</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4
</span></div></div>
</div>
</div>
<span id="document-products"></span><div class="tex2jax_ignore mathjax_ignore section" id="products">
<h2>Products<a class="headerlink" href="#products" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>There is no point in being precise if you do not even know what you are talking about. –<em>John von Neumann</em></p>
</div></blockquote>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<p>We’ll talk about outer and inner products in APL, two powerful features. Other resources on these topics:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://www.dyalog.com/uploads/documents/MasteringDyalogAPL.pdf">Mastering Dyalog APL</a> has an excellent section on products, from around page 387.</p></li>
<li><p>Dyalog docs on <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Operators/Outer%20Product.htm">outer product</a> and <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Operators/Inner%20Product.htm">inner product</a></p></li>
<li><p>Marshall Lochbaum’s talk on <a class="reference external" href="https://mlochbaum.github.io/OuterProduct/">outer products</a></p></li>
</ul>
<div class="section" id="outer-product">
<h3>Outer product<a class="headerlink" href="#outer-product" title="Permalink to this headline">¶</a></h3>
<p>Let’s look at APL’s dyadic <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/Outer%20Product.htm"><em>Outer product</em></a> operator <code class="docutils literal notranslate"><span class="pre">∘.</span></code> - and by “product” in this case we don’t mean multiplication, but as in outer product in the linear algebra sense. The canonical example of an outer product is to build a “times table”:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="na">∘.</span><span class="o">×</span><span class="na">⍨</span><span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0  0  0  0  0  0  0  0  0
0 1  2  3  4  5  6  7  8  9
0 2  4  6  8 10 12 14 16 18
0 3  6  9 12 15 18 21 24 27
0 4  8 12 16 20 24 28 32 36
0 5 10 15 20 25 30 35 40 45
0 6 12 18 24 30 36 42 48 54
0 7 14 21 28 35 42 49 56 63
0 8 16 24 32 40 48 56 64 72
0 9 18 27 36 45 54 63 72 81
</span></div></div>
</div>
<p>To all intents and purposes, that’s a nested for-loop which we could write out in Python along the lines of:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">i</span><span class="o">*</span><span class="n">j</span><span class="si">}</span><span class="s2"> &quot;</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">()</span>
</pre></div>
</div>
<p>apart from the fact that in APL, outer products are vectorised and operate on the whole arrays.</p>
<p>The right side operand can be any dyadic function, including user-defined ones. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="na">∘.</span><span class="o">&lt;</span><span class="na">⍨</span><span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 1 1 1 1 1 1 1 1
0 0 1 1 1 1 1 1 1 1
0 0 0 1 1 1 1 1 1 1
0 0 0 0 1 1 1 1 1 1
0 0 0 0 0 1 1 1 1 1
0 0 0 0 0 0 1 1 1 1
0 0 0 0 0 0 0 1 1 1
0 0 0 0 0 0 0 0 1 1
0 0 0 0 0 0 0 0 0 1
0 0 0 0 0 0 0 0 0 0
</span></div></div>
</div>
<p>The eagle-eyed reader might interject that we can achieve the same thing with <a class="reference internal" href="intro.html#document-rank"><span class="doc std std-doc"><em>Rank</em></span></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">⍳</span><span class="m">10</span><span class="p">)</span> <span class="o">&lt;</span><span class="na">⍤</span><span class="m">0</span> <span class="m">1</span> <span class="o">⊢</span> <span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 1 1 1 1 1 1 1 1
0 0 1 1 1 1 1 1 1 1
0 0 0 1 1 1 1 1 1 1
0 0 0 0 1 1 1 1 1 1
0 0 0 0 0 1 1 1 1 1
0 0 0 0 0 0 1 1 1 1
0 0 0 0 0 0 0 1 1 1
0 0 0 0 0 0 0 0 1 1
0 0 0 0 0 0 0 0 0 1
0 0 0 0 0 0 0 0 0 0
</span></div></div>
</div>
<p>If you realised that unprompted: well done – this is a deep insight.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Outer product can be defined in terms of Rank:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>∘.f → f¨⍤0 99
</pre></div>
</div>
</div>
<p>The performance characteristics will differ though, for example</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">prod</span> <span class="kd">←</span> <span class="na">∘.</span><span class="o">×</span>
<span class="nv">rank</span> <span class="kd">←</span> <span class="o">×</span><span class="na">⍤</span><span class="m">0</span> <span class="m">1</span>
<span class="nv">x</span><span class="kd">←</span><span class="o">⍳</span><span class="m">1000</span>
<span class="sr">]</span><span class="nv">runtime</span> <span class="o">-</span><span class="nv">c</span> <span class="s2">&quot;x prod x&quot;</span> <span class="s2">&quot;x rank x&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">                                                                    
  x prod x → 5.0E¯4 |   0% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕               
  x rank x → 7.7E¯4 | +55% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕ 
</span></div></div>
</div>
<p>Here’s an expression using an outer product that picks out the prime numbers between 0 and 20. Can you figure out how it works?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">2</span><span class="o">=+</span><span class="na">⌿</span><span class="m">0</span><span class="o">=</span><span class="nv">x</span><span class="na">∘.</span><span class="o">|</span><span class="nv">x</span><span class="p">)</span><span class="na">/</span><span class="nv">x</span><span class="kd">←</span><span class="o">⍳</span><span class="m">20</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2 3 5 7 11 13 17 19
</span></div></div>
</div>
</div>
<div class="section" id="inner-product">
<h3>Inner product<a class="headerlink" href="#inner-product" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://help.dyalog.com/latest/#Language/Primitive%20Operators/Inner%20Product.htm"><em>Inner product</em></a>, <code class="docutils literal notranslate"><span class="pre">f.g</span></code> is perhaps less obvious. An example of an inner product is actual <a class="reference external" href="https://en.wikipedia.org/wiki/Matrix_multiplication">matrix multiplication</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">A</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">4</span><span class="o">⍴</span><span class="m">3</span> <span class="m">2</span> <span class="m">0</span> <span class="m">8</span> <span class="m">11</span> <span class="m">7</span> <span class="m">5</span> <span class="m">1</span> <span class="m">4</span> <span class="m">9</span> <span class="m">6</span> <span class="m">10</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">B</span> <span class="kd">←</span> <span class="m">4</span> <span class="m">3</span><span class="o">⍴</span><span class="m">8</span> <span class="m">10</span> <span class="m">11</span> <span class="m">2</span> <span class="m">4</span> <span class="m">6</span> <span class="m">5</span> <span class="m">1</span> <span class="m">7</span> <span class="m">9</span> <span class="m">3</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">A</span> <span class="o">+</span><span class="na">.</span><span class="o">×</span> <span class="nv">B</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓ 3 2 0  8│
│11 7 5  1│
│ 4 9 6 10│
└~────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
↓8 10 11│
│2  4  6│
│5  1  7│
│9  3  0│
└~──────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────────┐
↓100  62  45│
│136 146 198│
│170 112 140│
└~──────────┘
</span></div></div>
</div>
<p>If you know how to multiply matrices, you’ll understand what the inner product operator does: consider the top left element of the result, 100. How did we get that? First we multiply each number in the first row of A with the corresponding element in the first col of B:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">row0col0prod</span> <span class="kd">←</span> <span class="nv">A</span><span class="sr">[</span><span class="m">0</span><span class="sr">;]</span><span class="o">×</span><span class="nv">B</span><span class="sr">[;</span><span class="m">0</span><span class="sr">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">24 4 0 72
</span></div></div>
</div>
<p>Then sum it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">/</span><span class="nv">row0col0prod</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">100
</span></div></div>
</div>
<p>Next element:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">/</span><span class="nv">A</span><span class="sr">[</span><span class="m">0</span><span class="sr">;]</span><span class="o">×</span><span class="nv">B</span><span class="sr">[;</span><span class="m">1</span><span class="sr">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">62
</span></div></div>
</div>
<p>We can apply inner product to many common problems where the impulse is to “first apply one function, then reduce another over the result”. For example, given two strings of equal lengths, how many letters are the same? You might try first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">/</span><span class="s1">&#39;GATTACA&#39;</span> <span class="o">=</span> <span class="s1">&#39;TATTCAG&#39;</span> <span class="c1">⍝ Equal-then-sum-reduce</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div></div>
</div>
<p>but this fits the inner product pattern nicely:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;GATTACA&#39;</span> <span class="o">+</span><span class="na">.</span><span class="o">=</span> <span class="s1">&#39;TATTCAG&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div></div>
</div>
</div>
<div class="section" id="calculating-expected-offspring">
<h3>Calculating expected offspring<a class="headerlink" href="#calculating-expected-offspring" title="Permalink to this headline">¶</a></h3>
<p>Here’s a problem from Project Rosalind, a bioinformatics problem collection, <a class="reference external" href="http://rosalind.info/problems/iev/">Calculating Expected Offspring</a>.</p>
<p>We’re given six integers, corresponding to the number of couples in a population possessing each genotype pairing for a given factor. In order, the six given integers represent the number of couples having the following genotypes:</p>
<ol class="simple">
<li><p>AA-AA</p></li>
<li><p>AA-Aa</p></li>
<li><p>AA-aa</p></li>
<li><p>Aa-Aa</p></li>
<li><p>Aa-aa</p></li>
<li><p>aa-aa</p></li>
</ol>
<p>If each couple have two offspring, what is the expected number of offspring displaying the dominant phenotype (<code class="docutils literal notranslate"><span class="pre">A</span></code>) in the next generation?</p>
<p>Let’s say we’re given the couples distribution as</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="m">19083</span> <span class="m">17341</span> <span class="m">19657</span> <span class="m">16896</span> <span class="m">16197</span> <span class="m">18256</span>
</pre></div>
</div>
</div>
</div>
<p>I’m no biologist, but the way this works is that for each of the 6 possible genotype pairings we can see the probability of an offspring displaying the dominant phenotype, which is 1, 1, 1, 0.75, 0.5 and 0 respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">prob</span> <span class="kd">←</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0.75</span> <span class="m">0.5</span> <span class="m">0</span>
</pre></div>
</div>
</div>
</div>
<p>We need to multiply the data with the corresponding probabilities, and sum that up, and finally multiply by 2, as we have two offspring per couple. This can be neatly formulated as an inner product:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="o">×</span><span class="nv">data</span><span class="o">+</span><span class="na">.</span><span class="o">×</span><span class="nv">prob</span> <span class="c1">⍝ Same as 2× +/ data×prob</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">153703
</span></div></div>
</div>
</div>
<div class="section" id="explanation-operator">
<h3>eXplanation operator<a class="headerlink" href="#explanation-operator" title="Permalink to this headline">¶</a></h3>
<p>A handy trick when figuring out products is to use the “eXplanation” operator, that <a class="reference external" href="https://aplwiki.com/wiki/Ad%C3%A1m_Brudzewsky">Adám Brudzewsky</a> demonstrated in one of the <a class="reference external" href="https://chat.stackexchange.com/transcript/52405?m=43945029#43945029">Cultivations</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">X</span> <span class="kd">←</span> <span class="kt">{</span><span class="nv">f</span><span class="kd">←</span><span class="bp">⍺⍺</span> <span class="p">⋄</span> <span class="bp">⍺</span><span class="kd">←</span><span class="o">⊢</span> <span class="p">⋄</span> <span class="s1">&#39;(&#39;</span><span class="o">,</span><span class="bp">⍺</span><span class="o">,</span><span class="p">(</span><span class="nf">⎕CR</span><span class="s1">&#39;f&#39;</span><span class="p">)</span><span class="o">,</span><span class="bp">⍵</span><span class="o">,</span><span class="s1">&#39;)&#39;</span><span class="kt">}</span> <span class="c1">⍝ The product eXplanation operator</span>
</pre></div>
</div>
</div>
</div>
<p>Using this we can visualise how Dyalog will calculate each element in a product – inner and outer. For example, given</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">A</span> <span class="kd">←</span> <span class="m">2</span> <span class="m">3</span><span class="o">⍴</span><span class="m">6</span><span class="o">?</span><span class="m">20</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">B</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">2</span><span class="o">⍴</span><span class="m">6</span><span class="o">?</span><span class="m">20</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">A</span> <span class="o">+</span><span class="na">.</span><span class="o">×</span> <span class="nv">B</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────┐
↓ 3  2 19│
│16 11  4│
└~───────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────┐
↓18 17│
│ 9  7│
│ 3  1│
└~────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
↓129  84│
│399 353│
└~──────┘
</span></div></div>
</div>
<p>We can show how this was derived with <code class="docutils literal notranslate"><span class="pre">X</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">A</span> <span class="o">+</span><span class="nv">X</span><span class="na">.</span><span class="p">(</span><span class="o">×</span><span class="nv">X</span><span class="p">)</span> <span class="nv">B</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────────────────────────────────────┬────────────────────────────────────┐
│(( 3 × 18 )+(( 2 × 9 )+( 19 × 3 ))) │(( 3 × 17 )+(( 2 × 7 )+( 19 × 1 ))) │
├────────────────────────────────────┼────────────────────────────────────┤
│(( 16 × 18 )+(( 11 × 9 )+( 4 × 3 )))│(( 16 × 17 )+(( 11 × 7 )+( 4 × 1 )))│
└────────────────────────────────────┴────────────────────────────────────┘
</span></div></div>
</div>
</div>
</div>
<span id="document-tacit"></span><div class="tex2jax_ignore mathjax_ignore section" id="trainspotting">
<h2>Trainspotting<a class="headerlink" href="#trainspotting" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Simplicity and elegance are unpopular because they require hard work and discipline to achieve and education to be appreciated. – <em>Edsger Dijkstra</em></p>
</div></blockquote>
<p><em>Tacit</em> is the <em>third</em> way to write code in Dyalog APL, after dfns, and <em>traditional</em> (which we’re not covering). The tacit style, also sometimes called <em>point-free</em>, was taken from the J language, which originated the concept. Tacit code can be made super-terse, and is best reserved for short snippets only. APL <em>idioms</em> – short, efficient, and ultra-optimised bits of code, are often expressed in tacit. You’ll find that pretty much everything on <a class="reference external" href="https://aplcart.info/?w">APLCart</a> is written in tacit, and as you start working on improving your <a class="reference external" href="https://codegolf.stackexchange.com">Code Golf</a> handicap, tacit is an essential skill.</p>
<p>We can look at tacit programming in APL as a little embedded DSL for functional composition, complete with its own grammar. The rules of this grammar are actually quite simple, but learning how to read and write tacit functions takes a lot of practice, even for those well-versed in the rest of APL.</p>
<p>References for tacit programming:</p>
<ul class="simple">
<li><p><a class="reference external" href="https://aplwiki.com/wiki/Tacit_programming">APL Wiki</a></p></li>
<li><p><a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-23-transcribing-to-and-reading-trains">Cultivation</a></p></li>
<li><p><a class="reference external" href="https://www.youtube.com/watch?v=Enlh5qwwDuY%3Ft%3D440">Dyalog webinar</a></p></li>
<li><p><a class="reference external" href="http://dfns.dyalog.com/n_tacit.htm">dfns</a> page on dfn to tacit translation</p></li>
</ul>
<p>The word <em>tacit</em> means implicit, and refers to a function where there is no explicit mention of its arguments. In a tacit function, then, you’ll see no <code class="docutils literal notranslate"><span class="pre">⍺</span></code> and <code class="docutils literal notranslate"><span class="pre">⍵</span></code> as you would in a dfn. Instead a set of rules decide how the components of a tacit function interact with the arguments.</p>
<p>This time, in our prelude, we’ll use the <code class="docutils literal notranslate"><span class="pre">-trains=tree</span> <span class="pre">-fns=on</span></code> arguments to <code class="docutils literal notranslate"><span class="pre">]box</span></code> which helps with showing the structure of tacit functions.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span> <span class="o">-</span><span class="nv">style</span><span class="o">=</span><span class="nv">min</span> <span class="o">-</span><span class="nv">trains</span><span class="o">=</span><span class="nv">tree</span> <span class="o">-</span><span class="nv">fns</span><span class="o">=</span><span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
<span class="nv">assert</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍺</span><span class="kd">←</span><span class="s1">&#39;assertion failure&#39;</span> <span class="p">⋄</span> <span class="m">0</span><span class="o">∊</span><span class="bp">⍵:⍺</span> <span class="nf">⎕signal</span> <span class="m">8</span> <span class="p">⋄</span> <span class="nv">shy</span><span class="kd">←</span><span class="m">0</span><span class="kt">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON -style=min -trains=tree -fns=on
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<div class="section" id="the-tacit-rules-atop">
<h3>The tacit rules: atop<a class="headerlink" href="#the-tacit-rules-atop" title="Permalink to this headline">¶</a></h3>
<p>A tacit function is wrapped in parentheses, <code class="docutils literal notranslate"><span class="pre">(</span> <span class="pre">...</span> <span class="pre">)</span></code>, and is governed by a set of rules. Let’s begin with the easiest one, the <em>monadic atop</em>. An <em>atop</em>, also known as a <em>2-train</em>, is a combination of two functions:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(f g)Y → f g Y
</pre></div>
</div>
<p>This states that the tacit function <code class="docutils literal notranslate"><span class="pre">(f</span> <span class="pre">g)</span></code>, comprising the monadic functions <code class="docutils literal notranslate"><span class="pre">f</span></code> and <code class="docutils literal notranslate"><span class="pre">g</span></code>, simply corresponds to the sequence <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">g</span></code> applied to an argument array <code class="docutils literal notranslate"><span class="pre">Y</span></code>. Well, that seems… obvious? We can try it:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">Y</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">3</span><span class="o">⍴⍳</span><span class="m">9</span>
<span class="p">(</span><span class="o">-⍉</span><span class="p">)</span><span class="nv">Y</span> <span class="c1">⍝ Tacit</span>
<span class="o">-⍉</span><span class="nv">Y</span>   <span class="c1">⍝ Explicit &quot;beside&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 2
3 4 5
6 7 8
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 0 ¯3 ¯6
¯1 ¯4 ¯7
¯2 ¯5 ¯8
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace"> 0 ¯3 ¯6
¯1 ¯4 ¯7
¯2 ¯5 ¯8
</span></div></div>
</div>
<p>Yes, it’s understandable if you’re scratching your head, wondering “what’s the point of that then?”. It pays to think of it as a means of creating a derived function. Doing</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="o">-⍉</span><span class="nv">Y</span>
</pre></div>
</div>
<p>is <em>two</em> operations, whereas</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">-⍉</span><span class="p">)</span><span class="nv">Y</span>
</pre></div>
</div>
<p>is the application of a single, derived function.</p>
<p>But the main purpose of the monadic atop rule is to serve as a building block in more complex tacit functions, as we shall discover shortly.</p>
<p>Let’s move on to the dyadic version of atop instead:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>X (f g) Y → f X g Y
</pre></div>
</div>
<p>Here, the dyadic tacit function <code class="docutils literal notranslate"><span class="pre">(f</span> <span class="pre">g)</span></code> combines the <em>monadic</em> function <code class="docutils literal notranslate"><span class="pre">f</span></code> and the dyadic function <code class="docutils literal notranslate"><span class="pre">g</span></code>. Let’s say we want to tally the elements that are left if you remove all elements from array A from those in B:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">B</span> <span class="kd">←</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span>
<span class="nv">A</span> <span class="kd">←</span> <span class="m">3</span> <span class="m">2</span> <span class="m">6</span>
<span class="o">≢</span> <span class="nv">B</span> <span class="o">~</span> <span class="nv">A</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">4
</span></div></div>
</div>
<p>There we can see the <code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">X</span> <span class="pre">g</span> <span class="pre">Y</span></code> pattern. Let’s try the tacit version, a dyadic <em>atop</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">B</span> <span class="p">(</span><span class="o">≢~</span><span class="p">)</span> <span class="nv">A</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">4
</span></div></div>
</div>
<p>There’s also a monadic version of the atop rule:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(f g)Y → f g Y
</pre></div>
</div>
<p>Again, hard to see the utility yet, perhaps.</p>
</div>
<div class="section" id="the-tacit-rules-fork">
<h3>The tacit rules: fork<a class="headerlink" href="#the-tacit-rules-fork" title="Permalink to this headline">¶</a></h3>
<p>Let’s keep going! Here’s our first <em>fork</em> (also known as a 3-train) – a tacit combination of <em>three</em> functions:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>X (f g h) Y → (X f Y) g (X h Y)
</pre></div>
</div>
<p>This is perhaps the simplest tacit rule that one can see applications for. Consider the three-way compare (sometimes called “spaceship”) operator, <code class="docutils literal notranslate"><span class="pre">a</span> <span class="pre">&lt;=&gt;</span> <span class="pre">b</span></code> that some languages (like Perl or Ruby) offer. It returns a negative value if a &lt; b, 0 if a == b and a positive value if a &gt; b. APL has no such thing, but we can cook up a tacit function using the fork rule:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">cmp</span> <span class="kd">←</span> <span class="o">&gt;-&lt;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="nv">cmp</span> <span class="m">2</span>
<span class="m">1</span> <span class="nv">cmp</span> <span class="m">1</span>
<span class="m">2</span> <span class="nv">cmp</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">¯1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div></div>
</div>
<p>Let’s look at the rule application to see why it works:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(a &gt; b) - (a &lt; b) ⍝ using the fork rule: (X f Y) g (X h Y)
</pre></div>
</div>
<p>Once you learn to see this pattern, it really crops up frequently. Why is it called a “fork”? Well, if we have specified <code class="docutils literal notranslate"><span class="pre">]box</span> <span class="pre">on</span></code> with <code class="docutils literal notranslate"><span class="pre">-trains=tree</span></code> we can ask the interpreter to show us its parse of the tacit function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">cmp</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┼─┐
&gt; - &lt;
</span></div></div>
</div>
<p>Very much a fork, or trident. As an aside, you can actually achieve the same thing with one symbol fewer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">cmp</span> <span class="kd">←</span> <span class="o">×-</span> <span class="c1">⍝ Try it!</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s look at a few more examples. A common problem is to split a string into substrings, dividing on some separator character. Here’s one way you can achieve that, using a dfn:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Split</span> <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍵</span><span class="o">⊆</span><span class="na">⍨</span><span class="bp">⍺</span><span class="o">≠</span><span class="bp">⍵</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39; &#39;</span> <span class="nv">Split</span> <span class="s1">&#39;A common problem is to split a string into substrings&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬──────┬───────┬──┬──┬─────┬─┬──────┬────┬──────────┐
│A│common│problem│is│to│split│a│string│into│substrings│
└─┴──────┴───────┴──┴──┴─────┴─┴──────┴────┴──────────┘
</span></div></div>
</div>
<p>Let’s rework that into a tacit formulation instead, taking it step by step. First, let’s flip that selfie and put in some parentheses for emphasis:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Split</span> <span class="kd">←</span> <span class="kt">{</span><span class="p">(</span><span class="bp">⍺</span><span class="o">≠</span><span class="bp">⍵</span><span class="p">)</span> <span class="o">⊆</span> <span class="p">(</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>So that <em>almost</em> matches the fork pattern <code class="docutils literal notranslate"><span class="pre">(X</span> <span class="pre">f</span> <span class="pre">Y)</span> <span class="pre">g</span> <span class="pre">(X</span> <span class="pre">h</span> <span class="pre">Y)</span></code>, but not quite. The last part makes no reference to <code class="docutils literal notranslate"><span class="pre">⍺</span></code>. Let’s address that with a tack-trick:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Split</span> <span class="kd">←</span> <span class="kt">{</span><span class="p">(</span><span class="bp">⍺</span><span class="o">≠</span><span class="bp">⍵</span><span class="p">)</span> <span class="o">⊆</span> <span class="p">(</span><span class="bp">⍺</span><span class="o">⊢</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>To recap, the tacks (<code class="docutils literal notranslate"><span class="pre">⊣⊢</span></code>) are functions that just return the value they’re “pointing” to:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="o">⊢</span><span class="m">3</span>
<span class="o">⊢</span><span class="m">5</span>
<span class="m">2</span><span class="o">⊣</span><span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">5
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div></div>
</div>
<p>They are very useful when writing tacit functions, as we’ve just seen. We now have a dfn body that matches the fork rule, and we can write it tacitly as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Split</span> <span class="kd">←</span> <span class="o">≠⊆⊢</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39; &#39;</span> <span class="nv">Split</span> <span class="s1">&#39;It should still work the same way&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬──────┬─────┬────┬───┬────┬───┐
│It│should│still│work│the│same│way│
└──┴──────┴─────┴────┴───┴────┴───┘
</span></div></div>
</div>
<p>Ok, let’s try another one, this time going the other way. Here’s a fork that scales a vector of numbers such that its components sum to 1:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">UnitSum</span> <span class="kd">←</span> <span class="o">⊢÷+</span><span class="na">/</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">UnitSum</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0.047619 0.0952381 0.142857 0.190476 0.238095 0.285714
</span></div></div>
</div>
<p>What is the corresponding explicit dfn?</p>
<p>The complication here is that we now have an operator involved: a reduction. Recall that operators take one (or two) function(s) and return a <em>derived function</em> that can then be applied to arguments in turn. So let’s think of the sum-reduction as a single function. Using spaces to make this clearer we get:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">UnitSum</span> <span class="kd">←</span> <span class="o">⊢</span> <span class="o">÷</span> <span class="o">+</span><span class="na">/</span>
</pre></div>
</div>
</div>
</div>
<p>We know already that the fork itself is monadic, meaning that the <code class="docutils literal notranslate"><span class="pre">f</span></code> and the <code class="docutils literal notranslate"><span class="pre">h</span></code> functions must both be monadic, and the <code class="docutils literal notranslate"><span class="pre">g</span></code> function dyadic. The tack becomes just <code class="docutils literal notranslate"><span class="pre">⍵</span></code> and the sum-reduction we just need to give an argument:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">UnitSum</span> <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍵</span><span class="o">÷+</span><span class="na">/</span><span class="bp">⍵</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">UnitSum</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0.047619 0.0952381 0.142857 0.190476 0.238095 0.285714
</span></div></div>
</div>
<p>That last example – a monadic fork – can be formalised as:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(f g h)Y → (f Y) g (h Y)
</pre></div>
</div>
<p>There are, in fact, two more fork-varieties, beyond the two we’ve already seen. They differ in how the consitutent functions are applied (monadically or dyadically):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>X(Z g h)Y → Z g X h Y ⍝ h dyad, g dyad, derived dyad
(X g h)Y  → X g h Y   ⍝ h modad, g dyad, derived monad
</pre></div>
</div>
</div>
<div class="section" id="summary-forks-and-atops">
<h3>Summary: forks and atops<a class="headerlink" href="#summary-forks-and-atops" title="Permalink to this headline">¶</a></h3>
<p>For completeness, then – here are all the rules of the tacit grammar in one place:</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="text-align:left head"><p>Tacit</p></th>
<th class="text-align:left head"><p>Type</p></th>
<th class="text-align:left head"><p>Explicit</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">X(Z</span> <span class="pre">g</span> <span class="pre">h)Y</span></code></p></td>
<td class="text-align:left"><p>Fork</p></td>
<td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">Z</span> <span class="pre">g</span> <span class="pre">X</span> <span class="pre">h</span> <span class="pre">Y</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">X(f</span> <span class="pre">g</span> <span class="pre">h)Y</span></code></p></td>
<td class="text-align:left"><p>Fork</p></td>
<td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">(X</span> <span class="pre">f</span> <span class="pre">Y)</span> <span class="pre">g</span> <span class="pre">(X</span> <span class="pre">h</span> <span class="pre">Y)</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">(X</span> <span class="pre">g</span> <span class="pre">h)Y</span></code></p></td>
<td class="text-align:left"><p>Fork</p></td>
<td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">X</span> <span class="pre">g</span> <span class="pre">h</span> <span class="pre">Y</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">(f</span> <span class="pre">g</span> <span class="pre">h)Y</span></code></p></td>
<td class="text-align:left"><p>Fork</p></td>
<td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">(f</span> <span class="pre">Y)</span> <span class="pre">g</span> <span class="pre">(h</span> <span class="pre">Y)</span></code></p></td>
</tr>
<tr class="row-even"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">X(f</span> <span class="pre">g)Y</span></code></p></td>
<td class="text-align:left"><p>Atop</p></td>
<td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">X</span> <span class="pre">g</span> <span class="pre">Y</span></code></p></td>
</tr>
<tr class="row-odd"><td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">(f</span> <span class="pre">g)Y</span></code></p></td>
<td class="text-align:left"><p>Atop</p></td>
<td class="text-align:left"><p><code class="docutils literal notranslate"><span class="pre">f</span> <span class="pre">g</span> <span class="pre">Y</span></code></p></td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="forks-atop-forks">
<h3>Forks atop forks<a class="headerlink" href="#forks-atop-forks" title="Permalink to this headline">¶</a></h3>
<p>This is where the real fun begins. We can string together longer tacit functions by combining forks and atops. Some consideration should be given to comprehensibility here. Long stretches of tacit code requires more effort to understand than the corresponding explicit formulation.</p>
<p>As our tacit rules indicate, barring the presence of parentheses, a combination of three functions is a fork, and two functions is an atop. If we have <em>more</em> than three functions, we start reading from the right, making groups of threes and twos, and combine <em>those</em> using the fork and atop rules.</p>
<p>From Dyalog’s <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Introduction/Trains.htm">docs</a>:</p>
<blockquote>
<div><p>…in the absence of parentheses, a sequence of an odd number of functions resolves to a 3-train (fork) and an even-numbered sequence resolves to a 2-train (atop)</p>
</div></blockquote>
<p>So how long is too long a train? It depends on the “carriages”. The example given in Dyalog’s docs above is a good point:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">6</span> <span class="p">(</span><span class="o">⌽+,-,×,÷</span><span class="p">)</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 12 4 8
</span></div></div>
</div>
<p>That’s 8 constituent functions. We’ll prise it apart in a bit, but looking at it, it’s pretty clear what the intention is: find the sum, difference, product and ratio of two numbers, and reverse the list.</p>
<p>As always, let’s look at the parse:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⌽+,-,×,÷</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┴─┐
⌽ ┌─┼───┐
  + , ┌─┼───┐
      - , ┌─┼─┐
          × , ÷
</span></div></div>
</div>
<p>So reading right to left, down to up, we have three forks and an atop. Let’s resolve them from the right:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">f1</span> <span class="kd">←</span> <span class="o">×,÷</span> <span class="c1">⍝ ...fork, (6×2),(6÷2)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">r</span> <span class="kd">←</span> <span class="m">6</span> <span class="p">(</span><span class="o">⌽+,-,</span><span class="nv">f1</span><span class="p">)</span> <span class="m">2</span> <span class="c1">⍝ does it still work?</span>
<span class="nv">assert</span> <span class="nv">r</span><span class="o">≡</span><span class="m">6</span> <span class="p">(</span><span class="o">⌽+,-,×,÷</span><span class="p">)</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 12 4 8
</span></div></div>
</div>
<p>The next fork is now</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">f2</span> <span class="kd">←</span> <span class="o">-,</span><span class="nv">f1</span> <span class="c1">⍝ ...fork: (6-2),f1 → (6-2),(6×2),(6÷2)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">6</span> <span class="p">(</span><span class="o">⌽+,</span><span class="nv">f2</span><span class="p">)</span> <span class="m">2</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 12 4 8
</span></div></div>
</div>
<p>and the final fork is more of the same:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">f3</span> <span class="kd">←</span> <span class="o">+,</span><span class="nv">f2</span> <span class="c1">⍝ (6+2),(6-2),(6×2),(6÷2)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">6</span> <span class="p">(</span><span class="o">⌽</span><span class="nv">f3</span><span class="p">)</span> <span class="m">2</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 12 4 8
</span></div></div>
</div>
<p>And finally, the atop, which moves the left argument to between the functions and removes the brackets:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⌽</span> <span class="m">6</span> <span class="nv">f3</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 12 4 8
</span></div></div>
</div>
<p>or, fully explicit:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">6</span> <span class="kt">{</span><span class="o">⌽</span><span class="p">(</span><span class="bp">⍺</span><span class="o">+</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="p">(</span><span class="bp">⍺</span><span class="o">-</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="p">(</span><span class="bp">⍺</span><span class="o">×</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="bp">⍺</span><span class="o">÷</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 12 4 8
</span></div></div>
</div>
</div>
<div class="section" id="complicating-factors">
<h3>Complicating factors<a class="headerlink" href="#complicating-factors" title="Permalink to this headline">¶</a></h3>
<p>Using the method outlined above, you can usually untangle reasonably-sized trains that others have composed:</p>
<ul class="simple">
<li><p>Use <code class="docutils literal notranslate"><span class="pre">]box</span> <span class="pre">on</span> <span class="pre">-style=mid</span> <span class="pre">-trains=tree</span> <span class="pre">-fns=on</span></code> to visualise the parse tree for the train</p></li>
<li><p>Follow the pattern indicated by the tree, and resolve forks and atops (R→L) using The Rules</p></li>
</ul>
<p>However, certain factors make this more complicated:</p>
<ul class="simple">
<li><p>Mid-train parentheses to alter order of precedence</p></li>
<li><p>Binding strengths – operators bind tighter than functions</p></li>
<li><p>Jots &amp; tacks, if overused.</p></li>
</ul>
<p>A handy tacit function is finding the min and max of an array, which we can use to demonstrate the operator binding:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">minmax</span> <span class="kd">←</span> <span class="o">⌊</span><span class="na">/</span><span class="o">,⌈</span><span class="na">/</span>
<span class="nv">minmax</span> <span class="m">7</span> <span class="m">2</span> <span class="m">3</span> <span class="m">8</span> <span class="m">0</span> <span class="m">9</span> <span class="m">12</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 12
</span></div></div>
</div>
<p>This is a single fork:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">minmax</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  ┌─┼─┐
  / , /
┌─┘ ┌─┘
⌊   ⌈
</span></div></div>
</div>
<p>So we can see that we need to start by letting the reduces bind first to form the derived functions that make up the fork. Ok, that wasn’t too bad. What about this one?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">ones</span> <span class="kd">←</span> <span class="o">⊢∧</span><span class="p">(</span><span class="o">∧</span><span class="na">⍀</span><span class="o">∨</span><span class="na">⍀</span><span class="o">=⊢</span><span class="p">)</span> <span class="c1">⍝ Hat tip to Adám Brudzewski for the suggestion</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┼───┐
⊢ ∧ ┌─┴─┐
    ⍀ ┌─┼─┐
  ┌─┘ ⍀ = ⊢
  ∧ ┌─┘
    ∨
</span></div></div>
</div>
<p>Top marks if you can say what that even does. Before we get into that, we can see that the parenthesis have affected the “groups of three from the right” parse. We’re now looking at a fork-atop-fork, two operators and two tacks. All non-specific religious holidays came at once.</p>
<p>This function preserves the first uninterrupted sequence of 1s in a vector:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">ones</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 1 1 1 0 0 0 0 0 0 0 0 0
</span></div></div>
</div>
<p>Let’s untangle the parse tree, bottom-up, right-left. The first fork is</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">f1</span> <span class="kd">←</span> <span class="o">∨</span><span class="na">⍀</span> <span class="o">=</span> <span class="o">⊢</span> <span class="c1">⍝ ...monadic fork, giving a dfn equivalent: {(∨⍀⍵)=⍵}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  ┌─┼─┐
  ⍀ = ⊢
┌─┘
∨
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">r</span> <span class="kd">←</span> <span class="p">(</span><span class="o">⊢∧</span><span class="p">(</span><span class="o">∧</span><span class="na">⍀</span><span class="nv">f1</span><span class="p">))</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span>
<span class="nv">assert</span> <span class="nv">r</span><span class="o">≡</span><span class="nv">ones</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="c1">⍝ still works!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 1 1 1 0 0 0 0 0 0 0 0 0
</span></div></div>
</div>
<p>Now let’s tackle the atop, which is just applying the and-scan to the fork:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">a1</span> <span class="kd">←</span> <span class="o">∧</span><span class="na">⍀</span><span class="nv">f1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  ┌─┴─┐
  ⍀ ┌─┼─┐
┌─┘ ⍀ = ⊢
∧ ┌─┘
  ∨
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">⊢∧</span><span class="nv">a1</span><span class="p">)</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 1 1 1 0 0 0 0 0 0 0 0 0
</span></div></div>
</div>
<p>and there we have a monadic fork:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">∧</span><span class="nv">a1</span> <span class="bp">⍵</span><span class="kt">}</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 1 1 1 0 0 0 0 0 0 0 0 0
</span></div></div>
</div>
<p>We can now fully untangle it if we want:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">∧∧</span><span class="na">⍀</span><span class="p">(</span><span class="o">∨</span><span class="na">⍀</span><span class="bp">⍵</span><span class="p">)</span><span class="o">=</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 1 1 1 0 0 0 0 0 0 0 0 0
</span></div></div>
</div>
<p>So now we can compare the tacit and explicit forms of the same function:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">tacit</span> <span class="kd">←</span> <span class="o">⊢∧</span><span class="p">(</span><span class="o">∧</span><span class="na">⍀</span><span class="o">∨</span><span class="na">⍀</span><span class="o">=⊢</span><span class="p">)</span>
<span class="nv">expl</span>  <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍵</span><span class="o">∧∧</span><span class="na">⍀</span><span class="p">(</span><span class="o">∨</span><span class="na">⍀</span><span class="bp">⍵</span><span class="p">)</span><span class="o">=</span><span class="bp">⍵</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>Which one is “better”? Yes, the tacit formulation is shorter by three glyphs. <em>Readability</em> is a slippery concept which depends on the skill and experience of the reader, but at least to <em>this</em> reader, without going through the above deconstruction exercise, I could not have told you how the tacit function worked. In the explicit formulation – to <em>my</em> eyes at least – the algorithm is more visible.</p>
<p>Let’s work through a couple more, back and forth. If you haven’t already, do check out Richard Park’s most excellent <a class="reference external" href="https://dyalog.tv/Webinar/?v=Enlh5qwwDuY">webinar</a> on the topic, too.</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Working through examples this way, whilst somewhat tedious, is the only way to learn. Eventually it clicks. If this all feels a bit dry, skip to the next chapter and keep coming back here in small doses.</p>
</div>
<p>Here’s a tacit phrase which groups pairs of elements based on the first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">group</span> <span class="kd">←</span> <span class="o">↓⊃</span><span class="na">¨</span><span class="o">,</span><span class="na">∘</span><span class="o">⊂</span><span class="na">⌸</span><span class="o">⊢</span><span class="na">/¨</span> <span class="c1">⍝ Group pairs based on first element</span>
<span class="nv">group</span> <span class="vg">⎕</span><span class="kd">←</span><span class="p">(</span><span class="m">5</span> <span class="m">3</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">5</span><span class="p">)(</span><span class="m">4</span> <span class="m">7</span><span class="p">)(</span><span class="m">1</span> <span class="m">8</span><span class="p">)(</span><span class="m">2</span> <span class="m">4</span><span class="p">)(</span><span class="m">1</span> <span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬───┬───┬───┬───┬───┐
│5 3│5 6│7 5│4 7│1 8│2 4│1 2│
└───┴───┴───┴───┴───┴───┴───┘
┌───────┬─────┬─────┬───────┬─────┐
│┌─┬───┐│┌─┬─┐│┌─┬─┐│┌─┬───┐│┌─┬─┐│
││5│3 6│││7│5│││4│7│││1│8 2│││2│4││
│└─┴───┘│└─┴─┘│└─┴─┘│└─┴───┘│└─┴─┘│
└───────┴─────┴─────┴───────┴─────┘
</span></div></div>
</div>
<p>Let’s look at the parse tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">group</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┴──┐
↓ ┌───┼───┐
  ¨   ⌸   ¨
┌─┘ ┌─┘ ┌─┘
⊃   ∘   ⊢/
   ┌┴┐
   , ⊂
</span></div></div>
</div>
<p>Yikes… but actually, it looks worse than it is – it’s a single fork, with an atop. The sprinkling of operators make it look more complicated than it is. So, bit by bit as indicated by the tree, starting with the <em>Key</em> (<code class="docutils literal notranslate"><span class="pre">⌸</span></code>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">key</span> <span class="kd">←</span> <span class="vg">⎕</span><span class="kd">←</span><span class="o">,</span><span class="na">∘</span><span class="o">⊂</span><span class="na">⌸</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">   ⌸
 ┌─┘
 ∘
┌┴┐
, ⊂
</span></div></div>
</div>
<p>Looks correct. If we substitute into the original definition, we get</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↓⊃</span><span class="na">¨</span><span class="nv">key</span><span class="o">⊢</span><span class="na">/¨</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┴──┐
↓ ┌───┼───┐
  ¨   ⌸   ¨
┌─┘ ┌─┘ ┌─┘
⊃   ∘   ⊢/
   ┌┴┐
   , ⊂
</span></div></div>
</div>
<p>Yep. Still the same. Now for the left and right tines:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">discloseAll</span> <span class="kd">←</span> <span class="o">⊃</span><span class="na">¨</span>
<span class="nv">mergeLasts</span> <span class="kd">←</span> <span class="o">⊢</span><span class="na">/¨</span>
<span class="o">↓</span><span class="nv">discloseAll</span> <span class="nv">key</span> <span class="nv">mergeLasts</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┴──┐
↓ ┌───┼───┐
  ¨   ⌸   ¨
┌─┘ ┌─┘ ┌─┘
⊃   ∘   ⊢/
   ┌┴┐
   , ⊂
</span></div></div>
</div>
<p>We can now translate to a dfn:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="o">↓</span><span class="p">(</span><span class="nv">discloseAll</span> <span class="bp">⍵</span><span class="p">)</span> <span class="nv">key</span> <span class="p">(</span><span class="nv">mergeLasts</span> <span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span>  <span class="p">(</span><span class="m">5</span> <span class="m">3</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">5</span><span class="p">)(</span><span class="m">4</span> <span class="m">7</span><span class="p">)(</span><span class="m">1</span> <span class="m">8</span><span class="p">)(</span><span class="m">2</span> <span class="m">4</span><span class="p">)(</span><span class="m">1</span> <span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────┬─────┬─────┬───────┬─────┐
│┌─┬───┐│┌─┬─┐│┌─┬─┐│┌─┬───┐│┌─┬─┐│
││5│3 6│││7│5│││4│7│││1│8 2│││2│4││
│└─┴───┘│└─┴─┘│└─┴─┘│└─┴───┘│└─┴─┘│
└───────┴─────┴─────┴───────┴─────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="o">↓</span><span class="p">(</span><span class="o">⊃</span><span class="na">¨</span><span class="bp">⍵</span><span class="p">)</span> <span class="o">,</span><span class="na">∘</span><span class="o">⊂</span><span class="na">⌸</span> <span class="o">⊢</span><span class="na">/¨</span><span class="bp">⍵</span><span class="kt">}</span> <span class="p">(</span><span class="m">5</span> <span class="m">3</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">5</span><span class="p">)(</span><span class="m">4</span> <span class="m">7</span><span class="p">)(</span><span class="m">1</span> <span class="m">8</span><span class="p">)(</span><span class="m">2</span> <span class="m">4</span><span class="p">)(</span><span class="m">1</span> <span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────┬─────┬─────┬───────┬─────┐
│┌─┬───┐│┌─┬─┐│┌─┬─┐│┌─┬───┐│┌─┬─┐│
││5│3 6│││7│5│││4│7│││1│8 2│││2│4││
│└─┴───┘│└─┴─┘│└─┴─┘│└─┴───┘│└─┴─┘│
└───────┴─────┴─────┴───────┴─────┘
</span></div></div>
</div>
<p>The operand to <em>Key</em> is a derived function. We could expand that, too, if we want to be purist:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="o">↓</span><span class="p">(</span><span class="o">⊃</span><span class="na">¨</span><span class="bp">⍵</span><span class="p">)</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,⊂</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌸</span> <span class="o">⊢</span><span class="na">/¨</span><span class="bp">⍵</span><span class="kt">}</span> <span class="p">(</span><span class="m">5</span> <span class="m">3</span><span class="p">)(</span><span class="m">5</span> <span class="m">6</span><span class="p">)(</span><span class="m">7</span> <span class="m">5</span><span class="p">)(</span><span class="m">4</span> <span class="m">7</span><span class="p">)(</span><span class="m">1</span> <span class="m">8</span><span class="p">)(</span><span class="m">2</span> <span class="m">4</span><span class="p">)(</span><span class="m">1</span> <span class="m">2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────┬─────┬─────┬───────┬─────┐
│┌─┬───┐│┌─┬─┐│┌─┬─┐│┌─┬───┐│┌─┬─┐│
││5│3 6│││7│5│││4│7│││1│8 2│││2│4││
│└─┴───┘│└─┴─┘│└─┴─┘│└─┴───┘│└─┴─┘│
└───────┴─────┴─────┴───────┴─────┘
</span></div></div>
</div>
<p>Here’s another one. What does this even do?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span> <span class="p">(</span><span class="o">|</span><span class="na">∘</span><span class="o">⍳</span><span class="na">∘</span><span class="o">≢⊢</span><span class="na">∘</span><span class="o">⊂</span><span class="na">⌸</span><span class="o">⊢</span><span class="p">)</span> <span class="s1">&#39;dyaloge&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬───┐
│daoe│ylg│
└────┴───┘
</span></div></div>
</div>
<p>Another thing we can do that may or may not be useful is to ask the interpreter to give us a parethesised expression instead of the parse tree.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span> <span class="o">-</span><span class="nv">style</span><span class="o">=</span><span class="nv">mid</span> <span class="o">-</span><span class="nv">trains</span><span class="o">=</span><span class="nv">parens</span> <span class="o">-</span><span class="nv">fns</span><span class="o">=</span><span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON -style=min -trains=tree -fns=on
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">|</span><span class="na">∘</span><span class="o">⍳</span><span class="na">∘</span><span class="o">≢⊢</span><span class="na">∘</span><span class="o">⊂</span><span class="na">⌸</span><span class="o">⊢</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">((|∘⍳)∘≢)((⊢∘⊂)⌸)⊢
</span></div></div>
</div>
<p>Some say that’s an easier start than the tree. Take your pick. Following the steps above you should land on:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span> <span class="kt">{</span><span class="p">(</span><span class="bp">⍺</span><span class="o">|⍳≢</span><span class="bp">⍵</span><span class="p">)</span> <span class="kt">{</span><span class="o">⊂</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌸</span> <span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;dyaloge&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───┬───┐
│daoe│ylg│
└───→┴──→┘
</span></div></div>
</div>
<p>This one draws a bar chart:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="p">(</span><span class="o">↑⍴</span><span class="na">¨∘</span><span class="s1">&#39;⎕&#39;</span><span class="p">)</span><span class="m">3</span> <span class="m">0</span> <span class="m">9</span> <span class="m">6</span> <span class="m">2</span> <span class="m">7</span> <span class="m">6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓⎕⎕⎕      │
│         │
│⎕⎕⎕⎕⎕⎕⎕⎕⎕│
│⎕⎕⎕⎕⎕⎕   │
│⎕⎕       │
│⎕⎕⎕⎕⎕⎕⎕  │
│⎕⎕⎕⎕⎕⎕   │
└─────────┘
</span></div></div>
</div>
<p>which is just</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">↑</span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⍴</span><span class="s1">&#39;⎕&#39;</span><span class="kt">}</span><span class="na">¨</span><span class="m">3</span> <span class="m">0</span> <span class="m">9</span> <span class="m">6</span> <span class="m">2</span> <span class="m">7</span> <span class="m">6</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────┐
↓⎕⎕⎕      │
│         │
│⎕⎕⎕⎕⎕⎕⎕⎕⎕│
│⎕⎕⎕⎕⎕⎕   │
│⎕⎕       │
│⎕⎕⎕⎕⎕⎕⎕  │
│⎕⎕⎕⎕⎕⎕   │
└─────────┘
</span></div></div>
</div>
<p>Let’s try a couple of harder ones. This one removes leading, trailing and repeated stretches of <code class="docutils literal notranslate"><span class="pre">⍺</span></code> from <code class="docutils literal notranslate"><span class="pre">⍵</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">trim</span> <span class="kd">←</span> <span class="m">1</span><span class="o">↓,⊢</span><span class="na">⍤/⍨</span><span class="m">1</span><span class="p">(</span><span class="o">⊢∨⌽</span><span class="p">)</span><span class="m">0</span><span class="o">,≠</span>
<span class="s1">&#39; &#39;</span> <span class="nv">trim</span> <span class="s1">&#39;        hello     world     &#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">hello world
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span> <span class="o">-</span><span class="nv">style</span><span class="o">=</span><span class="nv">mid</span> <span class="o">-</span><span class="nv">trains</span><span class="o">=</span><span class="nv">tree</span> <span class="o">-</span><span class="nv">fns</span><span class="o">=</span><span class="nv">on</span> <span class="c1">⍝ I&#39;m a tree guy!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON -style=mid -trains=parens -fns=on
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">trim</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┼───┐
1 ↓ ┌─┼─────┐
    , ⍨ ┌───┼─────┐
    ┌─┘ 1 ┌─┼─┐ ┌─┼─┐
    ⍤     ⊢ ∨ ⌽ 0 , ≠
   ┌┴┐
   ⊢ /
</span></div></div>
</div>
<p>No fewer than <em>five</em> forks! The other thing to note is the use of <code class="docutils literal notranslate"><span class="pre">⍤</span></code> here which in fact is <em>not</em> <em>Rank</em>. When <code class="docutils literal notranslate"><span class="pre">⍤</span></code> is used with a right <em>function</em> operand, it becomes <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Operators/Atop.htm"><em>Atop</em></a>, not <em>Rank</em> (which takes a right <em>array</em> operand).</p>
<p>The tacit phrase <code class="docutils literal notranslate"><span class="pre">⊢⍤f</span></code> is a trick to force <code class="docutils literal notranslate"><span class="pre">f</span></code> to be parsed as a function, rather than as an operator for glyphs that can be either. In our case, <code class="docutils literal notranslate"><span class="pre">⊢⍤/⍨</span></code> is just <code class="docutils literal notranslate"><span class="pre">{⍵/⍺}</span></code>. With that we may be able to skip a few intermediate steps:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">f</span> <span class="kd">←</span> <span class="kt">{</span><span class="m">1</span><span class="kt">{</span><span class="bp">⍵</span><span class="o">∨</span><span class="bp">⍺</span><span class="o">⌽</span><span class="bp">⍵</span><span class="kt">}</span><span class="bp">⍺</span><span class="kt">{</span><span class="m">0</span><span class="o">,</span><span class="bp">⍺</span><span class="o">≠</span><span class="bp">⍵</span><span class="kt">}</span><span class="bp">⍵</span><span class="kt">}</span>
<span class="nv">g</span> <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍵</span><span class="na">/</span><span class="bp">⍺</span><span class="kt">}</span>     
<span class="nv">trimdfn</span> <span class="kd">←</span> <span class="kt">{</span><span class="m">1</span><span class="o">↓</span><span class="p">(</span><span class="bp">⍺</span><span class="o">,</span><span class="bp">⍵</span><span class="p">)</span><span class="nv">g</span><span class="bp">⍺</span><span class="nv">f</span><span class="bp">⍵</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39; &#39;</span> <span class="nv">trimdfn</span> <span class="s1">&#39;        hello     world     &#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">hello world
</span></div></div>
</div>
<p>Expanding that out we can make a few simplifications, arriving at the resaonably compact</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">trim</span> <span class="kd">←</span> <span class="kt">{</span><span class="m">1</span><span class="o">↓</span><span class="p">(</span><span class="nv">x</span><span class="o">∨</span><span class="m">1</span><span class="o">⌽</span><span class="nv">x</span><span class="kd">←</span><span class="m">0</span><span class="o">,</span><span class="bp">⍺</span><span class="o">≠</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="bp">⍺</span><span class="o">,</span><span class="bp">⍵</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39; &#39;</span> <span class="nv">trim</span> <span class="s1">&#39;        hello     world     &#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">hello world
</span></div></div>
</div>
<p>How about going the other way? We’ve done some already. A pretty comprehensive guide to the mechanical process of translating a dfn to its tacit equivalent can be found in the <a class="reference external" href="http://dfns.dyalog.com/n_tacit.htm">docs</a> for the dfns workspace, mentioned at the top of this chapter.</p>
<p>Here’s a noddy dfn that takes a string consisting of a leading letter and some digits, and returns a 2-element vector with the letter and the number:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="p">(</span><span class="m">1</span><span class="o">↑</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,⍎</span><span class="m">1</span><span class="o">↓</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;X1234&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">X 1234
</span></div></div>
</div>
<p>There’s clearly a fork in there, but also an atop. This should pose little difficulty, right? Change the braces for parantheses, and omegas for right-tack, but we need to delineate the eval call:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">((</span><span class="m">1</span><span class="o">↑⊢</span><span class="p">)</span><span class="o">,</span><span class="p">(</span><span class="o">⍎</span><span class="p">(</span><span class="m">1</span><span class="o">↓⊢</span><span class="p">)))</span> <span class="s1">&#39;X1234&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">X 1234
</span></div></div>
</div>
<p>We can do more here. Both left and right tines of the fork share a <code class="docutils literal notranslate"><span class="pre">1</span></code>. We can make that a left argument, so in our case a <em>left</em> tack:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="p">((</span><span class="o">⊣↑⊢</span><span class="p">)</span><span class="o">,</span><span class="p">(</span><span class="o">⍎</span><span class="p">(</span><span class="o">⊣↓⊢</span><span class="p">)))</span> <span class="s1">&#39;X1234&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">X 1234
</span></div></div>
</div>
<p>but the pattern <code class="docutils literal notranslate"><span class="pre">⊣f⊢</span></code> is just <code class="docutils literal notranslate"><span class="pre">f</span></code>, which also lets us remove some parentheses:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="p">(</span><span class="o">↑,</span><span class="p">(</span><span class="o">⍎↓</span><span class="p">))</span> <span class="s1">&#39;X1234&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">X 1234
</span></div></div>
</div>
<p>We can actually remove the inner parantheses, too, by a bit of sleight of hand:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="p">(</span><span class="o">↑,</span><span class="na">∘</span><span class="o">⍎↓</span><span class="p">)</span> <span class="s1">&#39;X1234&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">X 1234
</span></div></div>
</div>
<p>but these two trains – whilst doing the same thing – parse differently:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↑,</span><span class="p">(</span><span class="o">⍎↓</span><span class="p">)</span>
<span class="o">↑,</span><span class="na">∘</span><span class="o">⍎↓</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┼──┐
↑ , ┌┴┐
    ⍎ ↓
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┼─┐
↑ ∘ ↓
 ┌┴┐
 , ⍎
</span></div></div>
</div>
<p>In other words, we made a derived function with jot: <code class="docutils literal notranslate"><span class="pre">,∘⍎</span></code>. That turned out well: the tacit version is shorter than the explicit, and no less readable.</p>
<p>A few more?</p>
<p>This dfn takes a rational to the right and tries to compute a vector representing the corresponding fraction:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="p">(</span><span class="m">1</span><span class="o">∧</span><span class="bp">⍵</span><span class="p">)</span><span class="o">÷</span><span class="m">1</span><span class="o">,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">0.75</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 4
</span></div></div>
</div>
<p>A fork, with both tines also being forks.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">f1</span> <span class="kd">←</span> <span class="kt">{</span><span class="m">1</span><span class="o">∧</span><span class="bp">⍵</span><span class="kt">}</span>
<span class="nv">f2</span> <span class="kd">←</span> <span class="kt">{</span><span class="m">1</span><span class="o">,</span><span class="bp">⍵</span><span class="kt">}</span>
<span class="kt">{</span><span class="p">(</span><span class="nv">f1</span> <span class="bp">⍵</span><span class="p">)</span> <span class="o">÷</span> <span class="nv">f2</span> <span class="bp">⍵</span><span class="kt">}</span> <span class="m">0.75</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 4
</span></div></div>
</div>
<p>We can convert the tine forks directly by swapping <code class="docutils literal notranslate"><span class="pre">⍵</span></code> for <code class="docutils literal notranslate"><span class="pre">⊢</span></code> and <code class="docutils literal notranslate"><span class="pre">{}</span></code> for <code class="docutils literal notranslate"><span class="pre">()</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">((</span><span class="m">1</span><span class="o">∧⊢</span><span class="p">)</span><span class="o">÷</span><span class="m">1</span><span class="o">,⊢</span><span class="p">)</span> <span class="m">0.75</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 4
</span></div></div>
</div>
<p>This one shifts a vector of numbers the specified number of steps to the left, padding with zeros on the right:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">↓</span><span class="bp">⍵</span><span class="o">,</span><span class="bp">⍺</span><span class="o">↑</span><span class="m">0</span><span class="kt">}</span> <span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 4 5 6 7 8 9 0 0 0
</span></div></div>
</div>
<p>Looks easy, right? Tempting to to jump to the conclusion that this is a fork on <em>Catenate</em>, <code class="docutils literal notranslate"><span class="pre">f,g</span></code> – it’s not.</p>
<p>The complication is the take at the end, which has an array right argument which isn’t allowed in a train: we need to <em>Commute</em> that one. So starting from the right, we have a dyadic function as <code class="docutils literal notranslate"><span class="pre">⍺↑0</span></code>, preceded by <code class="docutils literal notranslate"><span class="pre">⍵,</span></code>. So that’s our first fork of the form <code class="docutils literal notranslate"><span class="pre">⊢,f</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊢,</span><span class="m">0</span><span class="o">↑</span><span class="na">⍨</span><span class="o">⊣</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┼───┐
⊢ , ┌─┼─┐
    0 ⍨ ⊣
    ┌─┘
    ↑
</span></div></div>
</div>
<p>Before that we have <code class="docutils literal notranslate"><span class="pre">⍺↑</span></code> which together with what we already did also makes a fork, this time <code class="docutils literal notranslate"><span class="pre">⊣↑g</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">shift</span> <span class="kd">←</span> <span class="o">⊣↓⊢,</span><span class="m">0</span><span class="o">↑</span><span class="na">⍨</span><span class="o">⊣</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┼───┐
⊣ ↓ ┌─┼───┐
    ⊢ , ┌─┼─┐
        0 ⍨ ⊣
        ┌─┘
        ↑
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="nv">shift</span> <span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 4 5 6 7 8 9 0 0 0
</span></div></div>
</div>
<p>Note that again it’s tempting to say that <code class="docutils literal notranslate"><span class="pre">⊣f⊢</span></code> is just <code class="docutils literal notranslate"><span class="pre">f</span></code> like we did earlier, but that makes the same slip as we started with – they don’t belong to one fork:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↓,</span><span class="m">0</span><span class="o">↑</span><span class="na">⍨</span><span class="o">⊣</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┼───┐
↓ , ┌─┼─┐
    0 ⍨ ⊣
    ┌─┘
    ↑
</span></div></div>
</div>
</div>
<div class="section" id="shuffle-the-array">
<h3>Shuffle the array<a class="headerlink" href="#shuffle-the-array" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://leetcode.com/problems/shuffle-the-array/">LeetCode problem 1470</a> was posed as a <a class="reference external" href="https://chat.stackexchange.com/transcript/message/57968695#57968695">chat mini challenge</a> on APL Orchard to produce a tacit solution, and some elegant solutions were presented. Let’s look at that problem.</p>
<p>The task is to take a vector of length <code class="docutils literal notranslate"><span class="pre">2n</span></code>, and essentially zip the first half with the second, and flatten:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Input: nums = [1,2,3,4,4,3,2,1], n = 4
Output: [1,4,2,3,3,2,4,1]
</pre></div>
</div>
<p>A dfn formulation is pretty straight-forward:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">4</span> <span class="kt">{</span><span class="o">,⍉</span><span class="m">2</span><span class="bp">⍺</span><span class="o">⍴</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4 2 3 3 2 4 1
</span></div></div>
</div>
<p>which is reshape to <code class="docutils literal notranslate"><span class="pre">2</span> <span class="pre">n</span></code>, <em>Transpose</em>, <em>Ravel</em> – in fact, it’s kind of how we said it: “zip the first half with the second, and flatten”. However, that particular dfn doesn’t lend itself nicely to a tacit formulation. APL Orchard user <a class="reference external" href="https://chat.stackexchange.com/users/470812/rak1507">&#64;rak1507</a> proposed the following gem:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">4</span> <span class="p">(</span><span class="o">∊↑,</span><span class="na">¨</span><span class="o">↓</span><span class="p">)</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4 2 3 3 2 4 1
</span></div></div>
</div>
<p>Remarkably clever, but kinda obvious (once you’ve seen it). This relies on <em>Catenate each</em> <code class="docutils literal notranslate"><span class="pre">,¨</span></code> as the (almost) “zip” instead of <code class="docutils literal notranslate"><span class="pre">,⍉</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="o">,</span><span class="na">¨</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──┬───┬───┬───┐
│1 4│2 3│3 2│4 1│
└~─→┴~─→┴~─→┴~─→┘
</span></div></div>
</div>
<p>The actual formulation is the tacit version of</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">4</span> <span class="kt">{</span><span class="o">∊</span><span class="p">(</span><span class="bp">⍺</span><span class="o">↑</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="na">¨</span><span class="p">(</span><span class="bp">⍺</span><span class="o">↓</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4 2 3 3 2 4 1
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">∊↑,</span><span class="na">¨</span><span class="o">↓</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┴─┐
∊ ┌─┼─┐
  ↑ ¨ ↓
  ┌─┘
  ,
</span></div></div>
</div>
<p>Nice. But wait, there’s more. <a class="reference external" href="https://aplwiki.com/wiki/Ad%C3%A1m_Brudzewsky">Adám’s</a> version takes a wholly different approach, and do note the way the function takes its arguments, which is key to how this works:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">,</span><span class="na">∘</span><span class="o">⍉</span><span class="m">2</span><span class="na">@</span><span class="m">0</span><span class="o">⍴⊃</span><span class="p">)</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span><span class="p">)</span> <span class="m">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4 2 3 3 2 4 1
</span></div></div>
</div>
<p>Not obvious how that works, right? Let’s look at the parse tree:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">,</span><span class="na">∘</span><span class="o">⍉</span><span class="m">2</span><span class="na">@</span><span class="m">0</span><span class="o">⍴⊃</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> ┌──┴──┐
 ∘   ┌─┼─┐
┌┴┐  @ ⍴ ⊃
, ⍉ ┌┴┐
    2 0
</span></div></div>
</div>
<p>The interesting bit is the fork <code class="docutils literal notranslate"><span class="pre">2&#64;0⍴⊃</span></code>, so let’s look at that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="na">@</span><span class="m">0</span><span class="o">⍴⊃</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> ┌─┼─┐
 @ ⍴ ⊃
┌┴┐
2 0
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="m">2</span><span class="na">@</span><span class="m">0</span><span class="o">⍴⊃</span><span class="p">)</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span><span class="p">)</span> <span class="m">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 3 4
4 3 2 1
</span></div></div>
</div>
<p>Aha. Yes, there’s the “fold in half” – but how <em>does that work</em>? The middle tine is clearly the reshape, and the right tine picks the first element, which makes sense, but what of the left tine?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">2</span><span class="na">@</span><span class="m">0</span> <span class="o">⊢</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span><span class="p">)</span> <span class="m">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2 4
</span></div></div>
</div>
<p>Wow. Did the penny drop? I think that qualifies as a code-golfer’s trick shot.</p>
<p>Other suggestions were:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">((</span><span class="o">⍋≢⍴</span><span class="p">(</span><span class="o">⍳</span><span class="m">.5</span><span class="o">×≢</span><span class="p">))</span><span class="o">⊃</span><span class="na">¨</span><span class="o">⊂</span><span class="p">)</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span> <span class="c1">⍝ Author: @Razetime -- no need for the length</span>
<span class="p">(</span><span class="o">⊢⌷</span><span class="na">⍨∘</span><span class="o">⊂</span><span class="na">∘</span><span class="o">⍋</span><span class="na">∘</span><span class="o">⍋</span><span class="m">2</span><span class="o">|⍳</span><span class="na">∘</span><span class="o">≢</span><span class="p">)</span>  <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">4</span> <span class="m">3</span> <span class="m">2</span> <span class="m">1</span> <span class="c1">⍝ Author: @rak1507  -- no need for the length</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4 2 3 3 2 4 1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4 2 3 3 2 4 1
</span></div></div>
</div>
<p>Feel free to untangle those at your leisure.</p>
</div>
</div>
<span id="document-find"></span><div class="tex2jax_ignore mathjax_ignore section" id="finding-things">
<h2>Finding things<a class="headerlink" href="#finding-things" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Computer languages of the future will be more concerned with goals and less with procedures specified by the programmer.
–<em>Marvin Minsky</em></p>
</div></blockquote>
<p>Just like with indexing, there seems to be a baffling array of ways to locate items in arrays in APL. As stated in <a class="reference external" href="https://zen-of-python.info/">The Zen of Python</a>:</p>
<blockquote>
<div><p>There should be one– and preferably only one –obvious way to do it.</p>
</div></blockquote>
<p>Aha. About that…</p>
<p><img alt="laugh" src="https://media.giphy.com/media/JmD9mkDmzvXE7nxy7j/giphy-downsized-medium.gif" /></p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<div class="section" id="equality">
<h3>Equality <code class="docutils literal notranslate"><span class="pre">=</span></code><a class="headerlink" href="#equality" title="Permalink to this headline">¶</a></h3>
<p>So how do you locate where an element resides in an array in APL? Well, the obvious way to do it is to exploit equality and scalar pervasion. Where is the number 2?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="o">↑</span><span class="p">(</span><span class="m">2</span><span class="o">=</span><span class="nv">data</span><span class="p">)(</span><span class="nv">data</span> <span class="kd">←</span> <span class="m">4</span> <span class="m">1</span> <span class="m">22</span> <span class="m">20</span> <span class="m">16</span> <span class="m">10</span> <span class="m">25</span> <span class="m">7</span> <span class="m">18</span> <span class="m">11</span> <span class="m">15</span> <span class="m">2</span> <span class="m">12</span> <span class="m">23</span> <span class="m">9</span> <span class="m">17</span> <span class="m">6</span> <span class="m">14</span> <span class="m">21</span> <span class="m">19</span> <span class="m">3</span> <span class="m">8</span> <span class="m">5</span> <span class="m">13</span> <span class="m">24</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→────────────────────────────────────────────────────────────────┐
↓0 0  0  0  0  0  0 0  0  0  0 1  0  0 0  0 0  0  0  0 0 0 0  0  0│
│4 1 22 20 16 10 25 7 18 11 15 2 12 23 9 17 6 14 21 19 3 8 5 13 24│
└~────────────────────────────────────────────────────────────────┘
</span></div></div>
</div>
<p>That’s surely sufficiently <em>Zen</em> in the <em>Zen of Python</em> sense. Hands up every item that equals 2. We can find out the actual index, too, by using <em>Iota underbar</em>, <code class="docutils literal notranslate"><span class="pre">⍸</span></code>, which, as you may recall from an <a class="reference internal" href="intro.html#document-manip"><span class="doc std std-doc">earlier chapter</span></a>, in its monadic form is appropriately enough called <a class="reference external" href="https://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Where.htm"><em>Where</em></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍸</span><span class="m">2</span><span class="o">=</span><span class="nv">data</span> <span class="c1">⍝ Where is data = 2?</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">11
</span></div></div>
</div>
<p>As we should expect by now, scalar pervasion lets scalar functions penetrate any level of nesting:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">nested</span> <span class="kd">←</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="p">(</span><span class="m">3</span> <span class="m">4</span> <span class="m">5</span><span class="p">))(</span><span class="m">4</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span><span class="p">(</span><span class="m">3</span> <span class="m">4</span><span class="p">)))</span>
<span class="m">4</span><span class="o">=</span><span class="nv">nested</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────┬─────────────┐
│┌─┬─┬─────┐│┌─┬─────────┐│
││1│2│3 4 5│││4│┌─┬─┬───┐││
│└─┴─┴─────┘││ ││1│2│3 4│││
│           ││ │└─┴─┴───┘││
│           │└─┴─────────┘│
└───────────┴─────────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────┬─────────────┐
│┌─┬─┬─────┐│┌─┬─────────┐│
││0│0│0 1 0│││1│┌─┬─┬───┐││
│└─┴─┴─────┘││ ││0│0│0 1│││
│           ││ │└─┴─┴───┘││
│           │└─┴─────────┘│
└───────────┴─────────────┘
</span></div></div>
</div>
</div>
<div class="section" id="match">
<h3>Match <code class="docutils literal notranslate"><span class="pre">≡</span></code><a class="headerlink" href="#match" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Where.htm"><em>Match</em></a> we’ve already met. It is like equality but for non-scalar things. You can be forgiven to think that if you look for a particular vector in a vector-of-vectors, you should be able to use equality, but that doesn’t work:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">strings</span> <span class="kd">←</span> <span class="s1">&#39;aaa&#39;</span> <span class="s1">&#39;bbb&#39;</span> <span class="s1">&#39;ccc&#39;</span> <span class="s1">&#39;ddd&#39;</span> <span class="s1">&#39;ccc&#39;</span> <span class="s1">&#39;aaa&#39;</span> <span class="s1">&#39;ccc&#39;</span> <span class="s1">&#39;bbb&#39;</span>
<span class="s1">&#39;ccc&#39;</span><span class="o">=</span><span class="nv">strings</span>  <span class="c1">⍝ LENGTH ERROR!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>LENGTH ERROR
      &#39;ccc&#39;=strings  ⍝ LENGTH ERROR!
           ∧
</pre></div>
</div>
</div>
</div>
<p>Instead we need either <em>Jot match each</em> (<code class="docutils literal notranslate"><span class="pre">∘≡¨</span></code>) or <em>Enclose match each</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍸</span><span class="s1">&#39;ccc&#39;</span><span class="na">∘</span><span class="o">≡</span><span class="na">¨</span><span class="nv">strings</span>
<span class="o">⍸</span><span class="p">(</span><span class="o">⊂</span><span class="s1">&#39;ccc&#39;</span><span class="p">)</span><span class="o">≡</span><span class="na">¨</span><span class="nv">strings</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2 4 6
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">2 4 6
</span></div></div>
</div>
</div>
<div class="section" id="index-of-ab">
<h3>Index of <code class="docutils literal notranslate"><span class="pre">A⍳B</span></code><a class="headerlink" href="#index-of-ab" title="Permalink to this headline">¶</a></h3>
<p>Another way we can find the index of things is via <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Index%20Of.htm"><em>Index of</em></a>, dyadic <code class="docutils literal notranslate"><span class="pre">⍳</span></code>, which we have actually met before:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span><span class="o">⍳</span><span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">11
</span></div></div>
</div>
<p>Dyadic <em>iota</em> finds the <em>first</em> index - or 1 plus the last index if not found. This has the nice feature that we can feed it an array to the right:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span><span class="o">⍳</span><span class="m">2</span> <span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">11 20
</span></div></div>
</div>
<p>…which, if we want to use equality requires a bit more dexterity – but this approach would also spot multiples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍸∨</span><span class="na">⌿</span><span class="m">2</span> <span class="m">3</span> <span class="na">∘.</span><span class="o">=</span> <span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">11 20
</span></div></div>
</div>
<p>What about if we crank the rank a bit?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">mat</span> <span class="kd">←</span> <span class="m">4</span> <span class="m">4</span><span class="o">⍴</span><span class="m">2</span> <span class="m">15</span> <span class="m">16</span> <span class="m">14</span> <span class="m">11</span> <span class="m">9</span> <span class="m">12</span> <span class="m">10</span> <span class="m">13</span> <span class="m">1</span> <span class="m">7</span> <span class="m">5</span> <span class="m">4</span> <span class="m">8</span> <span class="m">6</span> <span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> 2 15 16 14
11  9 12 10
13  1  7  5
 4  8  6  3
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">mask</span> <span class="kd">←</span> <span class="m">7</span><span class="o">=</span><span class="nv">mat</span>
<span class="o">⍸</span><span class="nv">mask</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0 0
0 0 0 0
0 0 1 0
0 0 0 0
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┐
│2 2│
└───┘
</span></div></div>
</div>
<p>Gotta love APL.</p>
</div>
<div class="section" id="find">
<h3>Find <code class="docutils literal notranslate"><span class="pre">⍷</span></code><a class="headerlink" href="#find" title="Permalink to this headline">¶</a></h3>
<p>There is of course also a glyph that’s called <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Find.htm"><em>Find</em></a> (<code class="docutils literal notranslate"><span class="pre">⍷</span></code>) which locates the start-points of subsequences:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;ana&#39;</span> <span class="o">⍷</span> <span class="s1">&#39;banana&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 0 1 0 0
</span></div></div>
</div>
<p>That combines nicely with <code class="docutils literal notranslate"><span class="pre">⍸</span></code> as a tacit atop to give a bit of an idiom to commit to memory:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">substr</span> <span class="kd">←</span> <span class="o">⍸⍷</span>
<span class="s1">&#39;ana&#39;</span> <span class="nv">substr</span> <span class="s1">&#39;banana&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 3
</span></div></div>
</div>
<p>We can use find to locate arrays-in-arrays of higher ranks, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">needle</span> <span class="kd">←</span> <span class="m">2</span> <span class="m">2</span><span class="o">⍴</span><span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">DISPLAY</span> <span class="nv">haystack</span> <span class="kd">←</span> <span class="m">4</span> <span class="m">4</span><span class="o">⍴</span><span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──┐
↓0 1│
│1 0│
└~──┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→──────┐
↓0 1 0 0│
│1 0 0 1│
│0 0 1 0│
│0 1 0 0│
└~──────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">needle</span> <span class="o">⍷</span> <span class="nv">haystack</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 0 0 0
0 0 1 0
0 1 0 0
0 0 0 0
</span></div></div>
</div>
<p>The 1s represent the top-left corners of the ‘needle’ array in ‘haystack’:</p>
<p><img alt="find1" src="_images/find1.png" /></p>
<p>and we can pick out the actual coordinates using the same idiom we used for <code class="docutils literal notranslate"><span class="pre">substring</span></code> above:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">needle</span> <span class="p">(</span><span class="o">⍸⍷</span><span class="p">)</span> <span class="nv">haystack</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬───┐
│0 0│1 2│2 1│
└───┴───┴───┘
</span></div></div>
</div>
</div>
<div class="section" id="regular-expessions">
<h3>Regular expessions<a class="headerlink" href="#regular-expessions" title="Permalink to this headline">¶</a></h3>
<p>Dyalog supports regular expressions through the most excellent <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Appendices/PCRE%20Regular%20Expression%20Details.htm">PCRE</a> engine. Dyalog’s docs on the topic can be found <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/r.htm">here</a>, and an APL Orchard cultivation was dedicated to the <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-24-r-and-s">topic</a>, too. How regexes themselves work is beyond the scope of this book, but an exceptional reference that belongs on every programmer’s bookshelf is Jeffrey Friedl’s <a class="reference external" href="http://regex.info/book.html">Mastering Regular Expressions</a>.</p>
<p>Let’s take a brief look at how regexes are integrated in Dyalog.</p>
<p>Two system operators, <code class="docutils literal notranslate"><span class="pre">⎕S</span></code> and <code class="docutils literal notranslate"><span class="pre">⎕R</span></code>, implement regex search and replace respectively. They’re both dyadic operators, taking regular expression(s) to the left and transformation(s) to the right. The derived function can be applied to text data.</p>
<p>Here’s a simple example. Using a transformation string of <code class="docutils literal notranslate"><span class="pre">&amp;</span></code>, <code class="docutils literal notranslate"><span class="pre">⎕S</span></code> returns a vector of what was matched:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;ll.\sw&#39;</span><span class="nf">⎕S</span><span class="s1">&#39;&amp;&#39;</span> <span class="o">⊢</span> <span class="s1">&#39;hello world well  worn&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┐
│llo w│ll  w│
└─────┴─────┘
</span></div></div>
</div>
<p>The left operand can be a nested vector of regexes:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;he&#39;</span> <span class="s1">&#39;wo&#39;</span> <span class="s1">&#39;ll&#39;</span><span class="nf">⎕S</span><span class="s1">&#39;&amp;&#39;</span> <span class="o">⊢</span> <span class="s1">&#39;hello world well  worn&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬──┬──┬──┬──┐
│he│ll│wo│ll│wo│
└──┴──┴──┴──┴──┘
</span></div></div>
</div>
<p>The right operand can be a function, too. This is where it gets a bit <s>hairy</s> flexible. We could have written the above as:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;he&#39;</span> <span class="s1">&#39;wo&#39;</span> <span class="s1">&#39;ll&#39;</span><span class="nf">⎕S</span><span class="kt">{</span><span class="bp">⍵</span><span class="na">.</span><span class="nv">Match</span><span class="kt">}</span><span class="s1">&#39;hello world well  worn&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬──┬──┬──┬──┐
│he│ll│wo│ll│wo│
└──┴──┴──┴──┴──┘
</span></div></div>
</div>
<p>In other words, the right operand function gets passed a <em>namespace</em> representing the match at that point. In this case, the <code class="docutils literal notranslate"><span class="pre">⍵.Match</span></code> holds “what the current regex matched” - the same as the magic transformation short-hand <code class="docutils literal notranslate"><span class="pre">'&amp;'</span></code>.</p>
<p>For capture groups, we have numbered references <code class="docutils literal notranslate"><span class="pre">'\1',</span> <span class="pre">'\2'</span></code> etc, as per Perl:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;(a{2,}|b{2,})&#39;</span><span class="nf">⎕S</span><span class="s1">&#39;\1&#39;</span> <span class="o">⊢</span><span class="s1">&#39;aaabababbbbbaaaa&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─────┬────┐
│aaa│bbbbb│aaaa│
└───┴─────┴────┘
</span></div></div>
</div>
<p>When using a function operand, we have the opportunity to apply the full might of APL to the matches. Let’s find stretches of 2 or longer of <code class="docutils literal notranslate"><span class="pre">a</span></code> or <code class="docutils literal notranslate"><span class="pre">b</span></code>, and turn them to upper-case (using <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/c.htm"><em>Case convert</em>, <code class="docutils literal notranslate"><span class="pre">⎕C</span></code></a>):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;(a{2,}|b{2,})&#39;</span><span class="nf">⎕S</span><span class="kt">{</span><span class="m">1</span><span class="nf">⎕C</span> <span class="bp">⍵</span><span class="na">.</span><span class="nv">Match</span><span class="kt">}</span><span class="s1">&#39;aaabababbbbbaaaa&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─────┬────┐
│AAA│BBBBB│AAAA│
└───┴─────┴────┘
</span></div></div>
</div>
<p>The regex replacement operator, <code class="docutils literal notranslate"><span class="pre">⎕R</span></code>, operates much in the same way, but here the right operand represents a substitution into the right argument:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;a(.)a&#39;</span><span class="nf">⎕R</span><span class="s1">&#39;A\1A&#39;</span><span class="o">⊢</span><span class="s1">&#39;abababadabaaba&#39;</span> <span class="c1">⍝ \1 is the first capture group</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">AbAbAbAdAbAAbA
</span></div></div>
</div>
<p>A handy trick is to split strings based on a regular expression, removing the separators in the process. This is tricker than you might guess in Dyalog. Here’s what <a class="reference external" href="https://aplcart.info/?q=regex%20split">APL Cart</a> suggests:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">rsplit</span> <span class="kd">←</span> <span class="kt">{</span><span class="p">(</span><span class="o">⊢</span><span class="na">/¨</span><span class="nv">r</span><span class="p">)</span><span class="o">↓</span><span class="na">¨</span><span class="bp">⍵</span><span class="o">⊂</span><span class="na">⍨</span><span class="p">(</span><span class="o">⍳≢</span><span class="bp">⍵</span><span class="p">)</span><span class="o">∊</span><span class="m">1</span><span class="o">+⊃</span><span class="na">¨</span><span class="nv">r</span><span class="kd">←</span><span class="p">(</span><span class="bp">⍺</span><span class="o">,</span><span class="s1">&#39;|^&#39;</span><span class="p">)</span><span class="nf">⎕S</span> <span class="m">0</span> <span class="m">1</span><span class="o">⊢</span><span class="bp">⍵</span><span class="kt">}</span> <span class="c1">⍝ APL Cart</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;\d+&#39;</span> <span class="nv">rsplit</span> <span class="s1">&#39;aaaa6666bbb1cccc999eee87&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬───┬────┬───┬┐
│aaa6│bb1│ccc9│ee8││
└────┴───┴────┴───┴┘
</span></div></div>
</div>
<p>Note the empty segment at the end.</p>
<div class="section" id="overlapping-matches">
<h4>Overlapping matches<a class="headerlink" href="#overlapping-matches" title="Permalink to this headline">¶</a></h4>
<p>In normal operations, a regex “consumes” what it matches, and any susbequent matches will start where the previous one ended. For example, if we want to capture pairs of letters starting with an <code class="docutils literal notranslate"><span class="pre">a</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;a.&#39;</span><span class="nf">⎕S</span><span class="s1">&#39;&amp;&#39;</span><span class="o">⊢</span><span class="s1">&#39;abaac&#39;</span> <span class="c1">⍝ Won&#39;t return ab aa ac</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬──┐
│ab│aa│
└──┴──┘
</span></div></div>
</div>
<p>which won’t capture the last pair <code class="docutils literal notranslate"><span class="pre">ac</span></code> as it overlaps with the previous match <code class="docutils literal notranslate"><span class="pre">aa</span></code>. If we want to capture potentially overlapping matches, we have two options. Option 1 is the time-honoured technique borrowed from Perl, using a capture group inside a <a class="reference external" href="https://www.regular-expressions.info/lookaround.html"><em>zero-width lookahead assertion</em></a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;(?=(a.))&#39;</span><span class="nf">⎕S</span><span class="s1">&#39;\1&#39;</span><span class="o">⊢</span><span class="s1">&#39;abaac&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬──┬──┐
│ab│aa│ac│
└──┴──┴──┘
</span></div></div>
</div>
<p>Zero-width lookaheads (and lookbehinds) work just like normal patterns, except that they don’t <em>consume</em> what they match.</p>
<p>Option 2 is to tell the regex engine that we want to allow overlapping matches via a <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Operators/Variant.htm"><em>Variant</em></a> (<code class="docutils literal notranslate"><span class="pre">⍠</span></code>) setting to <code class="docutils literal notranslate"><span class="pre">⎕S</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;a.&#39;</span><span class="nf">⎕S</span><span class="s1">&#39;&amp;&#39;</span><span class="na">⍠</span><span class="s1">&#39;OM&#39;</span><span class="m">1</span><span class="o">⊢</span><span class="s1">&#39;abaac&#39;</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬──┬──┐
│ab│aa│ac│
└──┴──┴──┘
</span></div></div>
</div>
<p>This is both elegant and clear: variant <code class="docutils literal notranslate"><span class="pre">OM</span></code> is <em>Overlapping Matches</em>. See the <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/r.htm">docs</a> for more details on the various options that can be enabled with <em>Variant</em>.</p>
</div>
</div>
</div>
<span id="document-cookbook1"></span><div class="tex2jax_ignore mathjax_ignore section" id="partitions">
<h2>Partitions<a class="headerlink" href="#partitions" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>It’s harder to read code than to write it. –<em>Joel Spolsky</em></p>
</div></blockquote>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div></div>
</div>
<p>We often need to group or select items in an array based on some criterion – perhaps stretches of items that are equal, or perhaps we have a boolean mask indicating which stretches of elements should be joined up.</p>
<p>Other resources:</p>
<ul class="simple">
<li><p>Dyalog docs <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Partition.htm">Partition</a>, <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Partitioned%20Enclose.htm">Partitioned enclose</a></p></li>
<li><p><a class="reference external" href="https://aplwiki.com/wiki/Partition_representations">APLWiki</a></p></li>
<li><p>Cultivations <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-7-apl-functions-">Lesson 7</a>, <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-49-extensions-in-18-0--1-json">Lesson 49</a></p></li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>This is a feature that different APL dialects treat differently. Dyalog’s <code class="docutils literal notranslate"><span class="pre">⎕ML</span></code> setting allows a degree of conformity if you need it: if <code class="docutils literal notranslate"><span class="pre">⎕ML≥3</span></code>, the symbol <code class="docutils literal notranslate"><span class="pre">⊂</span></code> means the same as <code class="docutils literal notranslate"><span class="pre">⊆</span></code>. We’ll use the default Dyalog approach throughout.</p>
</div>
<div class="section" id="partition">
<h3>Partition <code class="docutils literal notranslate"><span class="pre">⊆</span></code><a class="headerlink" href="#partition" title="Permalink to this headline">¶</a></h3>
<p>The glyph <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Partition.htm"><em>Partition</em></a>, <code class="docutils literal notranslate"><span class="pre">⊆</span></code>, selects groups elements based on a vector where new selections are started where the corresponding element is larger than its predecessor. In its simplest form it’s like <em>Compress</em>, but enclosing elements corresponding to stretches of 1s. Compare:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span><span class="o">⊆⍳</span><span class="m">12</span> <span class="c1">⍝ Partition</span>
<span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span><span class="na">/</span><span class="o">⍳</span><span class="m">12</span> <span class="c1">⍝ Compress</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─┬────┬──┐
│1 2│4│9 10│12│
└───┴─┴────┴──┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 4 9 10 12
</span></div></div>
</div>
<p>This can be supremely handy: apply some predicate to an array to give a boolean vector. Use enclose to get the matching elements, grouped. As we noted above, the left argument array doesn’t have to be Boolean, just integer. That gives us a bit more flexibility in our mapping.</p>
</div>
<div class="section" id="partitioned-enclose-ab">
<h3>Partitioned enclose <code class="docutils literal notranslate"><span class="pre">A⊂B</span></code><a class="headerlink" href="#partitioned-enclose-ab" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Primitive%20Functions/Partitioned%20Enclose.htm"><em>Partitioned enclose</em></a>, <code class="docutils literal notranslate"><span class="pre">A⊂B</span></code>, groups items based on a Boolean mask where enclosures start on 1. For example:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span><span class="o">⊂⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬───┬───┬────┐
│1 2│3 4│5 6│7 8│9 10│
└───┴───┴───┴───┴────┘
</span></div></div>
</div>
<p>We can use this to group stretches of elements which are equal:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⊂</span><span class="na">⍨</span><span class="m">1</span><span class="o">,</span><span class="m">2</span><span class="o">≠</span><span class="na">/</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">2</span> <span class="m">1</span> <span class="m">4</span> <span class="m">4</span> <span class="m">4</span> <span class="m">4</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────┬───┬─┬───────┬───┬───┐
│1 1 1 1 1│2 2│1│4 4 4 4│1 1│2 2│
└─────────┴───┴─┴───────┴───┴───┘
</span></div></div>
</div>
<p>We can apply the same technique to group based on sign:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⊂</span><span class="na">⍨</span><span class="m">1</span><span class="o">,</span><span class="m">2</span><span class="o">≠</span><span class="na">/</span><span class="o">×</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">0</span> <span class="m">¯1</span> <span class="m">¯7</span> <span class="m">¯8</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─────┬─┬────────┬───┬─────┐
│0 0│1 2 3│0│¯1 ¯7 ¯8│0 0│1 2 3│
└───┴─────┴─┴────────┴───┴─────┘
</span></div></div>
</div>
<p>In the above two examples we generate the mask by a windowed reduction of size 2:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="m">2</span><span class="o">≠</span><span class="na">/</span><span class="o">×</span><span class="bp">⍵</span><span class="kt">}</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">0</span> <span class="m">¯1</span> <span class="m">¯7</span> <span class="m">¯8</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 0 0 1 1 0 0 1 0 1 0 0
</span></div></div>
</div>
<p>but we also need to prepend a 1, as we want the first partition to start at the beginning.</p>
<p>Note that the left argument doesn’t have to be the same length as the right. If it’s shorter, it will be padded with zeros, allowing us a convenient way to chop a vector into a head and tail:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span><span class="o">⊂⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬──────────────────┐
│1│2 3 4 5 6 7 8 9 10│
└─┴──────────────────┘
</span></div></div>
</div>
</div>
<div class="section" id="non-boolean-left">
<h3>Non-boolean left <code class="docutils literal notranslate"><span class="pre">⊂</span></code><a class="headerlink" href="#non-boolean-left" title="Permalink to this headline">¶</a></h3>
<p>From v18 of Dyalog, the left argument is no longer restricted to a Boolean array, which allows us to generate empty partitions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">2</span> <span class="m">0</span> <span class="m">0</span> <span class="m">3</span> <span class="m">0</span> <span class="m">1</span> <span class="o">⊂</span> <span class="o">⍳</span><span class="m">20</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬┬─────┬┬┬───┬──────────────────────────────────┐
│1 2 3││4 5 6│││7 8│9 10 11 12 13 14 15 16 17 18 19 20│
└─────┴┴─────┴┴┴───┴──────────────────────────────────┘
</span></div></div>
</div>
<p>We can think of each number as specifying how many partitions beyond its neighbor to the left it is. So 0 means same partition, 1 means new partition, 2 means “skip one”, 3 means “skip two” etc.</p>
</div>
</div>
<span id="document-errors"></span><div class="tex2jax_ignore mathjax_ignore section" id="error-handling">
<h2>Error handling<a class="headerlink" href="#error-handling" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Controlling complexity is the essence of computer programming. –<em>Brian Kernighan</em></p>
</div></blockquote>
<p>Other resources on the topic:</p>
<ul class="simple">
<li><p>Dyalog docs: <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Defined%20Functions%20and%20Operators/DynamicFunctions/Error%20Guards.htm">Error guards</a>, <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Errors/APL%20Errors.htm">Error codes</a>, <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/signal.htm">Signal event</a></p></li>
<li><p>Dyalog webinars: <a class="reference external" href="https://dyalog.tv/Webinar/?v=tDK0AKXXRAk">Part 1</a>, <a class="reference external" href="https://dyalog.tv/Webinar/?v=PSrXyk5tN6o">Part 2</a>, <a class="reference external" href="https://dyalog.tv/Webinar/?v=jkD-iQfjo_Q">Part 3</a>, <a class="reference external" href="https://dyalog.tv/Webinar/?v=G7Ht8iKvDMo">Part 4</a></p></li>
</ul>
<p>By now you will have encountered a range of errors where Dyalog takes objection to something you wrote, like for example</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">vec</span> <span class="kd">←</span> <span class="o">⍳</span><span class="m">10</span>
<span class="m">50</span><span class="o">⊃</span><span class="nv">vec</span>      <span class="c1">⍝ INDEX ERROR</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>INDEX ERROR
      50⊃vec      ⍝ INDEX ERROR
        ∧
</pre></div>
</div>
</div>
</div>
<p>If you’re used to a Java or Python stack trace, the errors thrown by Dyalog will appear spartan, but after a bit of experience, they’re actually <em>blissfully</em> spartan, not unlike APL itself. As an aside, the K language is even more brutal in its simplicity here.</p>
<p>So how do you deal with errors? There is no <code class="docutils literal notranslate"><span class="pre">try-catch-throw</span></code> exception mechanism to draw on. What we have instead is the concept of an <em>error guard</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">pick50</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="m">3</span><span class="bp">::</span><span class="s1">&#39;out of range&#39;</span> <span class="c1">⍝ Error guard, catching INDEX ERROR</span>
    <span class="m">50</span><span class="o">⊃</span><span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">pick50</span> <span class="o">⍳</span><span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">out of range
</span></div></div>
</div>
<p>An error guard takes an array of error numbers to the left, and an expression to be returned to the right, separated by two colons. Simple, right? Wrong.</p>
<p>Here’s a rather contrived function that prepends a 1 to its left argument and then multiplies it with the inverse of its right argument. We want to protect against division by zero, in which case we just want to return the 1 prepended to the left argument, like so:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">f</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">nums</span><span class="kd">←</span><span class="m">1</span> <span class="bp">⍺</span>
    <span class="m">0</span><span class="o">=</span><span class="bp">⍵:</span><span class="nv">nums</span>
    <span class="nv">nums</span><span class="o">×÷</span><span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">4</span> <span class="nv">f</span> <span class="m">0</span>
<span class="m">4</span> <span class="nv">f</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0.5 2
</span></div></div>
</div>
<p>This seems like a job for an error guard. Division by zero in this case will throw a <code class="docutils literal notranslate"><span class="pre">DOMAIN</span> <span class="pre">ERROR</span></code>, which has a code of 11.</p>
<p>Try to predict what happens before revealing the actual result:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">fbug</span> <span class="kd">←</span> <span class="kt">{</span> <span class="c1">⍝ Can you spot the bug?</span>
    <span class="m">11</span><span class="bp">::</span><span class="nv">nums</span>
    <span class="nv">nums</span><span class="kd">←</span><span class="m">1</span> <span class="bp">⍺</span>
    <span class="nv">nums</span><span class="o">×÷</span><span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">4</span> <span class="nv">fbug</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>VALUE ERROR: Undefined name: nums
fbug[1] 11::nums
            ∧
</pre></div>
</div>
</div>
</div>
<p>What happens is that the local environment is unwound <em>before</em> the error-guard’s body is evaluated. To get the behavior we wanted we’d need to do this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">fnew</span> <span class="kd">←</span> <span class="kt">{</span> <span class="c1">⍝ Now correct</span>
    <span class="nv">nums</span><span class="kd">←</span><span class="m">1</span> <span class="bp">⍺</span>
    <span class="m">11</span><span class="bp">::</span><span class="nv">nums</span>
    <span class="nv">nums</span><span class="o">×÷</span><span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">4</span> <span class="nv">fnew</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 4
</span></div></div>
</div>
<p>The other subtlety is that following the <em>setting</em> of an error guard, subsequent calls disable tail-call optimization:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">g</span> <span class="kd">←</span> <span class="kt">{</span> 
    <span class="m">3</span><span class="bp">::</span><span class="s1">&#39;out of range&#39;</span> <span class="c1">⍝ Error guard, catching INDEX ERROR</span>
    <span class="nv">h</span> <span class="bp">⍺</span><span class="o">⊃</span><span class="bp">⍵</span> <span class="c1">⍝ No longer a tail call, due to presense of error guard</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>This can be worked around by localizing the error guard in its own dfn:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">g</span> <span class="kd">←</span> <span class="kt">{</span> 
    <span class="nv">val</span> <span class="kd">←</span> <span class="bp">⍺</span> <span class="kt">{</span><span class="m">3</span><span class="bp">::</span><span class="s1">&#39;out of range&#39;</span> <span class="p">⋄</span> <span class="bp">⍺</span><span class="o">⊃</span><span class="bp">⍵</span><span class="kt">}</span> <span class="bp">⍵</span>
    <span class="nv">h</span> <span class="nv">val</span> <span class="c1">⍝ Tail call</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>The mapping of numeric error code to error message can be found in Dyalog’s documentation, referenced above, or via the system function <code class="docutils literal notranslate"><span class="pre">⎕EM</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕EM</span><span class="o">⍳</span><span class="m">10</span> <span class="c1">⍝ ...and the rest</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────┬────────────┬───────────┬──────────┬────────────┬───────────┬────────────┬───────┬───────┬───────────┐
│WS FULL│SYNTAX ERROR│INDEX ERROR│RANK ERROR│LENGTH ERROR│VALUE ERROR│FORMAT ERROR│ERROR 8│ERROR 9│LIMIT ERROR│
└───────┴────────────┴───────────┴──────────┴────────────┴───────────┴────────────┴───────┴───────┴───────────┘
</span></div></div>
</div>
<p>Error guards can also be stacked if you want to take different actions for different kinds of errors:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">g</span> <span class="kd">←</span> <span class="kt">{</span> 
    <span class="m">3</span><span class="bp">::</span><span class="s1">&#39;handle index error&#39;</span>
    <span class="m">4</span><span class="bp">::</span><span class="s1">&#39;handle rank error&#39;</span>
    <span class="m">11</span><span class="bp">::</span><span class="s1">&#39;handle domain error&#39;</span>
    <span class="c1">⍝ error-prone function body here</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>or if you want a catch-all for the errors you think you might encounter, the guard takes a vector to the left:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">g</span> <span class="kd">←</span> <span class="kt">{</span> 
    <span class="m">3</span> <span class="m">4</span> <span class="m">11</span><span class="bp">::</span><span class="s1">&#39;it all went pear-shaped in some way&#39;</span>
    <span class="c1">⍝ error-prone function body here</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>You can also (sort of) throw “exceptions”. You may have noticed the definition for <code class="docutils literal notranslate"><span class="pre">assert</span></code> I’ve used here and there already:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">assert</span> <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍺</span><span class="kd">←</span><span class="s1">&#39;assertion failure&#39;</span> <span class="p">⋄</span> <span class="m">0</span><span class="o">∊</span><span class="bp">⍵:⍺</span> <span class="nf">⎕SIGNAL</span> <span class="m">8</span> <span class="p">⋄</span> <span class="nv">shy</span><span class="kd">←</span><span class="m">0</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">assert</span> <span class="m">0</span><span class="o">=</span><span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>assertion failure
      assert 0=1
      ∧
</pre></div>
</div>
</div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">⎕SIGNAL</span></code> ambivalent system function <em>throws</em> an error of the number given by its right argument, presenting as the corresponding message from the vector given by <code class="docutils literal notranslate"><span class="pre">⎕EM</span></code> if no left argument is given, or by the left argument if given, as is the case in the <code class="docutils literal notranslate"><span class="pre">assert</span></code> function above. In other words, we could for example claim that the “workspace is full” by throwing error 1, somewhat duplicitously:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕SIGNAL</span> <span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>WS FULL
      ⎕SIGNAL 1
      ∧
</pre></div>
</div>
</div>
</div>
<p>In the <code class="docutils literal notranslate"><span class="pre">assert</span></code> function we make use of an error code that isn’t used by Dyalog normally, error 8:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕SIGNAL</span> <span class="m">8</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output stderr highlight-myst-ansi notranslate"><div class="highlight"><pre><span></span>ERROR 8
      ⎕SIGNAL 8
      ∧
</pre></div>
</div>
</div>
</div>
</div>
<span id="document-aplway"></span><div class="tex2jax_ignore mathjax_ignore section" id="the-apl-way">
<h2>The APL Way<a class="headerlink" href="#the-apl-way" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Every reader should ask himself periodically “Toward what end, toward what end?”—but do not ask it too often lest you pass up the fun of programming for the constipation of bittersweet philosophy. –<em>Alan Perlis</em></p>
</div></blockquote>
<p>Up until now, we’ve skirted around one of the main advantages of APL – array-oriented, or <em>data-parallel</em> programming. This feels awkward and unnatural at first, but finding data-parallel approaches to problems is a skill that makes for efficient solutions in other languages, too, not just APL, and libraries such as Python’s <a class="reference external" href="https://numpy.org/">NumPy</a> encourages such solutions (it was inspired by APL, by the way).</p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>In this chapter, we’ll be making some comparisons between data-parallel APL and “loop &amp; branch” implementations in Python. We chose Python because its syntax is clean and understandable by a large proportion of programmers from other languages, too. In case it’s not immediately obvious, no effort has been made to find optimal Python solutions here; indeed, quite the opposite. View the Python examples as pseudocode illustrations of the algorithms, and yes, we’re fully aware that one can string together elegant, efficient Python solutions using iterator algebra and comprehensions.</p>
</div>
<p>A few pointers – Richard Park gave a series of webinars on <a class="reference external" href="https://dyalog.tv/Webinar/?v=myoK22rq1jk">Thinking in APL</a> that you should check out, and Adám Brudzewski gave several interactive Cultivations dedicated to the topic, <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-39-array-programming-techniques">Lesson 39 - Array programming techniques</a> and <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-42-array-coding-style-in-depth">Lesson 42 - Array coding style in depth</a>, too.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span> <span class="o">-</span><span class="nv">s</span><span class="o">=</span><span class="nv">min</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
<span class="nv">assert</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍺</span><span class="kd">←</span><span class="s1">&#39;assertion failure&#39;</span> <span class="p">⋄</span> <span class="m">0</span><span class="o">∊</span><span class="bp">⍵:⍺</span> <span class="nf">⎕signal</span> <span class="m">8</span> <span class="p">⋄</span> <span class="nv">shy</span><span class="kd">←</span><span class="m">0</span><span class="kt">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON -style=min
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<div class="section" id="the-power-of-the-array">
<h3>The power of the Array<a class="headerlink" href="#the-power-of-the-array" title="Permalink to this headline">¶</a></h3>
<p>Several factors super-charge array-oriented programming in APL:</p>
<ol class="simple">
<li><p>Many operations on non-nested arrays are fast; <em>really</em> fast, taking advantage of data parallelism in the processor (SIMD).</p></li>
<li><p>By operating on whole arrays, we can – with a bit of practice – avoid branches, thus avoiding processor branch-prediction misses.</p></li>
<li><p>Arrays in APL are implemented frugally when it comes to memory, especially Boolean arrays.</p></li>
</ol>
<p>The helicopter pitch for the simplest case might go something like this. Here’s a naive “loop and branch” way to pick all elements matching some predicate in Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">select</span><span class="p">(</span><span class="n">f</span><span class="p">,</span> <span class="n">array</span><span class="p">):</span> 
    <span class="sd">&quot;&quot;&quot;Loop &amp; branch&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">element</span> <span class="ow">in</span> <span class="n">array</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">f</span><span class="p">(</span><span class="n">element</span><span class="p">):</span>
            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">element</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span>
</pre></div>
</div>
<p>and here’s a data-parallel version:</p>
<div class="highlight-apl notranslate"><div class="highlight"><pre><span></span><span class="nv">elems</span> <span class="kd">←</span> <span class="nv">f</span> <span class="nv">array</span> <span class="c1">⍝ Boolean mask</span>
<span class="nv">elems</span><span class="na">/</span><span class="nv">array</span>     <span class="c1">⍝ Compress; i.e. pick elemets at 1s</span>
</pre></div>
</div>
<p>Let’s say we want to find the odd numbers in a sequence:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">where</span> <span class="kd">←</span> <span class="m">2</span><span class="o">|</span><span class="nv">data</span> <span class="kd">←</span> <span class="o">⍳</span><span class="m">20</span> <span class="c1">⍝ mod-2 for the whole array at once</span>
<span class="nv">where</span><span class="na">/</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 3 5 7 9 11 13 15 17 19
</span></div></div>
</div>
<p>In the APL version, there is no loop, and no branch. The data is simple, and most likely allocated contiguously, and the CPU will be able to process several items in parallel for every cycle without any branch-prediction misses. Of course, with only 20 elements, algorithmic performance is a largely academic concern.</p>
<p>We can think of many problems that can be solved using the pattern of a scalar selection function applied to an array. One example, given by Richard Park in his webinar mentioned above, is to pick out all vowels from a string:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;aeiou&#39;</span> <span class="kt">{</span><span class="p">(</span><span class="bp">⍵</span><span class="o">∊</span><span class="bp">⍺</span><span class="p">)</span><span class="na">/</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;pick out all vowels from a string&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">iouaoeoai
</span></div></div>
</div>
<p>…or for train spotters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;aeiou&#39;</span> <span class="p">(</span><span class="o">∊</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">⍤/</span><span class="o">⊢</span><span class="p">)</span> <span class="s1">&#39;pick out all vowels from a string&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">iouaoeoai
</span></div></div>
</div>
<p>It’s the same idea as the ‘odd numbers’ above: create a Boolean mask using set membership (dyadic <code class="docutils literal notranslate"><span class="pre">∊</span></code>) and compress.</p>
<p>As an aside, and for the avoidance of any doubt, the <em>actual</em> APL way would be to just intersect the string with the vowels:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;aeiou&#39;</span> <span class="o">∩</span><span class="na">⍨</span> <span class="s1">&#39;pick out all vowels from a string&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">iouaoeoai
</span></div></div>
</div>
<p>Shorter, faster, array-ier, nicer – but not the point we wanted to make.</p>
</div>
<div class="section" id="luhn-s-algorithm">
<h3>Luhn’s Algorithm<a class="headerlink" href="#luhn-s-algorithm" title="Permalink to this headline">¶</a></h3>
<p>For something meatier, let’s look at implementing <a class="reference external" href="https://en.wikipedia.org/wiki/Luhn_algorithm">Luhn’s</a> algorithm, an error-detecting code used for validating credit card numbers. This was used to illustrate array-oriented concepts by Dyalog CTO, <a class="reference external" href="https://aplwiki.com/wiki/Morten_Kromberg">Morten Kromberg</a>, at a <a class="reference external" href="https://jiotalks.com/watch/204/home/Morten_Kromberg_&amp;_Aaron_Hsu/Pragmatic_Array_Oriented_Functional_Programming">presentation</a> given at JIO. We’ll follow Morten’s clear explanation of this algorithm:</p>
<ol>
<li><p>Split the credit card number into a <em>body</em> and the last digit, a <em>checksum</em></p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Card number: 7 9 9 2 7 3 9 8 7 1 3
Body:        7 9 9 2 7 3 9 8 7 1    Checksum: 3
</pre></div>
</div>
</li>
<li><p>Multiply every other digit in the body by 2, starting from the last digit with a 2</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Body:        7  9 9 2 7 3 9  8 7 1
Weights:     1  2 1 2 1 2 1  2 1 2
           ×______________________
Products:    7 18 9 4 7 6 9 16 7 2
</pre></div>
</div>
</li>
<li><p>Separate any numbers greater than 9 into their individual digits, and sum columns</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Tens:        0 1 0 0 0 0 0 1 0 0
Units:       7 8 9 4 7 6 9 6 7 2
           +____________________
Sum:         7 9 9 4 7 6 9 7 7 2
</pre></div>
</div>
</li>
<li><p>Sum the sums</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Sum:         7+9+9+4+7+6+9+7+7+2 = 67
</pre></div>
</div>
</li>
<li><p>Sum the <em>digits</em> of this, modulo 10:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Result:      (6+7)%10 = 3
</pre></div>
</div>
</li>
</ol>
<p>If the result equals the checksum, the card number is valid.</p>
<p>Here’s one way this could be implemented in Python:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="k">def</span> <span class="nf">luhn</span><span class="p">(</span><span class="n">cardnum</span><span class="p">):</span>
    <span class="n">checksum</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">parity</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">cardnum</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span>
    <span class="k">for</span> <span class="n">index</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">cardnum</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">):</span>
        <span class="n">digit</span> <span class="o">=</span> <span class="n">cardnum</span><span class="p">[</span><span class="n">index</span><span class="p">]</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">index</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">%</span> <span class="mi">2</span> <span class="o">!=</span> <span class="n">parity</span><span class="p">:</span>
            <span class="n">digit</span> <span class="o">*=</span> <span class="mi">2</span>
            <span class="k">if</span> <span class="n">digit</span> <span class="o">&gt;</span> <span class="mi">9</span><span class="p">:</span>
                <span class="n">digit</span> <span class="o">-=</span> <span class="mi">9</span>
        <span class="n">checksum</span> <span class="o">+=</span> <span class="n">digit</span>

    <span class="k">return</span> <span class="n">checksum</span> <span class="o">%</span> <span class="mi">10</span> <span class="o">==</span> <span class="mi">0</span>
</pre></div>
</div>
<p>It may or may not be clear that the Python implementation follows the algorithm description. We step through the card number backwards making it easier to ensure that we get the factors right, regardless of the number of digits.</p>
<p>Now let’s implement this in APL. We can follow the algorithm description very closely.</p>
<p><strong>1: Split the credit card number into a <em>body</em> and the last digit, a <em>checksum</em></strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">card</span> <span class="kd">←</span> <span class="m">7</span> <span class="m">9</span> <span class="m">9</span> <span class="m">2</span> <span class="m">7</span> <span class="m">3</span> <span class="m">9</span> <span class="m">8</span> <span class="m">7</span> <span class="m">1</span> <span class="m">3</span>

<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">body</span> <span class="kd">←</span> <span class="p">(</span><span class="nv">count</span><span class="kd">←</span><span class="m">¯1</span><span class="o">+≢</span><span class="nv">card</span><span class="p">)</span><span class="o">↑</span><span class="nv">card</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">check</span> <span class="kd">←</span> <span class="o">⊢</span><span class="na">/</span><span class="nv">card</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">7 9 9 2 7 3 9 8 7 1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div></div>
</div>
<p><strong>2: Multiply every other digit in the body by 2, starting from the last digit with a 2</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">weights</span> <span class="kd">←</span> <span class="nv">count</span><span class="o">⍴</span><span class="p">(</span><span class="m">2</span><span class="o">|</span><span class="nv">count</span><span class="p">)</span><span class="o">⌽</span><span class="m">1</span> <span class="m">2</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">products</span> <span class="kd">←</span> <span class="nv">body</span><span class="o">×</span><span class="nv">weights</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 1 2 1 2 1 2 1 2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">7 18 9 4 7 6 9 16 7 2
</span></div></div>
</div>
<p><strong>3, 4. Separate any numbers greater than 9 into their individual digits, and sum</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">digits</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">10</span><span class="o">⊤</span><span class="nv">products</span> <span class="c1">⍝ We can think of `0 10⊤` as divmod</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">sum</span> <span class="kd">←</span> <span class="o">+</span><span class="na">⌿</span><span class="o">,</span><span class="nv">digits</span>        <span class="c1">⍝ By raveling, we save doing sum the sum of cols</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 0 0 0 0 0 1 0 0
7 8 9 4 7 6 9 6 7 2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">67
</span></div></div>
</div>
<p><strong>5. Digit sum, mod 10</strong></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">10</span><span class="o">|-</span><span class="nv">sum</span> <span class="c1">⍝ Magic</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3
</span></div></div>
</div>
<p>If we put all that together, we arrive at Morten’s solution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">luhn</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">check</span> <span class="kd">←</span> <span class="o">⊢</span><span class="na">/</span><span class="bp">⍵</span>
    <span class="nv">body</span> <span class="kd">←</span> <span class="p">(</span><span class="nv">count</span><span class="kd">←</span><span class="m">¯1</span><span class="o">+≢</span><span class="bp">⍵</span><span class="p">)</span><span class="o">↑</span><span class="bp">⍵</span>
    <span class="nv">weights</span> <span class="kd">←</span> <span class="nv">count</span><span class="o">⍴</span><span class="p">(</span><span class="m">2</span><span class="o">|</span><span class="nv">count</span><span class="p">)</span><span class="o">⌽</span><span class="m">1</span> <span class="m">2</span>
    <span class="nv">digits</span> <span class="kd">←</span> <span class="m">0</span> <span class="m">10</span><span class="o">⊤</span><span class="nv">body</span><span class="o">×</span><span class="nv">weights</span>
    <span class="nv">check</span><span class="o">=</span><span class="m">10</span><span class="o">|-+</span><span class="na">/</span><span class="o">,</span><span class="nv">digits</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">assert</span> <span class="nv">luhn</span> <span class="m">7</span> <span class="m">9</span> <span class="m">9</span> <span class="m">2</span> <span class="m">7</span> <span class="m">3</span> <span class="m">9</span> <span class="m">8</span> <span class="m">7</span> <span class="m">1</span> <span class="m">3</span>
</pre></div>
</div>
</div>
</div>
<p>The Luhn algorithm was obviously chosen as an ideal fit for a data-parallel implementation. A few things stand out: firstly, the APL implementation follows the algorithm definition very closely, much closer than the Python version. Granted – and this is an interesting experiment – you can take the APL approach and implement a Python version following a similar pattern, albeit without array operations. Secondly, the solution is completely free or loops and branches. As Morten also observes, over 10 digits, there is no meaningful performance implication here, but it’s not hard to imagine what would happen over a million or more digits.</p>
</div>
<div class="section" id="balancing-the-scales">
<h3>Balancing the Scales<a class="headerlink" href="#balancing-the-scales" title="Permalink to this headline">¶</a></h3>
<p>This is Problem 8, Phase II from the 2020 Dyalog problem solving competition. You can see the problem statement <a class="reference external" href="https://www.dyalog.com/uploads/files/student_competition/2020_problems_phase2.pdf">here</a>. Obviously, there are spoilers to follow – if you want to have a crack at it yourself, stop reading here.</p>
<p>Our task is to partition a set of numbers into two groups of equal sum if this is possible, or return <code class="docutils literal notranslate"><span class="pre">⍬</span></code> if not. This is a well-known NP-hard problem, called <a class="reference external" href="https://en.wikipedia.org/wiki/Partition_problem">The Partition Problem</a>, and as such has no fast, always correct solutions for the general case. The problem statement indicates that we only need to consider a set of 20 numbers or fewer, which is a bit of a hint on what kind of solution is expected.</p>
<p>This problem, in common with many other NP problems, also has a plethora of interesting heuristic solutions: faster algorithms that whilst not guaranteed to always find the optimal solution will either get close, or be correct for a significant subset of the problem domain in a fraction of the time the exhaustive search would take. We’ll look at one of these approaches, too, although it probably wasn’t what Dyalog wanted in terms of the competition (I might be wrong; I didn’t take part at the time).</p>
<p>So given that we have a defined upper bound, and that Dyalog wants the solution to be optimal for all inputs up to this bound, and we know this problem to be NP-hard, we’re looking at an exhaustive search of some sort. We can also guess that given this is a Dyalog competition problem, whilst the algorithm might be crude, we should be able to exploit APL’s fast array processing to implement it efficiently.</p>
<p>The algorithm (if we can call it that) is simply to try every possible combination in which the numbers can be put into two separate piles and check if the partition sum equals half the total sum. If we have <code class="docutils literal notranslate"><span class="pre">n</span></code> items in our set, that corresponds to considering all numbers up to <code class="docutils literal notranslate"><span class="pre">¯1+2*n</span></code> in binary (recall  that <code class="docutils literal notranslate"><span class="pre">*</span></code> is exponentiation, not multiplication), and the two sets correspond to those matching the 0 bits and 1 bits respectively. For example, if we have the numbers 1, 1 and 2 we need to consider the following partitions (although we can skip the first and last):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>(0: 0 0 0)
 1: 0 0 1
 2: 0 1 0
 3: 0 1 1
 4: 1 0 0
 5: 1 0 1
 6: 1 1 0
(7: 1 1 1)
</pre></div>
</div>
<p>In this case, the solutions would be either 0 0 1, or its inverse, 1 1 0, corresponding to the partitioning <code class="docutils literal notranslate"><span class="pre">(1</span> <span class="pre">1)(,2)</span></code>.</p>
<p>So what are we dealing with here, in terms of the search space?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">¯1</span><span class="o">+</span><span class="m">2</span><span class="o">*</span><span class="m">20</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1048575
</span></div></div>
</div>
<p>Just over a million or so different partitions to check, which should be manageable. The search space doubles in size for each additional item, which is something alluded to in the <a class="reference external" href="https://en.wikipedia.org/wiki/Wheat_and_chessboard_problem">old fable</a> about the inventor of Chess:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">e</span><span class="kd">←</span><span class="m">¯1</span><span class="o">+</span><span class="m">2</span><span class="na">∘</span><span class="o">*</span><span class="p">⋄</span><span class="nv">e</span><span class="na">¨</span><span class="m">21</span><span class="o">+⍳</span><span class="m">9</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2097151 4194303 8388607 16777215 33554431 67108863 134217727 268435455 536870911
</span></div></div>
</div>
<p>To generate all binary combinations for <code class="docutils literal notranslate"><span class="pre">n</span></code> bits, we can use the following incantation (for n=3):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍉</span><span class="m">2</span><span class="na">∘</span><span class="o">⊥</span><span class="na">⍣</span><span class="m">¯1</span><span class="o">⍳</span><span class="m">2</span><span class="o">*</span><span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0
0 0 1
0 1 0
0 1 1
1 0 0
1 0 1
1 1 0
1 1 1
</span></div></div>
</div>
<p>Given a Boolean vector, how do we turn that into the two corresponding sets of numbers? There are several ways you can try, for example compress:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="kt">{</span><span class="p">(</span><span class="bp">⍺</span><span class="na">/</span><span class="bp">⍵</span><span class="p">)(</span><span class="bp">⍵</span><span class="na">/⍨</span><span class="o">~</span><span class="bp">⍺</span><span class="p">)</span><span class="kt">}</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="c1">⍝ compress and compress ~</span>
<span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="kt">{</span><span class="p">(</span><span class="bp">⍵</span><span class="o">~</span><span class="nv">v</span><span class="p">)(</span><span class="nv">v</span><span class="kd">←</span><span class="bp">⍺</span><span class="na">/</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span> <span class="c1">⍝ compress and set difference</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─┐
│1 1│2│
└───┴─┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬───┐
│2│1 1│
└─┴───┘
</span></div></div>
</div>
<p>but we can exploit the fact that we’re really interested in the <em>sums</em> of the sets. The sum of the items corresponding to the set bits is really just the bit pattern times the input set, summed:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">/</span><span class="m">1</span> <span class="m">1</span> <span class="m">0</span><span class="o">×</span><span class="m">1</span> <span class="m">1</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div></div>
</div>
<p>which we by now hopefully should recognize as an inner product:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="o">+</span><span class="na">.</span><span class="o">×</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">2
</span></div></div>
</div>
<p>And of course, inner product can be applied to an array, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">patterns</span> <span class="kd">←</span> <span class="o">⍉</span><span class="m">2</span><span class="na">∘</span><span class="o">⊥</span><span class="na">⍣</span><span class="m">¯1</span><span class="o">⍳</span><span class="m">2</span><span class="o">*</span><span class="m">3</span>
<span class="nv">patterns</span> <span class="o">+</span><span class="na">.</span><span class="o">×</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 2 1 3 1 3 2 4
</span></div></div>
</div>
<p>We can now draw up a plan for this.</p>
<ol class="simple">
<li><p>Our target partition sum is the total divided by two.</p></li>
<li><p>Generate the bit patterns up to <code class="docutils literal notranslate"><span class="pre">≢⍵</span></code>.</p></li>
<li><p>Calculate the sums of the numbers corresponding to the set bits in each pattern</p></li>
<li><p>Find the first point where the partition sum is equal to the target</p></li>
<li><p>Return the corresponding partitioning</p></li>
</ol>
<p>This translates readily to APL:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Balance</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">total</span> <span class="kd">←</span> <span class="o">+</span><span class="na">/</span><span class="bp">⍵</span>
    <span class="m">2</span><span class="o">|</span><span class="nv">total</span><span class="bp">:</span> <span class="no">⍬</span>             <span class="c1">⍝ Sum must be divisible by 2</span>
    <span class="nv">psum</span> <span class="kd">←</span> <span class="nv">total</span><span class="o">÷</span><span class="m">2</span>         <span class="c1">⍝ Our target partition sum</span>
    <span class="nv">bitp</span> <span class="kd">←</span> <span class="o">⍉</span><span class="m">2</span><span class="na">∘</span><span class="o">⊥</span><span class="na">⍣</span><span class="m">¯1</span><span class="o">⍳</span><span class="m">2</span><span class="o">*≢</span><span class="bp">⍵</span>    <span class="c1">⍝ All possible bit patterns up to ≢⍵</span>
    <span class="nv">idx</span> <span class="kd">←</span> <span class="o">⍸&lt;</span><span class="na">\</span><span class="nv">psum</span><span class="o">=</span><span class="nv">bitp</span><span class="o">+</span><span class="na">.</span><span class="o">×</span><span class="bp">⍵</span> <span class="c1">⍝ First index of partition sum = target</span>
    <span class="no">⍬</span><span class="o">≡</span><span class="nv">idx</span><span class="bp">:</span> <span class="no">⍬</span>               <span class="c1">⍝ If we have no 1s, there is no solution</span>
    <span class="nv">part</span> <span class="kd">←</span> <span class="nv">idx</span><span class="o">⌷</span><span class="nv">bitp</span>        <span class="c1">⍝ Partition corresponding to solution index</span>
    <span class="p">(</span><span class="nv">part</span><span class="na">/</span><span class="bp">⍵</span><span class="p">)(</span><span class="bp">⍵</span><span class="na">/⍨</span><span class="o">~</span><span class="nv">part</span><span class="p">)</span>     <span class="c1">⍝ Compress input by solution pattern and inverse</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Balance</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬───┐
│2│1 1│
└─┴───┘
</span></div></div>
</div>
<p>and on the full 20-bits:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Balance</span> <span class="m">10</span> <span class="m">81</span> <span class="m">98</span> <span class="m">27</span> <span class="m">28</span> <span class="m">5</span> <span class="m">1</span> <span class="m">46</span> <span class="m">63</span> <span class="m">99</span> <span class="m">25</span> <span class="m">39</span> <span class="m">84</span> <span class="m">87</span> <span class="m">76</span> <span class="m">85</span> <span class="m">78</span> <span class="m">64</span> <span class="m">41</span> <span class="m">93</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────────────────────┬────────────────────────────────────┐
│99 84 87 76 85 41 93│10 81 98 27 28 5 1 46 63 25 39 78 64│
└────────────────────┴────────────────────────────────────┘
</span></div></div>
</div>
<p>To a Python programmer, this approach must seem <em>incredibly</em> counter-intuitive, borderline criminally wasteful. Despite the fact that we only want the first solution (which occurs around bit pattern 1,500ish), we go through the <em>entire</em> search space. In a “loop and branch” language, we’d try each candidate pattern in turn, and break once we find the first solution.</p>
<p>But the seemingly naive APL solution is quick, even though it will process 2-3 orders of magnitude more patterns than would a scalar solution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">runtime</span> <span class="s2">&quot;Balance 10 81 98 27 28 5 1 46 63 99 25 39 84 87 76 85 78 64 41 93&quot;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">
* Benchmarking "Balance 10 81 98 27 28 5 1 46 63 99 25 39 84 87 76 85 78 64 41 93"
┌──────────┬────┐
│          │(ms)│
├──────────┼────┤
│CPU (avg):│28  │
├──────────┼────┤
│Elapsed:  │29  │
└──────────┴────┘
</span></div></div>
</div>
<p>So what’s going on here? Well, two things. Firstly, we’re hitting the most optimal core of Dyalog APL, its handling of Boolean vectors, using only primitive functions. Secondly, APL is able to vectorise our operations, taking advantage of SIMD operations in the processor.</p>
<p>For completeness, let’s see how a scalar solution would perform. We can, for example, take a tail-call Scheme-like approach:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">BalanceScalar</span> <span class="kd">←</span> <span class="kt">{</span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">0</span>     
    <span class="nv">total</span> <span class="kd">←</span> <span class="o">+</span><span class="na">/</span><span class="bp">⍵</span>
    <span class="m">2</span><span class="o">|</span><span class="nv">total</span><span class="bp">:</span> <span class="no">⍬</span>             <span class="c1">⍝ Sum must be divisible by 2</span>
    <span class="nv">psum</span> <span class="kd">←</span> <span class="nv">total</span><span class="o">÷</span><span class="m">2</span>         <span class="c1">⍝ Our target partition sum</span>
    <span class="nv">data</span> <span class="kd">←</span> <span class="bp">⍵</span>
    <span class="nv">bitp</span> <span class="kd">←</span> <span class="o">↓⍉</span><span class="m">2</span><span class="na">∘</span><span class="o">⊥</span><span class="na">⍣</span><span class="m">¯1</span><span class="o">⍳</span><span class="m">2</span><span class="o">*≢</span><span class="bp">⍵</span>   <span class="c1">⍝ Pre-compute the bit patterns</span>
    <span class="kt">{</span>                      <span class="c1">⍝ Try one sum after the other, halt on first solution</span>
        <span class="m">0</span><span class="o">=</span><span class="bp">⍵:</span> <span class="no">⍬</span>
        <span class="nv">patt</span> <span class="kd">←</span> <span class="bp">⍵</span><span class="o">⊃</span><span class="nv">bitp</span>
        <span class="nv">psum</span><span class="o">=</span><span class="nv">patt</span><span class="o">+</span><span class="na">.</span><span class="o">×</span><span class="nv">data</span><span class="bp">:</span> <span class="p">(</span><span class="nv">patt</span><span class="na">/</span><span class="nv">data</span><span class="p">)(</span><span class="nv">data</span><span class="na">/⍨</span><span class="o">~</span><span class="nv">patt</span><span class="p">)</span> <span class="c1">⍝ Exit on first solution found</span>
        <span class="bp">∇</span><span class="m">¯1</span><span class="o">+</span><span class="bp">⍵</span>
    <span class="kt">}</span> <span class="m">¯1</span><span class="o">+≢</span><span class="nv">bitp</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">BalanceScalar</span> <span class="m">1</span> <span class="m">1</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─┐
│1 1│2│
└───┴─┘
</span></div></div>
</div>
<p>Ok, let’s compare:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;cmpx&#39;</span><span class="nf">⎕CY</span><span class="s1">&#39;dfns&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">d</span><span class="kd">←</span><span class="m">10</span> <span class="m">81</span> <span class="m">98</span> <span class="m">27</span> <span class="m">28</span> <span class="m">5</span> <span class="m">1</span> <span class="m">46</span> <span class="m">63</span> <span class="m">99</span> <span class="m">25</span> <span class="m">39</span> <span class="m">84</span> <span class="m">87</span> <span class="m">76</span> <span class="m">85</span> <span class="m">78</span> <span class="m">64</span> <span class="m">41</span> <span class="m">93</span>
<span class="nv">cmpx</span> <span class="s1">&#39;Balance d&#39;</span> <span class="s1">&#39;BalanceScalar d&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  Balance d       → 2.7E¯2 |   0% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕             
* BalanceScalar d → 4.0E¯2 | +46% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕
</span></div></div>
</div>
<p>Ouch. That difference is pretty stark.</p>
<p>Dyalog can no longer vectorise, and performance slips considerably. If you take home anything from this chapter, this is the thing to remember.</p>
<p>However, the brute-force algorithm is of course still crude, even if APL can be quick about it at the specified scale. Add a few more elements, and the unforgiving <code class="docutils literal notranslate"><span class="pre">O(2^N)</span></code> complexity would soon crush us.</p>
<p>As I mentioned earlier, there are a number of heuristic algorithms that have a much more benign complexity, at the cost of not being able to guarantee optimal solutions in all cases. One such algorithm is called the <a class="reference external" href="https://en.wikipedia.org/wiki/Largest_differencing_method">Karmarkar-Karp</a>, after its inventors, and has a complexity of <code class="docutils literal notranslate"><span class="pre">O(N</span> <span class="pre">log</span> <span class="pre">N)</span></code>, but is not guaranteed to find the optimal solution, even if such a solution does exist.</p>
<p>In short, the KK algorithm maintains a priority queue of the remaining numbers, and picks the two largest numbers in each iteration, replacing them with their difference until a single number remains – this represents the final difference between the two partitions. We can construct the corresponding partitions via backtracking. A thorough analysis of this algorithm can be found <a class="reference external" href="https://core.ac.uk/download/pdf/82710454.pdf">here</a>.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">KarmarkarKarp</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">sort</span> <span class="kd">←</span> <span class="kt">{</span><span class="bp">⍵</span><span class="sr">[;</span><span class="o">⍋</span><span class="bp">⍵</span><span class="sr">[</span><span class="m">0</span><span class="sr">;]]</span><span class="kt">}</span>
    <span class="p">(</span><span class="nv">pairs</span> <span class="nv">last</span><span class="p">)</span> <span class="kd">←</span> <span class="no">⍬</span> <span class="kt">{</span>
        <span class="m">2</span><span class="o">&gt;≢⍉</span><span class="bp">⍵:⍺</span> <span class="p">(</span><span class="m">1</span> <span class="m">0</span><span class="o">⌷</span><span class="bp">⍵</span><span class="p">)</span>
        <span class="p">(</span><span class="nv">i</span> <span class="nv">x</span><span class="p">)(</span><span class="nv">j</span> <span class="nv">y</span><span class="p">)</span> <span class="kd">←</span> <span class="o">↓⍉</span><span class="bp">⍵</span><span class="sr">[;</span><span class="m">0</span> <span class="m">1</span><span class="sr">]</span>
        <span class="p">(</span><span class="bp">⍺</span><span class="o">,⊂</span><span class="nv">x</span> <span class="nv">y</span><span class="p">)</span><span class="bp">∇</span><span class="nv">sort</span> <span class="p">(</span><span class="m">2</span><span class="o">↓</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="p">(</span><span class="nv">i</span><span class="o">-</span><span class="nv">j</span><span class="p">)</span> <span class="nv">x</span>
    <span class="kt">}</span> <span class="nv">sort</span> <span class="o">↑</span><span class="p">(</span><span class="o">-</span><span class="bp">⍵</span><span class="p">)(</span><span class="bp">⍵</span><span class="p">)</span>
        
    <span class="nv">last</span> <span class="no">⍬</span> <span class="kt">{</span>
        <span class="p">(</span><span class="nv">a</span> <span class="nv">b</span><span class="p">)</span> <span class="kd">←</span> <span class="bp">⍺</span>
        <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="bp">⍺</span>
        <span class="nv">pair</span> <span class="kd">←</span> <span class="o">⊃</span><span class="m">¯1</span><span class="o">↑</span><span class="bp">⍵</span>
        <span class="nv">a</span><span class="o">∊</span><span class="na">⍨</span><span class="o">⊃</span><span class="nv">pair</span><span class="bp">:</span> <span class="p">(</span><span class="nv">a</span> <span class="p">(</span><span class="nv">b</span><span class="o">,</span><span class="m">1</span><span class="o">⊃</span><span class="nv">pair</span><span class="p">))</span><span class="bp">∇</span><span class="m">¯1</span><span class="o">↓</span><span class="bp">⍵</span>
        <span class="p">((</span><span class="nv">a</span><span class="o">,</span><span class="m">1</span><span class="o">⊃</span><span class="nv">pair</span><span class="p">)</span> <span class="nv">b</span><span class="p">)</span><span class="bp">∇</span><span class="m">¯1</span><span class="o">↓</span><span class="bp">⍵</span>
    <span class="kt">}</span> <span class="nv">pairs</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>In our test case, the KK does return an optimal solution:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">KarmarkarKarp</span> <span class="m">10</span> <span class="m">81</span> <span class="m">98</span> <span class="m">27</span> <span class="m">28</span> <span class="m">5</span> <span class="m">1</span> <span class="m">46</span> <span class="m">63</span> <span class="m">99</span> <span class="m">25</span> <span class="m">39</span> <span class="m">84</span> <span class="m">87</span> <span class="m">76</span> <span class="m">85</span> <span class="m">78</span> <span class="m">64</span> <span class="m">41</span> <span class="m">93</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────────────────────────────┬────────────────────────────┐
│41 85 99 5 93 10 63 27 64 78│1 25 28 76 81 39 46 84 87 98│
└────────────────────────────┴────────────────────────────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">cmpx</span> <span class="s1">&#39;Balance d&#39;</span> <span class="s1">&#39;KarmarkarKarp d&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">  Balance d       → 3.7E¯2 |    0% ⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕⎕
* KarmarkarKarp d → 1.4E¯4 | -100%                                         
</span></div></div>
</div>
<p>and, unsurprisingly, although completely scalar, it wins hands down. However, it’s still a heuristic:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">Balance</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span>
<span class="nv">KarmarkarKarp</span> <span class="m">4</span> <span class="m">5</span> <span class="m">6</span> <span class="m">7</span> <span class="m">8</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─────┐
│7 8│4 5 6│
└───┴─────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬───┐
│4 5 7│6 8│
└─────┴───┘
</span></div></div>
</div>
<p>A thing to note in the KK implementation above: it simply sorts the array at each iteration, instead of using a heap queue. As an exercise for the interested reader, try re-implementing it using a heap. However, and for similar reasons as we saw earlier, you will probably find that APL is likely faster at sorting a simple array than the complexity cost of maintaining a more nested data structure.</p>
</div>
<div class="section" id="merge">
<h3>Merge<a class="headerlink" href="#merge" title="Permalink to this headline">¶</a></h3>
<p>Ok, we’re on a roll. Problem 6 from the same year was a spin on the old “mail merge” concept: given a template file, expand templates with values from a corresponding merge file. For example, given a template of</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Hello @firstname@,
You have been selected to test drive a new @carmake@!
</pre></div>
</div>
<p>with a merge file of</p>
<div class="highlight-json notranslate"><div class="highlight"><pre><span></span><span class="p">{</span>
    <span class="nt">&quot;firstname&quot;</span><span class="p">:</span> <span class="nt">&quot;Bob&quot;</span>
    <span class="nt">&quot;carmake&quot;</span><span class="p">:</span> <span class="s2">&quot;Aston Martin&quot;</span>
<span class="p">}</span>
</pre></div>
</div>
<p>the final output should be</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Hello Bob,
You have been selected to test drive a new Aston Martin!
</pre></div>
</div>
<p>A literal <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> is represented by <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code> in the template, and templates with no corresponding match in the merge file should be expanded to <code class="docutils literal notranslate"><span class="pre">???</span></code>.</p>
<p>We’ll try two different solutions. For the first approach, it’s hard not to think of regexes here – replace “templates” matching a defined pattern with corresponding values.</p>
<p>Let’s look at the two data files first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">template</span> <span class="kd">←</span> <span class="s1">&#39;/Users/stefan/template.txt&#39;</span>
<span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="nv">template</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">@salutation@ @firstname@ @lastname@;
Congratulations!  You have won a @prize@ worth over £@value@!
@firstname@, please come to our office to pick up your @prize@.
Please feel free to contact us at info@@contest.com.
Your email address in our domain is @firstname@@@contest.com

</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">merge</span> <span class="kd">←</span> <span class="s1">&#39;/Users/stefan/merge1.json&#39;</span>
<span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="nv">merge</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">{
    "firstname":"Drake",
    "lastname":"Mallard",
    "prize":"yoyo",
    "value":100
}

</span></div></div>
</div>
<p>So our patterns are defined by the keys in the JSON, plus the <code class="docutils literal notranslate"><span class="pre">&#64;&#64;</span></code> for literal <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> and any remaining templates that have no corresponding entry in the merge file, along the lines of <code class="docutils literal notranslate"><span class="pre">&#64;[^&#64;]+&#64;</span></code>. We’ll start with reading the JSON data into a namespace and pulling out the keys and values:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">mrg</span><span class="kd">←</span><span class="nf">⎕JSON</span><span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="nv">merge</span>
<span class="nv">keys</span><span class="kd">←</span><span class="nv">mrg</span><span class="na">.</span><span class="nf">⎕NL¯2</span>
<span class="nv">vals</span><span class="kd">←</span><span class="nv">mrg</span><span class="na">.</span><span class="p">(</span><span class="o">⍎</span><span class="na">¨</span><span class="c1">#.keys)</span>
<span class="o">↑</span><span class="nv">keys</span> <span class="nv">vals</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────┬────────┬─────┬─────┐
│firstname│lastname│prize│value│
├─────────┼────────┼─────┼─────┤
│Drake    │Mallard │yoyo │100  │
└─────────┴────────┴─────┴─────┘
</span></div></div>
</div>
<p>and our patterns and replacements then become:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↑</span><span class="p">((</span><span class="kt">{</span><span class="s1">&#39;@&#39;</span><span class="o">,</span><span class="p">(</span><span class="o">⍕</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="s1">&#39;@&#39;</span><span class="kt">}</span><span class="na">¨</span><span class="nv">keys</span><span class="p">)</span><span class="o">,</span> <span class="p">(</span><span class="o">⊂</span><span class="s1">&#39;@@&#39;</span><span class="p">)</span><span class="o">,</span> <span class="o">⊂</span><span class="s1">&#39;@[^@]+@&#39;</span><span class="p">)</span> <span class="p">((</span><span class="o">⍕</span><span class="na">¨</span><span class="nv">vals</span><span class="p">)</span><span class="o">,</span> <span class="p">(</span><span class="o">⊂,</span><span class="s1">&#39;@&#39;</span><span class="p">)</span><span class="o">,</span> <span class="o">⊂</span><span class="s1">&#39;???&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────┬──────────┬───────┬───────┬──┬───────┐
│@firstname@│@lastname@│@prize@│@value@│@@│@[^@]+@│
├───────────┼──────────┼───────┼───────┼──┼───────┤
│Drake      │Mallard   │yoyo   │100    │@ │???    │
└───────────┴──────────┴───────┴───────┴──┴───────┘
</span></div></div>
</div>
<p>Putting it all together we get:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Merge</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">mrg</span><span class="kd">←</span><span class="nf">⎕JSON</span><span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="bp">⍺</span>
    <span class="nv">keys</span><span class="kd">←</span><span class="nv">mrg</span><span class="na">.</span><span class="nf">⎕NL¯2</span>
    <span class="nv">vals</span><span class="kd">←</span><span class="nv">mrg</span><span class="na">.</span><span class="p">(</span><span class="o">⍎</span><span class="na">¨</span><span class="c1">#.keys)</span>
    
    <span class="p">((</span><span class="kt">{</span><span class="s1">&#39;@&#39;</span><span class="o">,</span><span class="p">(</span><span class="o">⍕</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="s1">&#39;@&#39;</span><span class="kt">}</span><span class="na">¨</span><span class="nv">keys</span><span class="p">)</span><span class="o">,</span> <span class="p">(</span><span class="o">⊂</span><span class="s1">&#39;@@&#39;</span><span class="p">)</span><span class="o">,</span> <span class="o">⊂</span><span class="s1">&#39;@[^@]+@&#39;</span><span class="p">)</span><span class="nf">⎕R</span><span class="p">((</span><span class="o">⍕</span><span class="na">¨</span><span class="nv">vals</span><span class="p">)</span><span class="o">,</span> <span class="p">(</span><span class="o">⊂,</span><span class="s1">&#39;@&#39;</span><span class="p">)</span><span class="o">,</span> <span class="o">⊂</span><span class="s1">&#39;???&#39;</span><span class="p">)</span><span class="o">⊢⊃</span><span class="nf">⎕NGET</span> <span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">merge</span> <span class="nv">Merge</span> <span class="nv">template</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">??? Drake Mallard;
Congratulations!  You have won a yoyo worth over £100!
Drake, please come to our office to pick up your yoyo.
Please feel free to contact us at info@contest.com.
Your email address in our domain is Drake@contest.com

</span></div></div>
</div>
<p>All well and good, but not very “array-oriented” now, is it? Let’s remedy that, and forget about cheaty regexes.</p>
<p>If we partition the data such that each partition begins with <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> we get this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;@&#39;</span> <span class="p">(</span><span class="o">=⊂⊢</span><span class="p">)</span> <span class="s1">&#39;aaaa @bbb@ ccc @@ @ddd@&#39;</span> <span class="c1">⍝ Partitions starting at @</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬──────┬─┬──┬────┬─┐
│@bbb│@ ccc │@│@ │@ddd│@│
└────┴──────┴─┴──┴────┴─┘
</span></div></div>
</div>
<p>in fact, let’s drop the leading <code class="docutils literal notranslate"><span class="pre">&#64;</span></code>, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">tmpls</span><span class="kd">←</span><span class="s1">&#39;@&#39;</span><span class="p">(</span><span class="m">1</span><span class="o">↓</span><span class="na">¨</span><span class="o">=⊂⊢</span><span class="p">)</span><span class="s1">&#39;aaaa @bbb@ ccc @@ @ddd@&#39;</span> 
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─────┬┬─┬───┬┐
│bbb│ ccc ││ │ddd││
└───┴─────┴┴─┴───┴┘
</span></div></div>
</div>
<p>What we have now is a nested vector where every other element is a template.</p>
<p>Our replacement values will again come from a namespace</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">mrg</span><span class="kd">←</span><span class="nf">⎕NS</span><span class="no">⍬</span><span class="p">)</span><span class="na">.</span><span class="p">(</span><span class="nv">bbb</span> <span class="nv">ccc</span> <span class="nv">ddd</span><span class="p">)</span> <span class="kd">←</span> <span class="s1">&#39;bees&#39;</span> <span class="s1">&#39;cees&#39;</span> <span class="s1">&#39;dees&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>and we’ll make a little helper function to look up value by key, with the added functionality to return <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> for `` and <code class="docutils literal notranslate"><span class="pre">???</span></code> for non-present keys:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">val</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="o">,</span><span class="s1">&#39;@&#39;</span>
    <span class="o">~</span><span class="p">(</span><span class="o">⊂</span><span class="bp">⍵</span><span class="p">)</span><span class="o">∊</span><span class="nv">mrg</span><span class="na">.</span><span class="nf">⎕NL¯2</span><span class="bp">:</span> <span class="s1">&#39;???&#39;</span>
    <span class="o">⍕</span><span class="nv">mrg</span><span class="o">⍎</span><span class="bp">⍵</span>
<span class="kt">}</span> 
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">val</span><span class="na">¨</span><span class="s1">&#39;bbb&#39;</span> <span class="s1">&#39;ddd&#39;</span> <span class="s1">&#39;ccc&#39;</span> <span class="s1">&#39;&#39;</span> <span class="s1">&#39;hubba&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬────┬────┬─┬───┐
│bees│dees│cees│@│???│
└────┴────┴────┴─┴───┘
</span></div></div>
</div>
<p>We can use Dyalog’s handy <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> operator to  make the replacements. Recall that the <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> operator can take a right operand function which must return a Boolean vector, which in our case should select every other element, starting with the first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">val</span><span class="na">¨@</span><span class="kt">{</span><span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span><span class="kt">}</span><span class="o">⊢</span><span class="nv">tmpls</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬─────┬─┬─┬────┬┐
│bees│ ccc │@│ │dees││
└────┴─────┴─┴─┴────┴┘
</span></div></div>
</div>
<p>Finally, we’d need to tack on anything prior to the first <code class="docutils literal notranslate"><span class="pre">&#64;</span></code> and enlist.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Merge</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">mrg</span> <span class="kd">←</span> <span class="nf">⎕JSON</span><span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="bp">⍺</span>
    <span class="nv">templ</span> <span class="kd">←</span> <span class="o">⊃</span><span class="nf">⎕NGET</span> <span class="bp">⍵</span>
    <span class="nv">first</span> <span class="kd">←</span> <span class="nv">templ</span><span class="o">⍳</span><span class="s1">&#39;@&#39;</span>
    <span class="nv">first</span><span class="o">&gt;≢</span><span class="nv">templ</span><span class="bp">:</span> <span class="nv">templ</span>    <span class="c1">⍝ No templates at all</span>
    <span class="nv">prefix</span> <span class="kd">←</span> <span class="nv">first</span><span class="o">↑</span><span class="nv">templ</span>
    <span class="nv">val</span> <span class="kd">←</span> <span class="kt">{</span>
        <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵:</span> <span class="o">,</span><span class="s1">&#39;@&#39;</span>
        <span class="o">~</span><span class="p">(</span><span class="o">⊂</span><span class="bp">⍵</span><span class="p">)</span><span class="o">∊</span><span class="nv">mrg</span><span class="na">.</span><span class="nf">⎕NL¯2</span><span class="bp">:</span> <span class="s1">&#39;???&#39;</span>
        <span class="o">⍕</span><span class="nv">mrg</span><span class="o">⍎</span><span class="bp">⍵</span>
    <span class="kt">}</span>
    <span class="o">∊</span><span class="nv">prefix</span><span class="o">,</span><span class="nv">val</span><span class="na">¨@</span><span class="kt">{</span><span class="m">1</span> <span class="m">0</span><span class="o">⍴</span><span class="na">⍨</span><span class="o">≢</span><span class="bp">⍵</span><span class="kt">}</span><span class="s1">&#39;@&#39;</span><span class="p">(</span><span class="m">1</span><span class="o">↓</span><span class="na">¨</span><span class="o">=⊂⊢</span><span class="p">)</span><span class="nv">templ</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">merge</span> <span class="nv">Merge</span> <span class="nv">template</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">??? Drake Mallard;
Congratulations!  You have won a yoyo worth over £100!
Drake, please come to our office to pick up your yoyo.
Please feel free to contact us at info@contest.com.
Your email address in our domain is Drake@contest.com

</span></div></div>
</div>
</div>
<div class="section" id="right-align-a-block-of-text">
<h3>Right-align a block of text<a class="headerlink" href="#right-align-a-block-of-text" title="Permalink to this headline">¶</a></h3>
<p>Let’s work through a more comprehensive problem. Here’s a tweaked version of one of the Phase 1 tasks from the <a class="reference external" href="https://www.dyalog.com/student-competition.htm">Dyalog Problem Solving Competition</a>, 2021:</p>
<p>Write a function that:</p>
<ul class="simple">
<li><p>has a right argument <code class="docutils literal notranslate"><span class="pre">T</span></code> which is a character scalar, vector or a vector of character vectors</p></li>
<li><p>has a left argument <code class="docutils literal notranslate"><span class="pre">W</span></code> which is a positive integer specifying the width of the result</p></li>
<li><p>returns a right-aligned character array of shape <code class="docutils literal notranslate"><span class="pre">((2=≡T)/≢T),W</span></code>.</p></li>
<li><p>if an element of T has length greater than <code class="docutils literal notranslate"><span class="pre">W</span></code>, truncate it after <code class="docutils literal notranslate"><span class="pre">W</span></code> characters.</p></li>
</ul>
<p>The challenge here is not resorting to ‘eaching’ the rows, or employing some creative regexing. So let’s treat this as an exercise in array-oriented problem solving.</p>
<p>We’re given a couple of examples of how the solution should behave for arrays of different ranks:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="c1">⍝ 6 Align &#39;⍒&#39;</span>
<span class="s1">&#39;     ⍒&#39;</span>

<span class="c1">⍝ 10 Align &#39;Parade&#39;</span>
<span class="s1">&#39;    Parade&#39;</span>

<span class="c1">⍝ 8 Align &#39;Longer Phrase&#39; &#39;APL&#39; &#39;Parade&#39;</span>
<span class="m">3</span> <span class="m">8</span><span class="o">⍴</span><span class="s1">&#39;Longer P     APL  Parade&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">     ⍒
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">    Parade
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Longer P
     APL
  Parade
</span></div></div>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The last example above is different from the way the problem was published. For extra points, solve it as it was presented in the competition:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>3 8⍴&#39;r Phrase     APL  Parade&#39;
</pre></div>
</div>
</div>
<p>A hint is given in the problem statement on where we could start: we’re told what the shape should be of the resulting array: <code class="docutils literal notranslate"><span class="pre">((2=≡T)/≢T),W</span></code>. Given the result shape, we can try the following approach:</p>
<p>Figure out the result shape, and squeeze the data into this shape, truncating if we need to. Locate trailing spaces. Prepend a space on each line, and then replicate by the number of trailing spaces.</p>
<p>We’re given the shape. In order for this to work for character scalars, a character vector, or vector of character vectors, we need to operate on the ravel of the right argument when finding the shape:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">6</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;⍋&#39;</span>
<span class="m">10</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;Parade&#39;</span>
<span class="m">8</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;Longer Phrase&#39;</span> <span class="s1">&#39;APL&#39;</span> <span class="s1">&#39;Parade&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">6
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">10
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">3 8
</span></div></div>
</div>
<p>To fit the data into that shape, we need to <em>Mix</em> the ravel (<code class="docutils literal notranslate"><span class="pre">↑,⍵</span></code>) to increase the rank and then <em>Take</em> <code class="docutils literal notranslate"><span class="pre">⍺</span></code> elements, rank 1 (along vectors), and then reshape. Let’s explore what this means:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="s1">&#39;Parade&#39;</span>
<span class="o">⊢</span><span class="nv">sh</span> <span class="kd">←</span> <span class="m">10</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="nv">data</span> <span class="c1">⍝ Shape</span>
<span class="o">↑,</span><span class="nv">data</span>                         <span class="c1">⍝ Mix ravel (no change for a char vector)</span>
<span class="m">10</span><span class="o">↑</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢↑,</span><span class="nv">data</span>                   <span class="c1">⍝ (over)take, rank-1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">10
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Parade
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Parade    
</span></div></div>
</div>
<p>More interesting to consider is the nested vector case:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="s1">&#39;Longer Phrase&#39;</span> <span class="s1">&#39;APL&#39;</span> <span class="s1">&#39;Parade&#39;</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">sh</span> <span class="kd">←</span> <span class="m">8</span> <span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span><span class="kt">}</span> <span class="nv">data</span> <span class="c1">⍝ Shape</span>
<span class="o">↑,</span><span class="nv">data</span>                           <span class="c1">⍝ Mix ravel</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">mat</span> <span class="kd">←</span> <span class="m">8</span><span class="o">↑</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢↑,</span><span class="nv">data</span>            <span class="c1">⍝ (over)take, rank 1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 8
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Longer Phrase
APL          
Parade       
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Longer P
APL     
Parade  
</span></div></div>
</div>
<p>So far, so array-oriented! Now we need to find trailing spaces. The equal sign makes for an excellent search function! Where are the spaces?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39; &#39;</span><span class="o">=</span><span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0 0 0 0 1 0
0 0 0 1 1 1 1 1
0 0 0 0 0 0 1 1
</span></div></div>
</div>
<p>All well and good, but we need the <em>trailing</em> spaces. A handy technique here is to <em>and-scan</em>, which is one of those APLisms that is so obvious (once someone pointed it out to you, you found it on APLCart, or you’re a genius). It keeps all 1s from the beginning, and zeros everything  after the first zero:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">∧</span><span class="na">\</span><span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1 1 0 0 0 0 0 0 0
</span></div></div>
</div>
<p>but that looks at <em>leading</em> not trailing spaces, so we need to flip, and-scan, flip back:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⌽∧</span><span class="na">\</span><span class="o">⌽</span><span class="s1">&#39; &#39;</span><span class="o">=</span><span class="nv">mat</span>   <span class="c1">⍝ We&#39;re keeping on arraying</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 0 0 0 0 0 0
0 0 0 1 1 1 1 1
0 0 0 0 0 0 1 1
</span></div></div>
</div>
<p>Conceptually, we’ll add extra spaces at the beginning of each line, the same number as any trailing spaces. In practice, we’ll add a single space, and then use a replication vector to clone it the relevant number of times. Recall:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">data</span> <span class="kd">←</span> <span class="s1">&#39; ABCDEFGHIK&#39;</span>         <span class="c1">⍝ Note: leading space</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">repl</span> <span class="kd">←</span> <span class="m">5</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="c1">⍝ Five spaces, one of everything else</span>
<span class="nv">repl</span><span class="na">/</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> ABCDEFGHIK
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">5 1 1 1 1 1 1 1 1 1 1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">     ABCDEFGHIK
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">trailing</span> <span class="kd">←</span> <span class="o">⌽∧</span><span class="na">\</span><span class="o">⌽</span><span class="s1">&#39; &#39;</span><span class="o">=</span><span class="nv">mat</span>     <span class="c1">⍝ Find trailing spaces, as per above</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">spaced</span> <span class="kd">←</span> <span class="s1">&#39; &#39;</span><span class="o">,</span><span class="nv">mat</span>       <span class="c1">⍝ Add a space as the first char of each row</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">keepers</span> <span class="kd">←</span> <span class="o">~</span><span class="nv">trailing</span>    <span class="c1">⍝ Everything not a trailing space</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">padding</span> <span class="kd">←</span> <span class="o">+</span><span class="na">/</span><span class="nv">trailing</span>   <span class="c1">⍝ Amount of leading padding to be inserted per row</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">repl</span> <span class="kd">←</span> <span class="nv">padding</span><span class="o">,</span><span class="nv">keepers</span> <span class="c1">⍝ Number of replications per character</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> Longer P
 APL     
 Parade  
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1 1 1 1 1 1 1
1 1 1 0 0 0 0 0
1 1 1 1 1 1 0 0
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0 5 2
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">0 1 1 1 1 1 1 1 1
5 1 1 1 0 0 0 0 0
2 1 1 1 1 1 1 0 0
</span></div></div>
</div>
<p>Now what remains is to do the replication and ensure that everything gets the shape it should have.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">repl</span><span class="na">/⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">spaced</span> <span class="c1">⍝ Replicate along vectors</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Longer P
     APL
  Parade
</span></div></div>
</div>
<p>That’s it! Putting it all together, we get the following:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Align</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">shape</span> <span class="kd">←</span> <span class="bp">⍺</span><span class="o">,</span><span class="na">⍨</span><span class="p">(</span><span class="m">2</span><span class="o">=≡,</span><span class="bp">⍵</span><span class="p">)</span><span class="na">/</span><span class="o">≢,</span><span class="bp">⍵</span>  <span class="c1">⍝ Shape, as specified</span>
    <span class="nv">mat</span> <span class="kd">←</span> <span class="bp">⍺</span><span class="o">↑</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢↑,</span><span class="bp">⍵</span>          <span class="c1">⍝ Truncate rank 1</span>
    <span class="nv">trailing</span> <span class="kd">←</span> <span class="o">⌽∧</span><span class="na">\</span><span class="o">⌽</span><span class="s1">&#39; &#39;</span><span class="o">=</span><span class="nv">mat</span>  <span class="c1">⍝ Find trailing spaces</span>
    <span class="nv">spaced</span> <span class="kd">←</span> <span class="s1">&#39; &#39;</span><span class="o">,</span><span class="nv">mat</span>        <span class="c1">⍝ Add a space as the first char of each row</span>
    <span class="nv">keepers</span> <span class="kd">←</span> <span class="o">~</span><span class="nv">trailing</span>     <span class="c1">⍝ Everything not a trailing space</span>
    <span class="nv">padding</span> <span class="kd">←</span> <span class="o">+</span><span class="na">/</span><span class="nv">trailing</span>    <span class="c1">⍝ Amount of leading padding to be inserted per row</span>
    <span class="nv">repl</span> <span class="kd">←</span> <span class="nv">padding</span><span class="o">,</span><span class="nv">keepers</span>  <span class="c1">⍝ Number of replications per character</span>
    <span class="nv">repl</span><span class="na">/⍤</span><span class="m">1</span><span class="o">⊢</span><span class="nv">spaced</span>          <span class="c1">⍝ Replicate rank 1</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">6</span> <span class="nv">Align</span> <span class="s1">&#39;⍋&#39;</span>
<span class="m">10</span> <span class="nv">Align</span> <span class="s1">&#39;Parade&#39;</span>
<span class="m">8</span> <span class="nv">Align</span> <span class="s1">&#39;Longer Phrase&#39;</span> <span class="s1">&#39;APL&#39;</span> <span class="s1">&#39;Parade&#39;</span>
<span class="m">8</span> <span class="nv">Align</span> <span class="s1">&#39;K&#39;</span> <span class="s1">&#39;E&#39;</span> <span class="s1">&#39;Iverson&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">     ⍋
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">    Parade
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Longer P
     APL
  Parade
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">       K
       E
 Iverson
</span></div></div>
</div>
<p>Pretty cool, eh? As an exercise, now shrink that to a one-liner suitable for submitting as a competition entry.</p>
<p>Shall we do one more?</p>
</div>
<div class="section" id="fizzbuzz">
<h3>FizzBuzz<a class="headerlink" href="#fizzbuzz" title="Permalink to this headline">¶</a></h3>
<p>Adám Brudzewski used the classic FizzBuzz problem – the darling of technical interviewers everywhere – as an illustration in one of his Cultivation lessons, <a class="reference external" href="https://chat.stackexchange.com/rooms/52405/conversation/lesson-39-array-programming-techniques">Lesson 39 - Array programming techniques</a>.</p>
<p>Wikipedia has the following to say about <a class="reference external" href="https://en.wikipedia.org/wiki/Fizz_buzz">FizzBuzz</a>:</p>
<blockquote>
<div><p>Fizz buzz is a group word game for children to teach them about division. Players take turns to count incrementally, replacing any number divisible by three with the word “fizz”, and any number divisible by five with the word “buzz”.</p>
</div></blockquote>
<p>but most programmers will be familiar with it as a task frequently set as a technical challenge in job interviews. In fact, we’ve seen an APL version of this already. Right at the beginning it was used as an illustration of a <em>trad function</em>.</p>
<p>Here’s a “loopy” version as an APL dfn, for context:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="o">∊</span><span class="p">(</span><span class="m">3</span><span class="o">↑</span><span class="p">(</span><span class="m">0</span><span class="o">=</span><span class="m">3</span> <span class="m">5</span><span class="o">|</span><span class="bp">⍵</span><span class="p">)</span><span class="o">∪</span><span class="m">1</span><span class="p">)</span><span class="na">/</span><span class="s1">&#39;Fizz&#39;</span> <span class="s1">&#39;Buzz&#39;</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">¨</span><span class="m">1</span><span class="o">+⍳</span><span class="m">16</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬─┬────┬─┬────┬────┬─┬─┬────┬────┬──┬────┬──┬──┬────────┬──┐
│1│2│Fizz│4│Buzz│Fizz│7│8│Fizz│Buzz│11│Fizz│13│14│FizzBuzz│16│
└─┴─┴────┴─┴────┴────┴─┴─┴────┴────┴──┴────┴──┴──┴────────┴──┘
</span></div></div>
</div>
<p>Can we do without the <code class="docutils literal notranslate"><span class="pre">each</span></code>, given what we’ve already learnt? Let’s ponder what an array solution might look like.</p>
<p>Let’s begin by creating a Boolean mask showing the positions of the numbers which are divisible by 3 (the “fizzes”) and those divisible by 5 (the “buzzes”). We can do that as an outer product:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="m">1</span><span class="o">+⍳</span><span class="m">16</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">fizzbuzz</span> <span class="kd">←</span> <span class="m">0</span><span class="o">=</span><span class="m">3</span> <span class="m">5</span><span class="na">∘.</span><span class="o">|</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0
0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0
</span></div></div>
</div>
<p>So the columns that have only zeros in them represent the “numbers” - the “non-fizzbuzzy” bits. Let’s add a new row to our matrix to make this clear:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">mat</span> <span class="kd">←</span> <span class="p">(</span><span class="o">⍱</span><span class="na">⌿</span><span class="o">⍪⊢</span><span class="p">)</span><span class="nv">fizzbuzz</span>  <span class="c1">⍝ Tacit for {(⍱⌿⍵)⍪⍵} -- column-wise logical NOR as the new first row</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1 0 1 0 0 1 1 0 0 1 0 1 1 0 1
0 0 1 0 0 1 0 0 1 0 0 1 0 0 1 0
0 0 0 0 1 0 0 0 0 1 0 0 0 0 1 0
</span></div></div>
</div>
<p>If we now multiply the first row by our input numbers, we have the numbers that aren’t “fizzbuzzy”</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">mat</span><span class="o">×</span><span class="na">@</span><span class="m">0</span><span class="na">⍨</span><span class="kd">←</span><span class="nv">data</span> <span class="c1">⍝ Check that out! Modified assignment</span>
<span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 0 4 0 0 7 8 0 0 11 0 13 14 0 16
0 0 1 0 0 1 0 0 1 0  0 1  0  0 1  0
0 0 0 0 1 0 0 0 0 1  0 0  0  0 1  0
</span></div></div>
</div>
<p>Now we substitute all 1s for “fizz” in the second row, and for “buzz” in the third row:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">mat</span><span class="sr">[</span><span class="o">↓</span><span class="m">1</span><span class="o">,</span><span class="na">⍤</span><span class="m">0</span> <span class="m">0</span><span class="o">⊢⍸</span><span class="m">1</span><span class="o">⌷</span><span class="nv">mat</span><span class="sr">]</span><span class="kd">←</span><span class="o">⊂</span><span class="s1">&#39;fizz&#39;</span>
<span class="nv">mat</span><span class="sr">[</span><span class="o">↓</span><span class="m">2</span><span class="o">,</span><span class="na">⍤</span><span class="m">0</span> <span class="m">0</span><span class="o">⊢⍸</span><span class="m">2</span><span class="o">⌷</span><span class="nv">mat</span><span class="sr">]</span><span class="kd">←</span><span class="o">⊂</span><span class="s1">&#39;buzz&#39;</span>
<span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬─┬────┬─┬────┬────┬─┬─┬────┬────┬──┬────┬──┬──┬────┬──┐
│1│2│0   │4│0   │0   │7│8│0   │0   │11│0   │13│14│0   │16│
├─┼─┼────┼─┼────┼────┼─┼─┼────┼────┼──┼────┼──┼──┼────┼──┤
│0│0│fizz│0│0   │fizz│0│0│fizz│0   │0 │fizz│0 │0 │fizz│0 │
├─┼─┼────┼─┼────┼────┼─┼─┼────┼────┼──┼────┼──┼──┼────┼──┤
│0│0│0   │0│buzz│0   │0│0│0   │buzz│0 │0   │0 │0 │buzz│0 │
└─┴─┴────┴─┴────┴────┴─┴─┴────┴────┴──┴────┴──┴──┴────┴──┘
</span></div></div>
</div>
<p>Merge columns, remove zeros:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">0</span><span class="o">~</span><span class="na">⍨¨</span><span class="o">,</span><span class="na">⌿</span><span class="nv">mat</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬─┬────┬─┬────┬────┬─┬─┬────┬────┬──┬────┬──┬──┬────────┬──┐
│1│2│fizz│4│buzz│fizz│7│8│fizz│buzz│11│fizz│13│14│fizzbuzz│16│
└─┴─┴────┴─┴────┴────┴─┴─┴────┴────┴──┴────┴──┴──┴────────┴──┘
</span></div></div>
</div>
<p>Nice. So in this case, is the longer array solution better than the clever loopy one we showed in the beginning? Well, the intention was to demonstrate how to approach solutions in a data-parallel way, but the problem was of a magnitude that probably made this unnecessary. But practice makes perfect.</p>
</div>
</div>
<span id="document-namespaces"></span><div class="tex2jax_ignore mathjax_ignore section" id="namespaces-ns">
<h2>Namespaces <code class="docutils literal notranslate"><span class="pre">⎕NS</span></code><a class="headerlink" href="#namespaces-ns" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>The utility of a language as a tool of thought increases with the range of topics it can treat, but decreases with the amount of vocabulary and the complexity of grammatical rules which the user must keep in mind. Economy of notation is therefore important. –<em>Kenneth E. Iverson</em></p>
</div></blockquote>
<p>A <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Introduction/Namespaces/Namespaces.htm">namespace</a> is a way to group data and code into a hierarchy. Dyalog describes namespaces like so:</p>
<blockquote>
<div><p>Namespace is a (class 9) object in Dyalog APL. Namespaces are analogous to nested workspaces.</p>
</div></blockquote>
<p>No, that doesn’t mean anything to me either. In fact, APL namespaces are similar in spirit to those found in <a class="reference external" href="https://en.cppreference.com/w/cpp/language/namespace">C++</a>:</p>
<blockquote>
<div><p>Namespaces provide a method for preventing name conflicts in large projects. Symbols declared inside a namespace block are placed in a named scope that prevents them from being mistaken for identically-named symbols in other scopes.</p>
</div></blockquote>
<p>Here’s an anonymous namespace:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">obj</span> <span class="kd">←</span> <span class="nf">⎕NS</span><span class="no">⍬</span>
</pre></div>
</div>
</div>
</div>
<p>We can assign values to variables inside this namespace:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">obj</span><span class="na">.</span><span class="p">(</span><span class="nv">name</span> <span class="nv">cost</span> <span class="nv">id</span><span class="p">)</span>  <span class="kd">←</span> <span class="s1">&#39;widget&#39;</span> <span class="m">55.0</span> <span class="s1">&#39;widg443&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">obj</span><span class="na">.</span><span class="p">(</span><span class="nv">name</span> <span class="nv">cost</span> <span class="nv">id</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──────┬──┬───────┐
│widget│55│widg443│
└──────┴──┴───────┘
</span></div></div>
</div>
<p>Names inside a namespace can hold any value that names can hold <em>outside</em> a namespace, including functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">obj</span><span class="na">.</span><span class="nv">sum</span><span class="kd">←</span><span class="o">+</span><span class="na">/</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">obj</span><span class="na">.</span><span class="nv">sum</span> <span class="m">1</span> <span class="m">2</span> <span class="m">3</span> <span class="m">4</span> <span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">15
</span></div></div>
</div>
<p>There is a handy user command, <code class="docutils literal notranslate"><span class="pre">]map</span></code> that gives a tree outline of a namespace that’s worth adding to your repertoire:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">map</span> <span class="nv">obj</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">#.[Namespace]
·   ~ cost id name
·   ∇ sum
</span></div></div>
</div>
<div class="section" id="scripted-namespaces">
<h3>Scripted namespaces<a class="headerlink" href="#scripted-namespaces" title="Permalink to this headline">¶</a></h3>
<p>A nifty feature is that we can compose a namespace as a <em>script</em>. In RIDE, you need to say <code class="docutils literal notranslate"><span class="pre">)ed</span> <span class="pre">⍟</span> <span class="pre">mynamespace</span></code> in order to work with a scripted namespace. Yes, of course that’s a good use for the <em>Logarithm</em> glyph. It looks like so:</p>
<p><img alt="ns1" src="_images/ns1.png" /></p>
<p>In this way, the namespace can be a convenient way to organise your code. And in case it wasn’t obvious, it’s actually a way in which you can have many multi-line dfns in the same editing window – or even text file. It even works as intended in the Jupyter notebook:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="bp">:</span><span class="nv">Namespace</span> <span class="nv">myns</span>
    <span class="nv">f</span> <span class="kd">←</span> <span class="kt">{</span>
        <span class="bp">⍺</span><span class="o">+</span><span class="bp">⍵</span>
    <span class="kt">}</span>

    <span class="nv">g</span> <span class="kd">←</span> <span class="kt">{</span>
        <span class="c1">⍝ g fun</span>
        <span class="bp">⍺⍵</span>
    <span class="kt">}</span>

    <span class="nv">h</span> <span class="kd">←</span> <span class="kt">{</span>
        <span class="nv">s</span> <span class="kd">←</span> <span class="s1">&#39;\d+&#39;</span><span class="nf">⎕R</span><span class="s1">&#39;D&#39;</span><span class="o">⊢</span><span class="bp">⍵</span>
        <span class="bp">⍺</span> <span class="nv">g</span> <span class="nv">s</span>
    <span class="kt">}</span>
<span class="bp">:</span><span class="nv">EndNamespace</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;nodigits&#39;</span> <span class="nv">myns</span><span class="na">.</span><span class="nv">h</span> <span class="s1">&#39;abd556jashgd8879&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────────┬───────────┐
│nodigits│abdDjashgdD│
└────────┴───────────┘
</span></div></div>
</div>
</div>
<div class="section" id="wait-this-is-starting-to-look-like-a-dict">
<h3>Wait, this is starting to look like a dict!<a class="headerlink" href="#wait-this-is-starting-to-look-like-a-dict" title="Permalink to this headline">¶</a></h3>
<p>We can get tantalisingly close to having a namespace function as a dict. In order to list the names of variables contained in a namespace, we have the <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/nl.htm">namelist</a>, <code class="docutils literal notranslate"><span class="pre">⎕NL</span></code>, system function.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">names</span> <span class="kd">←</span> <span class="nv">obj</span><span class="na">.</span><span class="nf">⎕NL</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">cost
id  
name
</span></div></div>
</div>
<p>The <code class="docutils literal notranslate"><span class="pre">2</span></code> there lets <code class="docutils literal notranslate"><span class="pre">⎕NL</span></code> know that we want an array back.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍴</span><span class="nv">names</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 4
</span></div></div>
</div>
<p>If we feed it <code class="docutils literal notranslate"><span class="pre">¯2</span></code> instead we get a nested vector instead:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">obj</span><span class="na">.</span><span class="nf">⎕NL</span> <span class="m">¯2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬──┬────┐
│cost│id│name│
└────┴──┴────┘
</span></div></div>
</div>
<p>The right argument to <code class="docutils literal notranslate"><span class="pre">⎕NL</span></code> is a <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/nc.htm">name class</a>, allowing us to select based on what kind something contained in the namespace is. Many of the name classes are concerned with bits of Dyalog that are out of scope for this book.</p>
<p>We can get the <em>values</em> of variables by evaluating their names:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">obj</span><span class="o">⍎</span><span class="s1">&#39;cost&#39;</span>
<span class="nv">obj</span><span class="na">.</span><span class="p">(</span><span class="o">⍎</span><span class="na">¨</span><span class="nf">⎕NL</span> <span class="m">¯2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">55
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬───────┬──────┐
│55│widg443│widget│
└──┴───────┴──────┘
</span></div></div>
</div>
<p>Almost, but not quite, a dict:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">_set</span><span class="kd">←</span><span class="kt">{</span><span class="o">⍎</span><span class="s1">&#39;⍺⍺.&#39;</span><span class="o">,</span><span class="bp">⍺</span><span class="o">,</span><span class="s1">&#39;←⍵&#39;</span><span class="o">⊣</span><span class="bp">⍺⍺</span><span class="kt">}</span>
<span class="nv">keys</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍵</span><span class="na">.</span><span class="nf">⎕NL</span> <span class="m">¯2</span><span class="kt">}</span>
<span class="nv">vals</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍵</span><span class="na">.</span><span class="p">(</span><span class="o">⍎</span><span class="na">¨</span><span class="nf">⎕NL</span> <span class="m">¯2</span><span class="p">)</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;hello&#39;</span> <span class="p">(</span><span class="nv">obj</span> <span class="nv">_set</span><span class="p">)</span> <span class="s1">&#39;world&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">obj</span><span class="o">⍎</span><span class="s1">&#39;hello&#39;</span>
<span class="nv">keys</span> <span class="nv">obj</span>
<span class="nv">vals</span> <span class="nv">obj</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">world
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬─────┬──┬────┐
│cost│hello│id│name│
└────┴─────┴──┴────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬─────┬───────┬──────┐
│55│world│widg443│widget│
└──┴─────┴───────┴──────┘
</span></div></div>
</div>
<p>but this approach won’t let you use anything but character vectors as keys, and the keys must also be valid APL names.  There are also some performance constraints if the number of items in a namespace grow large.</p>
</div>
<div class="section" id="a-note-on-mutability">
<h3>A note on mutability<a class="headerlink" href="#a-note-on-mutability" title="Permalink to this headline">¶</a></h3>
<p>Namespaces in Dyalog are reference types, and mutable. This allows you to bypass some scope-related barriers that may have been erected for very good reasons, so <em>caveat emptor</em>. For example, we can mutate a namespace even if it’s passed as the <em>left</em> argument, which is an error for normal arrays:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">ns</span> <span class="kd">←</span> <span class="nf">⎕NS</span><span class="no">⍬</span>
<span class="nv">ns</span><span class="na">.</span><span class="nv">key</span> <span class="kd">←</span> <span class="m">45</span>
<span class="nv">ns</span> <span class="kt">{</span><span class="bp">⍺</span><span class="na">.</span><span class="nv">key</span> <span class="kd">←</span> <span class="m">99</span> <span class="p">⋄</span> <span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;hello&#39;</span> <span class="c1">⍝ Mutation through ⍺...</span>
<span class="nv">ns</span><span class="na">.</span><span class="nv">key</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">hello
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">99
</span></div></div>
</div>
<p>It also means that there is no need for modified assignment through a tack, <code class="docutils literal notranslate"><span class="pre">⊢←</span></code> if we want to set a value in a namespace not in our immediate scope. All of this is either very useful, or very dangerous, depending on your particular view point. The reality is that it’s both useful, but also increases the risk of foot-gun incidents.</p>
</div>
<div class="section" id="arrays-of-namespaces">
<h3>Arrays of namespaces<a class="headerlink" href="#arrays-of-namespaces" title="Permalink to this headline">¶</a></h3>
<p>Certain namespace operations extend into arrays of namespaces, almost like scalar extension, which might not be obvious at all, but supremely useful. For example, we can assign to a specific field across the whole array:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">0</span>
<span class="nv">nsarray</span><span class="kd">←</span><span class="nf">⎕NS</span><span class="na">¨</span><span class="m">6</span><span class="o">⍴⊂</span><span class="no">⍬</span>
<span class="nv">nsarray</span><span class="na">.</span><span class="nv">name</span><span class="kd">←</span><span class="s1">&#39;adam&#39;</span> <span class="s1">&#39;bob&#39;</span> <span class="s1">&#39;charlotte&#39;</span> <span class="s1">&#39;dave&#39;</span> <span class="s1">&#39;erica&#39;</span> <span class="s1">&#39;fred&#39;</span>
<span class="nv">nsarray</span><span class="na">.</span><span class="nv">pid</span><span class="kd">←</span><span class="m">3</span> <span class="m">7</span> <span class="m">87</span> <span class="m">32</span> <span class="m">32</span> <span class="m">9</span>
<span class="nv">nsarray</span><span class="na">.</span><span class="nv">items</span><span class="kd">←</span><span class="p">(</span><span class="m">1</span> <span class="m">2</span> <span class="m">3</span><span class="p">)(</span><span class="m">2</span> <span class="m">3</span><span class="p">)(</span><span class="m">9</span> <span class="m">32</span> <span class="m">23</span><span class="p">)(</span><span class="m">9</span> <span class="m">8</span> <span class="m">7</span> <span class="m">6</span> <span class="m">5</span> <span class="m">4</span><span class="p">)(</span><span class="m">8</span> <span class="m">7</span><span class="p">)(</span><span class="o">,</span><span class="m">1</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">nsarray</span><span class="sr">[</span><span class="m">2</span><span class="sr">]</span><span class="na">.</span><span class="nv">name</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">charlotte
</span></div></div>
</div>
<p>and, as a consequence, pick a field from all array elements:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">nsarray</span><span class="na">.</span><span class="nv">name</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬───┬─────────┬────┬─────┬────┐
│adam│bob│charlotte│dave│erica│fred│
└────┴───┴─────────┴────┴─────┴────┘
</span></div></div>
</div>
<p>We can also execute functions on fields if we enclose in parentheses:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">nsarray</span><span class="na">.</span><span class="p">(</span><span class="o">≢</span><span class="nv">items</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3 2 3 6 2 1
</span></div></div>
</div>
<p>or pick multiple fields, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">nsarray</span><span class="na">.</span><span class="p">(</span><span class="nv">name</span> <span class="nv">pid</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────────┬───────┬──────────────┬─────────┬──────────┬────────┐
│┌────┬─┐│┌───┬─┐│┌─────────┬──┐│┌────┬──┐│┌─────┬──┐│┌────┬─┐│
││adam│3│││bob│7│││charlotte│87│││dave│32│││erica│32│││fred│9││
│└────┴─┘│└───┴─┘│└─────────┴──┘│└────┴──┘│└─────┴──┘│└────┴─┘│
└────────┴───────┴──────────────┴─────────┴──────────┴────────┘
</span></div></div>
</div>
<p>If you were jealous of KDB+’s neat SQL integration, we can even knock up a simple query DSL for accessing data represented as arrays of namespaces, as <a class="reference external" href="https://chat.stackexchange.com/users/130368/adam">Adám</a> showed in a post in <a class="reference external" href="https://chat.stackexchange.com/transcript/message/58127218#58127218">APL Orchard</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">From</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍵</span><span class="o">⍎</span><span class="na">¨</span><span class="o">⊂</span><span class="bp">⍺</span><span class="kt">}</span>
<span class="nv">Has</span><span class="kd">←</span><span class="kt">{</span><span class="o">×</span><span class="bp">⍺</span><span class="na">.</span><span class="nf">⎕NC</span><span class="o">⊂⊂</span><span class="bp">⍵</span><span class="kt">}</span>
<span class="nv">In</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍺</span><span class="na">∘</span><span class="p">(</span><span class="o">∨</span><span class="na">/</span><span class="o">⍷</span><span class="p">)</span><span class="na">¨</span><span class="bp">⍵</span><span class="kt">}</span>
<span class="nv">Where</span><span class="kd">←</span><span class="na">/⍨</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;pid&#39;</span> <span class="nv">From</span> <span class="nv">nsarray</span> <span class="nv">Where</span> <span class="s1">&#39;dave&#39;</span> <span class="nv">In</span> <span class="nv">nsarray</span><span class="na">.</span><span class="nv">name</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">32
</span></div></div>
</div>
<p>Who needs SQL now? We can select on the existence of a particular field using the <code class="docutils literal notranslate"><span class="pre">Has</span></code> helper:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">nsarray</span><span class="sr">[</span><span class="m">2</span> <span class="m">5</span><span class="sr">]</span><span class="na">.</span><span class="nv">title</span><span class="kd">←</span><span class="s1">&#39;manager&#39;</span> <span class="s1">&#39;pointy-haired boss&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;name&#39;</span> <span class="nv">From</span> <span class="nv">nsarray</span> <span class="nv">Where</span> <span class="nv">nsarray</span> <span class="nv">Has</span> <span class="s1">&#39;title&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────┬────┐
│charlotte│fred│
└─────────┴────┘
</span></div></div>
</div>
</div>
<div class="section" id="left-argument">
<h3>Left argument<a class="headerlink" href="#left-argument" title="Permalink to this headline">¶</a></h3>
<p>We can also pass a left argument to <code class="docutils literal notranslate"><span class="pre">⎕NS</span></code>, which names the namespace, <em>including nested names</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;a&#39;</span><span class="nf">⎕NS</span><span class="no">⍬</span>
<span class="nv">a</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">#.a
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;top.middle.bottom&#39;</span><span class="nf">⎕NS</span><span class="no">⍬</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">map</span> <span class="nv">top</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">#.top
·   middle
·   ·   bottom
</span></div></div>
</div>
</div>
</div>
<span id="document-io"></span><div class="tex2jax_ignore mathjax_ignore section" id="dealing-with-real-data">
<h2>Dealing with real data<a class="headerlink" href="#dealing-with-real-data" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>You want it in one line? Does it have to fit in 80 columns?
–<em>Larry Wall</em></p>
</div></blockquote>
<p>Amazingly, we got all the way to here without once mentioning how to get data in (or out) with less than typing it in. Nor have we dealt with “real” data much. Real data is usually messy. Dyalog APL has a rich set of routines to deal with data, either as bytes on disk, or formatted as JSON or CSV (or XML, but let’s keep pretending that XML was never actually a thing), or fetching it from a database, or as an HTTP-request. Some of this stuff we won’t cover – if you need it, you’re probably capable enough as an APLer to figure it out yourself.</p>
<p>Some other resources to consult:</p>
<ul class="simple">
<li><p>Docs on <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/nget.htm">⎕NGET</a>, <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/csv.htm">⎕CSV</a>, <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/json.htm">⎕JSON</a> and (if you must) <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/xml.htm">⎕XML</a></p></li>
<li><p>Dyalog <a class="reference external" href="https://dyalog.tv/Webinar/?v=yDpRGaheEH4">webinar</a> on http, <code class="docutils literal notranslate"><span class="pre">⎕JSON</span></code> and <code class="docutils literal notranslate"><span class="pre">⎕XML</span></code></p></li>
</ul>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<div class="section" id="reading-text-files-nget">
<h3>Reading text files: <code class="docutils literal notranslate"><span class="pre">⎕NGET</span></code><a class="headerlink" href="#reading-text-files-nget" title="Permalink to this headline">¶</a></h3>
<p>The system function <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/nget.htm">⎕NGET</a> reads text files from disk:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⊃</span><span class="nf">⎕NGET</span><span class="s1">&#39;/Users/stefan/work/dyalog/file.txt&#39;</span><span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────────┬───────────────┬───────────────┬───────────────┐
│1 8 6 9 5 9 5 9│6 3 4 2 8 1 8 2│8 0 7 5 5 1 2 3│6 5 2 9 8 2 6 1│
└───────────────┴───────────────┴───────────────┴───────────────┘
</span></div></div>
</div>
<p>We can note two things from that:</p>
<ol class="simple">
<li><p>We disclose the result (actually, we pick the first item)</p></li>
<li><p>There is a <code class="docutils literal notranslate"><span class="pre">1</span></code> after the file name</p></li>
</ol>
<p>Let’s explore what happens if we don’t do these things.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕NGET</span><span class="s1">&#39;/Users/stefan/work/dyalog/file.txt&#39;</span><span class="m">1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────────────────────────────────────────────────────────────────┬───────────┬──┐
│┌───────────────┬───────────────┬───────────────┬───────────────┐│UTF-8-NOBOM│10│
││1 8 6 9 5 9 5 9│6 3 4 2 8 1 8 2│8 0 7 5 5 1 2 3│6 5 2 9 8 2 6 1││           │  │
│└───────────────┴───────────────┴───────────────┴───────────────┘│           │  │
└─────────────────────────────────────────────────────────────────┴───────────┴──┘
</span></div></div>
</div>
<p>We can see that when we read a file with <code class="docutils literal notranslate"><span class="pre">⎕NGET</span></code> we get back a vector with several elements, the first is the data itself, and the second contains information about the file’s encoding. The last one is Dyalog’s opinion of what the file’s newline separator is. This will vary across operating systems.</p>
<p>What happens if we leave out the <code class="docutils literal notranslate"><span class="pre">1</span></code> at the end?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕NGET</span><span class="s1">&#39;/Users/stefan/work/dyalog/file.txt&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────────┬───────────┬──┐
│1 8 6 9 5 9 5 9│UTF-8-NOBOM│10│
│6 3 4 2 8 1 8 2│           │  │
│8 0 7 5 5 1 2 3│           │  │
│6 5 2 9 8 2 6 1│           │  │
│               │           │  │
└───────────────┴───────────┴──┘
</span></div></div>
</div>
<p>Leaving out the <code class="docutils literal notranslate"><span class="pre">1</span></code> (or indeed instead passing the default value of <code class="docutils literal notranslate"><span class="pre">0</span></code>) returns a single character vector containing the data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍴⊃</span><span class="nf">⎕NGET</span><span class="s1">&#39;/Users/stefan/work/dyalog/file.txt&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">64
</span></div></div>
</div>
<p>This is probably not what you want in most cases when processing a text file. Note that we’ve read lines of <em>characters</em>. But we can convert them to numbers:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍎</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢↑⊃</span><span class="nf">⎕NGET</span><span class="s1">&#39;/Users/stefan/work/dyalog/file.txt&#39;</span><span class="m">1</span> <span class="c1">⍝ Note health warning below!</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 8 6 9 5 9 5 9
6 3 4 2 8 1 8 2
8 0 7 5 5 1 2 3
6 5 2 9 8 2 6 1
</span></div></div>
</div>
<p>We mixed the vector into an array of rank 2, then applied the <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/Symbols/Execute%20Symbol.htm"><em>Hydrant</em></a>, <code class="docutils literal notranslate"><span class="pre">⍎</span></code> at rank 1 (vectors). <em>Hydrant</em> is a function called  <em>Execute</em>, and it takes a string and evaluates it as if it was a little APL program, similar to how <a class="reference external" href="https://docs.python.org/3/library/functions.html#eval">eval()</a> works in Python and Perl:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍎</span> <span class="s1">&#39;1 8 6 7 5 9 5 9&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 8 6 7 5 9 5 9
</span></div></div>
</div>
<p>If you have ever seen code written in <a class="reference external" href="https://www.php.net/manual/en/intro-whatis.php">PHP</a>, you know why evaluating strings requires a degree of <a class="reference external" href="https://www.php.net/manual/en/security.database.sql-injection.php">caution</a> unless you’re certain of the provenance. Perl has a <a class="reference external" href="https://perldoc.perl.org/perlsec#Taint-mode">taint</a> mode to stop bleed-over from untrusted sources, and Python papers over the issue by decree, calling <code class="docutils literal notranslate"><span class="pre">eval()</span></code> un-Pythonic, and Guido-hated.</p>
<div class="admonition tip">
<p class="admonition-title">Tip</p>
<p>Dyalog provides more industry-strength mechanisms for converting strings to numbers in a safe manner, like <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/vfi.htm">verify-fix-input</a>, <code class="docutils literal notranslate"><span class="pre">⎕VFI</span></code></p>
</div>
<p>Anyway, enough of the yak shaving already.</p>
</div>
<div class="section" id="reading-csv-csv">
<h3>Reading CSV: <code class="docutils literal notranslate"><span class="pre">⎕CSV</span></code><a class="headerlink" href="#reading-csv-csv" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://en.wikipedia.org/wiki/Comma-separated_values">CSV</a>, or <em>comma-separated values</em>, is a data format for tabular data. It’s <a class="reference external" href="http://thomasburette.com/blog/2014/05/25/so-you-want-to-write-your-own-CSV-code/">hairier than one might think</a> to write a correct CSV parser. Fortunately, Dyalog provides one for us as the system function <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/csv.htm">⎕CSV</a>. It can be used to convert data both to and from the CSV format. The <code class="docutils literal notranslate"><span class="pre">⎕CSV</span></code> function has one extremely handy feature: it converts numbers for us, avoiding the hydrant-dance we resorted to above.</p>
<p>Consider the following decidedly not-CSV-looking data. It’s a section from the data given in Day 2 in the <a class="reference external" href="https://adventofcode.com/2020/day/2">Advent of Code</a> competition from 2020. Let’s assume we’ve already read from disk using <code class="docutils literal notranslate"><span class="pre">⎕NGET</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="s1">&#39;3-6 s: ssdsssss&#39;</span> <span class="s1">&#39;17-19 f: cnffsfffzhfnsffttms&#39;</span> <span class="s1">&#39;8-11 c: tzvtwncnwvwttp&#39;</span> <span class="s1">&#39;8-10 r: rwrrtrvttrrrr&#39;</span> <span class="s1">&#39;1-2 p: zhpjph&#39;</span> <span class="s1">&#39;4-6 l: pldnxv&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Whilst it’s not CSV, it <em>does</em> look tabular. One handy use of <code class="docutils literal notranslate"><span class="pre">⎕CSV</span></code> is to rely on it to make a table from data, and convert columns of numbers. In our case, we separate each item by converting each “non-word” character to a comma, and then ask <code class="docutils literal notranslate"><span class="pre">⎕CSV</span></code> to do the conversion:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕CSV</span><span class="p">(</span><span class="s1">&#39;\W+&#39;</span><span class="nf">⎕R</span><span class="s1">&#39;,&#39;</span><span class="o">⊢</span><span class="nv">data</span><span class="p">)</span><span class="s1">&#39;&#39;</span><span class="m">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌──┬──┬─┬───────────────────┐
│3 │6 │s│ssdsssss           │
├──┼──┼─┼───────────────────┤
│17│19│f│cnffsfffzhfnsffttms│
├──┼──┼─┼───────────────────┤
│8 │11│c│tzvtwncnwvwttp     │
├──┼──┼─┼───────────────────┤
│8 │10│r│rwrrtrvttrrrr      │
├──┼──┼─┼───────────────────┤
│1 │2 │p│zhpjph             │
├──┼──┼─┼───────────────────┤
│4 │6 │l│pldnxv             │
└──┴──┴─┴───────────────────┘
</span></div></div>
</div>
<p>We called <code class="docutils literal notranslate"><span class="pre">⎕CSV</span></code> monadically, with an argument vector containing three items. The first, in our case, is obviously the data itself. The second is called the <em>data description</em>, which is used to specify the encoding where necessary. Dyalog’s docs tells us:</p>
<blockquote>
<div><p>If omitted or empty, the file encoding is deduced</p>
</div></blockquote>
<p>The <code class="docutils literal notranslate"><span class="pre">4</span></code> at the end of that is the <em>column specifier</em>, and this is what Dyalog’s docs have to say about it:</p>
<blockquote>
<div><p>4: The field is to be interpreted numeric data but invalid numeric data is tolerated. Empty fields and fields which cannot be converted to numeric values are returned instead as character data.</p>
</div></blockquote>
<p>We can read files containing CSV data directly with <code class="docutils literal notranslate"><span class="pre">⎕CSV</span></code>, in which case the first element of the argument vector should be a character vector containing the file name. We can also use <code class="docutils literal notranslate"><span class="pre">⎕CSV</span></code> to <em>write</em> .csv files – consult Dyalog’s docs for details.</p>
</div>
<div class="section" id="reading-json-json">
<h3>Reading JSON: <code class="docutils literal notranslate"><span class="pre">⎕JSON</span></code><a class="headerlink" href="#reading-json-json" title="Permalink to this headline">¶</a></h3>
<p>Dyalog also has a function for reading (and writing) JSON, appropriately enough called <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/json.htm">⎕JSON</a>. The JSON data interchange format crops up everywhere: usually in REST-like APIs as the payload, as config files, as the document format in document-oriented databases. The name JSON is short for <em>JavaScript Object Notation</em>, and as one can expect, dealing with JSON in JavaScript is both trivial and convenient. Python’s native dictionary and list types - through luck, mostly - map pretty closely to JSON, too, making working with JSON in Python pretty simple.</p>
<p>In APL, we have a wealth of different data types: array. JSON doesn’t do arrays of rank &gt; 1. This makes a recursively defined format depending on dictionaries, like JSON, potentially more awkward to deal with. In the specific case of Dyalog APL, we do have the <em>namespace</em> which can be persuaded to act a bit like a dictionary.</p>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p>Dyalog <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/json.htm">notes</a>:</p>
<p>JSON supports a limited number of data types and there is not a direct correspondence between JSON and APL data structures. In particular:</p>
<ul class="simple">
<li><p>JSON does not support arrays with rank &gt; 1.</p></li>
<li><p>The JSON standard includes Boolean values true and false which are distinct from numeric values 1 and 0, and have no direct APL equivalent.</p></li>
<li><p>The JSON5 standard includes numeric constants Infinity, -Infinity, NaN and -NaN which have no direct APL equivalent.</p></li>
<li><p>JSON objects are named and these might not be valid names in APL.</p></li>
</ul>
</div>
<p>Whilst the <code class="docutils literal notranslate"><span class="pre">⎕JSON</span></code> function does a good job given these constraints, working with JSON data (IMHO) in Dyalog always end up feeling a smidge gritty compared with JavaScript or Python.</p>
<p>Let’s look at some examples:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">json</span> <span class="kd">←</span> <span class="s1">&#39;{&quot;key&quot;: 1, &quot;list&quot;: [1, 2, 3, {&quot;colour&quot;: &quot;red&quot;, &quot;shape&quot;: &quot;oblong&quot;, &quot;number&quot;: 5}, [98, 43, 77]]}&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Yep, that’s JSON alright. Let’s convert that to APL as vectors and namespaces:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">data</span> <span class="kd">←</span> <span class="nf">⎕JSON</span> <span class="nv">json</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">#.[JSON object]
</span></div></div>
</div>
<p>Ok, that went through without complaints, and we can see that Dyalog (correctly) thinks that the top level is “object”. We can now get at the innards of this by attribute names and indices:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span><span class="na">.</span><span class="nv">key</span>
<span class="nv">data</span><span class="na">.</span><span class="nv">list</span>
<span class="nv">data</span><span class="na">.</span><span class="nv">list</span><span class="sr">[</span><span class="m">3</span><span class="sr">]</span><span class="na">.</span><span class="nv">shape</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬─┬─┬─────────────────────────────┬────────┐
│1│2│3│#.[JSON object].[JSON object]│98 43 77│
└─┴─┴─┴─────────────────────────────┴────────┘
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">oblong
</span></div></div>
</div>
<p>Well, that looks perfectly smooth, right? But the unsmooth bit here is that in a JSON dict, the keys are <em>strings</em>, not object instance attributes which is what they end up as in our namespace. If we’re reading an unknown bit of JSON data where we don’t already know what the layout is, how do we, for example, process each key’s value in turn if the keys aren’t known to us?</p>
<p>We can list all keys in a namespace using the following construct, where <code class="docutils literal notranslate"><span class="pre">⎕NL</span></code> is the <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/nl.htm"><em>Name list</em></a> and the <code class="docutils literal notranslate"><span class="pre">¯2</span></code> magic number means that we want a vector back:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span><span class="na">.</span><span class="nf">⎕NL¯2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬────┐
│key│list│
└───┴────┘
</span></div></div>
</div>
<p>To get the corresponding values, we need to <em>evaluate</em> each such key:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span><span class="na">.</span><span class="p">(</span><span class="o">⍎</span><span class="na">¨</span><span class="nf">⎕NL¯2</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬──────────────────────────────────────────────┐
│1│┌─┬─┬─┬─────────────────────────────┬────────┐│
│ ││1│2│3│#.[JSON object].[JSON object]│98 43 77││
│ │└─┴─┴─┴─────────────────────────────┴────────┘│
└─┴──────────────────────────────────────────────┘
</span></div></div>
</div>
<p>Let’s say that we want to sum all numbers in the JSON. Here’s one way we can achieve that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Values</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">keys</span> <span class="kd">←</span> <span class="bp">⍵</span><span class="na">.</span><span class="nf">⎕NL¯2</span>
    <span class="nv">values</span> <span class="kd">←</span> <span class="nv">keys</span> <span class="kt">{</span><span class="m">0</span><span class="o">=≢</span><span class="bp">⍺:</span><span class="no">⍬</span><span class="p">⋄</span><span class="bp">⍵</span><span class="na">.</span><span class="p">(</span><span class="o">⍎</span><span class="na">¨</span><span class="bp">⍺</span><span class="p">)</span><span class="kt">}</span> <span class="bp">⍵</span> 
    <span class="m">0</span><span class="o">=≢</span><span class="bp">⍵</span><span class="na">.</span><span class="nf">⎕NL¯9</span><span class="bp">:</span><span class="nv">values</span>       <span class="c1">⍝ No nested namespaces: done</span>
    <span class="nv">values</span><span class="o">,∊</span><span class="bp">∇</span><span class="na">¨</span><span class="bp">⍵</span><span class="na">.</span><span class="p">(</span><span class="o">⍎</span><span class="na">¨</span><span class="nf">⎕NL¯9</span><span class="p">)</span>   <span class="c1">⍝ Also expand any namespaces we found as values</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">JSONSum</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="kt">{</span><span class="p">(</span><span class="m">1</span><span class="o">=</span><span class="m">2</span><span class="o">|</span><span class="nf">⎕DR</span><span class="p">)</span><span class="bp">⍵</span><span class="kt">}</span><span class="bp">⍵:⍵</span>                    <span class="c1">⍝ Are we a number?</span>
    <span class="p">(</span><span class="o">⍕≡⊢</span><span class="p">)</span><span class="bp">⍵:</span><span class="m">0</span>                           <span class="c1">⍝ Are we a string?</span>
    <span class="kt">{</span><span class="p">(</span><span class="m">326</span><span class="o">=</span><span class="nf">⎕DR</span><span class="bp">⍵</span><span class="p">)</span><span class="o">∧</span><span class="p">(</span><span class="m">0</span><span class="o">=≡</span><span class="p">)</span><span class="bp">⍵</span><span class="kt">}</span> <span class="bp">⍵:</span><span class="o">+</span><span class="na">/</span><span class="bp">∇</span><span class="nv">Values</span> <span class="bp">⍵</span>  <span class="c1">⍝ Are we an object?</span>
    <span class="o">+</span><span class="na">/</span><span class="o">∊</span><span class="bp">∇</span><span class="na">¨</span><span class="bp">⍵</span>                             <span class="c1">⍝ We&#39;re a list</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">JSONSum</span> <span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">230
</span></div></div>
</div>
<p>The bits to find the type of each field in <code class="docutils literal notranslate"><span class="pre">JSONSum</span></code> are all things you can just look up on APLCart: monadic <a class="reference external" href="http://help.dyalog.com/18.0/index.htm#Language/System%20Functions/Data%20Representation%20Monadic.htm">⎕DR</a> means <em>Data representation</em>, and you just need to feed it the right magic number.</p>
<p>There is a lot more to say about the <code class="docutils literal notranslate"><span class="pre">⎕JSON</span></code> function that we won’t go into here (we’ll see a bit more of it in the next <a class="reference internal" href="intro.html#document-http"><span class="doc std std-doc">chapter</span></a>). It can also convert JSON to a pure array format instead of using namespaces, and it can also be used to convert APL arrays <em>to</em> JSON. The interested reader will have plenty to go at in the Dyalog docs, and Morten’s webinar signposted at the top of this chapter.</p>
</div>
</div>
<span id="document-http"></span><div class="tex2jax_ignore mathjax_ignore section" id="httpcommand">
<h2>HttpCommand<a class="headerlink" href="#httpcommand" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Ignorance more frequently begets confidence than does knowledge: it is those who know little, not those who know much, who so positively assert that this or that problem will never be solved by science. –<em>Charles Darwin</em></p>
</div></blockquote>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<p>Ah yes, the web. I’m sure you’ve heard of it. Dyalog has a nifty http client library built in, called <code class="docutils literal notranslate"><span class="pre">HttpCommand</span></code>. In order to make us of it, we first need to load it up:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">hc</span> <span class="kd">←</span> <span class="nf">⎕SE</span><span class="na">.</span><span class="nv">SALT</span><span class="na">.</span><span class="nv">Load</span><span class="s1">&#39;HttpCommand&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>This loads the <code class="docutils literal notranslate"><span class="pre">HttpCommand</span></code> class, calling it <code class="docutils literal notranslate"><span class="pre">hc</span></code>. We could also have used the Dyalog user command <code class="docutils literal notranslate"><span class="pre">]load</span> <span class="pre">HttpCommand</span></code>, which loads it as <code class="docutils literal notranslate"><span class="pre">HttpCommand</span></code> – but who wants to type all that? The above approach is also usable programmatically.</p>
<div class="section" id="kanye-rest">
<h3>Kanye.rest<a class="headerlink" href="#kanye-rest" title="Permalink to this headline">¶</a></h3>
<p>There is a handy web service delivering random Kanye West quotations we can put to good use, <code class="docutils literal notranslate"><span class="pre">kanye.rest</span></code>, to demonstrate this. Kanye as a Service?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">resp</span> <span class="kd">←</span> <span class="nv">hc</span><span class="na">.</span><span class="nv">Get</span> <span class="s1">&#39;https://api.kanye.rest/&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">[rc: 0 | msg: "" | HTTP Status: 200 "OK" | ⍴Data: 25]
</span></div></div>
</div>
<p>What did we get back? Let’s look in the headers to start with:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="p">(</span><span class="bp">⍵</span><span class="sr">[;</span><span class="m">0</span><span class="sr">]</span><span class="o">∊⊂</span><span class="s1">&#39;Content-Type&#39;</span><span class="p">)</span><span class="na">⌿</span><span class="bp">⍵</span><span class="kt">}</span> <span class="nv">resp</span><span class="na">.</span><span class="nv">Headers</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────────────┬────────────────┐
│Content-Type│application/json│
└────────────┴────────────────┘
</span></div></div>
</div>
<p>We know JSON; good. Let’s unpack that.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">body</span> <span class="kd">←</span> <span class="nf">⎕JSON</span> <span class="nv">resp</span><span class="na">.</span><span class="nv">Data</span>
</pre></div>
</div>
</div>
</div>
<p>We can use the handy user command <code class="docutils literal notranslate"><span class="pre">]map</span></code> to show what the inside of a namespace looks like (and yes, there is no way you’d ever discover its existence without being told):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">map</span> <span class="nv">body</span>  <span class="c1">⍝ list the fields</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">#.[JSON object]
·   ~ quote
</span></div></div>
</div>
<p>So the payload we’re interested in is in the <code class="docutils literal notranslate"><span class="pre">quote</span></code> field of the <code class="docutils literal notranslate"><span class="pre">body</span></code> namespace:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">body</span><span class="na">.</span><span class="nv">quote</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Manga all day
</span></div></div>
</div>
<p>If we already know we’re dealing with JSON, there is a handy shortcut, called <code class="docutils literal notranslate"><span class="pre">GetJSON</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">hc</span><span class="na">.</span><span class="nv">GetJSON</span> <span class="s1">&#39;GET&#39;</span> <span class="s1">&#39;https://api.kanye.rest/&#39;</span><span class="p">)</span><span class="na">.</span><span class="nv">Data</span><span class="na">.</span><span class="nv">quote</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">There are people sleeping in parking lots
</span></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">GetJSON</span></code> will do a couple of things for us behind the scenes. It will unpack the JSON body of the http response. If we’re POSTing to the url, it will also treat a parameter namespace as the JSON body of the <em>request</em>; we’ll look at that in more detail below. One last pearl of wisdom from Kanye:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">hc</span><span class="na">.</span><span class="nv">GetJSON</span> <span class="s1">&#39;GET&#39;</span> <span class="s1">&#39;https://api.kanye.rest/&#39;</span><span class="p">)</span><span class="na">.</span><span class="nv">Data</span><span class="na">.</span><span class="nv">quote</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">I feel calm but energized
</span></div></div>
</div>
<p>Thanks for that, Kanye. Here’s the seminal <a class="reference external" href="https://open.spotify.com/track/3QHPHLAkYV5cQBUYs6rowx?si=7JnJeGWiT6aGCAXr1YlRIg">Gold Digger</a>, feat. Jamie Foxx. If you’re easily offended by colorful language, that’s probably not a choon for you.</p>
<iframe src="https://open.spotify.com/embed/track/3QHPHLAkYV5cQBUYs6rowx" width="300" height="380" frameborder="0" allowtransparency="true" allow="encrypted-media"></iframe>
</div>
<div class="section" id="a-more-complex-api">
<h3>A more complex API<a class="headerlink" href="#a-more-complex-api" title="Permalink to this headline">¶</a></h3>
<p>Anyway. Back to APL. Let’s look at a more complex API to examine a large data set. The Cloudant database <code class="docutils literal notranslate"><span class="pre">https://skruger.cloudant.com/airaccidents</span></code> contains a large data set drawn from the FAA, listing air accident reports. <a class="reference external" href="https://www.ibm.com/cloud/cloudant">Cloudant</a> is a db as a service running the open source <a class="reference external" href="https://couchdb.apache.org/">CouchDB</a> database, a JSON-over-HTTP distributed document store. Let’s pull a few documents from it and see what they look like.</p>
<p>We’re going to hit the <code class="docutils literal notranslate"><span class="pre">_all_docs</span></code> endpoint, but as this is a large database, we only want to fetch a few documents. In order to do so, we pass the parameters <code class="docutils literal notranslate"><span class="pre">limit=3</span></code> and <code class="docutils literal notranslate"><span class="pre">include_docs=true</span></code> on the URL.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">url</span> <span class="kd">←</span> <span class="s1">&#39;https://skruger.cloudant.com/airaccidents/_all_docs&#39;</span>
<span class="p">(</span><span class="nv">params</span><span class="kd">←</span><span class="nf">⎕NS</span><span class="no">⍬</span><span class="p">)</span><span class="na">.</span><span class="p">(</span><span class="nv">include_docs</span> <span class="nv">limit</span><span class="p">)</span> <span class="kd">←</span> <span class="s1">&#39;true&#39;</span> <span class="m">3</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">resp</span> <span class="kd">←</span> <span class="nv">hc</span><span class="na">.</span><span class="nv">Get</span> <span class="nv">url</span> <span class="nv">params</span>
</pre></div>
</div>
</div>
</div>
<p>We know it’s going to be JSON, as everything in CouchDB is JSON.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">body</span> <span class="kd">←</span> <span class="nf">⎕JSON</span> <span class="nv">resp</span><span class="na">.</span><span class="nv">Data</span>
<span class="sr">]</span><span class="nv">map</span> <span class="nv">body</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">#.[JSON object]
·   ~ offset rows total_rows
</span></div></div>
</div>
<p>For the <code class="docutils literal notranslate"><span class="pre">_all_docs</span></code> API endpoint, the data is returned under <code class="docutils literal notranslate"><span class="pre">rows</span></code>, and if we set the <code class="docutils literal notranslate"><span class="pre">include_docs</span></code> parameter, each of those entries will have a <code class="docutils literal notranslate"><span class="pre">doc</span></code> field, containing the document itself. Let’s look at the first one.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">map</span> <span class="nv">body</span><span class="na">.</span><span class="nv">rows</span><span class="sr">[</span><span class="m">0</span><span class="sr">]</span><span class="na">.</span><span class="nv">doc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">#.[JSON object].[JSON object].[JSON object]
·   ~ Country Latitude Location Longitude Make Model Schedule _id _rev ⍙Accident⍙32⍙Number ⍙Aircraft⍙32⍙Category ⍙Aircraft⍙32⍙Damage ⍙Airport⍙32⍙Code ⍙Airport⍙32⍙Name ⍙Air⍙32⍙Carrier ⍙Amateur⍙32⍙Built ⍙Broad⍙32⍙Phase⍙32⍙of⍙32⍙Flight ⍙Engine⍙32⍙Type ⍙Event⍙32⍙Date ⍙Event⍙32⍙Id ⍙FAR⍙32⍙Description ⍙Injury⍙32⍙Severity ⍙Investigation⍙32⍙Type ⍙Number⍙32⍙of⍙32⍙Engines ⍙Publication⍙32⍙Date ⍙Purpose⍙32⍙of⍙32⍙Flight ⍙Registration⍙32⍙Number ⍙Report⍙32⍙Status ⍙Total⍙32⍙Fatal⍙32⍙Injuries ⍙Total⍙32⍙Minor⍙32⍙Injuries ⍙Total⍙32⍙Serious⍙32⍙Injuries ⍙Total⍙32⍙Uninjured ⍙Weather⍙32⍙Condition
</span></div></div>
</div>
<p>Yuck. What <em>is</em> that‽ So the JSON field names aren’t valid APL names, meaning Dyalog had to mangle them when converting to namespaces. We <em>can</em> read them like that if we want to, for example</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">body</span><span class="na">.</span><span class="nv">rows</span><span class="sr">[</span><span class="m">0</span><span class="sr">]</span><span class="na">.</span><span class="nv">doc</span><span class="na">.</span><span class="nv">⍙Event⍙32⍙Date</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">10/10/1982
</span></div></div>
</div>
<p>but it sure hurts the eyes. A handy trick if we want to quickly peer into a nested JSON namespace thing is to… turn it back into JSON, but nicer:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="p">(</span><span class="nf">⎕JSON</span><span class="na">⍠</span><span class="s1">&#39;Compact&#39;</span> <span class="m">0</span><span class="p">)</span><span class="nv">body</span><span class="na">.</span><span class="nv">rows</span><span class="sr">[</span><span class="m">0</span><span class="sr">]</span><span class="na">.</span><span class="nv">doc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">{
  "Country": "United States",
  "Latitude": "",
  "Location": "1/4NM S. OF PEO, OR",
  "Longitude": "",
  "Make": "BELLANCA",
  "Model": "7GCBC",
  "Schedule": "",
  "_id": "42788bb50806d9cc7770d46953000c99",
  "_rev": "1-0f7d34e40be0c3d4db805cf52c4adf42",
  "Accident Number": "SEA83FYM01",
  "Aircraft Category": "Airplane",
  "Aircraft Damage": "Substantial",
  "Airport Code": "",
  "Airport Name": "",
  "Air Carrier": "",
  "Amateur Built": "No",
  "Broad Phase of Flight": "CLIMB",
  "Engine Type": "Reciprocating",
  "Event Date": "10/10/1982",
  "Event Id": "20020917X05139",
  "FAR Description": "Part 91: General Aviation",
  "Injury Severity": "Fatal(1)",
  "Investigation Type": "Accident",
  "Number of Engines": "1",
  "Publication Date": "10/10/1983",
  "Purpose of Flight": "Personal",
  "Registration Number": "N57457",
  "Report Status": "Probable Cause",
  "Total Fatal Injuries": "1",
  "Total Minor Injuries": "1",
  "Total Serious Injuries": "0",
  "Total Uninjured": "0",
  "Weather Condition": "VMC"
}
</span></div></div>
</div>
<p>As before, we could have used <code class="docutils literal notranslate"><span class="pre">GetJSON</span></code> instead, and we can utilize the scalar extension behavior of arrays of namespaces to pick out all the embedded docs in the <code class="docutils literal notranslate"><span class="pre">rows</span></code> field of the CouchDB <code class="docutils literal notranslate"><span class="pre">_all_docs</span></code> response.</p>
<p>A quirk with <code class="docutils literal notranslate"><span class="pre">GetJSON</span></code> if you’re used to, say, Python’s <code class="docutils literal notranslate"><span class="pre">requests</span></code> library, is that it will encode any parameters given as JSON and pass those in the request body, which isn’t going to work against the CouchDB API, so we need to tag on the parameters on the URL ourselves first:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">hc</span><span class="na">.</span><span class="nv">GetJSON</span> <span class="s1">&#39;GET&#39;</span> <span class="p">(</span><span class="nv">url</span><span class="o">,</span><span class="s1">&#39;?include_docs=true&amp;limit=3&#39;</span><span class="p">))</span><span class="na">.</span><span class="nv">Data</span><span class="na">.</span><span class="nv">rows</span><span class="na">.</span><span class="nv">doc</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace"> #.HttpCommand.[JSON object].[JSON object].[JSON object]  #.HttpCommand.[JSON object].[JSON object].[JSON object]  #.HttpCommand.[JSON object].[JSON object].[JSON object]
</span></div></div>
</div>
<p>The other option is to convert the data to an array instead:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">body</span> <span class="kd">←</span> <span class="nf">⎕JSON</span><span class="na">⍠</span><span class="s1">&#39;M&#39;</span> <span class="o">⊢</span> <span class="nv">resp</span><span class="na">.</span><span class="nv">Data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬──────────────────────┬──────────────────────────────────┬─┐
│0│                      │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│total_rows            │68389                             │3│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│offset                │0                                 │3│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│rows                  │                                  │2│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│2│                      │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│id                    │42788bb50806d9cc7770d46953000c99  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│key                   │42788bb50806d9cc7770d46953000c99  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│value                 │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│rev                   │1-0f7d34e40be0c3d4db805cf52c4adf42│4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│doc                   │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│_id                   │42788bb50806d9cc7770d46953000c99  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│_rev                  │1-0f7d34e40be0c3d4db805cf52c4adf42│4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Air Carrier           │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Aircraft Category     │Airplane                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Injury Severity       │Fatal(1)                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Event Id              │20020917X05139                    │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Country               │United States                     │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Airport Name          │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Fatal Injuries  │1                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Minor Injuries  │1                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Uninjured       │0                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Latitude              │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Amateur Built         │No                                │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Event Date            │10/10/1982                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Report Status         │Probable Cause                    │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Airport Code          │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│FAR Description       │Part 91: General Aviation         │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Schedule              │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Publication Date      │10/10/1983                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Longitude             │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Make                  │BELLANCA                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Model                 │7GCBC                             │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Engine Type           │Reciprocating                     │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Serious Injuries│0                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Purpose of Flight     │Personal                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Broad Phase of Flight │CLIMB                             │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Weather Condition     │VMC                               │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Aircraft Damage       │Substantial                       │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Accident Number       │SEA83FYM01                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Location              │1/4NM S. OF PEO, OR               │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Registration Number   │N57457                            │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Number of Engines     │1                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Investigation Type    │Accident                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│2│                      │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│id                    │42788bb50806d9cc7770d469530012b9  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│key                   │42788bb50806d9cc7770d469530012b9  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│value                 │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│rev                   │1-4aae09af2230b2cbb6ffec5fa2767e56│4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│doc                   │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│_id                   │42788bb50806d9cc7770d469530012b9  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│_rev                  │1-4aae09af2230b2cbb6ffec5fa2767e56│4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Air Carrier           │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Aircraft Category     │Airplane                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Injury Severity       │Non-Fatal                         │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Event Id              │20020917X05078                    │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Country               │United States                     │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Airport Name          │CHEMUNG CO.                       │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Fatal Injuries  │0                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Minor Injuries  │0                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Uninjured       │2                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Latitude              │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Amateur Built         │No                                │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Event Date            │10/10/1982                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Report Status         │Probable Cause                    │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Airport Code          │ELM                               │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│FAR Description       │Part 91: General Aviation         │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Schedule              │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Publication Date      │10/10/1983                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Longitude             │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Make                  │GLOBE                             │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Model                 │SWIFT GC-1B                       │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Engine Type           │Reciprocating                     │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Serious Injuries│0                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Purpose of Flight     │Personal                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Broad Phase of Flight │APPROACH                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Weather Condition     │VMC                               │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Aircraft Damage       │Substantial                       │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Accident Number       │NYC83LA007                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Location              │ELMIRA, NY                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Registration Number   │N50BS                             │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Number of Engines     │1                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Investigation Type    │Accident                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│2│                      │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│id                    │42788bb50806d9cc7770d46953001c8c  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│key                   │42788bb50806d9cc7770d46953001c8c  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│value                 │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│rev                   │1-0b3960a8c809e5b33b0cfb122c2fb7bb│4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│3│doc                   │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│_id                   │42788bb50806d9cc7770d46953001c8c  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│_rev                  │1-0b3960a8c809e5b33b0cfb122c2fb7bb│4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Air Carrier           │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Aircraft Category     │Airplane                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Injury Severity       │Non-Fatal                         │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Event Id              │20020917X05079                    │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Country               │United States                     │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Airport Name          │SULLIVAN CO. INT'L                │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Fatal Injuries  │0                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Minor Injuries  │0                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Uninjured       │3                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Latitude              │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Amateur Built         │No                                │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Event Date            │10/10/1982                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Report Status         │Probable Cause                    │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Airport Code          │MSV                               │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│FAR Description       │Part 91: General Aviation         │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Schedule              │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Publication Date      │10/10/1983                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Longitude             │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Make                  │CESSNA                            │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Model                 │172P                              │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Engine Type           │Reciprocating                     │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Total Serious Injuries│0                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Purpose of Flight     │Personal                          │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Broad Phase of Flight │MANEUVERING                       │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Weather Condition     │VMC                               │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Aircraft Damage       │Substantial                       │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Accident Number       │NYC83LA008                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Location              │GRAHAMSVILLE, NY                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Registration Number   │N54177                            │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Number of Engines     │1                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│4│Investigation Type    │Accident                          │4│
└─┴──────────────────────┴──────────────────────────────────┴─┘
</span></div></div>
</div>
<p>Which is actually quite suitable for this data – the documents are completely flat. The documents themselves are at “depth 4”, as indicated by the first column.</p>
<p>The database has a few handy indexes, too, which in CouchDB-speak is called <em>views</em>. Let’s look at a couple of those. The first view allows us to fetch documents based on the make of aircraft. Here’s the first entry in the index where the make of the plane involved was a Cessna:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">url</span> <span class="kd">←</span> <span class="s1">&#39;https://skruger.cloudant.com/airaccidents/_design/make/_view/by-make&#39;</span>
<span class="p">(</span><span class="nv">params</span> <span class="kd">←</span> <span class="nf">⎕NS</span><span class="no">⍬</span><span class="p">)</span><span class="na">.</span><span class="p">(</span><span class="nv">limit</span> <span class="nv">reduce</span> <span class="nv">key</span><span class="p">)</span> <span class="kd">←</span> <span class="m">1</span> <span class="s1">&#39;false&#39;</span> <span class="s1">&#39;&quot;Cessna&quot;&#39;</span>
<span class="nv">resp</span> <span class="kd">←</span> <span class="nv">hc</span><span class="na">.</span><span class="nv">Get</span> <span class="nv">url</span> <span class="nv">params</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">body</span> <span class="kd">←</span> <span class="nf">⎕JSON</span><span class="na">⍠</span><span class="s1">&#39;M&#39;</span> <span class="o">⊢</span> <span class="nv">resp</span><span class="na">.</span><span class="nv">Data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬──────────┬────────────────────────────────┬─┐
│0│          │                                │1│
├─┼──────────┼────────────────────────────────┼─┤
│1│total_rows│68387                           │3│
├─┼──────────┼────────────────────────────────┼─┤
│1│offset    │13905                           │3│
├─┼──────────┼────────────────────────────────┼─┤
│1│rows      │                                │2│
├─┼──────────┼────────────────────────────────┼─┤
│2│          │                                │1│
├─┼──────────┼────────────────────────────────┼─┤
│3│id        │5b97c6d78b17b37ceff620baf9657693│4│
├─┼──────────┼────────────────────────────────┼─┤
│3│key       │Cessna                          │4│
├─┼──────────┼────────────────────────────────┼─┤
│3│value     │1                               │3│
└─┴──────────┴────────────────────────────────┴─┘
</span></div></div>
</div>
<p>This is a materialised view, keyed on make. The view iteself contains no particularly interesting information beyond the document id and the “value” 1. We can fetch this document by the id:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">url</span> <span class="kd">←</span> <span class="s1">&#39;https://skruger.cloudant.com/airaccidents/5b97c6d78b17b37ceff620baf9657693&#39;</span>
<span class="nv">resp</span> <span class="kd">←</span> <span class="nv">hc</span><span class="na">.</span><span class="nv">Get</span> <span class="nv">url</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">body</span> <span class="kd">←</span> <span class="nf">⎕JSON</span><span class="na">⍠</span><span class="s1">&#39;M&#39;</span> <span class="o">⊢</span> <span class="nv">resp</span><span class="na">.</span><span class="nv">Data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬──────────────────────┬──────────────────────────────────┬─┐
│0│                      │                                  │1│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│_id                   │5b97c6d78b17b37ceff620baf9657693  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│_rev                  │1-8d2e3c5096718be0236ef51ff7e0f153│4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Air Carrier           │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Aircraft Category     │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Injury Severity       │Non-Fatal                         │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Event Id              │20080611X00825                    │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Country               │United States                     │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Airport Name          │PORTLAND-TROUTDALE                │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Total Fatal Injuries  │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Total Minor Injuries  │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Total Uninjured       │1                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Latitude              │45.549444                         │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Amateur Built         │No                                │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Event Date            │05/24/2008                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Report Status         │Probable Cause                    │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Airport Code          │TTD                               │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│FAR Description       │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Schedule              │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Publication Date      │06/30/2008                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Longitude             │-122.401389                       │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Make                  │Cessna                            │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Model                 │172P                              │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Engine Type           │Reciprocating                     │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Total Serious Injuries│                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Purpose of Flight     │Instructional                     │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Broad Phase of Flight │                                  │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Weather Condition     │VMC                               │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Aircraft Damage       │Substantial                       │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Accident Number       │LAX08CA156                        │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Location              │Troutdale, OR                     │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Registration Number   │N62348                            │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Number of Engines     │1                                 │4│
├─┼──────────────────────┼──────────────────────────────────┼─┤
│1│Investigation Type    │Accident                          │4│
└─┴──────────────────────┴──────────────────────────────────┴─┘
</span></div></div>
</div>
<p>but perhaps more interesting is that we can do aggregations if we enable the <code class="docutils literal notranslate"><span class="pre">reduce</span></code> part of the view. We can also exploit the CouchDB API a bit further by using a POST instead, noting that we again treat the body and URL parameters separately. Let’s say we want to find the accident distribution, per make, for a make subset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">url</span> <span class="kd">←</span> <span class="s1">&#39;https://skruger.cloudant.com/airaccidents/_design/make/_view/by-make?group=true&#39;</span>
<span class="p">(</span><span class="nv">params</span> <span class="kd">←</span> <span class="nf">⎕NS</span><span class="no">⍬</span><span class="p">)</span><span class="na">.</span><span class="nv">keys</span> <span class="kd">←</span> <span class="s1">&#39;Cessna&#39;</span> <span class="s1">&#39;Boeing&#39;</span> <span class="s1">&#39;Airbus&#39;</span> <span class="c1">⍝ Request body payload; will be JSON-encoded</span>
<span class="nv">body</span> <span class="kd">←</span> <span class="p">(</span><span class="nv">hc</span><span class="na">.</span><span class="nv">GetJSON</span> <span class="s1">&#39;POST&#39;</span> <span class="nv">url</span> <span class="nv">params</span><span class="p">)</span><span class="na">.</span><span class="nv">Data</span>
</pre></div>
</div>
</div>
</div>
<p>As we’re now relying on <code class="docutils literal notranslate"><span class="pre">GetJSON</span></code> to encode our parameter list, we no longer need the ugly double-quotes in our list of keys.</p>
<p>Reductions in CouchDB views are similar to reduces in APL. All we did there was a <code class="docutils literal notranslate"><span class="pre">+/</span></code> over the values in the view, which as we saw earlier was a “1”, grouping by key:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="p">(</span><span class="nf">⎕JSON</span><span class="na">⍠</span><span class="s1">&#39;Compact&#39;</span> <span class="m">0</span><span class="p">)</span><span class="nv">body</span><span class="na">.</span><span class="nv">rows</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">[
  {
    "key": "Cessna",
    "value": 7728
  },
  {
    "key": "Boeing",
    "value": 771
  },
  {
    "key": "Airbus",
    "value": 13
  }
]
</span></div></div>
</div>
<p>Now we’re running the risk of making this about the CouchDB API, but this is quite an interesting data set. I made a <a class="reference external" href="https://www.youtube.com/watch?v=2SXPMCvuTQA">video</a> a long time ago about it and how to process the data with map-reduce using CouchDB, and this was all inspired by a very old <a class="reference external" href="https://blog.cloudant.com/2011/01/13/mapreduce-from-the-basics-to-the-actually-useful.html">blog post</a> from Cloudant founder, <a class="reference external" href="https://www.linkedin.com/in/mlmilleratmit">Mike Miller</a>.</p>
</div>
<div class="section" id="other-useful-bits">
<h3>Other useful bits<a class="headerlink" href="#other-useful-bits" title="Permalink to this headline">¶</a></h3>
<p>You can pass a left argument 1 to <code class="docutils literal notranslate"><span class="pre">HttpCommand</span></code>’s functions to inspect what the request would have looked like had it been issued:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="nv">hc</span><span class="na">.</span><span class="nv">GetJSON</span> <span class="s1">&#39;GET&#39;</span> <span class="s1">&#39;https://api.kanye.rest/&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">GET / HTTP/1.1
Host: api.kanye.rest
Content-Type: application/json
User-Agent: Dyalog/Conga
Accept: */*
Accept-Encoding: gzip, deflate


</span></div></div>
</div>
<p>HttpCommand will strip basic auth params passed on the URL and turn them into a header instead:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span> <span class="nv">hc</span><span class="na">.</span><span class="nv">Get</span> <span class="s1">&#39;https://username:password@example.com&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">GET / HTTP/1.1
Host: example.com
User-Agent: Dyalog/Conga
Accept: */*
Accept-Encoding: gzip, deflate
Authorization: Basic dXNlcm5hbWU6cGFzc3dvcmQ=


</span></div></div>
</div>
</div>
<div class="section" id="web-scraping">
<h3>Web scraping<a class="headerlink" href="#web-scraping" title="Permalink to this headline">¶</a></h3>
<p>The Dyalog student competition in 2020 had a web-scraping problem set, problem 3, from <a class="reference external" href="https://www.dyalog.com/uploads/files/student_competition/2020_problems_phase2.pdf">Phase 2</a>, asking us to find all URLs referencing PDF-files off the competition website, <a class="reference external" href="https://www.dyalog.com/student-competition.htm">https://www.dyalog.com/student-competition.htm</a>. There will be spoilers here, so if you want to have a go yourself, stop reading here.</p>
<p>Still here? The suggestion is that we process the data as XML (<em>sigh</em>). Let’s grab that page and see what we can find:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">page</span> <span class="kd">←</span> <span class="p">(</span><span class="nv">_</span><span class="kd">←</span><span class="nv">hc</span><span class="na">.</span><span class="nv">Get</span> <span class="s1">&#39;https://www.dyalog.com/student-competition.htm&#39;</span><span class="p">)</span><span class="na">.</span><span class="nv">Data</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">xml</span> <span class="kd">←</span> <span class="nf">⎕XML</span> <span class="nv">page</span>
</pre></div>
</div>
</div>
</div>
<p>What we get back from <code class="docutils literal notranslate"><span class="pre">⎕XML</span></code> is a matrix with columns for depth, tag, content, attribute and type. We care only about the tag and attribute columns:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">tags</span> <span class="nv">attributes</span><span class="p">)</span> <span class="kd">←</span> <span class="p">(</span><span class="o">⊂</span><span class="m">1</span> <span class="m">3</span><span class="p">)</span><span class="o">⌷↓⍉</span><span class="nv">xml</span>
</pre></div>
</div>
</div>
</div>
<p>To pick out URLS, we need to look at the anchor tags:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">anchors</span> <span class="kd">←</span> <span class="p">((</span><span class="o">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="na">∘</span><span class="o">≡</span><span class="na">¨</span><span class="nv">tags</span><span class="p">)</span><span class="na">/</span><span class="nv">attributes</span>
</pre></div>
</div>
</div>
</div>
<p>Each such tag has a set of attribute key-value pairs. Let’s grab those:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">names</span> <span class="nv">vals</span><span class="p">)</span> <span class="kd">←</span> <span class="o">↓⍉⊃⍪</span><span class="na">/</span><span class="nv">anchors</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can look through the attribute values to find things that end in <code class="docutils literal notranslate"><span class="pre">.pdf</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">pdfs</span> <span class="kd">←</span> <span class="nv">vals</span><span class="na">/⍨</span><span class="kt">{</span><span class="s1">&#39;.pdf&#39;</span><span class="na">∘</span><span class="o">≡</span><span class="m">¯4</span><span class="o">↑</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">¨</span><span class="nv">vals</span>
<span class="o">↑</span><span class="m">3</span><span class="o">↑</span><span class="nv">pdfs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">uploads/files/student_competition/2020_problems_phase1.pdf
uploads/files/student_competition/2020_problems_phase2.pdf
uploads/files/student_competition/2019_problems_phase1.pdf
</span></div></div>
</div>
<p>As we can see, these are all relative URLs. To convert to absolute, we need to extract the <code class="docutils literal notranslate"><span class="pre">base</span></code>, and prepend that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">base</span> <span class="kd">←</span> <span class="o">⊃⌽⊃</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="na">∘</span><span class="o">≡</span><span class="na">¨</span><span class="nv">tags</span><span class="p">)</span><span class="na">/</span><span class="nv">attributes</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">https://www.dyalog.com/
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↑</span><span class="m">3</span><span class="o">↑</span><span class="nv">base</span><span class="na">∘</span><span class="o">,</span><span class="na">¨</span><span class="nv">pdfs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">https://www.dyalog.com/uploads/files/student_competition/2020_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2020_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2019_problems_phase1.pdf
</span></div></div>
</div>
<p>Putting it all together, we get something like</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">PastTasks</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="p">(</span><span class="nv">tags</span> <span class="nv">attributes</span><span class="p">)</span> <span class="kd">←</span> <span class="p">(</span><span class="o">⊂</span><span class="m">1</span> <span class="m">3</span><span class="p">)</span><span class="o">⌷↓⍉</span><span class="nf">⎕XML</span><span class="p">(</span><span class="nv">hc</span><span class="na">.</span><span class="nv">Get</span> <span class="bp">⍵</span><span class="p">)</span><span class="na">.</span><span class="nv">Data</span>
    <span class="p">(</span><span class="nv">names</span> <span class="nv">vals</span><span class="p">)</span> <span class="kd">←</span> <span class="o">↓⍉⊃⍪</span><span class="na">/</span><span class="p">((</span><span class="o">,</span><span class="s1">&#39;a&#39;</span><span class="p">)</span><span class="na">∘</span><span class="o">≡</span><span class="na">¨</span><span class="nv">tags</span><span class="p">)</span><span class="na">/</span><span class="nv">attributes</span> <span class="c1">⍝ Names and values of attributes of anchor tags</span>
    <span class="nv">pdfs</span> <span class="kd">←</span> <span class="nv">vals</span><span class="na">/⍨</span><span class="kt">{</span><span class="s1">&#39;.pdf&#39;</span><span class="na">∘</span><span class="o">≡</span><span class="m">¯4</span><span class="o">↑</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">¨</span><span class="nv">vals</span>
    <span class="nv">base</span> <span class="kd">←</span> <span class="o">⊃⌽⊃</span><span class="p">(</span><span class="s1">&#39;base&#39;</span><span class="na">∘</span><span class="o">≡</span><span class="na">¨</span><span class="nv">tags</span><span class="p">)</span><span class="na">/</span><span class="nv">attributes</span>
    <span class="nv">base</span><span class="na">∘</span><span class="o">,</span><span class="na">¨</span><span class="nv">pdfs</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>Here’s what we get:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↑</span><span class="nv">PastTasks</span> <span class="s1">&#39;https://www.dyalog.com/student-competition.htm&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">https://www.dyalog.com/uploads/files/student_competition/2020_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2020_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2019_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2019_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2018_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2018_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2017_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2017_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2016_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2016_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2015_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2015_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2014_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2014_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2013_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2013_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2012_problems.pdf       
https://www.dyalog.com/uploads/files/student_competition/2011_problems.pdf       
https://www.dyalog.com/uploads/files/student_competition/2010_problems.pdf       
https://www.dyalog.com/uploads/files/student_competition/2009_problems.pdf       
</span></div></div>
</div>
<p>For the sake of completeness, we could equally have solved this with some filthy regexing if we were so inclined:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">PastTasksRE</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">body</span> <span class="kd">←</span> <span class="p">(</span><span class="nv">hc</span><span class="na">.</span><span class="nv">Get</span> <span class="bp">⍵</span><span class="p">)</span><span class="na">.</span><span class="nv">Data</span>
    <span class="nv">pdfs</span> <span class="kd">←</span> <span class="s1">&#39;&lt;a href=&quot;(.+?\.pdf)&quot;&#39;</span><span class="nf">⎕S</span><span class="s1">&#39;\1&#39;</span><span class="o">⊢</span><span class="nv">body</span>
    <span class="nv">base</span> <span class="kd">←</span> <span class="s1">&#39;&lt;base href=&quot;(.+?)&quot;&#39;</span><span class="nf">⎕S</span><span class="s1">&#39;\1&#39;</span><span class="o">⊢</span><span class="nv">body</span>
    <span class="nv">base</span><span class="o">,</span><span class="na">¨</span><span class="nv">pdfs</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↑</span><span class="nv">PastTasksRE</span> <span class="s1">&#39;https://www.dyalog.com/student-competition.htm&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">https://www.dyalog.com/uploads/files/student_competition/2020_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2020_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2019_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2019_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2018_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2018_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2017_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2017_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2016_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2016_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2015_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2015_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2014_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2014_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2013_problems_phase1.pdf
https://www.dyalog.com/uploads/files/student_competition/2013_problems_phase2.pdf
https://www.dyalog.com/uploads/files/student_competition/2012_problems.pdf       
https://www.dyalog.com/uploads/files/student_competition/2011_problems.pdf       
https://www.dyalog.com/uploads/files/student_competition/2010_problems.pdf       
https://www.dyalog.com/uploads/files/student_competition/2009_problems.pdf       
</span></div></div>
</div>
<p>So which one is better? I wrote a bit on this topic on my guest <a class="reference external" href="https://www.dyalog.com/blog/2021/04/2020-problem-solving-competition-phase-ii-highlights/">blog post on Dyalog’s blog</a>. In this case, as we <em>know</em> that the page is valid XML, we can delegate a lot of complexity to the <code class="docutils literal notranslate"><span class="pre">⎕XML</span></code> function, such as different quotes, whitespace etc, which we’d need to be explicit about in anything regexy if we wanted it to be robust. However, regular expressions are hard to beat when looking for complex patterns in textual data. If the page had <em>not</em> been correct XML, it would have been a lot harder solving this problem without reaching for regular expressions.</p>
</div>
</div>
<span id="document-dfnsws"></span><div class="tex2jax_ignore mathjax_ignore section" id="the-dfns-workspace">
<h2>The dfns workspace<a class="headerlink" href="#the-dfns-workspace" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Computers are like Old Testament gods; lots of rules and no mercy.  –<em>Joseph Campbell</em></p>
</div></blockquote>
<p>Dyalog ships with a workspace called <a class="reference external" href="http://dfns.dyalog.com/sindx.htm">dfns</a>. It’s perhaps best viewed as a set of diverse examples of … stuff. Hard to explain – maybe think of it as <a class="reference external" href="https://en.wikipedia.org/wiki/John_M._Scholes">John Scholes’</a> scrap book, interesting snippets of APL code that may (or may not) be useful to other APLers. No other language I’m aware of has something like this – a folklore snapshot. The oral tradition of the language, written down.</p>
<p>As a “standard library” it’s hopelessly badly organized - so let’s not call it that, and it’s not the intention anyway. Yet it contains some real gems, and it’s outstandingly well documented, most entries accompanied by substantial essays. It contains interpreters for several languages, including <a class="reference external" href="http://dfns.dyalog.com/n_lisp.htm">Lisp</a>, tons of utility routines, a pretty comprehensive set of functions for manipulating graphs, various non-trivial data structures (<a class="reference external" href="http://dfns.dyalog.com/n_avl.htm">avl</a>, <a class="reference external" href="http://dfns.dyalog.com/n_splay.htm">splay</a>, <a class="reference external" href="http://dfns.dyalog.com/n_redblack.htm">redblack</a>) etc etc.</p>
<p>For the learner, perhaps the most productive use of the dfns ws is as inspiration: browsing through it, learning from its examples and well-documented implementations. I thought I’d highlight some of the things I’ve discovered in there and found useful.</p>
<div class="section" id="iotag">
<h3>iotag<a class="headerlink" href="#iotag" title="Permalink to this headline">¶</a></h3>
<p>A very useful little function is <a class="reference external" href="http://dfns.dyalog.com/n_iotag.htm">iotag</a>, for <code class="docutils literal notranslate"><span class="pre">iota-generalized</span></code>, although I can’t help but read it <code class="docutils literal notranslate"><span class="pre">io-tag</span></code>. It fleshes out the built-in <code class="docutils literal notranslate"><span class="pre">iota</span></code>, <code class="docutils literal notranslate"><span class="pre">⍳</span></code>, both in its monadic and dyadic forms. Let’s look at a few examples:</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;iotag&#39;</span> <span class="nf">⎕CY</span> <span class="s1">&#39;dfns&#39;</span> <span class="c1">⍝ Load the iotag function</span>
</pre></div>
</div>
</div>
</div>
<p>Inclusive range <code class="docutils literal notranslate"><span class="pre">start</span></code> to <code class="docutils literal notranslate"><span class="pre">end</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">10</span> <span class="nv">iotag</span> <span class="m">20</span> <span class="c1">⍝ ⍺ to ⍵ inclusive range</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">10 11 12 13 14 15 16 17 18 19 20
</span></div></div>
</div>
<p>…and which can also count down:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">20</span> <span class="nv">iotag</span> <span class="m">10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">20 19 18 17 16 15 14 13 12 11 10
</span></div></div>
</div>
<p>and is fine with negative numbers, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">¯10</span> <span class="nv">iotag</span> <span class="m">¯20</span>
<span class="m">¯20</span> <span class="nv">iotag</span> <span class="m">¯10</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">¯10 ¯11 ¯12 ¯13 ¯14 ¯15 ¯16 ¯17 ¯18 ¯19 ¯20
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">¯20 ¯19 ¯18 ¯17 ¯16 ¯15 ¯14 ¯13 ¯12 ¯11 ¯10
</span></div></div>
</div>
<p>We can also specify a step-size:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">10</span> <span class="nv">iotag</span> <span class="m">21</span> <span class="m">2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">10 12 14 16 18 20
</span></div></div>
</div>
<p>which doesn’t even have to be integer</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">10</span> <span class="nv">iotag</span> <span class="m">21</span> <span class="m">0.53</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">10 10.53 11.06 11.59 12.12 12.65 13.18 13.71 14.24 14.77 15.3 15.83 16.36 16.89 17.42 17.95 18.48 19.01 19.54 20.07 20.6
</span></div></div>
</div>
<p>It also understands letters:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;Q&#39;</span> <span class="nv">iotag</span> <span class="s1">&#39;H&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">QPONMLKJIH
</span></div></div>
</div>
<p>It can do many, many more things, also generalizing the <code class="docutils literal notranslate"><span class="pre">index-of</span></code> aspect of <em>iota</em>.</p>
</div>
<div class="section" id="segs">
<h3>segs<a class="headerlink" href="#segs" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="http://dfns.dyalog.com/n_segs.htm">segs</a> function splits a character vector on a set of separator chars. Whilst the implementation is simple enough to memorize – and easy enough to derive – it’s a handy tool to have access to.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;segs&#39;</span> <span class="nf">⎕CY</span> <span class="s1">&#39;dfns&#39;</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;,;: &#39;</span> <span class="nv">segs</span> <span class="s1">&#39;one,two;three four,;:five,six,&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬─────┬────┬────┬───┐
│one│two│three│four│five│six│
└───┴───┴─────┴────┴────┴───┘
</span></div></div>
</div>
<p>There isn’t much to this:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;,;: &#39;</span> <span class="kt">{</span><span class="p">(</span><span class="o">~</span><span class="bp">⍵</span><span class="o">∊</span><span class="bp">⍺</span><span class="p">)</span><span class="o">⊆</span><span class="bp">⍵</span><span class="kt">}</span> <span class="s1">&#39;one,two;three four,;:five,six,&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬─────┬────┬────┬───┐
│one│two│three│four│five│six│
└───┴───┴─────┴────┴────┴───┘
</span></div></div>
</div>
</div>
<div class="section" id="cmat-and-pmat">
<h3>cmat and pmat<a class="headerlink" href="#cmat-and-pmat" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="http://dfns.dyalog.com/n_cmat.htm">cmat</a> and <a class="reference external" href="http://dfns.dyalog.com/n_pmat.htm">pmat</a> generates combinations and permutations respectively.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;cmat&#39;</span> <span class="s1">&#39;pmat&#39;</span> <span class="nf">⎕CY</span> <span class="s1">&#39;dfns&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Starting with <code class="docutils literal notranslate"><span class="pre">cmat</span></code>, what unique ways can we combine three numbers out of 1, 2, 3, 4 and 5?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">3</span> <span class="nv">cmat</span> <span class="m">5</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 3
1 2 4
1 2 5
1 3 4
1 3 5
1 4 5
2 3 4
2 3 5
2 4 5
3 4 5
</span></div></div>
</div>
<p>Or 3 out of 5 letters?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↓</span><span class="m">3</span><span class="kt">{</span><span class="bp">⍵</span><span class="sr">[</span><span class="bp">⍺</span> <span class="nv">cmat</span><span class="o">⍴</span><span class="bp">⍵</span><span class="sr">]</span><span class="kt">}</span><span class="s1">&#39;abcde&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬───┬───┬───┬───┬───┬───┬───┬───┐
│abc│abd│abe│acd│ace│ade│bcd│bce│bde│cde│
└───┴───┴───┴───┴───┴───┴───┴───┴───┴───┘
</span></div></div>
</div>
<p>Note that <code class="docutils literal notranslate"><span class="pre">cmat</span></code> produces results that are lexicographically ordered.</p>
<p>Moving on to <code class="docutils literal notranslate"><span class="pre">pmat</span></code> we generate <em>permutations</em> instead – given an integer right argument, produce all the different ways that many items can be ordered.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">pmat</span> <span class="m">4</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 2 3 4
1 2 4 3
1 3 2 4
1 3 4 2
1 4 2 3
1 4 3 2
2 1 3 4
2 1 4 3
2 3 1 4
2 3 4 1
2 4 1 3
2 4 3 1
3 1 2 4
3 1 4 2
3 2 1 4
3 2 4 1
3 4 1 2
3 4 2 1
4 1 2 3
4 1 3 2
4 2 1 3
4 2 3 1
4 3 1 2
4 3 2 1
</span></div></div>
</div>
</div>
<div class="section" id="span-stpath-and-scc">
<h3>span, stpath and scc<a class="headerlink" href="#span-stpath-and-scc" title="Permalink to this headline">¶</a></h3>
<p>There is also an excellent set of routines for graph manipulation, path finding and searching. Whilst a full intro to those is beyond the scope I had in mind for this, we can show some simple examples that perhaps can serve as a jump-off point. The documentation is comprehensive and excellent.</p>
<p>When we deal with graphs, we want to separate the graph <em>structure</em> from the content. The graph routines in the dfns ws only deal with graph structure, so it’s up to you to relate that back to content. We’ll look at how this is done.</p>
<p>So a graph consists of a set of vertices, connected by edges that have a direction. We represent the connectivity as a vector of vectors, where the position is the “vertex id” and the content a list of other vertices reachable from here. So, for example, the graph <code class="docutils literal notranslate"><span class="pre">g</span></code></p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">0</span>
<span class="nv">g</span> <span class="kd">←</span> <span class="vg">⎕</span> <span class="kd">←</span> <span class="p">(</span><span class="m">1</span> <span class="m">2</span><span class="p">)(</span><span class="o">,</span><span class="m">2</span><span class="p">)(</span><span class="m">1</span> <span class="m">3</span><span class="p">)(</span><span class="m">0</span> <span class="m">4</span><span class="p">)(</span><span class="o">,</span><span class="no">⍬</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬─┬───┬───┬┐
│1 2│2│1 3│0 4││
└───┴─┴───┴───┴┘
</span></div></div>
</div>
<p>could be visualized like so:</p>
<p><img alt="graph1" src="_images/graph1.png" /></p>
<p>We can easily create a separate vector that holds each vertex’s contents if we wanted to, say</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">vertices</span> <span class="kd">←</span> <span class="s1">&#39;adam&#39;</span> <span class="s1">&#39;bob&#39;</span> <span class="s1">&#39;charlotte&#39;</span> <span class="s1">&#39;damian&#39;</span> <span class="s1">&#39;erica&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>Let’s load up a few of the graph functions:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;span&#39;</span> <span class="s1">&#39;stpath&#39;</span> <span class="s1">&#39;scc&#39;</span><span class="nf">⎕CY</span> <span class="s1">&#39;dfns&#39;</span>
</pre></div>
</div>
</div>
</div>
<p>…and a little helper function to show graph structure:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">show</span><span class="kd">←</span><span class="kt">{</span><span class="o">↑⍕</span><span class="na">¨</span><span class="p">(</span><span class="o">⍳⍴</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="na">¨</span><span class="s1">&#39;→&#39;</span><span class="o">,</span><span class="na">¨</span><span class="bp">⍵</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">show</span> <span class="nv">g</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0 → 1 2
1 → 2  
2 → 1 3
3 → 0 4
4 →    
</span></div></div>
</div>
<p>The function <a class="reference external" href="http://dfns.dyalog.com/n_span.htm">span</a> finds the <a class="reference external" href="https://en.wikipedia.org/wiki/Spanning_tree">spanning tree</a> of a graph, which is basically removing any cycles whilst not making any previously reachable vertices unreachable. So let’s find the (actually, one of potentially several) spanning tree for our graph <code class="docutils literal notranslate"><span class="pre">g</span></code>, rooted at vertex 0, using the function called <code class="docutils literal notranslate"><span class="pre">span</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">st</span> <span class="kd">←</span> <span class="nv">g</span> <span class="nv">span</span> <span class="m">0</span>
</pre></div>
</div>
</div>
</div>
<p>Now that we have a spanning tree, we can find shortest paths in the graph. For example, what’s the shortest path from <code class="docutils literal notranslate"><span class="pre">adam</span></code> (vertex 0) to <code class="docutils literal notranslate"><span class="pre">erica</span></code> (vertex 4)? For this we apply the function <a class="reference external" href="http://dfns.dyalog.com/n_stpath.htm">stpath</a>, <em>spanning tree path</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">vertices</span><span class="sr">[</span><span class="nv">st</span> <span class="nv">stpath</span> <span class="m">4</span><span class="sr">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌────┬─────────┬──────┬─────┐
│adam│charlotte│damian│erica│
└────┴─────────┴──────┴─────┘
</span></div></div>
</div>
<p>By pre-calculating the spanning tree, we can do quick path finding to any other node in the graph. Note though that this approach will only find one shortest path, even if several of equal length might exist.</p>
<p>The implementations for <code class="docutils literal notranslate"><span class="pre">span</span></code> and <code class="docutils literal notranslate"><span class="pre">stpath</span></code> are worth studying. Note, however, that for many path-finding applications in graphs, as the graph gets bigger there are other algorithms worth considering, like <a class="reference external" href="https://en.wikipedia.org/wiki/Dijkstra%27s_algorithm">Dijkstra’s shortest path</a>, or its heuristic cousin, <a class="reference external" href="https://en.wikipedia.org/wiki/A*_search_algorithm">A*</a>, that would cut the search space.</p>
<div class="section" id="strongly-connected-components">
<h4>Strongly Connected Components<a class="headerlink" href="#strongly-connected-components" title="Permalink to this headline">¶</a></h4>
<p>The function <a class="reference external" href="http://dfns.dyalog.com/n_scc.htm">scc</a> implements <a class="reference external" href="https://en.wikipedia.org/wiki/Tarjan%27s_strongly_connected_components_algorithm">Tarjan’s algorithm</a> for finding the strongly connected components of a graph. The strongly connected components are groups of interconnected vertices, so for example a graph defined by the following adjacency index vector</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">1</span>
<span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">graph</span> <span class="kd">←</span> <span class="p">(</span><span class="o">,</span><span class="m">2</span><span class="p">)</span> <span class="p">(</span><span class="m">1</span> <span class="m">8</span><span class="p">)</span> <span class="no">⍬</span> <span class="p">(</span><span class="o">,</span><span class="m">10</span><span class="p">)</span> <span class="p">(</span><span class="o">,</span><span class="m">9</span><span class="p">)</span> <span class="p">(</span><span class="o">,</span><span class="m">10</span><span class="p">)</span> <span class="p">(</span><span class="o">,</span><span class="m">9</span><span class="p">)</span> <span class="p">(</span><span class="o">,</span><span class="m">2</span><span class="p">)</span> <span class="p">(</span><span class="m">5</span> <span class="m">7</span><span class="p">)</span> <span class="p">(</span><span class="m">4</span> <span class="m">6</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─┬───┬┬──┬─┬──┬─┬─┬───┬───┐
│2│1 8││10│9│10│9│2│5 7│4 6│
└─┴───┴┴──┴─┴──┴─┴─┴───┴───┘
</span></div></div>
</div>
<p>has the following strongly connected components (graph has vertices labeled ⍳10):</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>1 2  8
3
4 6 10
5 7  9
</pre></div>
</div>
<p>Note how vertex 3 is not connected to any other vertices and so forms its own connected component. We can use <code class="docutils literal notranslate"><span class="pre">scc</span></code> directly on the graph adjacency index vector to label each vertex with a connected component index:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">display</span> <span class="o">↑</span><span class="p">(</span><span class="o">⍳</span><span class="m">10</span><span class="p">)</span> <span class="p">(</span><span class="nv">scc</span> <span class="nv">graph</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌→───────────────────┐
↓1 2 3 4 5 6 7 8 9 10│
│1 1 2 3 4 3 4 1 4  3│
└~───────────────────┘
</span></div></div>
</div>
<p>In the dfns ws there are also graph algorithms operating on <a class="reference external" href="http://dfns.dyalog.com/n_wGraphs.htm">weighted graphs</a> – where each edge has a cost that can differ from 1.</p>
<p>If you’re interested in using APL for graphs, there is a complete example provided for route planning in various <a class="reference external" href="http://dfns.dyalog.com/tube_n_index.htm">tube systems of world cities</a> for you to study.</p>
</div>
</div>
</div>
<span id="document-testing"></span><div class="tex2jax_ignore mathjax_ignore section" id="testing">
<h2>Testing<a class="headerlink" href="#testing" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Reminds me of the awesome bug report I saw once: ‘Everything is broken. Steps to reproduce: do anything. Expected result: it should work’. –<em>Felipe Knorr Kuhn</em></p>
</div></blockquote>
<p><img alt="bugs" src="_images/bugs.jpg" /></p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<p>APL programmers don’t need to test their code, as they always write correct code. Next chapter…</p>
<p>Ahem. Ninja master &#64;ngn offered up the following <a class="reference external" href="https://ngn.bitbucket.io/apl/unit-test-framework.dyalog">unit testing framework</a> on APL Orchard:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">≡</span> <span class="c1">⍝ usage: expectedoutput ≡ f input.  prints 1 for ok and 0 for failure</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">≡
</span></div></div>
</div>
<p>Whilst &#64;ngn was (at least partially) joking, he’s got a point.</p>
<p>There is no official testing framework blessed by Dyalog. However, APL programmers do of course test their code. We can learn a lot from Dyalog’s published source code. <a class="reference external" href="https://github.com/Dyalog/link/blob/master/StartupSession/Link/Test.dyalog">Here</a>, for example, is the test suite for the Link package. This is a fairly hefty namespace running to 2k+ LOC. If the code looks unfamiliar, it’s because it’s written in the tradfn style.</p>
<div class="section" id="a-framework">
<h3>A ‘framework’?<a class="headerlink" href="#a-framework" title="Permalink to this headline">¶</a></h3>
<p>No. But let’s look at how unit testing is handled in other languages. In Python there are (too) many testing frameworks to choose from, all different. The original unit testing framework, included in Python by default, is the imaginatively named <a class="reference external" href="https://docs.python.org/3/library/unittest.html">unittest</a> module. <code class="docutils literal notranslate"><span class="pre">unittest</span></code> talks about <code class="docutils literal notranslate"><span class="pre">test</span> <span class="pre">suites</span></code> comprising of related <code class="docutils literal notranslate"><span class="pre">test</span> <span class="pre">cases</span></code>, controlled by a <code class="docutils literal notranslate"><span class="pre">runner</span></code> and context managed by <code class="docutils literal notranslate"><span class="pre">fixtures</span></code>. There is no reason why we couldn’t have something similar in APL if we wanted to build such a thing. But we probably want to find a more APL-y way of doing that.</p>
<p>Here’s what I’d want from my testing system:</p>
<ol class="simple">
<li><p>Ability to automatically run all tests, and get a report back on which tests succeeded.</p></li>
<li><p>Ability to run a single test.</p></li>
<li><p>Easy way to create more tests and have them be picked up by the test runner.</p></li>
</ol>
<p>Here’s the first example from the <code class="docutils literal notranslate"><span class="pre">unittest</span></code> docs:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">unittest</span>

<span class="k">class</span> <span class="nc">TestStringMethods</span><span class="p">(</span><span class="n">unittest</span><span class="o">.</span><span class="n">TestCase</span><span class="p">):</span>

    <span class="k">def</span> <span class="nf">test_upper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="s1">&#39;foo&#39;</span><span class="o">.</span><span class="n">upper</span><span class="p">(),</span> <span class="s1">&#39;FOO&#39;</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">test_isupper</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertTrue</span><span class="p">(</span><span class="s1">&#39;FOO&#39;</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertFalse</span><span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="o">.</span><span class="n">isupper</span><span class="p">())</span>

    <span class="k">def</span> <span class="nf">test_split</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="n">s</span> <span class="o">=</span> <span class="s1">&#39;hello world&#39;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">assertEqual</span><span class="p">(</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(),</span> <span class="p">[</span><span class="s1">&#39;hello&#39;</span><span class="p">,</span> <span class="s1">&#39;world&#39;</span><span class="p">])</span>
        <span class="c1"># check that s.split fails when the separator is not a string</span>
        <span class="k">with</span> <span class="bp">self</span><span class="o">.</span><span class="n">assertRaises</span><span class="p">(</span><span class="ne">TypeError</span><span class="p">):</span>
            <span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>

<span class="k">if</span> <span class="vm">__name__</span> <span class="o">==</span> <span class="s1">&#39;__main__&#39;</span><span class="p">:</span>
    <span class="n">unittest</span><span class="o">.</span><span class="n">main</span><span class="p">()</span>
</pre></div>
</div>
<p>To add further tests, we just add methods starting with <code class="docutils literal notranslate"><span class="pre">test_</span></code> to the <code class="docutils literal notranslate"><span class="pre">TestStringMethods</span></code> class, and the <code class="docutils literal notranslate"><span class="pre">unittest.main()</span></code> method will run them for us. So for our first attempt, let’s try to replicate that functionality in a Dyalog namespace. Here’s our test runner, which simply executes all functions where the name starts with <code class="docutils literal notranslate"><span class="pre">test_</span></code> and produces a little report.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="bp">:</span><span class="nv">Namespace</span> <span class="nv">unittest</span>
    <span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
    <span class="nv">run</span><span class="kd">←</span><span class="kt">{</span>
        <span class="nv">tests</span> <span class="kd">←</span> <span class="s1">&#39;test_.+&#39;</span><span class="nf">⎕S</span><span class="s1">&#39;&amp;&#39;</span><span class="nf">⎕NL</span> <span class="m">¯3</span>
        <span class="m">0</span><span class="o">=≢</span><span class="nv">tests</span><span class="bp">:</span> <span class="s1">&#39;no tests found&#39;</span>
        <span class="o">↑</span><span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="na">/⍨</span><span class="m">30</span><span class="o">-≢</span><span class="bp">⍺</span><span class="p">)</span><span class="o">,</span><span class="bp">⍵</span><span class="o">⊃</span><span class="s1">&#39;[FAIL]&#39;</span> <span class="s1">&#39;[OK]&#39;</span><span class="kt">}</span><span class="na">⌿</span><span class="o">↑</span><span class="nv">tests</span> <span class="p">(</span><span class="o">⍎</span><span class="na">¨</span><span class="nv">tests</span><span class="o">,</span><span class="na">¨</span><span class="o">⊂</span><span class="s1">&#39; ⍬&#39;</span><span class="p">)</span>
    <span class="kt">}</span>
<span class="bp">:</span><span class="nv">EndNamespace</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">unittest</span><span class="na">.</span><span class="nv">run</span><span class="no">⍬</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">no tests found
</span></div></div>
</div>
<p>Let’s make some functions that we can unit test. We can take the ones from the Python example above.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">upper</span><span class="kd">←</span><span class="m">1</span><span class="na">∘</span><span class="nf">⎕C</span>
<span class="nv">isupper</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍵</span><span class="o">≡</span><span class="m">1</span><span class="nf">⎕C</span><span class="bp">⍵</span><span class="kt">}</span>
<span class="nv">split</span><span class="kd">←</span><span class="o">≠⊆⊢</span>         <span class="c1">⍝ Won&#39;t complain about a non-string separator, but hey, why should it?</span>
</pre></div>
</div>
</div>
</div>
<p>Now we can write the tests themselves. Note that as in this case the functions we’re testing are defined outside the <code class="docutils literal notranslate"><span class="pre">unittest</span></code> namespace, so we need to prefix the calls with <code class="docutils literal notranslate"><span class="pre">#.</span></code>. Note how we’re using the test framework proposed by &#64;ngn, outlined above :)</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">unittest</span><span class="na">.</span><span class="nv">test_upper</span><span class="kd">←</span><span class="kt">{</span><span class="s1">&#39;FOO&#39;</span><span class="o">≡</span><span class="c1">#.upper &#39;foo&#39;}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">unittest</span><span class="na">.</span><span class="nv">run</span><span class="no">⍬</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">test_upper....................[OK]
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">unittest</span><span class="na">.</span><span class="nv">test_isupper</span><span class="kd">←</span><span class="kt">{</span><span class="p">(</span><span class="c1">#.isupper &#39;FOO&#39;)∧~#.isupper &#39;Foo&#39;}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">unittest</span><span class="na">.</span><span class="nv">run</span><span class="no">⍬</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">test_isupper..................[OK]
test_upper....................[OK]
</span></div></div>
</div>
<p>Let’s add a test that fails.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">unittest</span><span class="na">.</span><span class="nv">test_isupper2</span><span class="kd">←</span><span class="kt">{</span><span class="p">(</span><span class="c1">#.isupper &#39;FOO&#39;)∧~#.isupper &#39;BAR&#39;} ⍝ Failing test</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">unittest</span><span class="na">.</span><span class="nv">run</span><span class="no">⍬</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">test_isupper..................[OK]  
test_isupper2.................[FAIL]
test_upper....................[OK]  
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">unittest</span><span class="na">.</span><span class="nv">test_split</span><span class="kd">←</span><span class="kt">{</span><span class="s1">&#39;hello&#39;</span> <span class="s1">&#39;world&#39;</span><span class="o">≡</span><span class="s1">&#39; &#39;</span><span class="c1">#.split &#39;hello world&#39;}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">unittest</span><span class="na">.</span><span class="nv">run</span><span class="no">⍬</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">test_isupper..................[OK]  
test_isupper2.................[FAIL]
test_split....................[OK]  
test_upper....................[OK]  
</span></div></div>
</div>
<p>We can of course run single tests trivially:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">unittest</span><span class="na">.</span><span class="nv">test_split</span><span class="no">⍬</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1
</span></div></div>
</div>
<p>Nice, simple, and surprisingly useful.</p>
</div>
<div class="section" id="data-driven-testing">
<h3>Data-driven testing<a class="headerlink" href="#data-driven-testing" title="Permalink to this headline">¶</a></h3>
<p>Data-driven testing, also known as parametrized testing, is where you provide essentially a table of inputs and expected outputs and let your testing framework run them all. This approach isn’t supported out of the box in Python’s basic <code class="docutils literal notranslate"><span class="pre">unittest</span></code> module. However, other more fully-featured Python frameworks, such as <a class="reference external" href="https://docs.pytest.org/en/stable/parametrize.html#parametrize">pytest</a>, do.</p>
<p>Here’s how that can look:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="kn">import</span> <span class="nn">pytest</span>

<span class="nd">@pytest</span><span class="o">.</span><span class="n">mark</span><span class="o">.</span><span class="n">parametrize</span><span class="p">(</span><span class="s2">&quot;test_input,expected&quot;</span><span class="p">,</span> <span class="p">[(</span><span class="s2">&quot;3+5&quot;</span><span class="p">,</span> <span class="mi">8</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;2+4&quot;</span><span class="p">,</span> <span class="mi">6</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;6*9&quot;</span><span class="p">,</span> <span class="mi">42</span><span class="p">)])</span>
<span class="k">def</span> <span class="nf">test_eval</span><span class="p">(</span><span class="n">test_input</span><span class="p">,</span> <span class="n">expected</span><span class="p">):</span>
    <span class="k">assert</span> <span class="nb">eval</span><span class="p">(</span><span class="n">test_input</span><span class="p">)</span> <span class="o">==</span> <span class="n">expected</span>
</pre></div>
</div>
<p>Here the decorator <code class="docutils literal notranslate"><span class="pre">&#64;pytest.mark.parametrize</span></code> defines the test function arguments, and then provides a list of tuples. The test runner will then call the test function with the arguments as given by each tuple in turn. Let’s see if we can achieve something similar in APL.</p>
<p>This sounds like a job for an operator: we pass a <em>function</em> to the test runner, and a vector of 3-“tuples” representing left argument, right argument and expected outcome.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">_test</span><span class="kd">←</span><span class="kt">{</span><span class="p">(</span><span class="o">⊢</span><span class="na">/</span><span class="o">↑</span><span class="bp">⍵</span><span class="p">)</span><span class="o">≡</span><span class="na">⍤</span><span class="m">0</span> <span class="m">0</span><span class="o">⊢</span><span class="bp">⍺⍺</span><span class="na">/</span><span class="m">¯1</span><span class="o">↓</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢↑</span><span class="bp">⍵</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">split</span> <span class="nv">_test</span> <span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">)</span> <span class="p">(</span><span class="s1">&#39;hello&#39;</span> <span class="s1">&#39;world&#39;</span><span class="p">))</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="p">(</span><span class="s1">&#39;hello,world&#39;</span><span class="p">)</span> <span class="p">(</span><span class="s1">&#39;hello&#39;</span> <span class="s1">&#39;world&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1
</span></div></div>
</div>
<p>What we need now is a convenient way to specify such parameter sets so they can be picked up by the test runner. We can do this by defining variables named <code class="docutils literal notranslate"><span class="pre">fn_testdata</span></code>, and have that be picked up by our unit testing namespace.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">split_testdata</span><span class="kd">←</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">)</span> <span class="p">(</span><span class="s1">&#39;hello&#39;</span> <span class="s1">&#39;world&#39;</span><span class="p">))</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="p">(</span><span class="s1">&#39;hello,world&#39;</span><span class="p">)</span> <span class="p">(</span><span class="s1">&#39;hello&#39;</span> <span class="s1">&#39;world&#39;</span><span class="p">))</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">split</span> <span class="nv">_test</span> <span class="nv">split_testdata</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1 1
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="bp">:</span><span class="nv">Namespace</span> <span class="nv">datatest</span>
    <span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
    <span class="nv">_test</span><span class="kd">←</span><span class="kt">{</span><span class="p">(</span><span class="o">⊢</span><span class="na">/</span><span class="o">↑</span><span class="bp">⍵</span><span class="p">)</span><span class="o">≡</span><span class="na">⍤</span><span class="m">0</span> <span class="m">0</span><span class="o">⊢</span><span class="bp">⍺⍺</span><span class="na">/</span><span class="m">¯1</span><span class="o">↓</span><span class="na">⍤</span><span class="m">1</span><span class="o">⊢↑</span><span class="bp">⍵</span><span class="kt">}</span>
    <span class="nv">run</span><span class="kd">←</span><span class="kt">{</span> <span class="c1">⍝ ⍵ -- ns containing functions to be tested</span>
        <span class="nv">params</span> <span class="kd">←</span> <span class="s1">&#39;_&#39;</span><span class="p">(</span><span class="o">≠⊆⊢</span><span class="p">)</span><span class="na">¨</span><span class="s1">&#39;[^_]+_testdata&#39;</span><span class="nf">⎕S</span><span class="s1">&#39;&amp;&#39;</span><span class="nf">⎕NL¯2</span><span class="m">.1</span>    <span class="c1">⍝ https://aplcart.info/?q=%E2%8E%95NL#</span>
        <span class="m">0</span><span class="o">=≢</span><span class="nv">params</span><span class="bp">:</span> <span class="s1">&#39;no test parameter sets found&#39;</span>
        <span class="nv">funs</span> <span class="kd">←</span> <span class="o">⊃</span><span class="na">¨</span><span class="o">↓</span><span class="m">¯1</span><span class="o">↓</span><span class="na">⍤</span><span class="m">1</span><span class="o">↑</span><span class="nv">params</span>                            <span class="c1">⍝ Corresponding functions defined?</span>
        <span class="nv">testable</span> <span class="kd">←</span> <span class="nv">funs</span><span class="na">/⍨</span><span class="nv">funs</span><span class="o">∊</span><span class="bp">⍵</span><span class="na">.</span><span class="nf">⎕NL¯3</span>
        <span class="nv">result</span><span class="kd">←</span><span class="bp">⍵</span><span class="na">∘</span><span class="kt">{</span><span class="p">(</span><span class="bp">⍺</span><span class="na">.</span><span class="o">⍎</span><span class="bp">⍵</span><span class="p">)</span><span class="nv">_test</span> <span class="o">⍎</span><span class="bp">⍵</span><span class="o">,</span><span class="s1">&#39;_testdata&#39;</span><span class="kt">}</span><span class="na">¨</span><span class="nv">testable</span>    <span class="c1">⍝ Run the tests</span>
        <span class="o">↑</span><span class="kt">{</span><span class="bp">⍺</span><span class="o">,</span><span class="p">(</span><span class="s1">&#39;.&#39;</span><span class="na">/⍨</span><span class="m">30</span><span class="o">-≢</span><span class="bp">⍺</span><span class="p">)</span><span class="o">,</span><span class="s1">&#39;[&#39;</span><span class="o">,</span><span class="p">(</span><span class="o">⍕+</span><span class="na">/</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="s1">&#39;/&#39;</span><span class="o">,</span><span class="p">(</span><span class="o">⍕≢</span><span class="bp">⍵</span><span class="p">)</span><span class="o">,</span><span class="s1">&#39;]&#39;</span><span class="kt">}</span><span class="na">⌿</span><span class="o">↑</span><span class="nv">testable</span> <span class="nv">result</span> <span class="c1">⍝ Format</span>
    <span class="kt">}</span>
<span class="bp">:</span><span class="nv">EndNamespace</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">datatest</span><span class="na">.</span><span class="nv">split_testdata</span><span class="kd">←</span><span class="p">(</span><span class="s1">&#39; &#39;</span> <span class="p">(</span><span class="s1">&#39;hello world&#39;</span><span class="p">)</span> <span class="p">(</span><span class="s1">&#39;hello&#39;</span> <span class="s1">&#39;world&#39;</span><span class="p">))</span> <span class="p">(</span><span class="s1">&#39;,&#39;</span> <span class="p">(</span><span class="s1">&#39;hello,world&#39;</span><span class="p">)</span> <span class="p">(</span><span class="s1">&#39;hello&#39;</span> <span class="s1">&#39;world&#39;</span><span class="p">))</span> <span class="c1">⍝ dyadic function</span>
<span class="nv">datatest</span><span class="na">.</span><span class="nv">isupper_testdata</span><span class="kd">←</span><span class="p">(</span><span class="no">⍬</span> <span class="p">(</span><span class="s1">&#39;FOO&#39;</span><span class="p">)</span> <span class="m">1</span><span class="p">)</span> <span class="p">(</span><span class="no">⍬</span> <span class="p">(</span><span class="s1">&#39;Foo&#39;</span><span class="p">)</span> <span class="m">0</span><span class="p">)</span> <span class="p">(</span><span class="no">⍬</span> <span class="p">(</span><span class="o">,</span><span class="s1">&#39;F&#39;</span><span class="p">)</span> <span class="m">1</span><span class="p">)</span> <span class="c1">⍝ monadic function</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">datatest</span><span class="na">.</span><span class="nv">run</span> <span class="nf">⎕THIS</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">isupper.......................[3/3]
split.........................[2/2]
</span></div></div>
</div>
<p>So there we have it. Of course, in a real project you may want a slightly more fleshed out test framework, capable of testing for exceptions etc.</p>
</div>
</div>
<span id="document-workflow"></span><div class="tex2jax_ignore mathjax_ignore section" id="a-dyalog-workflow-or-two">
<h2>A Dyalog workflow. Or two.<a class="headerlink" href="#a-dyalog-workflow-or-two" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>I don’t know how many of you have ever met Dijkstra, but you probably know that arrogance in computer science is measured in nano-Dijkstras.
–<em>Alan Kay</em></p>
</div></blockquote>
<p>For the majority of the examples we’ll encounter in this book, you can just type them directly into the Dyalog IDE, or TryAPL, and when you understand the point made, scrap them. But as you progress, sooner or later you will want to save your work to disk.</p>
<p>If you have a similar background to me, you’ll expect to be able to write your code using an editor of your choice, arranging it into files containing logically related routines, which you then put into a source code revision management system, like git, perhaps triggering a build and test pipeline on every commit via something like jenkins or circle-ci. This is most likely in the neighbourhood of your current workflow, regardless of which language or platform you’re using, from ADA to Zig.</p>
<p>Before we get into the practicalities of how you can do this and more, we’ll need a slight diversion into the history of APL and Dyalog in particular [<a class="reference external" href="https://dl.acm.org/doi/pdf/10.1145/3386319">Kromb&amp;Hui2020</a>]. Firstly, APL predates all these workflows and build tools. That in itself isn’t an issue: so does C. But APL wasn’t really conceived as a software engineering tool. During its heyday, middle management and CFOs were slinging APL to generate forecasts and reports, and they <em>loved</em> APL as it allowed them to essentially perform tasks that up until then had been in the realm of specialist “batch processing” on the company mainframe. It essentially occupied the niche which is now dominated by Microsoft Excel.</p>
<p>This influenced all APL vendors. Commercial APL systems are full application stacks that make it seductively convenient to package up your work as binary workspaces that can be easily distributed to other APL users without ever having to “leave” the confines of the stack itself. In terms of Dyalog, its tooling and development philosophy supports this world view, as that is what its customers expect: professional Dyalog developers working for billion-dollar financial institutions will be of the opinion that you can pry their binary workspaces from their cold, dead hands. You can build fully-fledged, GUI-driven applications integrating deeply with code bases written in .NET.</p>
<p>Yet, for you, the newcomer, this approach will probably feel a bit alien. Dyalog obviously understand this, and they’re walking the tightrope of both delivering what their current paying, long-term customers need, but also a keen eye on what <em>new</em> users and potential customers might be looking to. Morten Kromberg, Dyalog CTO, wrote a <a class="reference external" href="https://www.dyalog.com/blog/2021/02/the-apl-orchard/">blog post</a> recently, ostensibly about the <a class="reference external" href="https://apl.chat">APL Orchard</a> chat room, but also touching on some of Dyalog’s challenges when dealing with this dichotomy.</p>
<p>Fortunately, and for the avoidance of any doubt, you can <em>absolutely</em> work with modern Dyalog (I’m using version 18.0) in a pretty similar way to what you expect, but it requires a little bit of setup to get right, and is not quite there “out of the box” at the time of writing. However, at the time of <em>reading</em> some of the kinks may well have been ironed out: better support for Dyalog as a scripting engine, and working with code-as-text is a priority for Dyalog right now.</p>
<p>So let’s take a brief look at workspaces and then at the <code class="docutils literal notranslate"><span class="pre">]LINK</span></code> tool that allows you to keep your code in text files that can be versioned.</p>
<p>Other resources:</p>
<ul class="simple">
<li><p>Dyalog <a class="reference external" href="https://dyalog.tv/Webinar/?v=S3JBHDayVjU">webinar</a></p></li>
</ul>
<div class="section" id="saving-and-loading-workspaces">
<h3>Saving and loading workspaces<a class="headerlink" href="#saving-and-loading-workspaces" title="Permalink to this headline">¶</a></h3>
<p>If you open RIDE, you’ll see no “Save as..” in the menu, and your OS’s default key binding for “Save” does nothing. You might have figured out how to enter multi-line functions, and how to “fix” (somewhere between “save” and “compile”) them. Yet, when you “fix” a function, where does it go?</p>
<p>At no point were you asked for a file name. The Excel analogy might help to clarify. Think of a cell containing a formula in Excel – you’re not expecting to “save” the formula out to a separate file. Instead, the formula becomes an integral part of the sheet or workbook. We can think of Dyalog workspaces as analoguous to Excel workbooks: a snapshot of values and logic to manipulate them. It has the nice feature that if you distribute a workspace, you can be sure that users of that workspace sees exactly what you intended: it’s an exact snapshot.</p>
<p>Let’s try this out. In a new RIDE session, let’s create a few functions and variables, like so:
<img alt="workspace1" src="_images/ws1.png" /></p>
<p>To save the workspace into a workspace file, type</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>)save myworkspace
Cannot perform operation with trace/edit windows open.
</pre></div>
</div>
<p>Ooops, that didn’t work. Dyalog can only save a workspace if you close down all edit windows first. So let’s do that, and once you’ve saved your workspace, close down the session and reopen a fresh one.</p>
<p>To get back your workspace, type</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>)load myworkspace
</pre></div>
</div>
<p><img alt="workspace2" src="_images/ws3.png" /></p>
<p>We can use the commands <code class="docutils literal notranslate"><span class="pre">)vars</span></code> to see the defined variables, and <code class="docutils literal notranslate"><span class="pre">)fns</span></code> to show the names of any functions contained in the workspace. As we can see, they’re all present and correct. If you find yourself using a set of utility functions over and over, they might be usefully combined into a workspace that you can then load up as a unit with a simple <code class="docutils literal notranslate"><span class="pre">)load</span></code> command. As you might expect, the workspace concept is deeply engrained in Dyalog and it comes with rich, sophisticated, thoroughly battle-tested functionality – all of which is overkill for our needs right now. If you want to explore this further, Legrand’s book, <a class="reference external" href="https://www.dyalog.com/uploads/documents/MasteringDyalogAPL.pdf">Mastering Dyalog APL</a> covers it extensively.</p>
</div>
<div class="section" id="using-link">
<h3>Using LINK<a class="headerlink" href="#using-link" title="Permalink to this headline">¶</a></h3>
<p><a class="reference external" href="https://dyalog.github.io/link/3.0/">LINK</a> is a Dyalog library that can be used to set up synchronisation between a directory of text files containing APL source code, and namespaces in your current workspace. As you may recall from the chapter on <a class="reference internal" href="intro.html#document-namespaces"><span class="doc std std-doc">namespaces</span></a>, one way to think of them is as a grouping mechanism akin to a module or class. Recent Dyalog versions come with LINK bundled, but it’s under active development and you can always install the latest version from the above link.</p>
<p>The LINK concept is pretty intuitive: a LINKed directory becomes a namespace, and all its content loaded. If you make a change to a file using an external tool or editor, that change will be reflected inside Dyalog, and if you make a change to the namespace inside Dyalog, these changes are reflected on disk. This means that you can write APL code in Emacs or VS Code, and have your Dyalog session see any changes you make. And – of course – now you can put your code in github with all that this entails in terms of your workflow.</p>
<p>Let’s work through a complete example, step by step, by building a “dict” – an array that gives the illusion of being indexable by string. Yes, you’re not the only one wishing Dyalog had one of those. Start by creating a new directory called <code class="docutils literal notranslate"><span class="pre">dict</span></code> and make a note of the full path:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>stefan-% mkdir -p ~/work/dyalog/dict
</pre></div>
</div>
<p>Now, using an editor of your choice, you’re going to create five functions, each contained in a file with the <code class="docutils literal notranslate"><span class="pre">.aplf</span></code> extension (for APL function). Here’s me editing the first one in VS Code, called <code class="docutils literal notranslate"><span class="pre">Create.aplf</span></code>:</p>
<p><img alt="dict1" src="_images/dict1.png" /></p>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>One thing you’ll notice when editing APL code in VS Code is that as VS Code also uses the option key for certain commands, it becomes a bit more tricky to type APL glyphs. You can always use the backtick as the APL key for combos that VS Code hijacks.</p>
</div>
<p>Here are the functions themselves, leaving aside for the moment how they work (or indeed if they’re particularly good):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Append</span><span class="kd">←</span><span class="kt">{</span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">0</span>
    <span class="c1">⍝ Given a vector of keys and a vector of vals append vals</span>
    <span class="bp">⍺</span><span class="na">∘</span><span class="kt">{</span>
        <span class="nv">k</span><span class="kd">←</span><span class="m">0</span><span class="o">⌷</span><span class="bp">⍵</span> <span class="p">⋄</span> <span class="nv">v</span><span class="kd">←</span><span class="m">1</span><span class="o">⌷</span><span class="bp">⍵</span>
        <span class="nv">i</span><span class="kd">←</span><span class="bp">⍺</span><span class="na">.</span><span class="nv">Keys</span><span class="o">⍳</span><span class="nv">k</span>
        <span class="nv">i</span><span class="o">=≢</span><span class="bp">⍺</span><span class="na">.</span><span class="nv">Keys</span><span class="bp">:</span><span class="m">1</span><span class="o">⊣</span><span class="bp">⍺</span><span class="na">.</span><span class="nv">Keys</span><span class="o">,</span><span class="kd">←</span><span class="nv">k</span><span class="o">⊣</span><span class="bp">⍺</span><span class="na">.</span><span class="nv">Vals</span><span class="o">,</span><span class="kd">←</span><span class="nv">v</span>  <span class="c1">⍝ New key</span>
        <span class="bp">⍺</span><span class="na">.</span><span class="nv">Vals</span><span class="sr">[</span><span class="nv">i</span><span class="sr">]</span><span class="o">,</span><span class="kd">←</span><span class="nv">v</span>                     <span class="c1">⍝ Append to existing</span>
        <span class="m">0</span>
    <span class="kt">}</span><span class="na">¨</span><span class="o">↓⍉↑</span><span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Create</span><span class="kd">←</span><span class="kt">{</span>
    <span class="nv">keys</span><span class="kd">←</span><span class="p">(</span><span class="m">1500</span><span class="na">⌶</span><span class="p">)</span><span class="o">,</span><span class="bp">⍺</span>
    <span class="nv">vals</span><span class="kd">←</span><span class="o">,</span><span class="bp">⍵</span>
    <span class="kt">{</span><span class="bp">⍵</span><span class="o">⊣</span><span class="bp">⍵</span><span class="na">.</span><span class="p">(</span><span class="nv">Vals</span> <span class="nv">Keys</span> <span class="nv">Default</span><span class="p">)</span><span class="kd">←</span><span class="nv">vals</span> <span class="nv">keys</span> <span class="no">⍬</span><span class="kt">}</span><span class="nf">⎕NS</span><span class="s1">&#39;&#39;</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Get</span><span class="kd">←</span><span class="kt">{</span>
    <span class="o">~</span><span class="bp">⍵</span> <span class="nv">In</span> <span class="bp">⍺:⍺</span><span class="na">.</span><span class="nv">Default</span>
    <span class="bp">⍺</span><span class="na">.</span><span class="nv">Vals</span><span class="sr">[</span><span class="bp">⍺</span><span class="na">.</span><span class="nv">Keys</span><span class="o">⍳</span><span class="bp">⍵</span><span class="sr">]</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">In</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍺</span><span class="o">∊</span><span class="bp">⍵</span><span class="na">.</span><span class="nv">Keys</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">Set</span><span class="kd">←</span><span class="kt">{</span><span class="nf">⎕IO</span><span class="kd">←</span><span class="m">0</span>
    <span class="c1">⍝ Upsert ht ⍺ given a vector of keys and a vector of vals</span>
    <span class="bp">⍺</span><span class="na">∘</span><span class="kt">{</span>
        <span class="nv">k</span><span class="kd">←</span><span class="m">0</span><span class="o">⌷</span><span class="bp">⍵</span> <span class="p">⋄</span> <span class="nv">v</span><span class="kd">←</span><span class="m">1</span><span class="o">⌷</span><span class="bp">⍵</span>
        <span class="nv">i</span><span class="kd">←</span><span class="bp">⍺</span><span class="na">.</span><span class="nv">Keys</span><span class="o">⍳</span><span class="nv">k</span>
        <span class="nv">i</span><span class="o">=≢</span><span class="bp">⍺</span><span class="na">.</span><span class="nv">Keys</span><span class="bp">:</span><span class="m">1</span><span class="o">⊣</span><span class="bp">⍺</span><span class="na">.</span><span class="nv">Keys</span><span class="o">,</span><span class="kd">←</span><span class="nv">k</span><span class="o">⊣</span><span class="bp">⍺</span><span class="na">.</span><span class="nv">Vals</span><span class="o">,</span><span class="kd">←</span><span class="nv">v</span> <span class="c1">⍝ New key</span>
        <span class="bp">⍺</span><span class="na">.</span><span class="nv">Vals</span><span class="sr">[</span><span class="nv">i</span><span class="sr">]</span><span class="kd">←</span><span class="nv">v</span>                     <span class="c1">⍝ Replace existing</span>
        <span class="m">0</span>
    <span class="kt">}</span><span class="na">¨</span><span class="o">↓⍉↑</span><span class="bp">⍵</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>Now open a new Dyalog session, and link this directory:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>]LINK.Create dict /Users/stefan/work/dyalog/dict
</pre></div>
</div>
<p>You should see the following:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Linked: #.dict → /Users/stefan/work/dyalog/dict
</pre></div>
</div>
<p>If you see a pop-up window with an error message about the .NET bridge not being present, this is a known bug you can ignore, see <a class="reference external" href="https://github.com/Dyalog/link/issues/166">issue 166</a>.</p>
<p>All being well, our session should now be aware of the code we just wrote. We can list the functions that Dyalog now thinks the namespace contains by executing the following obvious and intuitive “list functions in namespace” command:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>dict.⎕NL -3
Append  Create  Get  In  Set
</pre></div>
</div>
<p>Great! Our functions have clearly been loaded. Let’s see if they work, shall we?</p>
<p><img alt="link2" src="_images/link2.png" /></p>
</div>
<div class="section" id="link-limitations">
<h3>LINK limitations<a class="headerlink" href="#link-limitations" title="Permalink to this headline">¶</a></h3>
<p>That works really well so far. Any change we make in RIDE to the <code class="docutils literal notranslate"><span class="pre">dict</span></code> namespace will be reflected on disk, including new functions, or modifications of existing. However, there are a few limitations you need to be aware of here. The eagle-eyed reader may have spotted our link being one-directional only:</p>
<div class="highlight-none notranslate"><div class="highlight"><pre><span></span>Linked: #.dict → /Users/stefan/work/dyalog/dict
</pre></div>
</div>
<p>The arrow shows synchronization direction. Bi-directional sync is really what we want, but at the time of writing this is only available under Windows. Do read the <a class="reference external" href="https://github.com/Dyalog/link/wiki/Overview">docs</a> for LINK.</p>
<p>In Dyalog version 18.1 (which at the time of writing isn’t formally released yet) you can get bi-directional <code class="docutils literal notranslate"><span class="pre">]LINK</span></code> on non-Windows platforms if you also install Microsoft .NET Core 3.1.</p>
<p><img alt="l2w" src="_images/linktwoway.png" /></p>
<p>The other thing is that when you’re working this way, you’ll need to keep each function, namespace, class, or operator in its own separate file, and they all have their separate file extensions, which if you’re anything like me is quite a fine granularity, especially since APL functions tend to be pretty short.</p>
</div>
<div class="section" id="dyalogscript">
<h3>Dyalogscript<a class="headerlink" href="#dyalogscript" title="Permalink to this headline">¶</a></h3>
<p>Also in Dyalog v18.1, a new feature called <code class="docutils literal notranslate"><span class="pre">dyalogscript</span></code> is present. For me, this is a bit of a workflow game changer. <code class="docutils literal notranslate"><span class="pre">dyalogscript</span></code> allows you to execute a text file containing APL code, top to bottom, with function definitions and all, from the command-line, following standard un×x conventions. This means that with this approach you can now use Dyalog for ‘quick and dirty’ scripts where you otherwise would have reached for Python, and that you can easily share code as files, or via a github gist and have other people run it. For example, I created the following file:</p>
<p><img alt="ds" src="_images/dyalogscript.png" /></p>
<p>and can run it from the command line:</p>
<p><img alt="trm" src="_images/term.png" /></p>
</div>
<div class="section" id="jupyter-workflow">
<h3>Jupyter workflow<a class="headerlink" href="#jupyter-workflow" title="Permalink to this headline">¶</a></h3>
<p>As I’ve mentioned before, this book is composed of a set of Jupyter notebooks running the Dyalog kernel. APL is a pretty sharp tool for data analysis and ad-hoc modeling and experimentation, and as such fits neatly into the expectations and workflows that gave rise to Jupyter in the first place. The way I have ended up working with Dyalog APL is 75% Jupyter, 20% exploration and debugging in RIDE and 5% LINK for stuff I really think I might reuse.</p>
<p>Here’s a Dyalog <a class="reference external" href="https://dyalog.tv/Webinar/?v=P7rGW5ZMq9w">webinar</a> introducing the Jupyter kernel.</p>
</div>
</div>
<span id="document-next"></span><div class="tex2jax_ignore mathjax_ignore section" id="what-now">
<h2>What now?<a class="headerlink" href="#what-now" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Beware of Methodologies. They are a great way to bring everyone up to a dismal, but passable, level of performance, but at the same time, they are aggravating to more talented people who chafe at the restrictions that are placed on them. –<em>Joel Spolsky</em></p>
</div></blockquote>
<p>If you stayed with it to here, well done – you’re going to Top Gun.</p>
<p><img alt="tg" src="https://media.giphy.com/media/wrzf9P70YWLJK/giphy.gif" /></p>
<p>You should have enough skills to make a considerable dent in a problem collection such as <a class="reference external" href="https://adventofcode.com/">Advent of Code</a>, <a class="reference external" href="https://projecteuler.net/">Project Euler</a>, <a class="reference external" href="https://perlweeklychallenge.org/challenges/">Perl Weekly Challenge</a> or <a class="reference external" href="http://rosalind.info/problems/locations/">Project Rosalind</a>. What you need now is practice.</p>
<p><img alt="owl" src="_images/owl.png" /></p>
<p>A good place to start is the <a class="reference external" href="https://www.dyalog.com/student-competition.htm">Dyalog Problem Solving Competition</a>, an annual event that’s been running for a while. All the old problems are available and they are typically constructed to flatter APL’s capabilities.</p>
<p>Advent of Code is <em>great</em> – a nice ramp-up of difficulty and a Grand Tour of Computer Science 101. It’s my benchmark – I find that starting on Day01 knowing near nothing, by the time I get to Day25 I am reasonably proficient in a new language. So I thought we’d solve a couple of Advent of Code problems here. Obviously, if you don’t want to spoil it for yourself, come back here once you’ve had a go yourself.</p>
<div class="cell tag_hide-output docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nf">⎕IO</span> <span class="kd">←</span> <span class="m">0</span>
<span class="nf">⎕PP</span> <span class="kd">←</span> <span class="m">34</span>
<span class="sr">]</span><span class="nv">box</span> <span class="nv">on</span>
<span class="sr">]</span><span class="nv">rows</span> <span class="nv">on</span>
<span class="nv">assert</span><span class="kd">←</span><span class="kt">{</span><span class="bp">⍺</span><span class="kd">←</span><span class="s1">&#39;assertion failure&#39;</span> <span class="p">⋄</span> <span class="m">0</span><span class="o">∊</span><span class="bp">⍵:⍺</span> <span class="nf">⎕signal</span> <span class="m">8</span> <span class="p">⋄</span> <span class="nv">shy</span><span class="kd">←</span><span class="m">0</span><span class="kt">}</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">Was ON
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">Was OFF
</span></div></div>
</div>
<div class="section" id="toboggan-trajectory">
<h3>20/3 Toboggan Trajectory<a class="headerlink" href="#toboggan-trajectory" title="Permalink to this headline">¶</a></h3>
<p>This one is <a class="reference external" href="https://adventofcode.com/2020/day/3">day 3</a> from 2020. Note that my data will be different from yours - a feature of Advent of Code.</p>
<p>We have a 2D array of dots and hashes. The pattern is repeated indefinitely to the right. The example given is:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span><span class="kd">←</span><span class="nv">data</span> <span class="kd">←</span> <span class="m">11</span> <span class="m">11</span><span class="o">⍴</span><span class="s1">&#39;..##.......#...#...#...#....#..#...#.#...#.#.#...##..#...#.##......#.#.#....#.#........##.##...#...#...##....#.#..#...#.#&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">..##.......
#...#...#..
.#....#..#.
..#.#...#.#
.#...##..#.
..#.##.....
.#.#.#....#
.#........#
#.##...#...
#...##....#
.#..#...#.#
</span></div></div>
</div>
<p>which is then assumed to repeat to the right indefinitely, the first few like so:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span><span class="o">,</span><span class="na">⍣</span><span class="m">3</span><span class="o">⊢</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">..##.........##.........##.........##.......
#...#...#..#...#...#..#...#...#..#...#...#..
.#....#..#..#....#..#..#....#..#..#....#..#.
..#.#...#.#..#.#...#.#..#.#...#.#..#.#...#.#
.#...##..#..#...##..#..#...##..#..#...##..#.
..#.##.......#.##.......#.##.......#.##.....
.#.#.#....#.#.#.#....#.#.#.#....#.#.#.#....#
.#........#.#........#.#........#.#........#
#.##...#...#.##...#...#.##...#...#.##...#...
#...##....##...##....##...##....##...##....#
.#..#...#.#.#..#...#.#.#..#...#.#.#..#...#.#
</span></div></div>
</div>
<p>The task is to calculate how many <code class="docutils literal notranslate"><span class="pre">#</span></code> we’d encounter if, starting from the top-left corner, we follow a path which for each iteration moves three steps to the right, and one step down. In this test case, we’d encounter 7, here indicated by quads, <code class="docutils literal notranslate"><span class="pre">⎕</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">11</span> <span class="m">44</span><span class="o">⍴</span><span class="s1">&#39;0.##.........##.........##.........##.......#..0#...#..#...#...#..#...#...#..#...#...#...#....⎕..#..#....#..#..#....#..#..#....#..#...#.#...#0#..#.#...#.#..#.#...#.#..#.#...#.#.#...##..#..⎕...##..#..#...##..#..#...##..#...#.##.......#.⎕#.......#.##.......#.##......#.#.#....#.#.#.#.0..#.#.#.#....#.#.#.#....#.#........#.#........⎕.#........#.#........##.##...#...#.##...#...#.⎕#...#...#.##...#...#...##....##...##....##...#⎕....##...##....#.#..#...#.#.#..#...#.#.#..#...⎕.#.#..#...#.#&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">0.##.........##.........##.........##.......
#..0#...#..#...#...#..#...#...#..#...#...#..
.#....⎕..#..#....#..#..#....#..#..#....#..#.
..#.#...#0#..#.#...#.#..#.#...#.#..#.#...#.#
.#...##..#..⎕...##..#..#...##..#..#...##..#.
..#.##.......#.⎕#.......#.##.......#.##.....
.#.#.#....#.#.#.#.0..#.#.#.#....#.#.#.#....#
.#........#.#........⎕.#........#.#........#
#.##...#...#.##...#...#.⎕#...#...#.##...#...
#...##....##...##....##...#⎕....##...##....#
.#..#...#.#.#..#...#.#.#..#...⎕.#.#..#...#.#
</span></div></div>
</div>
<p>We can generate the coordinates for the path directly. The y-coordinate just increases by 1. The x-coordinate increases by 3 until we “fall off” the end of the pattern, after which it resets back to zero. Let’s look at this specific case.</p>
<p>If we ignore the wrap-around in x, we can get our coordinates as (assuming the pattern is shape 11 11):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↓⍉↑</span><span class="m">1</span> <span class="m">3</span><span class="o">×⊂⍳</span><span class="m">11</span> <span class="c1">⍝ Remix to create y x pairs</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬───┬───┬────┬────┬────┬────┬────┬────┬─────┐
│0 0│1 3│2 6│3 9│4 12│5 15│6 18│7 21│8 24│9 27│10 30│
└───┴───┴───┴───┴────┴────┴────┴────┴────┴────┴─────┘
</span></div></div>
</div>
<p>The wrap-around is just a mod by the shape of the pattern, in our case 11 11:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">↓⍉↑</span><span class="m">11</span> <span class="m">11</span><span class="o">|</span><span class="m">1</span> <span class="m">3</span><span class="o">×⊂⍳</span><span class="m">11</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬───┬───┬───┬───┬───┬────┬───┬───┬────┐
│0 0│1 3│2 6│3 9│4 1│5 4│6 7│7 10│8 2│9 5│10 8│
└───┴───┴───┴───┴───┴───┴───┴────┴───┴───┴────┘
</span></div></div>
</div>
<p>So we pick out the chars along this vector, look for <code class="docutils literal notranslate"><span class="pre">#</span></code> and sum:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">+</span><span class="na">⌿</span><span class="s1">&#39;#&#39;</span><span class="o">=</span><span class="nv">data</span><span class="sr">[</span><span class="o">↓⍉↑</span><span class="m">11</span> <span class="m">11</span><span class="o">|</span><span class="m">1</span> <span class="m">3</span><span class="o">×⊂⍳</span><span class="m">11</span><span class="sr">]</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">7
</span></div></div>
</div>
<p>So that works on the test data at least; good. Let’s make that generic in the pattern shape and the path offset:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kt">{</span><span class="o">+</span><span class="na">⌿</span><span class="s1">&#39;#&#39;</span><span class="o">=</span><span class="bp">⍺</span><span class="sr">[</span><span class="o">↓⍉↑</span><span class="p">(</span><span class="o">⍴</span><span class="bp">⍺</span><span class="p">)</span><span class="o">|</span><span class="bp">⍵</span><span class="o">×⊂⍳⌈</span><span class="p">(</span><span class="o">≢</span><span class="bp">⍺</span><span class="p">)</span><span class="o">÷⊃</span><span class="bp">⍵</span><span class="sr">]</span><span class="kt">}</span> <span class="m">1</span> <span class="m">3</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">7
</span></div></div>
</div>
<p>At this point we’re ready to try it on the real pattern.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="o">↑⊃</span><span class="nf">⎕NGET</span><span class="s1">&#39;../../AoCDyalog/data/2020/day03.txt&#39;</span><span class="m">1</span>
</pre></div>
</div>
</div>
</div>
<p>The real pattern is considerably larger, but as we’ve made our solution independent of pattern shape and path offset, this should not present a problem:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍴</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">323 31
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">part1</span> <span class="kd">←</span> <span class="nv">data</span> <span class="kt">{</span><span class="o">+</span><span class="na">⌿</span><span class="s1">&#39;#&#39;</span><span class="o">=</span><span class="bp">⍺</span><span class="sr">[</span><span class="o">↓⍉↑</span><span class="p">(</span><span class="o">⍴</span><span class="bp">⍺</span><span class="p">)</span><span class="o">|</span><span class="bp">⍵</span><span class="o">×⊂⍳⌈</span><span class="p">(</span><span class="o">≢</span><span class="bp">⍺</span><span class="p">)</span><span class="o">÷⊃</span><span class="bp">⍵</span><span class="sr">]</span><span class="kt">}</span> <span class="m">1</span> <span class="m">3</span>
<span class="nv">assert</span> <span class="m">203</span><span class="o">=</span><span class="nv">part1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">203
</span></div></div>
</div>
<p>That was the correct answer for part 1 (for me – you will get a different number).</p>
<p>For part 2, we’re given five slopes, and we need to multiply all results together. Not much left to do:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">part2</span> <span class="kd">←</span> <span class="o">×</span><span class="na">⌿</span><span class="nv">data</span><span class="na">∘</span><span class="kt">{</span><span class="o">+</span><span class="na">⌿</span><span class="s1">&#39;#&#39;</span><span class="o">=</span><span class="bp">⍺</span><span class="sr">[</span><span class="o">↓⍉↑</span><span class="p">(</span><span class="o">⍴</span><span class="bp">⍺</span><span class="p">)</span><span class="o">|</span><span class="bp">⍵</span><span class="o">×⊂⍳⌈</span><span class="p">(</span><span class="o">≢</span><span class="bp">⍺</span><span class="p">)</span><span class="o">÷⊃</span><span class="bp">⍵</span><span class="sr">]</span><span class="kt">}</span><span class="na">¨</span><span class="p">(</span><span class="m">1</span> <span class="m">1</span><span class="p">)(</span><span class="m">1</span> <span class="m">3</span><span class="p">)(</span><span class="m">1</span> <span class="m">5</span><span class="p">)(</span><span class="m">1</span> <span class="m">7</span><span class="p">)(</span><span class="m">2</span> <span class="m">1</span><span class="p">)</span>
<span class="nv">assert</span> <span class="m">3316272960</span><span class="o">=</span><span class="nv">part2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">3316272960
</span></div></div>
</div>
<p>So that was kind of APL home-court advantage - a nice, array-oriented solution.</p>
</div>
<div class="section" id="signals-and-noise">
<h3>16/6 Signals and Noise<a class="headerlink" href="#signals-and-noise" title="Permalink to this headline">¶</a></h3>
<p>This one is <a class="reference external" href="https://adventofcode.com/2016/day/6">day 6</a> from 2016.</p>
<p>Given a bunch of random-looking strings of letters of equal lengths, we’re to find the most commonly occurring letter in each position. We’re given the following test set:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="s1">&#39;eedadn&#39;</span> <span class="s1">&#39;drvtee&#39;</span> <span class="s1">&#39;eandsr&#39;</span> <span class="s1">&#39;raavrd&#39;</span> <span class="s1">&#39;atevrs&#39;</span> <span class="s1">&#39;tsrnev&#39;</span> <span class="s1">&#39;sdttsa&#39;</span> <span class="s1">&#39;rasrtv&#39;</span> <span class="s1">&#39;nssdts&#39;</span> <span class="s1">&#39;ntnada&#39;</span> <span class="s1">&#39;svetve&#39;</span> <span class="s1">&#39;tesnvt&#39;</span> <span class="s1">&#39;vntsnd&#39;</span> <span class="s1">&#39;vrdear&#39;</span> <span class="s1">&#39;dvrsen&#39;</span> <span class="s1">&#39;enarar&#39;</span>
<span class="o">↑</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">eedadn
drvtee
eandsr
raavrd
atevrs
tsrnev
sdttsa
rasrtv
nssdts
ntnada
svetve
tesnvt
vntsnd
vrdear
dvrsen
enarar
</span></div></div>
</div>
<p>Picking out the most commonly occurring letter in each column spells <code class="docutils literal notranslate"><span class="pre">easter</span></code>. “Most commonly occurring” should have us reach for <em>Key</em>, <code class="docutils literal notranslate"><span class="pre">⌸</span></code>. We remix the input data so that we get a vector of the columns, which we then <em>Key</em>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="bp">⍺</span><span class="o">,≢</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌸¨</span><span class="o">↓⍉↑</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬───┬───┬───┬───┐
│e 3│e 2│d 2│a 2│d 2│n 2│
│d 2│r 2│v 1│t 3│e 3│e 2│
│r 2│a 3│n 2│d 2│s 2│r 3│
│a 1│t 2│a 2│v 2│r 2│d 2│
│t 2│s 2│e 2│n 2│t 2│s 2│
│s 2│d 1│r 2│r 2│v 2│v 2│
│n 2│v 2│t 2│s 2│n 1│a 2│
│v 2│n 2│s 3│e 1│a 2│t 1│
└───┴───┴───┴───┴───┴───┘
</span></div></div>
</div>
<p>Now we sort each array based on the last column, and select the element at 0 0 in each, which should be the most frequent letter:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">∊</span><span class="kt">{</span><span class="m">0</span> <span class="m">0</span><span class="o">⌷</span><span class="bp">⍵</span><span class="sr">[</span><span class="o">⍒</span><span class="bp">⍵</span><span class="sr">[;</span><span class="m">1</span><span class="sr">];]</span><span class="kt">}</span><span class="na">¨</span><span class="kt">{</span><span class="bp">⍺</span><span class="o">,≢</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌸¨</span><span class="o">↓⍉↑</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">easter
</span></div></div>
</div>
<p>Looks promising. Let’s try that on the real data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="o">⊃</span><span class="nf">⎕NGET</span><span class="s1">&#39;../../AoCDyalog/data/2016/06.txt&#39;</span><span class="m">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">part1</span> <span class="kd">←</span> <span class="o">∊</span><span class="kt">{</span><span class="m">0</span> <span class="m">0</span><span class="o">⌷</span><span class="bp">⍵</span><span class="sr">[</span><span class="o">⍒</span><span class="bp">⍵</span><span class="sr">[;</span><span class="m">1</span><span class="sr">];]</span><span class="kt">}</span><span class="na">¨</span><span class="kt">{</span><span class="bp">⍺</span><span class="o">,≢</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌸¨</span><span class="o">↓⍉↑</span><span class="nv">data</span>
<span class="nv">assert</span> <span class="s1">&#39;qrqlznrl&#39;</span><span class="o">≡</span><span class="nv">part1</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">qrqlznrl
</span></div></div>
</div>
<p>Part 2 - the same, but now pick the <em>least</em> frequent. All we need to do is to swap grade down for grade up:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">part2</span> <span class="kd">←</span> <span class="o">∊</span><span class="kt">{</span><span class="m">0</span> <span class="m">0</span><span class="o">⌷</span><span class="bp">⍵</span><span class="sr">[</span><span class="o">⍋</span><span class="bp">⍵</span><span class="sr">[;</span><span class="m">1</span><span class="sr">];]</span><span class="kt">}</span><span class="na">¨</span><span class="kt">{</span><span class="bp">⍺</span><span class="o">,≢</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌸¨</span><span class="o">↓⍉↑</span><span class="nv">data</span>
<span class="nv">assert</span> <span class="s1">&#39;kgzdfaon&#39;</span><span class="o">≡</span><span class="nv">part2</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">kgzdfaon
</span></div></div>
</div>
<p>If we wanted to be clever, we could make that an operator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">_day6</span> <span class="kd">←</span> <span class="kt">{</span><span class="o">∊</span><span class="bp">⍺⍺</span><span class="kt">{</span><span class="m">0</span> <span class="m">0</span><span class="o">⌷</span><span class="bp">⍵</span><span class="sr">[</span><span class="bp">⍺⍺⍵</span><span class="sr">[;</span><span class="m">1</span><span class="sr">];]</span><span class="kt">}</span><span class="na">¨</span><span class="kt">{</span><span class="bp">⍺</span><span class="o">,≢</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⌸¨</span><span class="o">↓⍉↑</span><span class="bp">⍵</span><span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍒</span><span class="nv">_day6</span> <span class="nv">data</span>
<span class="o">⍋</span><span class="nv">_day6</span> <span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">qrqlznrl
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">kgzdfaon
</span></div></div>
</div>
</div>
<div class="section" id="the-stars-align">
<h3>18/10 The Stars Align<a class="headerlink" href="#the-stars-align" title="Permalink to this headline">¶</a></h3>
<p>Back in 2018, we were treated to this gem on <a class="reference external" href="https://adventofcode.com/2018/day/10">day 10</a>. We have a bunch of “stars” each having a position and a velocity. At some moment in time, these stars will align, forming a message.</p>
<p>We can reasonably guess that the message forms when the bounding box of all the stars is at its smallest. If that <em>isn’t</em> the case, then this becomes much harder, so let’s try this hypothesis first.</p>
<p>Step one is to pick out four numbers, including negatives, from each line of the input data:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span> <span class="kd">←</span> <span class="o">↑</span><span class="s1">&#39;-?\d+&#39;</span><span class="nf">⎕S</span><span class="kt">{</span><span class="o">⍎</span><span class="bp">⍵</span><span class="na">.</span><span class="nv">Match</span><span class="kt">}</span><span class="na">¨</span><span class="o">⊃</span><span class="nf">⎕NGET</span><span class="s1">&#39;../../AoCDyalog/data/2018/10.txt&#39;</span><span class="m">1</span>
</pre></div>
</div>
</div>
</div>
<p>The first two columns are the position, and the last two columns the velocity.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">pos</span> <span class="kd">←</span> <span class="o">,</span><span class="na">/</span><span class="nv">data</span><span class="sr">[;</span><span class="m">0</span> <span class="m">1</span><span class="sr">]</span>
<span class="nv">vel</span> <span class="kd">←</span> <span class="o">,</span><span class="na">/</span><span class="nv">data</span><span class="sr">[;</span><span class="m">2</span> <span class="m">3</span><span class="sr">]</span>
</pre></div>
</div>
</div>
</div>
<p>We want to minimise the bounding box. We can use the sum of the width and height of the bounding box as a single number that we can compare. Here’s a function to compute that:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">bbx</span> <span class="kd">←</span> <span class="kt">{</span><span class="o">+</span><span class="na">/</span><span class="o">|-</span><span class="na">⌿</span><span class="m">2</span> <span class="m">2</span><span class="o">⍴</span><span class="p">(</span><span class="o">⌊</span><span class="na">⌿</span><span class="o">,⌈</span><span class="na">⌿</span><span class="p">)</span><span class="o">↑</span><span class="bp">⍵</span><span class="kt">}</span> <span class="c1">⍝ Width + height of bounding box</span>
</pre></div>
</div>
</div>
</div>
<p>So we want to repeatedly apply a function (the adding of the velocity to the position) to the output of itself until we reach a defined stopping condition – when the width plus the height of the bounding box no longer decreases. This sounds like a job for the power operator:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">msg</span> <span class="kd">←</span> <span class="nv">vel</span><span class="o">-</span><span class="na">⍨</span><span class="kt">{</span><span class="nv">vel</span><span class="o">+</span><span class="bp">⍵</span><span class="kt">}</span><span class="na">⍣</span><span class="kt">{</span><span class="bp">⍺</span><span class="o">&gt;</span><span class="na">⍥</span><span class="nv">bbx</span><span class="bp">⍵</span><span class="kt">}</span><span class="o">⊢</span><span class="nv">pos</span> <span class="c1">⍝ Add velocity until bounding box no longer decreases.</span>
</pre></div>
</div>
</div>
</div>
<p>That’s actually it – but in order to actually <em>see</em> the message we need to prune it down to the bounding box, and for extra flair, use the <code class="docutils literal notranslate"><span class="pre">*</span></code> character, as shown in the question.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="nv">w</span> <span class="nv">h</span><span class="p">)</span> <span class="kd">←</span> <span class="o">|-</span><span class="na">⌿</span><span class="m">2</span> <span class="m">2</span><span class="o">⍴</span><span class="p">(</span><span class="o">⌊</span><span class="na">⌿</span><span class="o">,⌈</span><span class="na">⌿</span><span class="p">)</span><span class="o">↑</span><span class="nv">msg</span>           <span class="c1">⍝ Width and height of bounding box</span>
<span class="p">(</span><span class="o">-</span><span class="nv">h</span><span class="o">+</span><span class="m">1</span><span class="p">)(</span><span class="o">-</span><span class="nv">w</span><span class="o">+</span><span class="m">1</span><span class="p">)</span><span class="o">↑</span><span class="s1">&#39;*&#39;</span><span class="na">@</span><span class="p">(</span><span class="o">⊖</span><span class="na">¨</span><span class="nv">msg</span><span class="p">)</span><span class="o">⊢</span><span class="m">143</span> <span class="m">203</span><span class="o">⍴</span><span class="s1">&#39; &#39;</span> <span class="c1">⍝ Prune our display, and make stars</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">******  *****   *****   *****   *****   *****   ******    **  
*       *    *  *    *  *    *  *    *  *    *       *   *  * 
*       *    *  *    *  *    *  *    *  *    *       *  *    *
*       *    *  *    *  *    *  *    *  *    *      *   *    *
*****   *****   *****   *****   *****   *****      *    *    *
*       *       *  *    *    *  *  *    *  *      *     ******
*       *       *   *   *    *  *   *   *   *    *      *    *
*       *       *   *   *    *  *   *   *   *   *       *    *
*       *       *    *  *    *  *    *  *    *  *       *    *
*       *       *    *  *****   *    *  *    *  ******  *    *
</span></div></div>
</div>
</div>
<div class="section" id="the-halting-problem">
<h3>17/25 The Halting Problem<a class="headerlink" href="#the-halting-problem" title="Permalink to this headline">¶</a></h3>
<p>The <a class="reference external" href="https://adventofcode.com/2017/day/25">Christmas Day</a> problem from 2017. We’re asked to solve the <a class="reference external" href="https://en.wikipedia.org/wiki/Halting_problem">Halting Problem</a> for a Turing machine. We’re given a description of the state transitions – the program, basically. The description for state <code class="docutils literal notranslate"><span class="pre">A</span></code> is:</p>
<div class="highlight-default notranslate"><div class="highlight"><pre><span></span><span class="n">In</span> <span class="n">state</span> <span class="n">A</span><span class="p">:</span>
  <span class="n">If</span> <span class="n">the</span> <span class="n">current</span> <span class="n">value</span> <span class="ow">is</span> <span class="mi">0</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Write</span> <span class="n">the</span> <span class="n">value</span> <span class="mf">1.</span>
    <span class="o">-</span> <span class="n">Move</span> <span class="n">one</span> <span class="n">slot</span> <span class="n">to</span> <span class="n">the</span> <span class="n">right</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">Continue</span> <span class="k">with</span> <span class="n">state</span> <span class="n">B</span><span class="o">.</span>
  <span class="n">If</span> <span class="n">the</span> <span class="n">current</span> <span class="n">value</span> <span class="ow">is</span> <span class="mi">1</span><span class="p">:</span>
    <span class="o">-</span> <span class="n">Write</span> <span class="n">the</span> <span class="n">value</span> <span class="mf">0.</span>
    <span class="o">-</span> <span class="n">Move</span> <span class="n">one</span> <span class="n">slot</span> <span class="n">to</span> <span class="n">the</span> <span class="n">left</span><span class="o">.</span>
    <span class="o">-</span> <span class="n">Continue</span> <span class="k">with</span> <span class="n">state</span> <span class="n">C</span><span class="o">.</span>
</pre></div>
</div>
<p>Compiling the state descriptions into a table, we get to something along the lines of</p>
<table class="colwidths-auto docutils align-default">
<thead>
<tr class="row-odd"><th class="head"><p></p></th>
<th class="head"><p>0</p></th>
<th class="head"><p>1</p></th>
</tr>
</thead>
<tbody>
<tr class="row-even"><td><p>A</p></td>
<td><p>1 R B</p></td>
<td><p>0 L C</p></td>
</tr>
<tr class="row-odd"><td><p>B</p></td>
<td><p>1 L A</p></td>
<td><p>1 R D</p></td>
</tr>
<tr class="row-even"><td><p>C</p></td>
<td><p>1 R A</p></td>
<td><p>0 L E</p></td>
</tr>
<tr class="row-odd"><td><p>D</p></td>
<td><p>1 R A</p></td>
<td><p>0 R B</p></td>
</tr>
<tr class="row-even"><td><p>E</p></td>
<td><p>1 L F</p></td>
<td><p>1 L C</p></td>
</tr>
<tr class="row-odd"><td><p>F</p></td>
<td><p>1 R D</p></td>
<td><p>1 R A</p></td>
</tr>
</tbody>
</table>
<p>which we can translate to a neat APL 6×6 matrix:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="vg">⎕</span> <span class="kd">←</span> <span class="nv">STATE</span> <span class="kd">←</span> <span class="m">6</span> <span class="m">6</span><span class="o">⍴</span><span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">¯1</span> <span class="m">2</span> <span class="m">1</span> <span class="m">¯1</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">3</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">¯1</span> <span class="m">4</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span> <span class="m">0</span> <span class="m">1</span> <span class="m">1</span> <span class="m">1</span> <span class="m">¯1</span> <span class="m">5</span> <span class="m">1</span> <span class="m">¯1</span> <span class="m">2</span> <span class="m">1</span> <span class="m">1</span> <span class="m">3</span> <span class="m">1</span> <span class="m">1</span> <span class="m">0</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">1  1 1 0 ¯1 2
1 ¯1 0 1  1 3
1  1 0 0 ¯1 4
1  1 0 0  1 1
1 ¯1 5 1 ¯1 2
1  1 3 1  1 0
</span></div></div>
</div>
<p>We’ll need a honking loooong magnetic tape, initially set to all zeros. We don’t know the exact length, but we know we are running 12919244 iterations, so let’s make the tape that size to start with.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">TAPE</span> <span class="kd">←</span> <span class="m">12919244</span><span class="o">⍴</span><span class="m">0</span>
</pre></div>
</div>
</div>
</div>
<p>We also need a state transition function, applying the rules from the <code class="docutils literal notranslate"><span class="pre">STATE</span></code> table, reading from, and writing to <code class="docutils literal notranslate"><span class="pre">TAPE</span></code>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">stf</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="p">(</span><span class="nv">pos</span> <span class="nv">state</span><span class="p">)</span> <span class="kd">←</span> <span class="bp">⍵</span>
    <span class="nv">args</span> <span class="kd">←</span> <span class="p">(</span><span class="m">0</span> <span class="m">3</span><span class="sr">[</span><span class="nv">pos</span><span class="o">⊃</span><span class="nv">TAPE</span><span class="sr">]</span><span class="p">)</span><span class="o">+⍳</span><span class="m">3</span>
    <span class="p">(</span><span class="nv">nv</span> <span class="nv">m</span> <span class="nv">ns</span><span class="p">)</span> <span class="kd">←</span> <span class="nv">STATE</span><span class="sr">[</span><span class="nv">state</span><span class="sr">;</span><span class="nv">args</span><span class="sr">]</span>
    <span class="nv">TAPE</span><span class="sr">[</span><span class="nv">pos</span><span class="sr">]</span> <span class="kd">←</span> <span class="nv">nv</span>
    <span class="p">(</span><span class="nv">pos</span><span class="o">+</span><span class="nv">m</span><span class="p">)</span> <span class="nv">ns</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<p>We need to run 12919244 iterations. We’ll start in the middle of the tape, and hope that it is long enough:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">_</span> <span class="kd">←</span> <span class="nv">stf</span><span class="na">⍣</span><span class="m">12919244</span><span class="o">⊢</span><span class="m">6459622</span> <span class="m">0</span>  <span class="c1">⍝ Takes ~20s</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">assert</span> <span class="m">4287</span><span class="o">=</span><span class="vg">⎕</span><span class="kd">←</span><span class="o">+</span><span class="na">/</span><span class="nv">TAPE</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">4287
</span></div></div>
</div>
</div>
<div class="section" id="statsify-all-the-words">
<h3>Statsify All The Words!<a class="headerlink" href="#statsify-all-the-words" title="Permalink to this headline">¶</a></h3>
<p>Here’s a task that I was set many, many years ago for a job interview. The original task sheet is included below, suitably redacted, although I’m sure they have moved on from this by now. They were somewhat arrogant to say “use any programming language” – I only wish I’d known APL by then…</p>
<p><img alt="task" src="_images/task.png" /></p>
<p>So the task is deliberately open-ended and not fully specified; part of the expectation was to show ability to work with ambiguous requirements yadda yadda. So we’ll make a note of the assumptions we make. First we need some test data in a file; let’s make a few paragraphs of <a class="reference external" href="https://www.lipsum.com/">Lorem Ipsum</a>:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">data</span><span class="kd">←</span><span class="o">⊃</span><span class="nf">⎕NGET</span><span class="s1">&#39;/Users/stefan/work/dyalog/learnapl/loremipsum.txt&#39;</span><span class="m">1</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="m">1</span><span class="o">↑</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───────────────────────────────────────────────────────────────────────────────────────────────────────┐
│Lorem ipsum dolor sit amet, consectetur adipiscing elit. Nullam non finibus felis, id imperdiet purus. │
└───────────────────────────────────────────────────────────────────────────────────────────────────────┘
</span></div></div>
</div>
<p>This file contains Latin words, mixed case, punctuation, whitespace including empty lines. Our first assumption is that we will do all calculations case-insensitively. So we’ll pick out the words, and turn them to upper-case. There are a number of ways we could do this, but let’s use a regex solution that’s UTF-8-safe – we do want to be able to deal with not just English, right?</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">words</span><span class="kd">←</span><span class="vg">⎕</span><span class="kd">←</span><span class="p">(</span><span class="s1">&#39;\W&#39;</span> <span class="s1">&#39;.&#39;</span><span class="nf">⎕S</span> <span class="m">3</span><span class="na">⍠</span><span class="s1">&#39;UCP&#39;</span><span class="m">1</span><span class="o">⊆⊢</span><span class="p">)</span><span class="m">1</span><span class="nf">⎕C</span><span class="o">⊃,</span><span class="na">/</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬─────┬─────┬───┬────┬───────────┬──────────┬────┬──────┬───┬───────┬─────┬──┬─────────┬─────┬───────┬─────────┬──────┬────┬─────────┬─────────┬──────┬──────┬──────┬──────┬────────┬──────────┬────┬─────┬───┬──┬─────┬──────┬─────┬─────┬──┬───────┬─────┬──────────┬─────────┬──┬───────┬─────┬──┬────┬─────────┬──┬───────────┬──────┬──────┬───┬───────┬──────┬──┬─────────┬───────┬─────┬──┬─────────┬──────┬──┬───┬────┬─────┬──┬──────┬───────┬──────┬──┬───┬────┬─────────┬──┬────┬─────┬────┬────────┬─────────┬───┬──┬──────┬────┬─────────┬─────┬────┬───────┬────────┬──────┬────┬────┬────────┬─────────┬──────┬───┬───────┬──────┬──────┬────────────┬─┬───────┬────┬───┬────────┬─────┬─────┬───┬───────┬───┬──────┬──┬─────────┬─────────┬──┬──────┬──┬────────┬───────┬──┬──────┬───────────┬────────┬─────┬──┬─────────┬────┬─────┬──────┬──────┬────────┬──┬──────┬────────┬───┬───────┬──────┬───┬────────┬─────────┬───────┬─────┬────┬───────────┬─────────┬────┬────┬────────┬──────┬────────┬───────┬─────────┬────┬──┬────────┬─────┬────────┬────┬─────┬───┬───────┬────┬─────────┬──┬───────┬────┬────────┬────┬───────┬──┬────┬───────┬───────┬────┬─────────┬───┬────┬────┬─────────┬─────────┬──────┬──────┬────┬─────┬─────┬────────────┬─┬──────┬─────┬──┬─────────┬─────┬───┬───┬──────┬──┬────┬──────┬────────┬──┬───────┬───────┬──────┬────┬────────┬───────┬────┬──┬─────────┬───┬───┬────┬──┬─────┬───────┬──────┬───┬──────┬──────┬──────┬─┬─────────┬─────┬───┬──────┬───┬────┬────────┬─────────┬─────┬────────┬─────┬────┬───┬────┬────────┬─────┬───────┬──┬──────────┬────┬─────┬──────┬──┬────────┬────┬──────┬──┬────────┬───────┬───────┬─────┬───┬────────┬────┬──┬───────┬─────────┬───┬────────┬───────┬─────┬────┬───────┬────┬────────┬──┬───────┬────────┬────┬──┬─────────┬───────┬───────────┬───┬─────┬───────┬──┬─────────┬───┬────────────┬───┬────┬──┬───────────┬──────┬───┬──────┬────────┬───────┬───────┬─────────┬────┬───────┬──────┬─────┬──┬─────────┬────┬───────┬─────┬────────┬─────┬────────────┬───────┬────┬───┬──────┬────────┬─────┬──────┬─────────┬────┬──┬───────┬─────┬────┬──┬────┬───────┬─────────┬─────┬───┬───────────┬──────┬─────┬──────┬─────┬───┬──┬────────┬────┬──┬──────┬─────┬────┬────────┬────┬─────┬─────────┬──────┬────┬──┬────────┬───┬─────────┬───────┬───┬──┬────┬─────────┬───────┬────┬──┬────────┬─────┬─────┬────┬──────┬──────┬────┬────────┬──┬─────────┬───┬─────┬──────┬──┬────┬──────┬───────────┬─────┬─────┬──────┬──┬────────┬──┬──────┬─────┬────┬────────────┬───┬─────┬───────┬───────┬──────┬──┬───────┬─────┬─────┬────────┬─────┬────┬───┬─────────┬────┬───────┬─┬───────┬───┬───────┬─────┬─────────┬──────┬────┬────────┬──┬─────────┬────┬───┬───────┬───────┬────┬───┬────┬───────────┬─────┬───────────┬──┬────┬──────┬──────┬────────┬─────┬─────────┬───────┬──────┬──┬────┬────────┬────────┬────┬─────┬─────┬──────────┬───┬───────┬─────┬──────┬───┬────────┬────┬─┬─────────┬────────┬─────────┬──┬─────┬───┬────┬──────┬─────────┬────┬──┬──────┬──┬──┬───────────┬──────┬─────┬─────┬────────┬─────────┬─────┬──────┬──────┬────────┬──┬──────┬────────┬───┬───────┬──────┬───┬────────┬─────────┬───────┬────────┬──────┬─┬────┬──────┬───┬────────┬─────┬───────┬───────────┬────┬───────────┬─────┬─────┬───────┬───┬───┬──────┬─────────┬────┬─────┬─────────┬──────┬─┬───────┬──────┬─────┬──┬─────┬─────┬─┬─────┬─────┬────────┬───┬─────┬──┬─────┬──────┬───────┬───┬────┬────┬─────┬──────┬───────┬──┬─────┬──┬───────┬────────┬───┬────┬───────┬─────────┬─────┬───┬────┬───────┬────┬───┬──┬─────┬──┬────┬─────────┬────────────┬───┬────┬─────┬─────┬────────┬──┬───┬─────┬────────────┬──┬──────┬──────┬─────────┐
│LOREM│IPSUM│DOLOR│SIT│AMET│CONSECTETUR│ADIPISCING│ELIT│NULLAM│NON│FINIBUS│FELIS│ID│IMPERDIET│PURUS│ALIQUAM│HENDRERIT│SAPIEN│EGET│PORTTITOR│HENDRERIT│LIGULA│TORTOR│AUCTOR│TORTOR│ACCUMSAN│VESTIBULUM│NIBH│MAGNA│VEL│MI│ETIAM│LUCTUS│NULLA│VELIT│IN│PRETIUM│PURUS│VESTIBULUM│VULPUTATE│IN│BLANDIT│PURUS│ET│ENIM│FRINGILLA│ET│ULLAMCORPER│LIGULA│MATTIS│SED│VIVERRA│TORTOR│ID│CONSEQUAT│ALIQUET│FUSCE│UT│VULPUTATE│LIBERO│UT│SIT│AMET│MAGNA│ID│TORTOR│SODALES│RUTRUM│AC│NEC│ODIO│PHASELLUS│ID│ANTE│VITAE│NISI│SAGITTIS│FRINGILLA│NON│AT│LIBERO│CRAS│TRISTIQUE│PURUS│EGET│ALIQUAM│VEHICULA│NULLAM│ELIT│ELIT│ACCUMSAN│IMPERDIET│LIBERO│NON│ALIQUAM│TEMPOR│TURPIS│PELLENTESQUE│A│SODALES│ERAT│NAM│ULTRICES│LACUS│IPSUM│NEC│FINIBUS│DUI│AUCTOR│UT│PHASELLUS│EFFICITUR│AT│TELLUS│IN│ELEIFEND│VIVAMUS│AC│LIBERO│CONSECTETUR│SAGITTIS│RISUS│AC│FERMENTUM│NISL│CLASS│APTENT│TACITI│SOCIOSQU│AD│LITORA│TORQUENT│PER│CONUBIA│NOSTRA│PER│INCEPTOS│HIMENAEOS│ALIQUAM│VITAE│NIBH│CONSECTETUR│TINCIDUNT│ERAT│EGET│ULTRICES│LIGULA│MAECENAS│MAXIMUS│DIGNISSIM│ARCU│AT│INTERDUM│FUSCE│SUSCIPIT│NISI│JUSTO│VEL│BLANDIT│ARCU│TINCIDUNT│UT│ALIQUAM│ERAT│VOLUTPAT│CRAS│COMMODO│EX│NISL│LACINIA│LACINIA│NIBH│TINCIDUNT│SIT│AMET│NUNC│CONSEQUAT│TINCIDUNT│AUCTOR│AENEAN│EGET│DOLOR│METUS│PELLENTESQUE│A│SEMPER│RISUS│ID│ULTRICIES│METUS│SED│NON│TELLUS│AC│NISI│AUCTOR│MOLESTIE│UT│FEUGIAT│VIVERRA│SEMPER│CRAS│VEHICULA│RHONCUS│ARCU│EU│TINCIDUNT│SED│NON│NISI│ET│MAGNA│SODALES│CONGUE│NAM│CONGUE│VARIUS│LECTUS│A│VENENATIS│DONEC│NON│LIBERO│SED│ANTE│SUSCIPIT│FRINGILLA│NULLA│INTERDUM│NEQUE│ODIO│SIT│AMET│BIBENDUM│IPSUM│VIVERRA│UT│VESTIBULUM│ANTE│IPSUM│PRIMIS│IN│FAUCIBUS│ORCI│LUCTUS│ET│ULTRICES│POSUERE│CUBILIA│CURAE│NAM│PHARETRA│NUNC│UT│LAOREET│TINCIDUNT│SED│SAGITTIS│DAPIBUS│AUGUE│QUIS│EGESTAS│EROS│SUSCIPIT│ID│ALIQUAM│FAUCIBUS│NISL│UT│MALESUADA│SODALES│SUSPENDISSE│SEM│NULLA│IACULIS│UT│FRINGILLA│NEC│PELLENTESQUE│NON│NISI│IN│SCELERISQUE│MAURIS│SED│LIGULA│SUSCIPIT│DAPIBUS│INTEGER│HENDRERIT│ERAT│EUISMOD│TEMPUS│NULLA│UT│PORTTITOR│NISL│INTEGER│VITAE│ELEIFEND│AUGUE│PELLENTESQUE│ALIQUAM│NISI│SED│TEMPUS│INTERDUM│MAGNA│TELLUS│VENENATIS│DIAM│ID│IACULIS│RISUS│NUNC│EU│ODIO│INTEGER│PORTTITOR│RISUS│NON│CONSECTETUR│CURSUS│PROIN│LUCTUS│VITAE│EST│EU│VOLUTPAT│NUNC│AC│ORNARE│METUS│EGET│FAUCIBUS│ODIO│FUSCE│TINCIDUNT│TELLUS│ORCI│ET│VOLUTPAT│EST│FRINGILLA│EUISMOD│SED│ID│NUNC│FRINGILLA│PRETIUM│ANTE│AT│ULTRICES│PURUS│ETIAM│ANTE│LIGULA│VARIUS│QUIS│VEHICULA│UT│ELEMENTUM│NEC│MASSA│MAURIS│UT│URNA│TELLUS│SUSPENDISSE│FELIS│RISUS│LUCTUS│AC│ELEIFEND│UT│SEMPER│VITAE│NISI│PELLENTESQUE│NEC│FELIS│SODALES│EUISMOD│TURPIS│IN│VIVERRA│AUGUE│ETIAM│VOLUTPAT│NULLA│ANTE│VEL│MALESUADA│URNA│FINIBUS│A│INTEGER│SED│EUISMOD│AUGUE│VULPUTATE│SEMPER│URNA│PRAESENT│UT│VENENATIS│ELIT│SED│COMMODO│PRETIUM│NISL│SIT│AMET│CONSECTETUR│METUS│SCELERISQUE│IN│DUIS│MAURIS│TORTOR│FAUCIBUS│VITAE│TINCIDUNT│COMMODO│TEMPOR│ET│URNA│PRAESENT│PHARETRA│ENIM│VITAE│IPSUM│VESTIBULUM│NON│FINIBUS│RISUS│MATTIS│SED│ULTRICES│ENIM│A│FRINGILLA│ELEIFEND│PHASELLUS│AT│METUS│NEC│ARCU│MOLLIS│CONSEQUAT│DUIS│IN│ORNARE│MI│IN│SCELERISQUE│LIBERO│PORTA│RISUS│ULTRICES│VULPUTATE│CLASS│APTENT│TACITI│SOCIOSQU│AD│LITORA│TORQUENT│PER│CONUBIA│NOSTRA│PER│INCEPTOS│HIMENAEOS│QUISQUE│ELEIFEND│LECTUS│A│ERAT│CONGUE│VEL│ACCUMSAN│VELIT│IACULIS│SUSPENDISSE│EGET│CONDIMENTUM│VELIT│ETIAM│PRETIUM│LEO│NEC│MATTIS│VENENATIS│NISI│VELIT│MALESUADA│TELLUS│A│DAPIBUS│SAPIEN│MASSA│ET│PURUS│PROIN│A│MAGNA│MASSA│PRAESENT│NON│VELIT│EU│VELIT│SEMPER│EGESTAS│SIT│AMET│QUIS│MASSA│MAURIS│MAXIMUS│ID│VELIT│IN│LACINIA│PRAESENT│VEL│NISL│FINIBUS│TINCIDUNT│IPSUM│SIT│AMET│ALIQUET│ANTE│SED│AT│FELIS│IN│QUAM│VULPUTATE│PELLENTESQUE│NEC│EGET│NEQUE│DONEC│VOLUTPAT│MI│NON│MASSA│PELLENTESQUE│AT│RUTRUM│TELLUS│CONSEQUAT│
└─────┴─────┴─────┴───┴────┴───────────┴──────────┴────┴──────┴───┴───────┴─────┴──┴─────────┴─────┴───────┴─────────┴──────┴────┴─────────┴─────────┴──────┴──────┴──────┴──────┴────────┴──────────┴────┴─────┴───┴──┴─────┴──────┴─────┴─────┴──┴───────┴─────┴──────────┴─────────┴──┴───────┴─────┴──┴────┴─────────┴──┴───────────┴──────┴──────┴───┴───────┴──────┴──┴─────────┴───────┴─────┴──┴─────────┴──────┴──┴───┴────┴─────┴──┴──────┴───────┴──────┴──┴───┴────┴─────────┴──┴────┴─────┴────┴────────┴─────────┴───┴──┴──────┴────┴─────────┴─────┴────┴───────┴────────┴──────┴────┴────┴────────┴─────────┴──────┴───┴───────┴──────┴──────┴────────────┴─┴───────┴────┴───┴────────┴─────┴─────┴───┴───────┴───┴──────┴──┴─────────┴─────────┴──┴──────┴──┴────────┴───────┴──┴──────┴───────────┴────────┴─────┴──┴─────────┴────┴─────┴──────┴──────┴────────┴──┴──────┴────────┴───┴───────┴──────┴───┴────────┴─────────┴───────┴─────┴────┴───────────┴─────────┴────┴────┴────────┴──────┴────────┴───────┴─────────┴────┴──┴────────┴─────┴────────┴────┴─────┴───┴───────┴────┴─────────┴──┴───────┴────┴────────┴────┴───────┴──┴────┴───────┴───────┴────┴─────────┴───┴────┴────┴─────────┴─────────┴──────┴──────┴────┴─────┴─────┴────────────┴─┴──────┴─────┴──┴─────────┴─────┴───┴───┴──────┴──┴────┴──────┴────────┴──┴───────┴───────┴──────┴────┴────────┴───────┴────┴──┴─────────┴───┴───┴────┴──┴─────┴───────┴──────┴───┴──────┴──────┴──────┴─┴─────────┴─────┴───┴──────┴───┴────┴────────┴─────────┴─────┴────────┴─────┴────┴───┴────┴────────┴─────┴───────┴──┴──────────┴────┴─────┴──────┴──┴────────┴────┴──────┴──┴────────┴───────┴───────┴─────┴───┴────────┴────┴──┴───────┴─────────┴───┴────────┴───────┴─────┴────┴───────┴────┴────────┴──┴───────┴────────┴────┴──┴─────────┴───────┴───────────┴───┴─────┴───────┴──┴─────────┴───┴────────────┴───┴────┴──┴───────────┴──────┴───┴──────┴────────┴───────┴───────┴─────────┴────┴───────┴──────┴─────┴──┴─────────┴────┴───────┴─────┴────────┴─────┴────────────┴───────┴────┴───┴──────┴────────┴─────┴──────┴─────────┴────┴──┴───────┴─────┴────┴──┴────┴───────┴─────────┴─────┴───┴───────────┴──────┴─────┴──────┴─────┴───┴──┴────────┴────┴──┴──────┴─────┴────┴────────┴────┴─────┴─────────┴──────┴────┴──┴────────┴───┴─────────┴───────┴───┴──┴────┴─────────┴───────┴────┴──┴────────┴─────┴─────┴────┴──────┴──────┴────┴────────┴──┴─────────┴───┴─────┴──────┴──┴────┴──────┴───────────┴─────┴─────┴──────┴──┴────────┴──┴──────┴─────┴────┴────────────┴───┴─────┴───────┴───────┴──────┴──┴───────┴─────┴─────┴────────┴─────┴────┴───┴─────────┴────┴───────┴─┴───────┴───┴───────┴─────┴─────────┴──────┴────┴────────┴──┴─────────┴────┴───┴───────┴───────┴────┴───┴────┴───────────┴─────┴───────────┴──┴────┴──────┴──────┴────────┴─────┴─────────┴───────┴──────┴──┴────┴────────┴────────┴────┴─────┴─────┴──────────┴───┴───────┴─────┴──────┴───┴────────┴────┴─┴─────────┴────────┴─────────┴──┴─────┴───┴────┴──────┴─────────┴────┴──┴──────┴──┴──┴───────────┴──────┴─────┴─────┴────────┴─────────┴─────┴──────┴──────┴────────┴──┴──────┴────────┴───┴───────┴──────┴───┴────────┴─────────┴───────┴────────┴──────┴─┴────┴──────┴───┴────────┴─────┴───────┴───────────┴────┴───────────┴─────┴─────┴───────┴───┴───┴──────┴─────────┴────┴─────┴─────────┴──────┴─┴───────┴──────┴─────┴──┴─────┴─────┴─┴─────┴─────┴────────┴───┴─────┴──┴─────┴──────┴───────┴───┴────┴────┴─────┴──────┴───────┴──┴─────┴──┴───────┴────────┴───┴────┴───────┴─────────┴─────┴───┴────┴───────┴────┴───┴──┴─────┴──┴────┴─────────┴────────────┴───┴────┴─────┴─────┴────────┴──┴───┴─────┴────────────┴──┴──────┴──────┴─────────┘
</span></div></div>
</div>
<p>Is that sufficient? Well, it depends if we expect the file to contain numbers, too:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;\W&#39;</span> <span class="s1">&#39;.&#39;</span><span class="nf">⎕S</span> <span class="m">3</span><span class="na">⍠</span><span class="s1">&#39;UCP&#39;</span><span class="m">1</span><span class="o">⊆⊢</span><span class="p">)</span> <span class="s1">&#39;These are words 55, 56 and 57 in total. Number1nmiddle&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬───┬─────┬──┬──┬───┬──┬──┬─────┬──────────────┐
│These│are│words│55│56│and│57│in│total│Number1nmiddle│
└─────┴───┴─────┴──┴──┴───┴──┴──┴─────┴──────────────┘
</span></div></div>
</div>
<p>The problem statement says nothing about numbers. We could remove those first, like so:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="s1">&#39;\W&#39;</span> <span class="s1">&#39;.&#39;</span><span class="nf">⎕S</span> <span class="m">3</span><span class="na">⍠</span><span class="s1">&#39;UCP&#39;</span><span class="m">1</span><span class="o">⊆⊢</span><span class="p">)</span> <span class="s1">&#39;\d&#39;</span><span class="nf">⎕R</span><span class="s1">&#39;&#39;</span><span class="o">⊢</span><span class="m">1</span><span class="nf">⎕C</span><span class="s1">&#39;These are words 55, 56 and 57 in total. Number1nmiddle&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌─────┬───┬─────┬───┬──┬─────┬─────────────┐
│THESE│ARE│WORDS│AND│IN│TOTAL│NUMBERNMIDDLE│
└─────┴───┴─────┴───┴──┴─────┴─────────────┘
</span></div></div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">words</span><span class="kd">←</span><span class="p">(</span><span class="s1">&#39;\W&#39;</span> <span class="s1">&#39;.&#39;</span><span class="nf">⎕S</span> <span class="m">3</span><span class="na">⍠</span><span class="s1">&#39;UCP&#39;</span><span class="m">1</span><span class="o">⊆⊢</span><span class="p">)</span> <span class="s1">&#39;\d&#39;</span><span class="nf">⎕R</span><span class="s1">&#39;&#39;</span><span class="o">⊢</span><span class="m">1</span><span class="nf">⎕C</span><span class="o">⊃,</span><span class="na">/</span><span class="nv">data</span>
</pre></div>
</div>
</div>
</div>
<p>So we wanted to know the number of words and lines in the text. That’s just</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">≢</span><span class="nv">words</span><span class="p">)(</span><span class="o">≢</span><span class="nv">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">555 42
</span></div></div>
</div>
<p>Next we want to find the most frequent letter. This is a fairly standard <em>Key</em> pattern, and here we also assume that if there are several most frequent letters, we should return all of them.</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">letters</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span><span class="nv">letters</span><span class="kd">←</span><span class="o">∊</span><span class="nv">words</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">E
</span></div></div>
</div>
<p>Finally, we need the average word length, to one decimal place. Let’s build a vector of word lengths and average with a neat little train:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">+</span><span class="na">/</span><span class="o">÷≢</span><span class="p">)</span><span class="o">≢</span><span class="na">¨</span><span class="nv">words</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5.531531531531532
</span></div></div>
</div>
<p>Oh, and to one decimal place:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="o">⍎</span><span class="m">1</span><span class="o">⍕</span><span class="p">(</span><span class="o">+</span><span class="na">/</span><span class="o">÷≢</span><span class="p">)</span><span class="o">≢</span><span class="na">¨</span><span class="nv">words</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">5.5
</span></div></div>
</div>
<p>I think we have all the pieces. Let’s golf that down to confuse the interviewers properly:</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="kt">{</span><span class="p">(</span><span class="o">≢</span><span class="nv">w</span><span class="p">)(</span><span class="o">≢</span><span class="bp">⍵</span><span class="p">)(</span><span class="o">⍎</span><span class="m">1</span><span class="o">⍕</span><span class="p">(</span><span class="o">+</span><span class="na">/</span><span class="o">÷≢</span><span class="p">)</span><span class="o">≢</span><span class="na">¨</span><span class="nv">w</span><span class="p">)(</span><span class="nv">l</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span><span class="nv">l</span><span class="kd">←</span><span class="o">∊</span><span class="nv">w</span><span class="kd">←</span><span class="p">(</span><span class="s1">&#39;\W&#39;</span> <span class="s1">&#39;.&#39;</span><span class="nf">⎕S</span> <span class="m">3</span><span class="na">⍠</span><span class="s1">&#39;UCP&#39;</span><span class="m">1</span><span class="o">⊆⊢</span><span class="p">)</span><span class="s1">&#39;\d&#39;</span><span class="nf">⎕R</span><span class="s1">&#39;&#39;</span><span class="o">⊢</span><span class="m">1</span><span class="nf">⎕C</span><span class="o">⊃,</span><span class="na">/</span><span class="bp">⍵</span><span class="p">)</span><span class="kt">}</span><span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬──┬───┬─┐
│555│42│5.5│E│
└───┴──┴───┴─┘
</span></div></div>
</div>
<p>If we didn’t care about numbers, and we were dealing with only the letters A-Z, we could have written the more compact</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="p">(</span><span class="o">≢</span><span class="nv">w</span><span class="p">)(</span><span class="o">≢</span><span class="nv">data</span><span class="p">)(</span><span class="o">⍎</span><span class="m">1</span><span class="o">⍕</span><span class="p">(</span><span class="o">+</span><span class="na">/</span><span class="o">÷≢</span><span class="p">)</span><span class="o">≢</span><span class="na">¨</span><span class="nv">w</span><span class="p">)(</span><span class="nv">l</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span><span class="nv">l</span><span class="kd">←</span><span class="o">∊</span><span class="nv">w</span><span class="kd">←</span><span class="p">(</span><span class="o">∊</span><span class="na">∘</span><span class="nf">⎕A</span><span class="o">⊆⊢</span><span class="p">)</span><span class="m">1</span><span class="nf">⎕C</span><span class="o">⊃,</span><span class="na">/</span><span class="nv">data</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬──┬───┬─┐
│555│42│5.5│E│
└───┴──┴───┴─┘
</span></div></div>
</div>
<p>Now we just have to wait for them to “assess the program for style and readability; and also look at how easy your program is to extend”. Once we’re done being smug, we could of course have structured that a bit friendlier for people new to APL (what Aaron Hsu calls “the didactic style”):</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="sr">]</span><span class="nv">dinput</span>
<span class="nv">stats</span> <span class="kd">←</span> <span class="kt">{</span>
    <span class="nv">words</span>   <span class="kd">←</span> <span class="p">(</span><span class="s1">&#39;\W&#39;</span> <span class="s1">&#39;.&#39;</span><span class="nf">⎕S</span> <span class="m">3</span><span class="na">⍠</span><span class="s1">&#39;UCP&#39;</span><span class="m">1</span><span class="o">⊆⊢</span><span class="p">)</span> <span class="s1">&#39;\d&#39;</span><span class="nf">⎕R</span><span class="s1">&#39;&#39;</span><span class="o">⊢</span><span class="m">1</span><span class="nf">⎕C</span><span class="o">⊃,</span><span class="na">/</span><span class="bp">⍵</span> <span class="c1">⍝ Flatten, upcase, remove numbers, split on &quot;non-word&quot;</span>
    <span class="nv">letters</span> <span class="kd">←</span> <span class="o">∊</span><span class="nv">words</span>                                   <span class="c1">⍝ Join</span>
    <span class="nv">common</span>  <span class="kd">←</span> <span class="nv">letters</span><span class="o">⌷</span><span class="na">⍨</span><span class="o">⊂</span><span class="m">0</span><span class="o">~</span><span class="na">⍨</span><span class="o">⊢</span><span class="na">/</span><span class="m">0</span><span class="o">,⊢</span><span class="na">⌸</span><span class="nv">letters</span>               <span class="c1">⍝ Frequency table, picking the most frequent</span>
    <span class="nv">lengths</span> <span class="kd">←</span> <span class="o">≢</span><span class="na">¨</span><span class="nv">words</span>                                  <span class="c1">⍝ Vector of length of each word</span>
    <span class="nv">ave</span>     <span class="kd">←</span> <span class="o">⍎</span><span class="m">1</span><span class="o">⍕</span><span class="p">(</span><span class="o">+</span><span class="na">/</span><span class="o">÷≢</span><span class="p">)</span><span class="nv">lengths</span>                         <span class="c1">⍝ Average, and round to 1 decimal place</span>
    <span class="p">(</span><span class="o">≢</span><span class="nv">words</span><span class="p">)</span> <span class="p">(</span><span class="o">≢</span><span class="bp">⍵</span><span class="p">)</span> <span class="nv">ave</span> <span class="nv">common</span>
<span class="kt">}</span>
</pre></div>
</div>
</div>
</div>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="nv">stats</span> <span class="nv">data</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬──┬───┬─┐
│555│42│5.5│E│
└───┴──┴───┴─┘
</span></div></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">Extensibility</span></code> is an amorphous topic, and typically something lauded by Object Orientationists as something that has intrinsic value. Is the above function extensible? Sure! I can add another line to count (say) the number of paragraphs and tag that on the end of the returned vector. However, in an OO language, perhaps you’d created a class that could be extended through inheritance. As APLers, we’d say that this obscures the intent, hiding the functionality away in perhaps other files, instead of having all available within a line or two.</p>
<p>So the question you’d have to ask yourself – would the above effort have gotten you the job?</p>
<p>I think we know the answer to that :) They expected five pages of Java… Anyway, if you aspire to dazzle interviewers, take a leaf out of <a class="reference external" href="https://aphyr.com/tags/Interviews">Aphyr’s book</a>.</p>
</div>
</div>
<span id="document-tldr"></span><div class="tex2jax_ignore mathjax_ignore section" id="too-long-didn-t-read">
<h2>Too long; didn’t read<a class="headerlink" href="#too-long-didn-t-read" title="Permalink to this headline">¶</a></h2>
<blockquote>
<div><p>Don’t be afraid to ask questions. Don’t be afraid to ask for help when you need it. I do that every day. Asking for help isn’t a sign of weakness, it’s a sign of strength. It shows you have the courage to admit when you don’t know something, and to learn something new. –<em>Barack Obama</em></p>
</div></blockquote>
<p>I started this from wanting to write down the few things that would have made my learning easier had I known them from the beginning. Many of those things (inevitably) now seem obvious, and this is probably part of the problem I faced at the time: the simple bits that everyone assumes everyone understands are only simple and obvious once you know them. Given that this book ended up creeping in scope, perhaps we should return to that original aim. What are the top-10 things that you really should take the time to understand from day 1, from practical to theoretical?</p>
<ol class="simple">
<li><p>Scalar extension is vital to understand (but also pretty hard to miss).</p></li>
<li><p>Arrays are not “list of lists”: rank is not depth. Make sure you <em>really</em> understand the difference.</p></li>
<li><p>Corollary: a vector of <code class="docutils literal notranslate"><span class="pre">n</span></code> items is not the same as a <code class="docutils literal notranslate"><span class="pre">1×n</span></code> array.</p></li>
<li><p>Arrays can only contain scalars. This means that everything in an array must have rank 0, and thus higher-rank elements must be enclosed before they can go in an array.</p></li>
<li><p>Cells are not equal to the element(s) they contain. Understand why pick (<code class="docutils literal notranslate"><span class="pre">⊃</span></code>) is different from squad (<code class="docutils literal notranslate"><span class="pre">⌷</span></code>).</p></li>
<li><p>Enclosures are not shown in output by default. Turn on boxing with <code class="docutils literal notranslate"><span class="pre">]box</span> <span class="pre">on</span> <span class="pre">-s=min|mid|max</span></code>! This also helps with visualising rank.</p></li>
<li><p>Understand the leading axis idea and a lot of other things start to make sense.</p></li>
<li><p>Study the rank (<code class="docutils literal notranslate"><span class="pre">⍤</span></code>) operator early and don’t stop until the penny drops.</p></li>
<li><p>RIDE: Shift-ctrl-backspace/return moves through your command history.</p></li>
<li><p>RIDE: Esc ‘fixes’ a function – change that immediately to command-s!</p></li>
</ol>
<div class="section" id="final-thoughts">
<h3>Final thoughts<a class="headerlink" href="#final-thoughts" title="Permalink to this headline">¶</a></h3>
<p>Learning APL is a rewarding pursuit. It certainly forced me to reexamine many calcified patterns in my own brain on what programming “should be like”. It was frustrating at first, feeling that the process of learning a new language was slower than usual. If you can resist the reaction that this is somehow the fault of APL (“It’s unreadable!”), you’ll soon conquer that initial small hump on the learning curve.</p>
<p>The other thing that I’ve found interesting is how many of your established “best practices” have evolved in completely different directions for APL. Aaron Hsu talks about this more eloquently than I ever could in his talk on <a class="reference external" href="https://www.sacrideo.us/apl-style-patterns-and-anti-patterns-in-apl/">APL patterns and anti-patterns</a>, but I’d like to highlight the following:</p>
<blockquote>
<div><p>Good APL follows a set of best practices that directly contradict and conflict with traditional programming wisdom. Indeed, APL design patterns appear as Anti-patterns in most other programming languages. –<em>Aaron Hsu</em></p>
</div></blockquote>
<p>This cognitive dissonance is one reason why some “computer people” <em>hate</em> APL. For me it’s one of the main draws: two fingers to <a class="reference external" href="http://cleancoder.com/products">Uncle Bob</a>, the <a class="reference external" href="https://en.wikipedia.org/wiki/Design_Patterns">Gang of Four</a>, and all of their ilk, the buzzkills of the software world.</p>
<blockquote>
<div><p>Writing APL code the same way you write traditional software only defeats both sanity and efficiency. –<em>Aaron Hsu</em></p>
</div></blockquote>
<div class="section" id="idioms-not-libraries">
<h4>Idioms, not libraries<a class="headerlink" href="#idioms-not-libraries" title="Permalink to this headline">¶</a></h4>
<p>When splitting a string on a delimiter is as easy as</p>
<div class="cell docutils container">
<div class="cell_input docutils container">
<div class="highlight-APL notranslate"><div class="highlight"><pre><span></span><span class="s1">&#39;,&#39;</span> <span class="p">(</span><span class="o">≠⊆⊢</span><span class="p">)</span> <span class="s1">&#39;one,two,three&#39;</span>
</pre></div>
</div>
</div>
<div class="cell_output docutils container">
<div class="output text_html"><span style="white-space:pre; font-family: monospace">
Rebuilding user command cache... done
</span></div><div class="output text_html"><span style="white-space:pre; font-family: monospace">┌───┬───┬─────┐
│one│two│three│
└───┴───┴─────┘
</span></div></div>
</div>
<p>there is no value in having a string library that needs importing and a <code class="docutils literal notranslate"><span class="pre">stringsplit</span></code> function. In fact, avoid naming things if you can, and if you must, only name things so close to their use that the definition can be seen without scrolling.</p>
<p>It’s kind of the polar opposite of any DRY rule you will have had drilled into you from the beginning. Good APL code reuses short idioms by “copy &amp; paste” so as not to obscure functionality.</p>
</div>
<div class="section" id="implicit-is-better-than-explicit-sometimes">
<h4>Implicit is better than explicit (sometimes)<a class="headerlink" href="#implicit-is-better-than-explicit-sometimes" title="Permalink to this headline">¶</a></h4>
<p>If you’re a Python programmer indoctrinated to believe in the Zen of Python ball and chain, you’re probably cringing. In APL, the tacit style allows you to compress more meaning into the glyph count, like, for example the string split example above. This means that short phrases can be made even shorter, and thus become idioms that can be recognized as whole “words”. See Aaron Hsu’s <a class="reference external" href="https://github.com/Co-dfns/">Co-dfns</a> project for an awe-inspiring masterclass in what this can look like when you take this approach to its logical conclusion.</p>
</div>
<div class="section" id="economy-of-representation-is-a-virtue">
<h4>Economy of representation is a virtue<a class="headerlink" href="#economy-of-representation-is-a-virtue" title="Permalink to this headline">¶</a></h4>
<p>The fewer keystrokes needed for your implementation, the easier it is to discover bugs by inspection, and the more of the system architecture you can hold in your head. This leads to increased confidence when making changes that these will function as intended in the larger context.</p>
<p>Ken wrote the following:</p>
<blockquote>
<div><p>The utility of a language as a tool of thought increases with the range of topics it can treat, but decreases with the amount of vocabulary and the complexity of grammatical rules which the user must keep in mind. Economy of notation is therefore important. Economy requires that a large number of ideas be expressible in terms of a relatively small vocabulary. A fundamental scheme for achieving this is the introduction of grammatical rules by which meaningful phrases and sentences can be constructed by combining elements of the vocabulary. –<em>Ken Iverson</em></p>
</div></blockquote>
<p>Somewhere in the mists of time, that idea was forgotten in mainstream languages. Look at your Java, your C++, your Rust, your Go – even your Python, a language which prides itself on its clean syntax. Why <em>do</em> you have to type all that stuff to get things done?</p>
</div>
</div>
<div class="section" id="acknowledgements">
<h3>Acknowledgements<a class="headerlink" href="#acknowledgements" title="Permalink to this headline">¶</a></h3>
<p><img alt="aplorchard" src="https://aplwiki.com/images/9/98/Me_at_the_APL_Orchard.png" /></p>
<div>[Illustration by <a href="https://chat.stackexchange.com/users/165520/razetime">Razetime</a> on <a href="https://chat.stackexchange.com/transcript/message/55290368#55290368">APL Orchard</a>]</div>
<p><p>
<p>I’d like to thank the bunch of mysterious pseudonyms that hang out on the <a class="reference external" href="https://apl.chat">APL Orchard</a> chat room who patiently answered every question I asked. It’s the main reason I persisted with APL. In no particular order, an incomplete list: <a class="reference external" href="https://chat.stackexchange.com/users/130368/adam">Adám</a>, <a class="reference external" href="https://chat.stackexchange.com/users/382943/rikedyp">rikedyp</a>, <a class="reference external" href="https://chat.stackexchange.com/users/245191/rgs">RGS</a>, <a class="reference external" href="https://chat.stackexchange.com/users/136283/ngn">ngn</a>, <a class="reference external" href="https://chat.stackexchange.com/users/337270/bubbler">Bubbler</a>, <a class="reference external" href="https://chat.stackexchange.com/users/470812/rak1507">rak1507</a>, <a class="reference external" href="https://chat.stackexchange.com/users/464678/marshall">Marshall</a>, <a class="reference external" href="https://chat.stackexchange.com/users/232772/dzaima">dzaima</a>, <a class="reference external" href="https://chat.stackexchange.com/users/165520/razetime">Razetime</a>, <a class="reference external" href="https://chat.stackexchange.com/users/76296/elias-martenson">Elias Mårtenson</a>, <a class="reference external" href="https://chat.stackexchange.com/users/354261/morten-kromberg">Morten Kromberg</a> and many others. I go under the mysterious pseudonym xpqz – pop in and say hello.</p>
</div>
</div>
</div>
</div>

    <script type="text/x-thebe-config">
    {
        requestKernel: true,
        binderOptions: {
            repo: "binder-examples/jupyter-stacks-datascience",
            ref: "master",
        },
        codeMirrorConfig: {
            theme: "abcdef",
            mode: "dyalog-kernel"
        },
        kernelOptions: {
            kernelName: "dyalog-kernel",
            path: "./."
        },
        predefinedOutput: true
    }
    </script>
    <script>kernelName = 'dyalog-kernel'</script>

              </div>
              
        
            <!-- Previous / next buttons -->
<div class='prev-next-area'>
</div>
        
        </div>
    </div>
    <footer class="footer">
    <div class="container">
      <p>
        
          By Stefan Kruger, Computational Array and Magic<br/>
        
          <div class="extra_footer">
            <p><a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">
  <img alt="Creative Commons License" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/4.0/88x31.png" />
</a></p>
<p>This work is licensed under a <a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/4.0/">Creative Commons Attribution-NonCommercial-ShareAlike 4.0 International License</a>.</p>

          </div>
      </p>
    </div>
  </footer>
</main>


      </div>
    </div>
  
  <script src="_static/js/index.be7d3bbb2ef33a8344ce.js"></script>

  </body>
</html>